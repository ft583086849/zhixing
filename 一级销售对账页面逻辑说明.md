# 一级销售对账页面数据逻辑说明

## 📊 核心逻辑概述

一级销售对账页面的数据逻辑是整个系统中最完整和准确的，按您的要求，应该作为标准数据源。

## 🔍 数据获取流程

### 1. 查询一级销售基础信息
```javascript
// 从 primary_sales 表直接获取
- wechat_name（微信号）
- sales_code（销售代码）
- commission_rate（基础佣金率，默认40%）
- payment_account（收款账户）
- payment_method（收款方式）
```

### 2. 查询二级销售团队
```javascript
// 获取该一级销售下的所有二级销售
从 secondary_sales 表查询:
- primary_sales_id = 一级销售ID
- 获取每个二级销售的订单和佣金数据
```

### 3. 订单统计逻辑
```javascript
// 排除已拒绝（rejected）的订单
// 只统计已确认的订单（confirmed_config等状态）

订单分类：
- 一级直接订单：sales_code = 一级销售代码
- 二级销售订单：sales_code = 二级销售代码

时间维度：
- 总计：所有已确认订单
- 本月：基于payment_time在当月
- 当日：基于payment_time在今天
```

## 💰 佣金计算核心逻辑

### 您明确的业务规则
```
每个订单总佣金池 = 40%

分配规则：
1. 一级自己卖的订单 → 一级拿40%
2. 二级卖的订单（假设二级佣金25%）：
   - 二级拿25%
   - 一级拿剩余15%（40% - 25%）
```

### 动态佣金率计算公式

```javascript
// 当前系统使用的公式（需要修正）
一级净佣金 = 
  (一级直接订单金额 × 40%) + 
  (二级订单总金额 × 40% - 二级实际佣金支出)

动态佣金率 = 一级净佣金 ÷ 团队总金额

// 修正后应该是：
一级实际佣金 = 
  (一级直接订单金额 × 40%) + 
  (二级订单总金额 × (40% - 二级佣金率))
```

### 具体计算示例

假设数据：
- 一级直接订单：1000美元
- 二级订单：2000美元（二级佣金率25%）

计算过程：
```
一级直接订单佣金 = 1000 × 40% = 400美元
二级订单：
  - 二级拿：2000 × 25% = 500美元
  - 一级拿：2000 × 15% = 300美元
  
一级总佣金 = 400 + 300 = 700美元
一级有效佣金率 = 700 ÷ 3000 = 23.33%
```

## 🔄 数据同步机制

### 当前问题
1. **管理员销售页面** - 使用独立的计算逻辑
2. **一级对账页面** - 使用getPrimarySalesSettlement
3. **数据不一致** - 两处计算逻辑不同

### 解决方案
统一使用`getPrimarySalesSettlement`的数据和逻辑，确保：
- 佣金率计算一致
- 订单统计口径一致
- 排除规则一致（如rejected订单）

## 📦 收款信息来源

收款信息直接从销售注册时填写的数据获取：

### 一级销售
```javascript
primary_sales表:
- payment_method（支付方式：usdt_trc20, usdt_bsc, alipay等）
- payment_account（收款账户/地址）
```

### 二级销售
```javascript
secondary_sales表:
- payment_method（支付方式）
- payment_account（收款账户/地址）
```

这些信息在销售注册时填写，用于后续的佣金打款。

## ⚠️ 需要修正的问题

### 1. 佣金率显示问题（2.5% vs 15%）
**原因**：动态计算公式错误导致
**解决**：修正计算公式或直接使用固定分配规则

### 2. 数据源不统一
**原因**：Admin页面和对账页面使用不同API
**解决**：统一使用getPrimarySalesSettlement

### 3. 特殊佣金率处理
- 张子俊：0%
- Liangjunhao889：0%
需要确保这些特殊设置正确生效

## 📝 总结

一级销售对账页面的逻辑是正确的，应该作为整个系统的数据标准。管理员页面应该调用相同的API或使用相同的计算逻辑，以确保数据一致性。
