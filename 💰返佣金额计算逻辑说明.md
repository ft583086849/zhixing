# 💰 返佣金额计算逻辑说明

## 一、佣金计算涉及的数据表

### 1. 销售表（存储佣金率）
- **primary_sales** 表
  - `commission_rate` 字段：一级销售的佣金率（默认 40%）
  - `sales_code` 字段：销售代码，用于关联订单

- **secondary_sales** 表
  - `commission_rate` 字段：二级销售的佣金率（默认 30%）
  - `sales_code` 字段：销售代码，用于关联订单
  - `primary_sales_id` 字段：关联的一级销售ID（如果有）

### 2. 订单表（存储计算后的佣金）
- **orders** 表
  - `sales_code` 字段：购买时使用的销售代码
  - `amount` 字段：订单金额
  - `actual_payment_amount` 字段：实际支付金额
  - `commission_amount` 字段：计算后的返佣金额
  - `commission_rate` 字段：使用的佣金率

## 二、佣金计算逻辑

### 1. 计算时机
佣金在**订单创建时**自动计算，具体流程：

```javascript
// 在 api.js 的 createOrder 函数中
if (processedOrderData.sales_code && processedOrderData.amount > 0) {
  // 1. 根据 sales_code 查找销售信息
  const salesInfo = await this.calculateCommission(
    processedOrderData.sales_code, 
    processedOrderData.amount
  );
  
  // 2. 设置佣金金额
  processedOrderData.commission_amount = salesInfo.commission;
  processedOrderData.commission_rate = salesInfo.rate;
}
```

### 2. 具体计算公式

#### calculateCommission 函数逻辑：
```javascript
async calculateCommission(salesCode, amount) {
  // 1. 根据 sales_code 查找销售记录
  const sale = await getSalesByCode(salesCode);
  
  // 2. 获取佣金率
  // - 如果销售表中有设置 commission_rate，使用设置的值
  // - 否则使用默认值：一级销售 40%，二级销售 30%
  const commissionRate = sale.commission_rate || 
    (sale.type === 'primary' ? 0.4 : 0.3);
  
  // 3. 计算佣金金额
  const commission = parseFloat(amount) * commissionRate;
  
  return {
    commission: commission,
    rate: commissionRate
  };
}
```

### 3. 佣金率规则

| 销售类型 | 默认佣金率 | 说明 |
|---------|-----------|------|
| 一级销售（直接销售） | 40% | 一级销售直接面向用户销售时的佣金 |
| 独立二级销售 | 30% | 没有关联一级销售的二级销售 |
| 一级销售下的二级销售 | 由一级销售设定 | 一级销售可以设置其下二级销售的佣金率 |

## 三、客户管理页面的佣金显示

在客户管理页面，返佣金额的显示逻辑：

1. **数据来源**：直接从 orders 表的 `commission_amount` 字段读取
2. **聚合计算**：按客户（customer_wechat + tradingview_username）分组，累加所有订单的佣金金额
3. **显示格式**：`$${parseFloat(commission_amount).toFixed(2)}`

## 四、数据流程示例

```
用户购买流程：
1. 用户通过销售链接购买
   ↓
2. 订单创建时携带 sales_code（如：PS_175450317913）
   ↓
3. 系统查询销售表
   - 查找 primary_sales WHERE sales_code = 'PS_175450317913'
   - 获取 commission_rate = 0.4（40%）
   ↓
4. 计算佣金
   - 订单金额：$188
   - 佣金率：40%
   - 返佣金额：$188 × 0.4 = $75.2
   ↓
5. 存储到订单表
   - commission_amount = 75.2
   - commission_rate = 0.4
   ↓
6. 客户管理页面显示
   - 返佣金额：$75.20
```

## 五、常见问题

### Q1: 为什么有些订单的返佣金额是 0？
**原因**：
- 订单金额为 0（如7天免费试用）
- 订单缺少 sales_code，无法关联到销售
- 销售表中的 commission_rate 设置为 0

### Q2: 如何修改历史订单的佣金？
**SQL修复脚本**：
```sql
-- 根据当前销售表的佣金率重新计算
UPDATE orders o
SET commission_amount = o.actual_payment_amount * (ps.commission_rate / 100)
FROM primary_sales ps
WHERE o.sales_code = ps.sales_code
  AND o.actual_payment_amount > 0
  AND ps.commission_rate > 0;
```

### Q3: 佣金计算是基于哪个金额？
**答案**：理论上应该基于 `actual_payment_amount`（实际支付金额），但目前代码中使用的是 `amount`（订单金额）。建议统一使用实际支付金额。

## 六、数据完整性检查

运行诊断脚本检查佣金数据问题：
```javascript
// 在浏览器控制台运行 🔍深度诊断客户管理数据问题.js
// 会检查：
// 1. 订单是否有 sales_code
// 2. sales_code 是否能匹配到销售
// 3. 佣金金额是否正确计算
```

## 七、注意事项

1. **佣金率单位**：在数据库中存储为百分比数值（如 40 表示 40%），计算时需要除以 100
2. **佣金计算时机**：仅在订单创建时计算，后续修改销售的佣金率不会影响历史订单
3. **数据关联**：依赖 sales_code 字段关联，如果此字段缺失会导致无法计算佣金
