# 🏗️ 新架构使用指南

## 📁 文件结构
```
client/src/services/
├── supabase.js          # Supabase数据库服务层
├── auth.js              # 身份验证服务
└── api.js               # 统一API业务逻辑层
```

## 🔧 三层架构说明

### 1. 数据库层 (supabase.js)
- **职责**: 直接与Supabase数据库交互
- **特点**: 提供原子性数据操作方法
- **使用场景**: 基础CRUD操作

```javascript
import { SupabaseService } from './supabase';

// 直接数据库操作
const orders = await SupabaseService.getOrders();
const admin = await SupabaseService.getAdminByUsername('admin');
```

### 2. 认证层 (auth.js)
- **职责**: 用户身份验证和权限管理
- **特点**: 统一的登录/登出逻辑
- **使用场景**: 用户登录、权限检查

```javascript
import { AuthService } from './auth';

// 登录
const result = await AuthService.login('admin', 'password');

// 检查登录状态
const isLoggedIn = AuthService.isAuthenticated();

// 登出
AuthService.logout();
```

### 3. 业务逻辑层 (api.js)
- **职责**: 复杂业务逻辑封装和缓存管理
- **特点**: 高级API接口，统一错误处理
- **使用场景**: React组件调用

```javascript
import { API } from './api';

// 管理员操作
const overview = await API.Admin.getOverview();
const orders = await API.Admin.getOrders();

// 销售操作
const salesInfo = await API.Sales.getSalesByCode('SALES001');
await API.Sales.registerSecondary(salesData);

// 订单操作
const newOrder = await API.Orders.create(orderData);
await API.Orders.updateStatus(orderId, 'completed');
```

## 📋 React组件使用示例

### 管理员登录页面
```javascript
import { useState } from 'react';
import { API } from '../services/api';

function AdminLogin() {
  const [loading, setLoading] = useState(false);
  
  const handleLogin = async (credentials) => {
    setLoading(true);
    try {
      const result = await API.Admin.login(credentials);
      if (result.success) {
        // 登录成功，跳转到管理页面
        window.location.href = '/#/admin/dashboard';
      }
    } catch (error) {
      // 错误已经在API层处理和显示
    } finally {
      setLoading(false);
    }
  };
  
  // ... 组件渲染
}
```

### 订单列表页面
```javascript
import { useEffect, useState } from 'react';
import { API } from '../services/api';

function OrdersList() {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    loadOrders();
  }, []);
  
  const loadOrders = async () => {
    try {
      const result = await API.Admin.getOrders();
      if (result.success) {
        setOrders(result.data);
      }
    } catch (error) {
      // 错误已处理
    } finally {
      setLoading(false);
    }
  };
  
  // ... 组件渲染
}
```

## ✅ 新架构优势

1. **清晰的职责分离**
   - 数据库操作 → Supabase层
   - 业务逻辑 → API层
   - 认证管理 → Auth层

2. **统一的错误处理**
   - 自动显示用户友好的错误信息
   - 自动处理登录过期
   - 统一的错误日志

3. **智能缓存管理**
   - 自动缓存频繁查询的数据
   - 数据更新时自动清除相关缓存
   - 提升用户体验

4. **易于维护和扩展**
   - 模块化设计，便于添加新功能
   - 清晰的API接口，便于团队协作
   - 完整的类型提示和文档

## 🔄 迁移步骤

1. **替换导入**
   ```javascript
   // 旧方式
   import api from '../services/api';
   
   // 新方式
   import { API } from '../services/api';
   ```

2. **更新API调用**
   ```javascript
   // 旧方式
   const response = await api.get('/admin?action=overview');
   
   // 新方式
   const result = await API.Admin.getOverview();
   ```

3. **处理返回值**
   ```javascript
   // 新API统一返回格式
   const result = await API.Admin.getOrders();
   if (result.success) {
     setOrders(result.data);
   }
   ```

## 🚀 立即开始使用
新架构已经完全兼容现有功能，可以立即开始使用！