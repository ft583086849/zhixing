# 新需求实现方案 - 实付金额和手工佣金率

## 🎯 需求总结

### 1. 实付金额功能
- **订单管理**：添加实付金额列
- **销售管理**：添加实付金额列（统计该销售的所有订单实付金额）
- **客户管理**：添加实付金额列  
- **佣金计算**：按实付金额计算返佣，不再按订单原金额

### 2. 手工填写佣金率功能
- **销售管理**：每个销售可以手动设置佣金率
- **生效范围**：影响该销售后续所有新订单的佣金计算
- **历史订单**：不影响已有订单的佣金

## 🔧 技术实现方案

### A. 数据库字段添加

#### 1. orders表添加实付金额字段
```sql
-- 添加实付金额字段到orders表
ALTER TABLE orders ADD COLUMN actual_payment_amount NUMERIC(10,2) DEFAULT 0.00;

-- 初始化现有数据：实付金额默认等于订单金额
UPDATE orders SET actual_payment_amount = amount WHERE actual_payment_amount IS NULL;
```

#### 2. 销售表添加自定义佣金率字段
```sql
-- 一级销售表添加自定义佣金率
ALTER TABLE primary_sales ADD COLUMN custom_commission_rate NUMERIC(6,4);
-- 设置默认值为系统默认佣金率
UPDATE primary_sales SET custom_commission_rate = commission_rate WHERE custom_commission_rate IS NULL;

-- 二级销售表添加自定义佣金率  
ALTER TABLE secondary_sales ADD COLUMN custom_commission_rate NUMERIC(6,4);
-- 设置默认值为系统默认佣金率
UPDATE secondary_sales SET custom_commission_rate = commission_rate WHERE custom_commission_rate IS NULL;
```

### B. API接口修改

#### 1. 订单创建逻辑修改
```javascript
// OrdersAPI.create 方法修改
async create(orderData) {
  // 新增实付金额处理
  const actualPaymentAmount = orderData.actual_payment_amount || orderData.amount;
  
  // 获取销售的自定义佣金率
  const salesInfo = await this.getSalesWithCustomRate(orderData.sales_code);
  const commissionRate = salesInfo.custom_commission_rate || salesInfo.commission_rate;
  
  // 按实付金额计算佣金
  const commissionAmount = actualPaymentAmount * commissionRate;
}
```

#### 2. 新增佣金率设置接口
```javascript
// AdminAPI 添加设置佣金率方法
async setCustomCommissionRate(salesId, salesType, customRate) {
  const table = salesType === 'primary' ? 'primary_sales' : 'secondary_sales';
  // 更新自定义佣金率
  await SupabaseService.updateSalesCommissionRate(table, salesId, customRate);
}
```

### C. 前端界面修改

#### 1. 订单管理页面
```javascript
// 添加实付金额列
{
  title: '实付金额',
  dataIndex: 'actual_payment_amount',
  key: 'actual_payment_amount',
  render: (amount) => `$${parseFloat(amount || 0).toFixed(2)}`
}
```

#### 2. 销售管理页面
```javascript
// 添加实付金额统计列
{
  title: '实付金额',
  key: 'total_actual_payment',
  render: (_, record) => {
    const totalActual = record.orders?.reduce((sum, order) => 
      sum + parseFloat(order.actual_payment_amount || 0), 0) || 0;
    return `$${totalActual.toFixed(2)}`;
  }
}

// 添加手工佣金率设置
{
  title: '佣金率设置',
  key: 'commission_rate_setting',
  render: (_, record) => (
    <InputNumber
      value={record.custom_commission_rate || record.commission_rate}
      min={0}
      max={1}
      step={0.0001}
      formatter={value => `${(value * 100).toFixed(2)}%`}
      parser={value => value.replace('%', '') / 100}
      onChange={(value) => handleCommissionRateChange(record.id, record.type, value)}
    />
  )
}
```

#### 3. 客户管理页面
```javascript
// 添加实付金额列
{
  title: '实付金额',
  key: 'total_actual_payment',
  render: (_, record) => `$${parseFloat(record.actual_payment_amount || 0).toFixed(2)}`
}
```

## 🚀 实施步骤

### 第1步：数据库字段添加
1. 运行SQL脚本添加 `actual_payment_amount` 字段
2. 运行SQL脚本添加 `custom_commission_rate` 字段

### 第2步：后端API修改
1. 修改订单创建逻辑，支持实付金额和自定义佣金率
2. 添加佣金率设置接口
3. 修改统计查询，包含实付金额统计

### 第3步：前端界面更新
1. 订单管理页面添加实付金额列
2. 销售管理页面添加实付金额统计和佣金率设置
3. 客户管理页面添加实付金额列

### 第4步：测试验证
1. 测试新订单按实付金额计算佣金
2. 测试手工设置佣金率功能
3. 测试各管理页面数据显示

## 📊 佣金计算逻辑调整

### 原逻辑
```
佣金金额 = 订单金额 × 固定佣金率
```

### 新逻辑  
```
佣金金额 = 实付金额 × 自定义佣金率（如果设置）|| 默认佣金率
```

## 🎯 优先级建议

1. **高优先级**：实付金额字段和显示
2. **中优先级**：手工佣金率设置功能
3. **低优先级**：历史数据的实付金额补填

这样可以先解决实付金额的显示问题，再逐步完善佣金率自定义功能。
