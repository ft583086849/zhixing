<!DOCTYPE html>
<html>
<head>
    <title>é”€å”®æœç´¢åŠŸèƒ½è°ƒè¯•</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container { 
            margin: 20px 0;
        }
        input, button { 
            padding: 10px; 
            margin: 5px;
            font-size: 16px;
        }
        input {
            width: 300px;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            color: red;
            background: #ffe0e0;
        }
        .success {
            color: green;
            background: #e0ffe0;
        }
        h2 {
            color: #333;
        }
        .info {
            background: #e0f0ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>é”€å”®æœç´¢åŠŸèƒ½è°ƒè¯•å·¥å…·</h1>
    
    <div class="info">
        <h3>ä½¿ç”¨è¯´æ˜ï¼š</h3>
        <ol>
            <li>åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ https://zhixing-seven.vercel.app</li>
            <li>ç™»å½•ç®¡ç†å‘˜è´¦å·</li>
            <li>æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰</li>
            <li>å°†ä¸‹é¢çš„è°ƒè¯•ä»£ç å¤åˆ¶åˆ°æ§åˆ¶å°è¿è¡Œ</li>
            <li>è¾“å…¥è¦æœç´¢çš„é”€å”®å¾®ä¿¡å·è¿›è¡Œæµ‹è¯•</li>
        </ol>
    </div>

    <div class="container">
        <h2>è°ƒè¯•ä»£ç ï¼ˆå¤åˆ¶åˆ°æµè§ˆå™¨æ§åˆ¶å°ï¼‰ï¼š</h2>
        <div class="result">
// é”€å”®æœç´¢è°ƒè¯•å‡½æ•°
window.debugSalesSearch = async (wechatName) => {
    console.log('=====================================');
    console.log(`å¼€å§‹è°ƒè¯•é”€å”®æœç´¢: "${wechatName}"`);
    console.log('=====================================');
    
    try {
        // 1. æ£€æŸ¥storeæ˜¯å¦å­˜åœ¨
        const store = window.store || window.__REDUX_STORE__;
        if (!store) {
            console.error('âŒ Redux storeæœªæ‰¾åˆ°');
            return;
        }
        console.log('âœ… Redux storeå·²æ‰¾åˆ°');
        
        // 2. è·å–å½“å‰é”€å”®æ•°æ®
        const currentState = store.getState();
        const currentSales = currentState.admin?.sales || [];
        console.log(`ğŸ“Š å½“å‰é”€å”®æ•°æ®: ${currentSales.length} æ¡`);
        
        // 3. è°ƒç”¨APIè¿›è¡Œæœç´¢
        console.log('\nğŸ“¡ è°ƒç”¨APIæœç´¢...');
        const adminAPI = window.adminAPI || {};
        
        // æ„å»ºæœç´¢å‚æ•°
        const searchParams = {
            wechat_name: wechatName
        };
        console.log('æœç´¢å‚æ•°:', searchParams);
        
        // ç›´æ¥è°ƒç”¨API
        const response = await fetch('/api/admin/sales?' + new URLSearchParams(searchParams), {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });
        
        const data = await response.json();
        console.log('APIå“åº”:', data);
        
        // 4. åˆ†ææœç´¢ç»“æœ
        if (data && data.data) {
            const results = data.data;
            console.log(`\nğŸ“‹ æœç´¢ç»“æœ: ${results.length} æ¡`);
            
            // åˆ†æä¸€çº§é”€å”®
            const primarySales = results.filter(s => s.sales_type === 'primary');
            console.log(`ä¸€çº§é”€å”®: ${primarySales.length} æ¡`);
            primarySales.forEach(s => {
                console.log(`  - ${s.sales?.wechat_name} (${s.sales?.sales_code})`);
            });
            
            // åˆ†æäºŒçº§é”€å”®
            const secondarySales = results.filter(s => s.sales_type === 'secondary');
            console.log(`äºŒçº§é”€å”®: ${secondarySales.length} æ¡`);
            secondarySales.forEach(s => {
                console.log(`  - ${s.sales?.wechat_name} (${s.sales?.sales_code}) - ä¸Šçº§ID: ${s.sales?.primary_sales_id}`);
            });
            
            // æ£€æŸ¥å…³è”å…³ç³»
            console.log('\nğŸ”— æ£€æŸ¥å…³è”å…³ç³»:');
            primarySales.forEach(primary => {
                const relatedSecondary = secondarySales.filter(s => 
                    s.sales?.primary_sales_id === primary.sales?.id
                );
                console.log(`${primary.sales?.wechat_name} çš„ä¸‹å±:`, 
                    relatedSecondary.map(s => s.sales?.wechat_name));
            });
        }
        
    } catch (error) {
        console.error('âŒ è°ƒè¯•å¤±è´¥:', error);
    }
};

// æµ‹è¯•å‡½æ•°
window.testSalesSearch = () => {
    const testName = prompt('è¯·è¾“å…¥è¦æœç´¢çš„é”€å”®å¾®ä¿¡å·:');
    if (testName) {
        window.debugSalesSearch(testName);
    }
};

console.log('âœ… è°ƒè¯•å·¥å…·å·²åŠ è½½ï¼');
console.log('ä½¿ç”¨æ–¹æ³•:');
console.log('1. debugSalesSearch("å¾®ä¿¡å·") - è°ƒè¯•æœç´¢åŠŸèƒ½');
console.log('2. testSalesSearch() - äº¤äº’å¼æµ‹è¯•');
        </div>
    </div>

    <div class="container">
        <h2>å¿«é€Ÿæµ‹è¯•ï¼š</h2>
        <p>åœ¨æ§åˆ¶å°è¿è¡Œ: <code>testSalesSearch()</code></p>
    </div>

    <div class="container">
        <h2>å¯èƒ½çš„é—®é¢˜ï¼š</h2>
        <ul>
            <li><strong>primary_sales_idå­—æ®µæœªè®¾ç½®</strong>ï¼šäºŒçº§é”€å”®æ²¡æœ‰æ­£ç¡®å…³è”åˆ°ä¸€çº§é”€å”®</li>
            <li><strong>æœç´¢å‚æ•°åç§°ä¸åŒ¹é…</strong>ï¼šå‰ç«¯ä½¿ç”¨wechat_nameï¼Œåç«¯å¯èƒ½æœŸæœ›å…¶ä»–å‚æ•°</li>
            <li><strong>æ•°æ®ç»“æ„é—®é¢˜</strong>ï¼šsaleså¯¹è±¡åµŒå¥—ç»“æ„ä¸æ­£ç¡®</li>
            <li><strong>ç¼“å­˜é—®é¢˜</strong>ï¼šæœç´¢ç»“æœè¢«ç¼“å­˜ï¼Œæ²¡æœ‰å®æ—¶æ›´æ–°</li>
        </ul>
    </div>
</body>
</html>
