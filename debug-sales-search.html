<!DOCTYPE html>
<html>
<head>
    <title>销售搜索功能调试</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .container { 
            margin: 20px 0;
        }
        input, button { 
            padding: 10px; 
            margin: 5px;
            font-size: 16px;
        }
        input {
            width: 300px;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px; 
            background: #f5f5f5; 
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .error {
            color: red;
            background: #ffe0e0;
        }
        .success {
            color: green;
            background: #e0ffe0;
        }
        h2 {
            color: #333;
        }
        .info {
            background: #e0f0ff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>销售搜索功能调试工具</h1>
    
    <div class="info">
        <h3>使用说明：</h3>
        <ol>
            <li>在浏览器中打开 https://zhixing-seven.vercel.app</li>
            <li>登录管理员账号</li>
            <li>打开浏览器控制台（F12）</li>
            <li>将下面的调试代码复制到控制台运行</li>
            <li>输入要搜索的销售微信号进行测试</li>
        </ol>
    </div>

    <div class="container">
        <h2>调试代码（复制到浏览器控制台）：</h2>
        <div class="result">
// 销售搜索调试函数
window.debugSalesSearch = async (wechatName) => {
    console.log('=====================================');
    console.log(`开始调试销售搜索: "${wechatName}"`);
    console.log('=====================================');
    
    try {
        // 1. 检查store是否存在
        const store = window.store || window.__REDUX_STORE__;
        if (!store) {
            console.error('❌ Redux store未找到');
            return;
        }
        console.log('✅ Redux store已找到');
        
        // 2. 获取当前销售数据
        const currentState = store.getState();
        const currentSales = currentState.admin?.sales || [];
        console.log(`📊 当前销售数据: ${currentSales.length} 条`);
        
        // 3. 调用API进行搜索
        console.log('\n📡 调用API搜索...');
        const adminAPI = window.adminAPI || {};
        
        // 构建搜索参数
        const searchParams = {
            wechat_name: wechatName
        };
        console.log('搜索参数:', searchParams);
        
        // 直接调用API
        const response = await fetch('/api/admin/sales?' + new URLSearchParams(searchParams), {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            }
        });
        
        const data = await response.json();
        console.log('API响应:', data);
        
        // 4. 分析搜索结果
        if (data && data.data) {
            const results = data.data;
            console.log(`\n📋 搜索结果: ${results.length} 条`);
            
            // 分析一级销售
            const primarySales = results.filter(s => s.sales_type === 'primary');
            console.log(`一级销售: ${primarySales.length} 条`);
            primarySales.forEach(s => {
                console.log(`  - ${s.sales?.wechat_name} (${s.sales?.sales_code})`);
            });
            
            // 分析二级销售
            const secondarySales = results.filter(s => s.sales_type === 'secondary');
            console.log(`二级销售: ${secondarySales.length} 条`);
            secondarySales.forEach(s => {
                console.log(`  - ${s.sales?.wechat_name} (${s.sales?.sales_code}) - 上级ID: ${s.sales?.primary_sales_id}`);
            });
            
            // 检查关联关系
            console.log('\n🔗 检查关联关系:');
            primarySales.forEach(primary => {
                const relatedSecondary = secondarySales.filter(s => 
                    s.sales?.primary_sales_id === primary.sales?.id
                );
                console.log(`${primary.sales?.wechat_name} 的下属:`, 
                    relatedSecondary.map(s => s.sales?.wechat_name));
            });
        }
        
    } catch (error) {
        console.error('❌ 调试失败:', error);
    }
};

// 测试函数
window.testSalesSearch = () => {
    const testName = prompt('请输入要搜索的销售微信号:');
    if (testName) {
        window.debugSalesSearch(testName);
    }
};

console.log('✅ 调试工具已加载！');
console.log('使用方法:');
console.log('1. debugSalesSearch("微信号") - 调试搜索功能');
console.log('2. testSalesSearch() - 交互式测试');
        </div>
    </div>

    <div class="container">
        <h2>快速测试：</h2>
        <p>在控制台运行: <code>testSalesSearch()</code></p>
    </div>

    <div class="container">
        <h2>可能的问题：</h2>
        <ul>
            <li><strong>primary_sales_id字段未设置</strong>：二级销售没有正确关联到一级销售</li>
            <li><strong>搜索参数名称不匹配</strong>：前端使用wechat_name，后端可能期望其他参数</li>
            <li><strong>数据结构问题</strong>：sales对象嵌套结构不正确</li>
            <li><strong>缓存问题</strong>：搜索结果被缓存，没有实时更新</li>
        </ul>
    </div>
</body>
</html>
