# 📋 v2.5.9 五个问题修复方案

## 问题解答与修复

### 1️⃣ 查看数据库中销售的收款地址数据

**查询代码（查看所有字段）**：
```javascript
// 查看销售完整注册数据.js
const { data: primarySales } = await supabase
  .from('primary_sales')
  .select('*');  // 获取所有字段

const { data: secondarySales } = await supabase
  .from('secondary_sales')
  .select('*');  // 获取所有字段
```

**查询结果**：
- 所有销售的`payment_account`字段都是"未设置"
- 所有销售选择了`crypto`作为收款方式，但没有填写地址
- 需要销售补充收款地址信息

---

### 2️⃣ 搜索改为精确匹配

**修改位置**：`client/src/services/api.js` 第701-725行

**修改内容**：
```javascript
// 之前：使用includes部分匹配
sale.wechat_name.toLowerCase().includes(searchTerm)

// 修改后：使用===精确匹配  
sale.wechat_name.toLowerCase() === searchTerm
```

**效果**：
- 搜索"张子俊"只显示完全匹配"张子俊"的一级销售及其二级销售
- 不再显示包含"张"字的其他销售

---

### 3️⃣ 实现已返佣金额保存

**数据库修改**（添加已返佣金字段.sql）：
```sql
-- 给一级销售表添加已返佣金字段
ALTER TABLE primary_sales 
ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;

-- 给二级销售表添加已返佣金字段  
ALTER TABLE secondary_sales
ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;

-- 可选：添加最后返佣时间
ALTER TABLE primary_sales
ADD COLUMN IF NOT EXISTS last_commission_paid_at TIMESTAMP DEFAULT NULL;

ALTER TABLE secondary_sales
ADD COLUMN IF NOT EXISTS last_commission_paid_at TIMESTAMP DEFAULT NULL;
```

**API实现**（api.js新增）：
```javascript
async updatePaidCommission(salesId, salesType, amount) {
  const table = salesType === 'primary' ? 'primary_sales' : 'secondary_sales';
  
  const { data, error } = await supabase
    .from(table)
    .update({ 
      paid_commission: amount,
      last_commission_paid_at: new Date().toISOString()
    })
    .eq('id', salesId);
}
```

**前端修改**（AdminSales.js）：
- 确认按钮现在会调用`updatePaidCommission` API保存数据
- 保存成功后刷新页面数据

---

### 4️⃣ 排除已拒绝订单的统计

**修改位置**：`client/src/services/api.js`

**客户管理修复**（第291-372行）：
```javascript
// 新增：排除已拒绝的订单
if (order.status === 'rejected') {
  return; // 跳过已拒绝的订单
}
```

**销售管理**（已正确实现）：
- 第791行：`order.status !== 'rejected'`
- 第895行：`order.status !== 'rejected'`
- 第1206行：排除已拒绝订单计算总收入
- 第1330行：排除已拒绝订单计算总订单数

**效果**：
- 已拒绝的订单不计入客户的订单数和金额统计
- 如果客户只有已拒绝订单，则不显示该客户

---

### 5️⃣ 客户管理数据来源说明

**数据表**：
- 主要从`orders`表获取数据
- 关联`primary_sales`和`secondary_sales`表获取销售信息

**API位置**：`client/src/services/api.js` 的 `AdminAPI.getCustomers()` 方法（第211-441行）

**核心逻辑**：
```javascript
// 1. 查询所有订单（排除已拒绝）
const orders = await supabase.from('orders').select('*');

// 2. 查询销售表
const primarySales = await supabase.from('primary_sales').select('*');
const secondarySales = await supabase.from('secondary_sales').select('*');

// 3. 通过sales_code关联订单和销售
const matchingSale = allSales.find(sale => 
  sale.sales_code === order.sales_code
);

// 4. 判断销售层级
if (primarySales.some(s => s.sales_code === order.sales_code)) {
  salesType = 'primary';  // 一级销售
} else if (secondarySales.some(s => s.sales_code === order.sales_code)) {
  salesType = 'secondary';  // 二级销售
  // 获取上级销售
  if (secondarySale.primary_sales_id) {
    const primarySale = primarySalesMap.get(secondarySale.primary_sales_id);
    primarySalesName = primarySale.wechat_name;
  }
}
```

**字段映射**：
- `客户微信号` = `order.customer_wechat`
- `TradingView用户` = `order.tradingview_username`
- `销售微信号` = 通过`sales_code`查找销售表的`wechat_name`
- `销售类型` = 判断是一级/二级/独立销售
- `一级销售名字` = 如果是二级销售，获取其`primary_sales_id`对应的一级销售

---

## 📝 修改文件清单

1. **client/src/services/api.js**
   - 搜索逻辑改为精确匹配（第701-725行）
   - 新增`updatePaidCommission` API（第1660-1688行）
   - 客户管理排除已拒绝订单（第291-372行）

2. **client/src/components/admin/AdminSales.js**
   - 导入AdminAPI（第36行）
   - 确认按钮调用保存API（第533-548行）

3. **添加已返佣金字段.sql**
   - 数据库字段添加脚本

---

## ✅ 测试要点

- [ ] 搜索"张子俊"精确显示张子俊及其二级销售
- [ ] 已返佣金额填写后点确认能保存
- [ ] 刷新页面后已返佣金额仍显示
- [ ] 客户管理不显示只有已拒绝订单的客户
- [ ] 销售管理统计不包含已拒绝订单

---

## 🚀 部署步骤

1. 先执行SQL添加数据库字段
2. 部署代码更新
3. 测试所有功能
4. 通知销售补充收款地址信息
