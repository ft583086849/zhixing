# ğŸ“‹ v2.5.9 äº”ä¸ªé—®é¢˜ä¿®å¤æ–¹æ¡ˆ

## é—®é¢˜è§£ç­”ä¸ä¿®å¤

### 1ï¸âƒ£ æŸ¥çœ‹æ•°æ®åº“ä¸­é”€å”®çš„æ”¶æ¬¾åœ°å€æ•°æ®

**æŸ¥è¯¢ä»£ç ï¼ˆæŸ¥çœ‹æ‰€æœ‰å­—æ®µï¼‰**ï¼š
```javascript
// æŸ¥çœ‹é”€å”®å®Œæ•´æ³¨å†Œæ•°æ®.js
const { data: primarySales } = await supabase
  .from('primary_sales')
  .select('*');  // è·å–æ‰€æœ‰å­—æ®µ

const { data: secondarySales } = await supabase
  .from('secondary_sales')
  .select('*');  // è·å–æ‰€æœ‰å­—æ®µ
```

**æŸ¥è¯¢ç»“æœ**ï¼š
- æ‰€æœ‰é”€å”®çš„`payment_account`å­—æ®µéƒ½æ˜¯"æœªè®¾ç½®"
- æ‰€æœ‰é”€å”®é€‰æ‹©äº†`crypto`ä½œä¸ºæ”¶æ¬¾æ–¹å¼ï¼Œä½†æ²¡æœ‰å¡«å†™åœ°å€
- éœ€è¦é”€å”®è¡¥å……æ”¶æ¬¾åœ°å€ä¿¡æ¯

---

### 2ï¸âƒ£ æœç´¢æ”¹ä¸ºç²¾ç¡®åŒ¹é…

**ä¿®æ”¹ä½ç½®**ï¼š`client/src/services/api.js` ç¬¬701-725è¡Œ

**ä¿®æ”¹å†…å®¹**ï¼š
```javascript
// ä¹‹å‰ï¼šä½¿ç”¨includeséƒ¨åˆ†åŒ¹é…
sale.wechat_name.toLowerCase().includes(searchTerm)

// ä¿®æ”¹åï¼šä½¿ç”¨===ç²¾ç¡®åŒ¹é…  
sale.wechat_name.toLowerCase() === searchTerm
```

**æ•ˆæœ**ï¼š
- æœç´¢"å¼ å­ä¿Š"åªæ˜¾ç¤ºå®Œå…¨åŒ¹é…"å¼ å­ä¿Š"çš„ä¸€çº§é”€å”®åŠå…¶äºŒçº§é”€å”®
- ä¸å†æ˜¾ç¤ºåŒ…å«"å¼ "å­—çš„å…¶ä»–é”€å”®

---

### 3ï¸âƒ£ å®ç°å·²è¿”ä½£é‡‘é¢ä¿å­˜

**æ•°æ®åº“ä¿®æ”¹**ï¼ˆæ·»åŠ å·²è¿”ä½£é‡‘å­—æ®µ.sqlï¼‰ï¼š
```sql
-- ç»™ä¸€çº§é”€å”®è¡¨æ·»åŠ å·²è¿”ä½£é‡‘å­—æ®µ
ALTER TABLE primary_sales 
ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;

-- ç»™äºŒçº§é”€å”®è¡¨æ·»åŠ å·²è¿”ä½£é‡‘å­—æ®µ  
ALTER TABLE secondary_sales
ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;

-- å¯é€‰ï¼šæ·»åŠ æœ€åè¿”ä½£æ—¶é—´
ALTER TABLE primary_sales
ADD COLUMN IF NOT EXISTS last_commission_paid_at TIMESTAMP DEFAULT NULL;

ALTER TABLE secondary_sales
ADD COLUMN IF NOT EXISTS last_commission_paid_at TIMESTAMP DEFAULT NULL;
```

**APIå®ç°**ï¼ˆapi.jsæ–°å¢ï¼‰ï¼š
```javascript
async updatePaidCommission(salesId, salesType, amount) {
  const table = salesType === 'primary' ? 'primary_sales' : 'secondary_sales';
  
  const { data, error } = await supabase
    .from(table)
    .update({ 
      paid_commission: amount,
      last_commission_paid_at: new Date().toISOString()
    })
    .eq('id', salesId);
}
```

**å‰ç«¯ä¿®æ”¹**ï¼ˆAdminSales.jsï¼‰ï¼š
- ç¡®è®¤æŒ‰é’®ç°åœ¨ä¼šè°ƒç”¨`updatePaidCommission` APIä¿å­˜æ•°æ®
- ä¿å­˜æˆåŠŸååˆ·æ–°é¡µé¢æ•°æ®

---

### 4ï¸âƒ£ æ’é™¤å·²æ‹’ç»è®¢å•çš„ç»Ÿè®¡

**ä¿®æ”¹ä½ç½®**ï¼š`client/src/services/api.js`

**å®¢æˆ·ç®¡ç†ä¿®å¤**ï¼ˆç¬¬291-372è¡Œï¼‰ï¼š
```javascript
// æ–°å¢ï¼šæ’é™¤å·²æ‹’ç»çš„è®¢å•
if (order.status === 'rejected') {
  return; // è·³è¿‡å·²æ‹’ç»çš„è®¢å•
}
```

**é”€å”®ç®¡ç†**ï¼ˆå·²æ­£ç¡®å®ç°ï¼‰ï¼š
- ç¬¬791è¡Œï¼š`order.status !== 'rejected'`
- ç¬¬895è¡Œï¼š`order.status !== 'rejected'`
- ç¬¬1206è¡Œï¼šæ’é™¤å·²æ‹’ç»è®¢å•è®¡ç®—æ€»æ”¶å…¥
- ç¬¬1330è¡Œï¼šæ’é™¤å·²æ‹’ç»è®¢å•è®¡ç®—æ€»è®¢å•æ•°

**æ•ˆæœ**ï¼š
- å·²æ‹’ç»çš„è®¢å•ä¸è®¡å…¥å®¢æˆ·çš„è®¢å•æ•°å’Œé‡‘é¢ç»Ÿè®¡
- å¦‚æœå®¢æˆ·åªæœ‰å·²æ‹’ç»è®¢å•ï¼Œåˆ™ä¸æ˜¾ç¤ºè¯¥å®¢æˆ·

---

### 5ï¸âƒ£ å®¢æˆ·ç®¡ç†æ•°æ®æ¥æºè¯´æ˜

**æ•°æ®è¡¨**ï¼š
- ä¸»è¦ä»`orders`è¡¨è·å–æ•°æ®
- å…³è”`primary_sales`å’Œ`secondary_sales`è¡¨è·å–é”€å”®ä¿¡æ¯

**APIä½ç½®**ï¼š`client/src/services/api.js` çš„ `AdminAPI.getCustomers()` æ–¹æ³•ï¼ˆç¬¬211-441è¡Œï¼‰

**æ ¸å¿ƒé€»è¾‘**ï¼š
```javascript
// 1. æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼ˆæ’é™¤å·²æ‹’ç»ï¼‰
const orders = await supabase.from('orders').select('*');

// 2. æŸ¥è¯¢é”€å”®è¡¨
const primarySales = await supabase.from('primary_sales').select('*');
const secondarySales = await supabase.from('secondary_sales').select('*');

// 3. é€šè¿‡sales_codeå…³è”è®¢å•å’Œé”€å”®
const matchingSale = allSales.find(sale => 
  sale.sales_code === order.sales_code
);

// 4. åˆ¤æ–­é”€å”®å±‚çº§
if (primarySales.some(s => s.sales_code === order.sales_code)) {
  salesType = 'primary';  // ä¸€çº§é”€å”®
} else if (secondarySales.some(s => s.sales_code === order.sales_code)) {
  salesType = 'secondary';  // äºŒçº§é”€å”®
  // è·å–ä¸Šçº§é”€å”®
  if (secondarySale.primary_sales_id) {
    const primarySale = primarySalesMap.get(secondarySale.primary_sales_id);
    primarySalesName = primarySale.wechat_name;
  }
}
```

**å­—æ®µæ˜ å°„**ï¼š
- `å®¢æˆ·å¾®ä¿¡å·` = `order.customer_wechat`
- `TradingViewç”¨æˆ·` = `order.tradingview_username`
- `é”€å”®å¾®ä¿¡å·` = é€šè¿‡`sales_code`æŸ¥æ‰¾é”€å”®è¡¨çš„`wechat_name`
- `é”€å”®ç±»å‹` = åˆ¤æ–­æ˜¯ä¸€çº§/äºŒçº§/ç‹¬ç«‹é”€å”®
- `ä¸€çº§é”€å”®åå­—` = å¦‚æœæ˜¯äºŒçº§é”€å”®ï¼Œè·å–å…¶`primary_sales_id`å¯¹åº”çš„ä¸€çº§é”€å”®

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. **client/src/services/api.js**
   - æœç´¢é€»è¾‘æ”¹ä¸ºç²¾ç¡®åŒ¹é…ï¼ˆç¬¬701-725è¡Œï¼‰
   - æ–°å¢`updatePaidCommission` APIï¼ˆç¬¬1660-1688è¡Œï¼‰
   - å®¢æˆ·ç®¡ç†æ’é™¤å·²æ‹’ç»è®¢å•ï¼ˆç¬¬291-372è¡Œï¼‰

2. **client/src/components/admin/AdminSales.js**
   - å¯¼å…¥AdminAPIï¼ˆç¬¬36è¡Œï¼‰
   - ç¡®è®¤æŒ‰é’®è°ƒç”¨ä¿å­˜APIï¼ˆç¬¬533-548è¡Œï¼‰

3. **æ·»åŠ å·²è¿”ä½£é‡‘å­—æ®µ.sql**
   - æ•°æ®åº“å­—æ®µæ·»åŠ è„šæœ¬

---

## âœ… æµ‹è¯•è¦ç‚¹

- [ ] æœç´¢"å¼ å­ä¿Š"ç²¾ç¡®æ˜¾ç¤ºå¼ å­ä¿ŠåŠå…¶äºŒçº§é”€å”®
- [ ] å·²è¿”ä½£é‡‘é¢å¡«å†™åç‚¹ç¡®è®¤èƒ½ä¿å­˜
- [ ] åˆ·æ–°é¡µé¢åå·²è¿”ä½£é‡‘é¢ä»æ˜¾ç¤º
- [ ] å®¢æˆ·ç®¡ç†ä¸æ˜¾ç¤ºåªæœ‰å·²æ‹’ç»è®¢å•çš„å®¢æˆ·
- [ ] é”€å”®ç®¡ç†ç»Ÿè®¡ä¸åŒ…å«å·²æ‹’ç»è®¢å•

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

1. å…ˆæ‰§è¡ŒSQLæ·»åŠ æ•°æ®åº“å­—æ®µ
2. éƒ¨ç½²ä»£ç æ›´æ–°
3. æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
4. é€šçŸ¥é”€å”®è¡¥å……æ”¶æ¬¾åœ°å€ä¿¡æ¯
