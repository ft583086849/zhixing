# ğŸ“Š å‰ç«¯é¡µé¢ä¸æ•°æ®åº“å¯¹åº”åˆ†ææŠ¥å‘Š

> åˆ†ææ—¶é—´ï¼š2025-08-13 å‡Œæ™¨3ç‚¹
> ç›®çš„ï¼šå¯¹æ¯”å‰ç«¯é¡µé¢ã€APIé€»è¾‘ä¸æ•°æ®åº“ç»“æ„çš„åŒ¹é…æ€§

---

## ğŸ”´ å…³é”®é—®é¢˜æ±‡æ€»

### 1. è´­ä¹°é¡µé¢ (PurchasePage.js) é—®é¢˜

#### æ•°æ®æäº¤å­—æ®µå¯¹æ¯”
| å‰ç«¯æäº¤å­—æ®µ | æ•°æ®åº“ordersè¡¨å­—æ®µ | é—®é¢˜ | å½±å“ |
|-------------|------------------|------|------|
| sales_code âœ… | sales_code | åŒ¹é… | - |
| link_code âŒ | link_code | éƒ½æ˜¯NULL | å‰ç«¯å‘é€ä½†æ•°æ®åº“ä¸å­˜å‚¨ |
| tradingview_username âœ… | tradingview_username | åŒ¹é… | - |
| customer_wechat âœ… | customer_wechat | åŒ¹é… | - |
| duration âœ… | duration | åŒ¹é… | - |
| amount âœ… | amount | åŒ¹é… | - |
| actual_payment_amount âœ… | actual_payment_amount | åŒ¹é… | - |
| payment_method âœ… | payment_method | åŒ¹é… | - |
| payment_time âœ… | payment_time | åŒ¹é… | - |
| purchase_type âœ… | purchase_type | åŒ¹é… | - |
| effective_time âœ… | effective_time | åŒ¹é… | - |
| screenshot_data âš ï¸ | screenshot_data | å­—æ®µå­˜åœ¨ä½†éƒ½æ˜¯NULL | æˆªå›¾æ•°æ®å¯èƒ½æ²¡ä¿å­˜ |
| crypto_amount âœ… | crypto_amount | åŒ¹é… | - |

#### ä»£ç é€»è¾‘é—®é¢˜
```javascript
// é—®é¢˜1ï¼šlink_codeå†—ä½™
const formData = {
  sales_code: linkCode,  // ä½¿ç”¨sales_code
  link_code: linkCode,   // å†—ä½™å­—æ®µï¼Œæ•°æ®åº“å®é™…ä¸ç”¨
  ...
}

// é—®é¢˜2ï¼šç¡¬ç¼–ç çš„é”€å”®é“¾æ¥
<a href="https://zhixing-seven.vercel.app/secondary-sales">
  ç‚¹æ­¤é“¾æ¥åˆ°é”€å”®ç”³è¯·é¡µé¢
</a>
// åº”è¯¥æ ¹æ®é”€å”®çš„registration_codeç”ŸæˆåŠ¨æ€é“¾æ¥
```

---

### 2. é”€å”®ç®¡ç†é¡µé¢ (AdminSales.js) é—®é¢˜

#### æ•°æ®å±•ç¤ºé—®é¢˜
| é¡µé¢æ˜¾ç¤ºå­—æ®µ | æ•°æ®æ¥æº | é—®é¢˜ | å½±å“ |
|------------|---------|------|------|
| é”€å”®ç±»å‹ | sales.sales_type | âœ… æ­£å¸¸ | - |
| é”€å”®å¾®ä¿¡å· | sales.wechat_name | âœ… æ­£å¸¸ | - |
| å±‚çº§å…³ç³» | secondary_sales_count | âš ï¸ éœ€è¦å®æ—¶è®¡ç®— | æ€§èƒ½å½±å“ |
| æ€»è®¢å•æ•° | total_orders | âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ | éœ€è¦å®æ—¶ç»Ÿè®¡ |
| æœ‰æ•ˆè®¢å•æ•° | valid_orders | âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ | éœ€è¦å®æ—¶ç»Ÿè®¡ |
| æ€»é‡‘é¢ | total_amount | âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ | éœ€è¦å®æ—¶ç»Ÿè®¡ |
| å¹³å‡äºŒçº§ä½£é‡‘ç‡ | secondary_avg_rate | âŒ éœ€è¦è®¡ç®— | éœ€è¦èšåˆæŸ¥è¯¢ |

#### ä½£é‡‘ç‡æ›´æ–°é€»è¾‘é—®é¢˜
```javascript
// é—®é¢˜ï¼šç‹¬ç«‹é”€å”®çš„å¤„ç†é€»è¾‘æ··ä¹±
let tableType = actualSalesType;
if (actualSalesType === 'independent') {
  tableType = 'secondary';  // ç‹¬ç«‹é”€å”®åœ¨secondary_salesè¡¨ä¸­
}
// è¿™ç§ç¡¬ç¼–ç çš„è¡¨åæ˜ å°„å®¹æ˜“å‡ºé”™
```

---

### 3. APIå±‚ä¸æ•°æ®åº“ä¸åŒ¹é…

#### getSales() APIæœŸæœ›è¿”å›
```javascript
{
  id: 1,
  sales_code: 'SEC123',
  wechat_name: 'sales001',
  total_orders: 10,        // âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ
  valid_orders: 8,         // âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ  
  total_amount: 1000,      // âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ
  confirmed_amount: 800,   // âŒ æ•°æ®åº“æ— æ­¤å­—æ®µ
  commission_rate: 0.25,
  sales_type: 'primary',
  secondary_sales_count: 3 // âŒ éœ€è¦å…³è”æŸ¥è¯¢
}
```

#### å®é™…æ•°æ®åº“secondary_salesè¡¨
```javascript
{
  id: 1,
  sales_code: 'SEC123',
  wechat_name: 'sales001',
  commission_rate: 0.25,
  sales_type: 'primary',
  // ç¼ºå°‘ç»Ÿè®¡å­—æ®µï¼Œéœ€è¦é€šè¿‡ordersè¡¨å®æ—¶è®¡ç®—
}
```

---

## ğŸ” å…·ä½“é¡µé¢é—®é¢˜åˆ†æ

### ä¸€çº§é”€å”®å¯¹è´¦é¡µé¢
**æœŸæœ›æ•°æ®ç»“æ„**ï¼š
```javascript
{
  direct_orders: 5,           // ç›´é”€è®¢å•æ•°
  direct_amount: 500,         // ç›´é”€é‡‘é¢
  direct_commission: 200,     // ç›´é”€ä½£é‡‘
  secondary_orders: 10,       // äºŒçº§è®¢å•æ•°
  secondary_amount: 1000,     // äºŒçº§è®¢å•é‡‘é¢
  distribution_profit: 150,   // åˆ†é”€æ”¶ç›Š
  total_commission: 350       // æ€»ä½£é‡‘
}
```

**é—®é¢˜**ï¼šè¿™äº›å­—æ®µå…¨éƒ¨éœ€è¦å®æ—¶è®¡ç®—ï¼Œæ•°æ®åº“æ²¡æœ‰å­˜å‚¨

### äºŒçº§é”€å”®å¯¹è´¦é¡µé¢
**é—®é¢˜**ï¼š
1. æœç´¢åŠŸèƒ½ä¾èµ–`sales_code`ï¼Œä½†ç”¨æˆ·è¾“å…¥çš„æ˜¯å¾®ä¿¡å·
2. ä½£é‡‘è®¡ç®—éœ€è¦å…³è”ordersè¡¨
3. ç»Ÿè®¡æ•°æ®å…¨éƒ¨éœ€è¦å®æ—¶è®¡ç®—

---

## ğŸš¨ ä¸¥é‡é—®é¢˜

### 1. è¡¨ä¸å­˜åœ¨é—®é¢˜
```javascript
// supabase.jsä¸­çš„ä»£ç 
static async getPrimarySales() {
  const { data, error } = await supabase
    .from('primary_sales')  // âŒ æ­¤è¡¨ä¸å­˜åœ¨ï¼
    .select('*');
}
```
**å½±å“**ï¼šæ‰€æœ‰è°ƒç”¨`getPrimarySales()`çš„åŠŸèƒ½éƒ½ä¼šå¤±è´¥

### 2. æˆªå›¾æ•°æ®ä¸¢å¤±
- å‰ç«¯å‘é€`screenshot_data`
- æ•°æ®åº“å­—æ®µ`screenshot_data`å…¨æ˜¯NULL
- å¯èƒ½æ˜¯base64æ•°æ®å¤ªå¤§ï¼Œä¿å­˜å¤±è´¥

### 3. ç»Ÿè®¡æ€§èƒ½é—®é¢˜
- æ¯æ¬¡æŸ¥è¯¢éƒ½éœ€è¦å®æ—¶è®¡ç®—ç»Ÿè®¡æ•°æ®
- æ²¡æœ‰ç¼“å­˜æœºåˆ¶
- å¤§é‡æ•°æ®æ—¶ä¼šå¾ˆæ…¢

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆå»ºè®®

### 1. åˆ›å»ºç»Ÿè®¡è§†å›¾
```sql
-- åˆ›å»ºé”€å”®ç»Ÿè®¡è§†å›¾
CREATE OR REPLACE VIEW sales_statistics AS
SELECT 
  s.id,
  s.sales_code,
  s.wechat_name,
  s.sales_type,
  s.commission_rate,
  COUNT(DISTINCT o.id) as total_orders,
  COUNT(DISTINCT CASE WHEN o.config_confirmed THEN o.id END) as valid_orders,
  COALESCE(SUM(o.amount), 0) as total_amount,
  COALESCE(SUM(CASE WHEN o.config_confirmed THEN o.amount ELSE 0 END), 0) as confirmed_amount
FROM secondary_sales s
LEFT JOIN orders o ON o.sales_code = s.sales_code AND o.status != 'rejected'
GROUP BY s.id, s.sales_code, s.wechat_name, s.sales_type, s.commission_rate;
```

### 2. ä¿®å¤APIè°ƒç”¨
```javascript
// ä¿®æ”¹æ‰€æœ‰primary_saleså¼•ç”¨
static async getSalesByType(type) {
  const { data, error } = await supabase
    .from('secondary_sales')  // ä½¿ç”¨æ­£ç¡®çš„è¡¨å
    .select(`
      *,
      orders:orders(count)
    `)
    .eq('sales_type', type);
  
  // å¤„ç†ç»Ÿè®¡æ•°æ®
  return data.map(sale => ({
    ...sale,
    total_orders: sale.orders?.length || 0
  }));
}
```

### 3. ä¼˜åŒ–æˆªå›¾å­˜å‚¨
```javascript
// æ”¹ç”¨æ–‡ä»¶å­˜å‚¨è€Œébase64
const uploadScreenshot = async (file) => {
  const { data, error } = await supabase.storage
    .from('screenshots')
    .upload(`orders/${Date.now()}_${file.name}`, file);
  
  if (error) throw error;
  return data.path;  // å­˜å‚¨è·¯å¾„è€Œébase64
};
```

---

## ğŸ“‹ å¾…ä¿®å¤æ¸…å•

### é«˜ä¼˜å…ˆçº§
1. âš ï¸ ä¿®å¤`primary_sales`è¡¨ä¸å­˜åœ¨çš„é—®é¢˜
2. âš ï¸ è§£å†³æˆªå›¾æ•°æ®æ— æ³•ä¿å­˜çš„é—®é¢˜
3. âš ï¸ åˆ›å»ºç»Ÿè®¡è§†å›¾æå‡æ€§èƒ½

### ä¸­ä¼˜å…ˆçº§
1. ğŸ“Œ ç§»é™¤`link_code`å†—ä½™å­—æ®µ
2. ğŸ“Œ æ·»åŠ `registration_code`å­—æ®µæ”¯æŒ
3. ğŸ“Œ ä¼˜åŒ–ç»Ÿè®¡æŸ¥è¯¢é€»è¾‘

### ä½ä¼˜å…ˆçº§
1. æ¸…ç†åºŸå¼ƒçš„æ”¯ä»˜å®ç›¸å…³ä»£ç 
2. ç»Ÿä¸€é”€å”®ç±»å‹çš„å¤„ç†é€»è¾‘
3. æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶

---

## ğŸ“Š å½±å“èŒƒå›´è¯„ä¼°

| åŠŸèƒ½æ¨¡å— | å½±å“ç¨‹åº¦ | å½“å‰çŠ¶æ€ | è¯´æ˜ |
|---------|---------|---------|------|
| ä¸€çº§é”€å”®åŠŸèƒ½ | ğŸ”´ ä¸¥é‡ | éƒ¨åˆ†å¤±æ•ˆ | primary_salesè¡¨ä¸å­˜åœ¨ |
| è®¢å•ç»Ÿè®¡ | ğŸŸ¡ ä¸­ç­‰ | æ€§èƒ½å·® | éœ€è¦å®æ—¶è®¡ç®— |
| æˆªå›¾ä¸Šä¼  | ğŸ”´ ä¸¥é‡ | å¤±æ•ˆ | æ•°æ®æœªä¿å­˜ |
| äºŒçº§é”€å”®æ³¨å†Œ | ğŸŸ¡ ä¸­ç­‰ | å¯ç”¨ | ç¼ºå°‘registration_code |
| ä½£é‡‘è®¡ç®— | ğŸŸ¢ è½»å¾® | æ­£å¸¸ | é€»è¾‘æ­£ç¡® |

---

## ğŸ¯ ç»“è®º

1. **å‰ç«¯é€»è¾‘åŸºæœ¬æ­£ç¡®**ï¼Œä½†ä¾èµ–çš„æ•°æ®ç»“æ„ä¸æ•°æ®åº“ä¸åŒ¹é…
2. **ä¸»è¦é—®é¢˜æ˜¯ç»Ÿè®¡å­—æ®µç¼ºå¤±**ï¼Œå¯¼è‡´å¤§é‡å®æ—¶è®¡ç®—
3. **è¡¨åä¸ä¸€è‡´æ˜¯æœ€ä¸¥é‡çš„é—®é¢˜**ï¼Œä¼šå¯¼è‡´åŠŸèƒ½å¤±æ•ˆ
4. **å»ºè®®ä¼˜å…ˆä¿®å¤è¡¨åé—®é¢˜**ï¼Œç„¶åä¼˜åŒ–ç»Ÿè®¡æ€§èƒ½

---

*åˆ†æå®Œæˆæ—¶é—´ï¼š2025-08-13 å‡Œæ™¨3:15*
*æé†’ï¼šæ—©ä¸Š8ç‚¹åéœ€è¦å¤„ç†è¿™äº›é—®é¢˜*