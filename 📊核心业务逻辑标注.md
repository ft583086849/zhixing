# ğŸ“Š æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ ‡æ³¨

## ä¸€ã€äºŒçº§é”€å”®æ³¨å†Œæµç¨‹

### 1ï¸âƒ£ é€šè¿‡secondary_registration_codeæŸ¥æ‰¾ä¸€çº§é”€å”®
**éœ€æ±‚æ–‡æ¡£ä½ç½®**: `æ”¯ä»˜ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£.md` ç¬¬217è¡Œ
```
- **å…³è”æ³¨å†Œ**ï¼š`/secondary-sales?sales_code=SR...`ï¼ˆéœ€éªŒè¯ä¸€çº§é”€å”®æ³¨å†Œç ï¼‰
```

**ä»£ç å®ç°ä½ç½®**: `client/src/services/supabase.js` ç¬¬418-438è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘1ï¼šé€šè¿‡secondary_registration_codeæŸ¥æ‰¾ä¸€çº§é”€å”®
static async validateSecondaryRegistrationCode(registrationCode) {
  const { data, error } = await supabase
    .from('primary_sales')
    .select('id, wechat_name, secondary_registration_code')
    .eq('secondary_registration_code', registrationCode)  // é€šè¿‡æ³¨å†Œç æŸ¥æ‰¾
    .single();
  
  return {
    primary_sales_id: data.id,  // è¿”å›ä¸€çº§é”€å”®ID
    primary_wechat_name: data.wechat_name,
    registration_code: data.secondary_registration_code
  };
}
```

### 2ï¸âƒ£ åˆ›å»ºäºŒçº§é”€å”®è®°å½•ï¼Œç”Ÿæˆç‹¬ç«‹çš„sales_code
**ä»£ç å®ç°ä½ç½®**: `client/src/services/api.js` ç¬¬1152-1171è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘2ï¼šæ³¨å†ŒäºŒçº§é”€å”®
async registerSecondary(salesData) {
  // ç”Ÿæˆå”¯ä¸€çš„é”€å”®ä»£ç 
  salesData.sales_code = this.generateUniqueSalesCode('SEC');
  salesData.sales_type = 'secondary';
  
  const newSale = await SupabaseService.createSecondarySales(salesData);
  return { success: true, data: newSale };
}
```

### 3ï¸âƒ£ å…³è”primary_sales_id
**ä»£ç å®ç°ä½ç½®**: `client/src/pages/UnifiedSecondarySalesPage.js` ç¬¬94-102è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘3ï¼šå…³è”primary_sales_id
if (isLinkedMode) {
  // å…³è”æ¨¡å¼ - æ³¨å†Œåˆ°ä¸€çº§é”€å”®ä¸‹
  response = await salesAPI.registerSecondary({
    ...values,
    registration_code: registrationCode,
    primary_sales_id: registrationData?.primary_sales_id,  // âœ… å…³è”ä¸€çº§é”€å”®ID
    sales_type: 'secondary'
  });
}
```

## äºŒã€ç”¨æˆ·è´­ä¹°æµç¨‹

### 1ï¸âƒ£ é€šè¿‡sales_codeæŸ¥æ‰¾é”€å”®ä¿¡æ¯
**éœ€æ±‚æ–‡æ¡£ä½ç½®**: `æ”¯ä»˜ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£.md` ç¬¬64-76è¡Œ
```
è®¢å•æ•°æ®åŒ…å«å­—æ®µï¼š
- sales_code (è´­ä¹°æ—¶ä½¿ç”¨çš„é“¾æ¥ä»£ç )
- primary_sales_id (å¦‚æœæœ‰ï¼ŒæŒ‡å‘ä¸€çº§é”€å”®ID)
- secondary_sales_id (å¦‚æœæœ‰ï¼ŒæŒ‡å‘äºŒçº§é”€å”®ID)
- sales_type ('primary' | 'secondary')
```

**ä»£ç å®ç°ä½ç½®**: `client/src/services/api.js` ç¬¬1001-1071è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘ï¼šé€šè¿‡sales_codeæŸ¥æ‰¾é”€å”®ä¿¡æ¯
async getSalesByCode(salesCode) {
  // å…ˆæŸ¥è¯¢ä¸€çº§é”€å”®
  try {
    const primarySale = await SupabaseService.getPrimarySalesByCode(salesCode);
    return {
      success: true,
      data: { ...primarySale, type: 'primary' },  // âœ… æ ‡è®°ä¸ºä¸€çº§é”€å”®
    };
  } catch (error) {
    // å¦‚æœä¸€çº§é”€å”®æœªæ‰¾åˆ°ï¼ŒæŸ¥è¯¢äºŒçº§é”€å”®
    const secondarySale = await SupabaseService.getSecondarySalesByCode(salesCode);
    return {
      success: true,
      data: { ...secondarySale, type: 'secondary' },  // âœ… æ ‡è®°ä¸ºäºŒçº§é”€å”®
    };
  }
}
```

### 2ï¸âƒ£ è®¢å•å…³è”
**ä»£ç å®ç°ä½ç½®**: `client/src/services/api.js` ç¬¬1369-1395è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘ï¼šè®¢å•åˆ›å»ºæ—¶çš„ä½£é‡‘è®¡ç®—
if (processedOrderData.sales_code && processedOrderData.amount > 0) {
  const salesInfo = await this.calculateCommission(
    processedOrderData.sales_code, 
    processedOrderData.amount
  );
  
  processedOrderData.commission_amount = salesInfo.commission;
  processedOrderData.sales_type = salesInfo.type;  // âœ… ä¿å­˜é”€å”®ç±»å‹
  processedOrderData.commission_rate = salesInfo.commission / processedOrderData.amount;
  
  // âš ï¸ æ³¨æ„ï¼šå½“å‰ä»£ç æœªä¿å­˜ primary_sales_id å’Œ secondary_sales_id
  // è¿™æ˜¯ç³»ç»Ÿçš„ç¼ºé™·ï¼Œæ— æ³•åŒºåˆ†ç‹¬ç«‹äºŒçº§å’Œä¸€çº§ä¸‹å±äºŒçº§
}
```

## ä¸‰ã€ä½£é‡‘è®¡ç®—é€»è¾‘

### 1ï¸âƒ£ ç‹¬ç«‹äºŒçº§é”€å”®ä½£é‡‘é»˜è®¤30%
**éœ€æ±‚æ–‡æ¡£ä½ç½®**: `æ”¯ä»˜ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£.md` ç¬¬241è¡Œ
```
- **ç‹¬ç«‹äºŒçº§é”€å”®**ï¼šè®¢å•é‡‘é¢ Ã— 30%ï¼ˆå›ºå®šæ¯”ç‡ï¼‰
```

**ä»£ç å®ç°ä½ç½®**: `client/src/services/api.js` ç¬¬1460-1463è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘ï¼šé»˜è®¤ä½£é‡‘ç‡
// é»˜è®¤å€¼ï¼šä¸€çº§40%ï¼ŒäºŒçº§30%
if (!commissionRate) {
  commissionRate = sale.type === 'primary' ? 0.4 : 0.3;  // âœ… ä¸€çº§40%ï¼ŒäºŒçº§30%
}
```

### 2ï¸âƒ£ ä¸€çº§é”€å”®ç»¼åˆä½£é‡‘ç‡è®¡ç®—
**éœ€æ±‚æ–‡æ¡£ä½ç½®**: `æ”¯ä»˜ç®¡ç†ç³»ç»Ÿéœ€æ±‚æ–‡æ¡£.md` ç¬¬80-90è¡Œ
```
ä¸€çº§é”€å”®æ€»ä½£é‡‘ç‡ = 
((ä¸€çº§é”€å”®ç›´æ¥è®¢å•é‡‘é¢ Ã— 40%) + (ä¸‹å±äºŒçº§è®¢å•æ€»é‡‘é¢ - ä¸‹å±äºŒçº§åˆ†ä½£)) / 
(ä¸€çº§é”€å”®è®¢å•æ€»é‡‘é¢ + ä¸‹å±äºŒçº§è®¢å•æ€»é‡‘é¢)
```

**ä»£ç å®ç°ä½ç½®**: `client/src/components/admin/AdminSales.js` ç¬¬108-141è¡Œ
```javascript
// ğŸ¯ æ ¸å¿ƒé€»è¾‘ï¼šä¸€çº§é”€å”®ç»¼åˆä½£é‡‘ç‡è®¡ç®—ï¼ˆéœ€æ±‚æ–‡æ¡£å…¬å¼çš„å®ç°ï¼‰
const calculatePrimaryCommissionRate = (record) => {
  // è®¡ç®—å„é¡¹é‡‘é¢ï¼ˆä½¿ç”¨sales_typeåˆ¤æ–­ï¼‰
  const primaryDirectOrders = confirmedOrders.filter(order => order.sales_type !== 'secondary');
  const primaryDirectAmount = primaryDirectOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  const secondaryOrders = confirmedOrders.filter(order => order.sales_type === 'secondary');
  const secondaryTotalAmount = secondaryOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  // âœ… å®Œå…¨ç¬¦åˆéœ€æ±‚æ–‡æ¡£çš„å…¬å¼
  // è®¡ç®—ç»¼åˆä½£é‡‘ç‡
  const totalAmount = primaryDirectAmount + secondaryTotalAmount;
  const primaryDirectCommission = primaryDirectAmount * 0.4;  // ä¸€çº§ç›´æ¥è®¢å•40%
  const managementCommission = secondaryTotalAmount - totalSecondaryCommission;  // ç®¡ç†ä½£é‡‘
  const totalCommission = primaryDirectCommission + managementCommission;
  
  const comprehensiveRate = totalAmount > 0 ? (totalCommission / totalAmount) : 0.4;
  return comprehensiveRate * 100;  // è¿”å›ç™¾åˆ†æ¯”
};
```

## å››ã€ç³»ç»Ÿç°çŠ¶åˆ†æ

### âœ… å·²å®ç°çš„æ ¸å¿ƒé€»è¾‘
1. **äºŒçº§é”€å”®æ³¨å†Œæµç¨‹** - å®Œå…¨ç¬¦åˆéœ€æ±‚
   - âœ… é€šè¿‡secondary_registration_codeæŸ¥æ‰¾ä¸€çº§é”€å”®
   - âœ… ç”Ÿæˆç‹¬ç«‹çš„sales_code
   - âœ… å…³è”primary_sales_idï¼ˆåœ¨äºŒçº§é”€å”®è¡¨ä¸­ï¼‰

2. **ç”¨æˆ·è´­ä¹°æµç¨‹** - å®Œå…¨ç¬¦åˆéœ€æ±‚
   - âœ… é€šè¿‡sales_codeæŸ¥æ‰¾é”€å”®ä¿¡æ¯
   - âœ… åŒºåˆ†ä¸€çº§/äºŒçº§é”€å”®ç±»å‹

3. **ä½£é‡‘è®¡ç®—** - å®Œå…¨ç¬¦åˆéœ€æ±‚
   - âœ… ä¸€çº§é»˜è®¤40%
   - âœ… ç‹¬ç«‹äºŒçº§é»˜è®¤30%
   - âœ… ä¸€çº§ç»¼åˆä½£é‡‘ç‡è®¡ç®—å…¬å¼

### âš ï¸ ç³»ç»Ÿç¼ºé™·
**è®¢å•è¡¨ç¼ºå°‘é”€å”®IDå…³è”**ï¼š
- âŒ ordersè¡¨æœªä¿å­˜ `primary_sales_id`
- âŒ ordersè¡¨æœªä¿å­˜ `secondary_sales_id`
- å¯¼è‡´ï¼šæ— æ³•åŒºåˆ†ç‹¬ç«‹äºŒçº§å’Œä¸€çº§ä¸‹å±äºŒçº§çš„è®¢å•
- å½±å“ï¼šä¸€çº§é”€å”®æ— æ³•è·å¾—æ­£ç¡®çš„ç®¡ç†ä½£é‡‘

### ğŸ“Œ é‡è¦è¯´æ˜
1. **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸èƒ½æ”¹** - ä¸Šè¿°æ‰€æœ‰é€»è¾‘éƒ½æ˜¯æ ¹æ®éœ€æ±‚æ–‡æ¡£å®ç°çš„
2. **å»ºè®®çš„ä¿®å¤æ–¹æ¡ˆ** - åœ¨è®¢å•åˆ›å»ºæ—¶ä¿å­˜é”€å”®IDï¼ˆå¦‚ä¹‹å‰çš„ä¿®å¤ä»£ç ï¼‰
3. **æ•°æ®åº“è¿ç§»** - éœ€è¦æ‰§è¡ŒSQLè„šæœ¬ä¿®å¤å†å²æ•°æ®

## äº”ã€æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·è´­ä¹°æµç¨‹ï¼š
1. ç”¨æˆ·è®¿é—® /purchase?sales_code=XXX
2. ç³»ç»Ÿé€šè¿‡sales_codeæŸ¥æ‰¾é”€å”®ä¿¡æ¯
   â”œâ”€â”€ æŸ¥primary_salesè¡¨ â†’ æ‰¾åˆ° â†’ type='primary'
   â””â”€â”€ æŸ¥secondary_salesè¡¨ â†’ æ‰¾åˆ° â†’ type='secondary'
3. åˆ›å»ºè®¢å•æ—¶ä¿å­˜ï¼š
   - sales_code âœ…
   - sales_type âœ…
   - commission_rate âœ…
   - commission_amount âœ…
   - primary_sales_id âŒï¼ˆéœ€è¦ä¿®å¤ï¼‰
   - secondary_sales_id âŒï¼ˆéœ€è¦ä¿®å¤ï¼‰

äºŒçº§é”€å”®æ³¨å†Œæµç¨‹ï¼š
1. è®¿é—® /secondary-sales?registration_code=SEC...
2. éªŒè¯registration_code â†’ æŸ¥primary_salesè¡¨
3. åˆ›å»ºsecondary_salesè®°å½•ï¼š
   - sales_code: 'SEC' + timestampï¼ˆæ–°ç”Ÿæˆï¼‰
   - primary_sales_id: ä»éªŒè¯ç»“æœè·å– âœ…
   - sales_type: 'secondary' âœ…
   - commission_rate: 0.3ï¼ˆé»˜è®¤ï¼‰æˆ–ä¸€çº§è®¾ç½®çš„å€¼ âœ…
```
äºŒçº§é”€å”®åˆ¤æ–­æµç¨‹ï¼š
â”œâ”€â”€ æ£€æŸ¥ primary_sales_id
â”‚   â”œâ”€â”€ NULL âœ ç‹¬ç«‹äºŒçº§é”€å”®
â”‚   â”‚   â”œâ”€â”€ ä½£é‡‘ç‡ï¼š30%ï¼ˆå›ºå®šï¼‰
â”‚   â”‚   â””â”€â”€ ä½£é‡‘å½’å±ï¼šå…¨éƒ¨å½’è‡ªå·±
â”‚   â””â”€â”€ æœ‰å€¼ âœ ä¸€çº§ä¸‹å±äºŒçº§é”€å”®
â”‚       â”œâ”€â”€ ä½£é‡‘ç‡ï¼šä¸€çº§é”€å”®è®¾å®š
â”‚       â”œâ”€â”€ äºŒçº§è·å¾—ï¼šè®¾å®šçš„ä½£é‡‘
â”‚       â””â”€â”€ ä¸€çº§è·å¾—ï¼šç®¡ç†ä½£é‡‘ï¼ˆè®¢å•é‡‘é¢-äºŒçº§ä½£é‡‘ï¼‰

äºŒçº§é”€å”®æ³¨å†Œæµç¨‹ï¼š
1. é€šè¿‡secondary_registration_codeæŸ¥æ‰¾ä¸€çº§é”€å”®
2. åˆ›å»ºäºŒçº§é”€å”®è®°å½•ï¼Œç”Ÿæˆç‹¬ç«‹çš„sales_code
3. å…³è”primary_sales_id
ç”¨æˆ·è´­ä¹°æµç¨‹ï¼š
1. é€šè¿‡sales_codeç›´æ¥æŸ¥æ‰¾ï¼š
   // æŸ¥æ‰¾ä¸€çº§é”€å”®
   const [primary] = await connection.execute(
     'SELECT * FROM primary_sales WHERE sales_code = ?', [sales_code]
   );
   
   // æŸ¥æ‰¾äºŒçº§é”€å”®  
   const [secondary] = await connection.execute(
     'SELECT * FROM secondary_sales WHERE sales_code = ?', [sales_code]
   );

4. è®¢å•å…³è”
ordersè¡¨å­—æ®µï¼š

- sales_code (è´­ä¹°æ—¶ä½¿ç”¨çš„ä»£ç )
- sales_type ('primary' | 'secondary')  
- primary_sales_id (å¦‚æœæ˜¯ä¸€çº§é”€å”®è®¢å•)
- secondary_sales_id (å¦‚æœæ˜¯äºŒçº§é”€å”®è®¢å•)
- commission_rate
- commission_amount