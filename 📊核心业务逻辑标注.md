# 📊 核心业务逻辑标注

## 一、二级销售注册流程

### 1️⃣ 通过secondary_registration_code查找一级销售
**需求文档位置**: `支付管理系统需求文档.md` 第217行
```
- **关联注册**：`/secondary-sales?sales_code=SR...`（需验证一级销售注册码）
```

**代码实现位置**: `client/src/services/supabase.js` 第418-438行
```javascript
// 🎯 核心逻辑1：通过secondary_registration_code查找一级销售
static async validateSecondaryRegistrationCode(registrationCode) {
  const { data, error } = await supabase
    .from('primary_sales')
    .select('id, wechat_name, secondary_registration_code')
    .eq('secondary_registration_code', registrationCode)  // 通过注册码查找
    .single();
  
  return {
    primary_sales_id: data.id,  // 返回一级销售ID
    primary_wechat_name: data.wechat_name,
    registration_code: data.secondary_registration_code
  };
}
```

### 2️⃣ 创建二级销售记录，生成独立的sales_code
**代码实现位置**: `client/src/services/api.js` 第1152-1171行
```javascript
// 🎯 核心逻辑2：注册二级销售
async registerSecondary(salesData) {
  // 生成唯一的销售代码
  salesData.sales_code = this.generateUniqueSalesCode('SEC');
  salesData.sales_type = 'secondary';
  
  const newSale = await SupabaseService.createSecondarySales(salesData);
  return { success: true, data: newSale };
}
```

### 3️⃣ 关联primary_sales_id
**代码实现位置**: `client/src/pages/UnifiedSecondarySalesPage.js` 第94-102行
```javascript
// 🎯 核心逻辑3：关联primary_sales_id
if (isLinkedMode) {
  // 关联模式 - 注册到一级销售下
  response = await salesAPI.registerSecondary({
    ...values,
    registration_code: registrationCode,
    primary_sales_id: registrationData?.primary_sales_id,  // ✅ 关联一级销售ID
    sales_type: 'secondary'
  });
}
```

## 二、用户购买流程

### 1️⃣ 通过sales_code查找销售信息
**需求文档位置**: `支付管理系统需求文档.md` 第64-76行
```
订单数据包含字段：
- sales_code (购买时使用的链接代码)
- primary_sales_id (如果有，指向一级销售ID)
- secondary_sales_id (如果有，指向二级销售ID)
- sales_type ('primary' | 'secondary')
```

**代码实现位置**: `client/src/services/api.js` 第1001-1071行
```javascript
// 🎯 核心逻辑：通过sales_code查找销售信息
async getSalesByCode(salesCode) {
  // 先查询一级销售
  try {
    const primarySale = await SupabaseService.getPrimarySalesByCode(salesCode);
    return {
      success: true,
      data: { ...primarySale, type: 'primary' },  // ✅ 标记为一级销售
    };
  } catch (error) {
    // 如果一级销售未找到，查询二级销售
    const secondarySale = await SupabaseService.getSecondarySalesByCode(salesCode);
    return {
      success: true,
      data: { ...secondarySale, type: 'secondary' },  // ✅ 标记为二级销售
    };
  }
}
```

### 2️⃣ 订单关联
**代码实现位置**: `client/src/services/api.js` 第1369-1395行
```javascript
// 🎯 核心逻辑：订单创建时的佣金计算
if (processedOrderData.sales_code && processedOrderData.amount > 0) {
  const salesInfo = await this.calculateCommission(
    processedOrderData.sales_code, 
    processedOrderData.amount
  );
  
  processedOrderData.commission_amount = salesInfo.commission;
  processedOrderData.sales_type = salesInfo.type;  // ✅ 保存销售类型
  processedOrderData.commission_rate = salesInfo.commission / processedOrderData.amount;
  
  // ⚠️ 注意：当前代码未保存 primary_sales_id 和 secondary_sales_id
  // 这是系统的缺陷，无法区分独立二级和一级下属二级
}
```

## 三、佣金计算逻辑

### 1️⃣ 独立二级销售佣金默认30%
**需求文档位置**: `支付管理系统需求文档.md` 第241行
```
- **独立二级销售**：订单金额 × 30%（固定比率）
```

**代码实现位置**: `client/src/services/api.js` 第1460-1463行
```javascript
// 🎯 核心逻辑：默认佣金率
// 默认值：一级40%，二级30%
if (!commissionRate) {
  commissionRate = sale.type === 'primary' ? 0.4 : 0.3;  // ✅ 一级40%，二级30%
}
```

### 2️⃣ 一级销售综合佣金率计算
**需求文档位置**: `支付管理系统需求文档.md` 第80-90行
```
一级销售总佣金率 = 
((一级销售直接订单金额 × 40%) + (下属二级订单总金额 - 下属二级分佣)) / 
(一级销售订单总金额 + 下属二级订单总金额)
```

**代码实现位置**: `client/src/components/admin/AdminSales.js` 第108-141行
```javascript
// 🎯 核心逻辑：一级销售综合佣金率计算（需求文档公式的实现）
const calculatePrimaryCommissionRate = (record) => {
  // 计算各项金额（使用sales_type判断）
  const primaryDirectOrders = confirmedOrders.filter(order => order.sales_type !== 'secondary');
  const primaryDirectAmount = primaryDirectOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  const secondaryOrders = confirmedOrders.filter(order => order.sales_type === 'secondary');
  const secondaryTotalAmount = secondaryOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  // ✅ 完全符合需求文档的公式
  // 计算综合佣金率
  const totalAmount = primaryDirectAmount + secondaryTotalAmount;
  const primaryDirectCommission = primaryDirectAmount * 0.4;  // 一级直接订单40%
  const managementCommission = secondaryTotalAmount - totalSecondaryCommission;  // 管理佣金
  const totalCommission = primaryDirectCommission + managementCommission;
  
  const comprehensiveRate = totalAmount > 0 ? (totalCommission / totalAmount) : 0.4;
  return comprehensiveRate * 100;  // 返回百分比
};
```

## 四、系统现状分析

### ✅ 已实现的核心逻辑
1. **二级销售注册流程** - 完全符合需求
   - ✅ 通过secondary_registration_code查找一级销售
   - ✅ 生成独立的sales_code
   - ✅ 关联primary_sales_id（在二级销售表中）

2. **用户购买流程** - 完全符合需求
   - ✅ 通过sales_code查找销售信息
   - ✅ 区分一级/二级销售类型

3. **佣金计算** - 完全符合需求
   - ✅ 一级默认40%
   - ✅ 独立二级默认30%
   - ✅ 一级综合佣金率计算公式

### ⚠️ 系统缺陷
**订单表缺少销售ID关联**：
- ❌ orders表未保存 `primary_sales_id`
- ❌ orders表未保存 `secondary_sales_id`
- 导致：无法区分独立二级和一级下属二级的订单
- 影响：一级销售无法获得正确的管理佣金

### 📌 重要说明
1. **核心业务逻辑不能改** - 上述所有逻辑都是根据需求文档实现的
2. **建议的修复方案** - 在订单创建时保存销售ID（如之前的修复代码）
3. **数据库迁移** - 需要执行SQL脚本修复历史数据

## 五、数据流程图

```
用户购买流程：
1. 用户访问 /purchase?sales_code=XXX
2. 系统通过sales_code查找销售信息
   ├── 查primary_sales表 → 找到 → type='primary'
   └── 查secondary_sales表 → 找到 → type='secondary'
3. 创建订单时保存：
   - sales_code ✅
   - sales_type ✅
   - commission_rate ✅
   - commission_amount ✅
   - primary_sales_id ❌（需要修复）
   - secondary_sales_id ❌（需要修复）

二级销售注册流程：
1. 访问 /secondary-sales?registration_code=SEC...
2. 验证registration_code → 查primary_sales表
3. 创建secondary_sales记录：
   - sales_code: 'SEC' + timestamp（新生成）
   - primary_sales_id: 从验证结果获取 ✅
   - sales_type: 'secondary' ✅
   - commission_rate: 0.3（默认）或一级设置的值 ✅
```
二级销售判断流程：
├── 检查 primary_sales_id
│   ├── NULL ➜ 独立二级销售
│   │   ├── 佣金率：30%（固定）
│   │   └── 佣金归属：全部归自己
│   └── 有值 ➜ 一级下属二级销售
│       ├── 佣金率：一级销售设定
│       ├── 二级获得：设定的佣金
│       └── 一级获得：管理佣金（订单金额-二级佣金）

二级销售注册流程：
1. 通过secondary_registration_code查找一级销售
2. 创建二级销售记录，生成独立的sales_code
3. 关联primary_sales_id
用户购买流程：
1. 通过sales_code直接查找：
   // 查找一级销售
   const [primary] = await connection.execute(
     'SELECT * FROM primary_sales WHERE sales_code = ?', [sales_code]
   );
   
   // 查找二级销售  
   const [secondary] = await connection.execute(
     'SELECT * FROM secondary_sales WHERE sales_code = ?', [sales_code]
   );

4. 订单关联
orders表字段：

- sales_code (购买时使用的代码)
- sales_type ('primary' | 'secondary')  
- primary_sales_id (如果是一级销售订单)
- secondary_sales_id (如果是二级销售订单)
- commission_rate
- commission_amount