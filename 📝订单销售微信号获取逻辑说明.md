# 订单表销售微信号获取逻辑说明

## 数据流程

### 1. 数据库表结构

#### orders 表（订单表）
- `sales_code` - 购买时使用的销售代码
- `primary_sales_id` - 一级销售ID（如果是一级销售的订单）
- `secondary_sales_id` - 二级销售ID（如果是二级销售的订单）
- `sales_type` - 销售类型（'primary' | 'secondary'）

#### primary_sales 表（一级销售表）
- `id` - 销售ID
- `sales_code` - 销售代码
- `wechat_name` - 销售微信号 ✅ **这是微信号的来源**
- `name` - 收款人姓名（仅支付宝收款时使用）
- `phone` - 手机号

#### secondary_sales 表（二级销售表）
- `id` - 销售ID
- `sales_code` - 销售代码
- `wechat_name` - 销售微信号 ✅ **这是微信号的来源**
- `name` - 收款人姓名（仅支付宝收款时使用）
- `phone` - 手机号
- `primary_sales_id` - 关联的一级销售ID

## 2. 获取逻辑（在 supabase.js 中）

### 关联优先级（第395-418行）：

1. **优先级1**: 通过 `primary_sales_id` 关联
   ```javascript
   if (order.primary_sales_id) {
     从 primary_sales 表查找 id = order.primary_sales_id
     获取 wechat_name 字段
   }
   ```

2. **优先级2**: 通过 `secondary_sales_id` 关联
   ```javascript
   if (order.secondary_sales_id) {
     从 secondary_sales 表查找 id = order.secondary_sales_id
     获取 wechat_name 字段
   }
   ```

3. **优先级3**: 通过 `sales_code` 匹配一级销售
   ```javascript
   if (order.sales_code) {
     从 primary_sales 表查找 sales_code = order.sales_code
     获取 wechat_name 字段
   }
   ```

4. **优先级4**: 通过 `sales_code` 匹配二级销售
   ```javascript
   if (order.sales_code) {
     从 secondary_sales 表查找 sales_code = order.sales_code
     获取 wechat_name 字段
   }
   ```

### 3. 最终设置（第430行）：
```javascript
// 将查询到的销售微信号设置到订单对象上
order.sales_wechat_name = salesInfo.wechat_name;
```

## 4. 前端显示

订单管理页面会显示 `order.sales_wechat_name` 字段，这个值就是从销售表的 `wechat_name` 字段获取的。

## 5. 示例数据流

```
用户购买 → 订单创建
↓
订单表存储: sales_code = "PS_175450317913"
↓
系统查询: 
1. 查询 primary_sales 表 WHERE sales_code = "PS_175450317913"
2. 找到记录，获取 wechat_name = "销售微信号"
↓
订单对象增强:
order.sales_wechat_name = "销售微信号"
↓
前端显示: 销售微信号
```

## 总结

- **来源表**: `primary_sales` 或 `secondary_sales`
- **来源字段**: `wechat_name`
- **关联方式**: 通过 `sales_code` 或 `sales_id`
- **最终字段**: `order.sales_wechat_name`（运行时动态添加，不存储在数据库）

