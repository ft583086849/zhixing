# ğŸ“Š è®¢å•ä½£é‡‘è®¡ç®—é€»è¾‘å®Œæ•´åˆ†æ

## ğŸ” å½“å‰ä½£é‡‘è®¡ç®—æµç¨‹

### 1. è®¢å•åˆ›å»ºæ—¶çš„ä½£é‡‘è®¡ç®—ï¼ˆOrdersAPI.createï¼‰
ä½ç½®ï¼š`client/src/services/api.js` è¡Œ2093-2099

```javascript
// è®¡ç®—ä½£é‡‘ï¼ˆåŸºäºé”€å”®ä»£ç ï¼‰
if (processedOrderData.sales_code && processedOrderData.amount > 0) {
  try {
    const salesInfo = await this.calculateCommission(processedOrderData.sales_code, processedOrderData.amount);
    processedOrderData.commission_amount = salesInfo.commission;
    processedOrderData.sales_type = salesInfo.type;
    processedOrderData.commission_rate = salesInfo.commission / processedOrderData.amount;
  } catch (error) {
    // é”™è¯¯å¤„ç†...
  }
}
```

### 2. calculateCommissionå‡½æ•°é€»è¾‘
ä½ç½®ï¼š`client/src/services/api.js` è¡Œ2180-2217

```javascript
async calculateCommission(salesCode, amount) {
  // 1. æ ¹æ®é”€å”®ä»£ç è·å–é”€å”®ä¿¡æ¯
  const salesResult = await SalesAPI.getSalesByCode(salesCode);
  const sale = salesResult.data;
  
  // 2. å¤„ç†ä½£é‡‘ç‡
  let commissionRate = sale.commission_rate;
  
  // å…¼å®¹æ€§å¤„ç†ï¼ˆå°†ç™¾åˆ†æ¯”è½¬ä¸ºå°æ•°ï¼‰
  if (commissionRate > 1) {
    commissionRate = commissionRate / 100;
  }
  
  // 3. é»˜è®¤å€¼è®¾ç½®
  if (!commissionRate) {
    commissionRate = sale.type === 'primary' ? 0.4 : 0.25;  // ä¸€çº§40%ï¼ŒäºŒçº§25%
  }
  
  // 4. è®¡ç®—ä½£é‡‘
  const commission = parseFloat(amount) * commissionRate;
  
  // 5. è¿”å›ç»“æœ
  return {
    commission,
    type: sale.type,
    rate: commissionRate,
    salesId: sale.id,
    primarySalesId: sale.type === 'primary' ? sale.id : (sale.primary_sales_id || null),
    secondarySalesId: sale.type === 'secondary' ? sale.id : null
  };
}
```

## âŒ å‘ç°çš„é—®é¢˜

### é—®é¢˜1ï¼šä½£é‡‘ç‡å­˜å‚¨æ ¼å¼ä¸ä¸€è‡´
- **æ•°æ®åº“ä¸­**ï¼šå¯èƒ½å­˜å‚¨çš„æ˜¯40ï¼ˆç™¾åˆ†æ¯”ï¼‰æˆ–0.4ï¼ˆå°æ•°ï¼‰
- **è®¡ç®—æ—¶**ï¼šæœŸæœ›æ˜¯å°æ•°æ ¼å¼ï¼ˆ0.4ï¼‰

### é—®é¢˜2ï¼šå…¼å®¹æ€§å¤„ç†é€»è¾‘å¯èƒ½æœ‰è¯¯
```javascript
if (commissionRate > 1) {
  commissionRate = commissionRate / 100;
}
```
è¿™ä¸ªé€»è¾‘å‡è®¾ï¼š
- å¦‚æœå€¼ > 1ï¼Œè®¤ä¸ºæ˜¯ç™¾åˆ†æ¯”ï¼ˆå¦‚40ï¼‰ï¼Œè½¬æ¢ä¸º0.4
- ä½†å¦‚æœæ•°æ®åº“å­˜å‚¨çš„æ˜¯15ï¼ˆè€Œä¸æ˜¯0.15ï¼‰ï¼Œä¼šè¢«è½¬æ¢ä¸º0.15

### é—®é¢˜3ï¼šgetSalesByCodeå¯èƒ½è¿”å›é”™è¯¯çš„é”€å”®ä¿¡æ¯
å¦‚æœsales_codeåœ¨ä¸€çº§å’ŒäºŒçº§é”€å”®è¡¨ä¸­éƒ½å­˜åœ¨ï¼Œå¯èƒ½è¿”å›é”™è¯¯çš„è®°å½•ã€‚

## ğŸ¯ WML792355703è®¢å•é—®é¢˜åˆ†æ

### ç°è±¡
- è®¢å•é‡‘é¢ï¼š$188
- æœŸæœ›ä½£é‡‘ï¼ˆ40%ï¼‰ï¼š$75.2
- å®é™…ä½£é‡‘ï¼šÂ¥28.2ï¼ˆç›¸å½“äº15%ï¼‰

### å¯èƒ½åŸå› 

#### åŸå› Aï¼šæ•°æ®åº“ä¸­ä½£é‡‘ç‡æ˜¯15è€Œä¸æ˜¯0.15
å¦‚æœWML792355703åœ¨primary_salesè¡¨ä¸­çš„commission_rate = 15ï¼š
- å…¼å®¹æ€§å¤„ç†ï¼š15 > 1ï¼Œæ‰€ä»¥ 15 / 100 = 0.15
- è®¡ç®—ä½£é‡‘ï¼š188 Ã— 0.15 = 28.2 âœ…

#### åŸå› Bï¼šä½£é‡‘ç‡å­—æ®µå€¼ä¸ºç©ºæˆ–å¼‚å¸¸
å¦‚æœcommission_rateä¸ºnullæˆ–undefinedï¼š
- ä½¿ç”¨é»˜è®¤å€¼ï¼š0.4ï¼ˆ40%ï¼‰
- ä½†è¿™åº”è¯¥å¾—åˆ°75.2ï¼Œä¸ç¬¦åˆç°è±¡

#### åŸå› Cï¼šgetSalesByCodeè¿”å›äº†é”™è¯¯çš„é”€å”®è®°å½•
å¯èƒ½è¿”å›äº†å¦ä¸€ä¸ªä½£é‡‘ç‡ä¸º15%çš„é”€å”®è®°å½•ã€‚

## ğŸ“ éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥WML792355703çš„å®é™…ä½£é‡‘ç‡
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
const { data: primarySale } = await window.supabase
  .from('primary_sales')
  .select('*')
  .eq('sales_code', 'WML792355703')
  .single();

console.log('ä¸€çº§é”€å”®ä¿¡æ¯:');
console.log('- é”€å”®ä»£ç :', primarySale.sales_code);
console.log('- ä½£é‡‘ç‡å­—æ®µå€¼:', primarySale.commission_rate);
console.log('- ä½£é‡‘ç‡ç±»å‹:', typeof primarySale.commission_rate);

// æ¨¡æ‹Ÿè®¡ç®—é€»è¾‘
let rate = primarySale.commission_rate;
if (rate > 1) {
  rate = rate / 100;
  console.log('- è½¬æ¢åä½£é‡‘ç‡:', rate);
}
console.log('- æœ€ç»ˆä½£é‡‘ç‡:', rate);
console.log('- 188ç¾å…ƒçš„ä½£é‡‘:', 188 * rate);
```

### 2. æ£€æŸ¥è®¢å•27çš„è¯¦ç»†ä¿¡æ¯
```javascript
const { data: order } = await window.supabase
  .from('orders')
  .select('*')
  .eq('id', 27)
  .single();

console.log('è®¢å•ä¿¡æ¯:');
console.log('- ä½£é‡‘ç‡:', order.commission_rate);
console.log('- ä½£é‡‘é‡‘é¢:', order.commission_amount);
```

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šç»Ÿä¸€ä½£é‡‘ç‡å­˜å‚¨æ ¼å¼
å°†æ‰€æœ‰ä½£é‡‘ç‡ç»Ÿä¸€å­˜å‚¨ä¸ºå°æ•°æ ¼å¼ï¼ˆ0.xxï¼‰ï¼š
```sql
-- ä¿®å¤primary_salesè¡¨
UPDATE primary_sales 
SET commission_rate = 
  CASE 
    WHEN commission_rate > 1 THEN commission_rate / 100
    ELSE commission_rate
  END
WHERE commission_rate > 1;

-- ä¿®å¤secondary_salesè¡¨
UPDATE secondary_sales 
SET commission_rate = 
  CASE 
    WHEN commission_rate > 1 THEN commission_rate / 100
    ELSE commission_rate
  END
WHERE commission_rate > 1;
```

### æ–¹æ¡ˆ2ï¼šä¿®æ”¹å…¼å®¹æ€§å¤„ç†é€»è¾‘
```javascript
// æ›´ä¸¥æ ¼çš„åˆ¤æ–­
if (commissionRate >= 1 && commissionRate <= 100) {
  // 1-100ä¹‹é—´è®¤ä¸ºæ˜¯ç™¾åˆ†æ¯”
  commissionRate = commissionRate / 100;
} else if (commissionRate > 100) {
  // å¤§äº100è®¤ä¸ºæ˜¯é”™è¯¯æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤å€¼
  commissionRate = sale.type === 'primary' ? 0.4 : 0.25;
}
```

### æ–¹æ¡ˆ3ï¼šä¿®å¤ç‰¹å®šè®¢å•
```sql
-- ä¿®å¤è®¢å•27
UPDATE orders 
SET 
  commission_rate = 0.4,
  commission_amount = 75.2
WHERE id = 27;

-- ä¿®å¤WML792355703çš„ä½£é‡‘ç‡
UPDATE primary_sales 
SET commission_rate = 0.4
WHERE sales_code = 'WML792355703';
```

