# 佣金率历史管理方案

## 一、需求分析

### 问题描述
- 当前佣金率修改会影响所有历史订单的佣金计算
- 例如：销售16号是40%，19号改为25%
  - 16-19号的订单应按40%计算
  - 19号之后的订单应按25%计算

### 需求
1. 记录佣金率变更历史
2. 按订单创建时间使用对应时期的佣金率
3. 支持一级、二级、独立销售

## 二、数据库设计

### 1. 新建佣金率历史表

```sql
CREATE TABLE commission_rate_history (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  sales_code VARCHAR(50) NOT NULL,
  sales_type VARCHAR(20), -- primary/secondary/independent
  old_rate DECIMAL(5,4), -- 旧佣金率
  new_rate DECIMAL(5,4) NOT NULL, -- 新佣金率
  effective_date TIMESTAMP NOT NULL, -- 生效时间
  changed_by VARCHAR(100), -- 修改人
  change_reason TEXT, -- 修改原因
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- 索引
  INDEX idx_sales_code_date (sales_code, effective_date DESC),
  INDEX idx_effective_date (effective_date)
);
```

### 2. 修改现有表

```sql
-- sales_optimized表保持当前佣金率
-- 但计算历史订单时要查commission_rate_history表

-- orders_optimized表已有created_at字段，用于确定使用哪个佣金率
```

## 三、实现逻辑

### 1. 修改佣金率时

```javascript
// 更新佣金率时同时记录历史
async function updateCommissionRate(salesId, newRate, changedBy) {
  // 1. 获取当前佣金率
  const currentRate = await getCurrentRate(salesId);
  
  // 2. 记录到历史表
  await supabase.from('commission_rate_history').insert({
    sales_code: salesCode,
    old_rate: currentRate,
    new_rate: newRate,
    effective_date: new Date(),
    changed_by: changedBy
  });
  
  // 3. 更新当前佣金率
  await supabase.from('sales_optimized').update({
    commission_rate: newRate
  });
  
  // 4. 只重新计算生效日期之后的订单佣金
  await recalculateFutureCommissions(salesId, effectiveDate);
}
```

### 2. 计算订单佣金时

```javascript
// 根据订单时间获取对应的佣金率
async function getCommissionRateAtTime(salesCode, orderDate) {
  // 查找订单时间对应的佣金率
  const { data } = await supabase
    .from('commission_rate_history')
    .select('new_rate')
    .eq('sales_code', salesCode)
    .lte('effective_date', orderDate)
    .order('effective_date', { ascending: false })
    .limit(1)
    .single();
    
  return data?.new_rate || getDefaultRate(salesType);
}

// 计算订单佣金
async function calculateOrderCommission(order) {
  const rate = await getCommissionRateAtTime(
    order.sales_code, 
    order.created_at
  );
  return order.amount * rate;
}
```

### 3. 显示历史记录

在销售管理页面添加"佣金率历史"按钮，点击显示：

| 生效时间 | 旧佣金率 | 新佣金率 | 修改人 | 原因 |
|---------|---------|---------|-------|------|
| 2025-01-19 | 40% | 25% | 管理员 | 业绩调整 |
| 2025-01-16 | 25% | 40% | 管理员 | 激励政策 |

## 四、实施步骤

### 第一步：创建历史表
```sql
CREATE TABLE commission_rate_history (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  sales_code VARCHAR(50) NOT NULL,
  sales_type VARCHAR(20),
  old_rate DECIMAL(5,4),
  new_rate DECIMAL(5,4) NOT NULL,
  effective_date TIMESTAMP NOT NULL DEFAULT NOW(),
  changed_by VARCHAR(100),
  change_reason TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_commission_history_sales ON commission_rate_history(sales_code, effective_date DESC);
```

### 第二步：初始化历史数据
将当前所有销售的佣金率作为初始记录插入历史表

### 第三步：修改API
1. updateSalesCommission添加历史记录
2. 计算佣金时查询历史表

### 第四步：更新前端
1. 添加生效日期选择器
2. 显示佣金率历史记录

## 五、注意事项

1. **不可追溯修改**：佣金率变更只影响未来订单，不改变历史订单的佣金
2. **审计追踪**：所有变更都有记录，便于审计
3. **批量处理**：如果需要追溯调整，需要单独的批量处理功能
4. **报表统计**：统计报表需要考虑不同时期的佣金率

## 六、优势

1. **准确性**：每笔订单都按当时的佣金率计算
2. **可追溯**：完整的变更历史
3. **灵活性**：支持未来调整而不影响历史
4. **合规性**：符合财务管理要求

---
*创建时间：2025-01-18*