# 📋 v2.8.0 部署清单（最新版）

## ⚠️ 部署前必须执行

### Supabase SQL 执行顺序：

1. **第一步**：创建基础表
```sql
-- 执行文件：🔧创建收益分配记录表.sql
```

2. **第二步**：更新字段
```sql
-- 执行文件：🔧更新收益分配字段.sql
```

3. **第三步**：更新佣金率
```sql
-- 执行文件：🔧修改二级销售默认佣金率为25%.sql
```

## 🚀 更新内容

### 1. ✅ 待付款确认订单统计优化
- **文件**：`client/src/services/api.js`
- **修改内容**：
  - 7天免费订单不计入"待付款确认订单"
  - 7天免费订单直接计入"待配置确认订单"

### 2. ✅ 资金统计收益分配增强
- **文件**：`client/src/components/admin/AdminFinance.js`
- **新增功能**：
  - ✨ 新增"总实付金额"列（在营利金额前）
  - ✨ 分配金额按总实付金额计算（而非营利金额）
  - ✨ 公户下添加三个子项：
    - 营销费用（10%）
    - 分红（15%）
    - 开发费用（15%）
  - ✨ 子项可独立调整，自动更新公户总比例

### 3. ✅ 二级销售佣金率文档更新
- **文件**：
  - `一级销售对账页面过滤逻辑说明.md`
  - `生产环境操作手册.md`
- **修改内容**：默认佣金率从30%改为25%

## 📊 资金统计表格新结构

### 列顺序（从左到右）：
1. **总实付金额**（新增，基准金额）
2. **营利金额**（扣除佣金后）
3. **分配对象**
4. **收益占比**
5. **分配金额**

### 分配对象层级：
```
🏢 公户 (40%)
  ├─ 营销费用 (10%)
  ├─ 分红 (15%)
  └─ 开发费用 (15%)
📚 知行 (35%)
👤 子俊 (25%)
```

### 计算逻辑变化：

**修改前**：
```javascript
分配金额 = 营利金额 × 收益占比
```

**修改后**：
```javascript
分配金额 = 总实付金额 × 收益占比
```

## 🔧 技术细节

### 1. 订单统计逻辑
```javascript
// 待付款确认（排除7天免费）
const pending_payment_orders = ordersToProcess.filter(order => 
  ['pending_payment', 'pending', 'pending_review'].includes(order.status) &&
  order.duration !== '7days'
).length;

// 待配置确认（包含7天免费）
const pending_config_orders = ordersToProcess.filter(order => 
  ['pending_config', 'confirmed_payment'].includes(order.status) ||
  (order.duration === '7days' && ['pending', 'pending_payment'].includes(order.status))
).length;
```

### 2. 收益分配数据结构
```javascript
profitRatios = {
  public: 40,        // 公户总占比（自动计算）
  marketing: 10,     // 营销费用
  dividend: 15,      // 分红
  development: 15,   // 开发费用
  zhixing: 35,       // 知行
  zijun: 25         // 子俊
}
```

## 📝 验证清单

### 订单统计验证：
- [ ] 创建7天免费订单
  - [ ] ❌ 不显示在"待付款确认订单"统计中
  - [ ] ✅ 显示在"待配置确认订单"统计中
- [ ] 创建付费订单
  - [ ] ✅ 正常显示在"待付款确认订单"统计中
  - [ ] ✅ 付款后进入"待配置确认订单"

### 资金统计验证：
- [ ] 总实付金额列显示正确
- [ ] 营利金额列显示正确
- [ ] 公户子项显示正确：
  - [ ] 营销费用10%
  - [ ] 分红15%
  - [ ] 开发费用15%
- [ ] 修改子项比例后，公户总比例自动更新
- [ ] 分配金额基于总实付金额计算

### 佣金率验证：
- [ ] 新创建的二级销售佣金率为25%
- [ ] waterli_1313显示为25%

## 🌐 测试链接

- 管理员仪表板：https://zhixing-seven.vercel.app/admin/dashboard
- 资金统计：https://zhixing-seven.vercel.app/admin/finance
- 订单管理：https://zhixing-seven.vercel.app/admin/orders
- 销售管理：https://zhixing-seven.vercel.app/admin/sales

## 📅 部署步骤

1. **执行 SQL（Supabase）**
   - 先执行创建表 SQL
   - 再执行更新字段 SQL
   - 最后执行佣金率 SQL

2. **部署代码（Git Push）**
   - 运行 `./deploy-v2.8.0.sh`
   - 等待 Vercel 自动部署

3. **验证功能**
   - 按照验证清单逐项测试
   - 确认所有功能正常

## ⚡ 预计时间

- SQL 执行：2分钟
- 代码部署：3-5分钟（Vercel 自动部署）
- 功能验证：5-10分钟

---

**版本号**：v2.8.0
**更新时间**：2025-01-07
**负责人**：系统管理员
**状态**：待部署

## 📌 重要提醒

1. **必须先执行 SQL 脚本**，否则前端会报错
2. **公户子项比例**可以独立调整，但总和应该等于公户总比例
3. **分配金额计算**现在基于总实付金额，不是营利金额
