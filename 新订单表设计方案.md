# 🎯 新订单表设计方案

## 表名：orders_optimized

### 📋 基础信息字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| id | BIGSERIAL | 主键ID | PRIMARY | ✅ |
| order_number | VARCHAR(50) | 订单号 | UNIQUE | ✅ |
| created_at | TIMESTAMPTZ | 创建时间 | INDEX | ✅ |
| updated_at | TIMESTAMPTZ | 更新时间 | INDEX | ✅ |

### 👤 客户信息字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| customer_name | VARCHAR(100) | 客户姓名 | INDEX | ✅ |
| customer_phone | VARCHAR(20) | 客户电话 | INDEX | ❌ |
| customer_email | VARCHAR(100) | 客户邮箱 | INDEX | ❌ |
| customer_wechat | VARCHAR(50) | 客户微信 | INDEX | ❌ |
| tradingview_username | VARCHAR(50) | TradingView用户名 | INDEX | ❌ |

### 💰 金额和支付字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| amount | DECIMAL(10,2) | 订单金额 | INDEX | ✅ |
| actual_payment_amount | DECIMAL(10,2) | 实际支付金额 | INDEX | ❌ |
| alipay_amount | DECIMAL(10,2) | 支付宝金额 | ❌ | ❌ |
| crypto_amount | DECIMAL(10,2) | 加密货币金额 | ❌ | ❌ |
| payment_method | VARCHAR(20) | 支付方式 | INDEX | ❌ |
| payment_status | VARCHAR(20) | 支付状态 | INDEX | ✅ |
| payment_time | TIMESTAMPTZ | 支付时间 | INDEX | ❌ |

### 📦 产品和订单字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| duration | VARCHAR(20) | 订单时长 | INDEX | ✅ |
| purchase_type | VARCHAR(20) | 购买类型 | INDEX | ❌ |
| status | VARCHAR(20) | 订单状态 | INDEX | ✅ |
| config_confirmed | BOOLEAN | 配置确认 | INDEX | ❌ |
| effective_time | TIMESTAMPTZ | 生效时间 | INDEX | ❌ |
| expiry_time | TIMESTAMPTZ | 过期时间 | INDEX | ❌ |
| submit_time | TIMESTAMPTZ | 提交时间 | INDEX | ❌ |

### 👥 销售关联字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| sales_code | VARCHAR(50) | 销售代码 | INDEX | ❌ |
| sales_type | VARCHAR(20) | 销售类型 | INDEX | ❌ |
| primary_sales_id | BIGINT | 一级销售ID | INDEX | ❌ |
| secondary_sales_id | BIGINT | 二级销售ID | INDEX | ❌ |
| commission_amount | DECIMAL(10,2) | 佣金金额 | INDEX | ❌ |
| commission_rate | DECIMAL(5,4) | 佣金比率 | ❌ | ❌ |
| link_code | VARCHAR(50) | 推广链接代码 | INDEX | ❌ |

### 📎 附件和截图字段
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| screenshot_path | VARCHAR(255) | 截图路径 | ❌ | ❌ |
| screenshot_data | TEXT | 截图数据 | ❌ | ❌ |

### 🚀 性能优化字段（新增）
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| search_keywords | TEXT | 搜索关键词 | FULLTEXT | ❌ |
| data_version | INTEGER | 数据版本 | ❌ | ❌ |
| is_deleted | BOOLEAN | 软删除标记 | INDEX | ❌ |

### 🎯 未来扩展字段（为注册系统预留）
| 字段名 | 类型 | 描述 | 索引 | 必填 |
|--------|------|------|------|------|
| customer_id | BIGINT | 客户ID（外键） | INDEX | ❌ |
| source_channel | VARCHAR(50) | 来源渠道 | INDEX | ❌ |
| referrer_code | VARCHAR(50) | 推荐人代码 | INDEX | ❌ |
| campaign_id | VARCHAR(50) | 营销活动ID | INDEX | ❌ |
| device_info | JSONB | 设备信息 | ❌ | ❌ |
| geo_location | JSONB | 地理位置 | ❌ | ❌ |
| risk_score | INTEGER | 风险评分 | INDEX | ❌ |
| tags | JSONB | 标签数组 | GIN | ❌ |

## 🔍 复合索引设计

### 核心查询索引
```sql
-- 订单列表查询（最常用）
CREATE INDEX idx_orders_list ON orders_optimized (payment_status, created_at DESC);

-- 销售相关查询
CREATE INDEX idx_orders_sales ON orders_optimized (sales_type, primary_sales_id, secondary_sales_id);

-- 时间范围查询
CREATE INDEX idx_orders_time_range ON orders_optimized (created_at, payment_time, effective_time);

-- 客户查询
CREATE INDEX idx_orders_customer ON orders_optimized (customer_name, customer_phone, customer_wechat);

-- 状态和配置查询
CREATE INDEX idx_orders_status ON orders_optimized (status, config_confirmed, is_deleted);

-- 金额查询
CREATE INDEX idx_orders_amount ON orders_optimized (amount, actual_payment_amount);
```

### 高级查询索引
```sql
-- 销售业绩查询
CREATE INDEX idx_orders_performance ON orders_optimized (sales_type, payment_status, amount, commission_amount);

-- 产品分析查询
CREATE INDEX idx_orders_product ON orders_optimized (duration, purchase_type, payment_status);

-- 搜索优化
CREATE INDEX idx_orders_search ON orders_optimized USING GIN (search_keywords);

-- 标签查询
CREATE INDEX idx_orders_tags ON orders_optimized USING GIN (tags);
```

## 📊 预期性能提升

| 查询类型 | 当前耗时 | 预期耗时 | 提升倍数 |
|----------|----------|----------|----------|
| 全部订单 | 1536ms | <50ms | 30x |
| 状态筛选 | 1362ms | <30ms | 45x |
| 销售筛选 | 852ms | <20ms | 42x |
| 客户搜索 | >1000ms | <15ms | 60x |

## 🎯 优势总结

1. **性能优化**：
   - 添加了30+个索引，覆盖所有常用查询
   - 复合索引优化组合查询
   - 全文搜索支持

2. **兼容性设计**：
   - 保留所有原有字段
   - 预留未来注册系统字段
   - 支持软删除和版本控制

3. **可扩展性**：
   - JSONB字段支持灵活数据
   - 标签系统支持分类
   - 设备和地理信息支持

4. **数据完整性**：
   - 合理的字段类型和长度
   - 必要的约束和索引
   - 时间戳自动更新