# 📱 用户注册与销售体系改革方案

> 创建时间：2024-12-19
> 版本：v1.0
> 状态：待实施

## 一、核心需求概述

### 1.1 用户系统
- 所有用户必须注册才能购买
- 登录方式：微信名 + 密码
- 存量用户后续迁移

### 1.2 销售体系变革
- 用户付费后可选择成为销售
- 不同来源的销售有不同返佣比例
- 支持多级销售体系

## 二、用户注册登录设计

### 2.1 数据库设计
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  wechat_name VARCHAR(100) UNIQUE NOT NULL,  -- 唯一微信名
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  last_login_at TIMESTAMP,
  is_sales BOOLEAN DEFAULT FALSE,  -- 是否是销售
  sales_type VARCHAR(20),  -- 'primary', 'secondary', 'independent_secondary'
  parent_sales_id INTEGER,  -- 上级销售ID
  commission_rate DECIMAL(5,2),  -- 个人返佣率
  payment_qr_code TEXT,  -- 收款码
  payment_info TEXT,  -- 收款信息
  sales_code VARCHAR(50),  -- 销售代码（成为销售后生成）
  enabled BOOLEAN DEFAULT TRUE,  -- 账号状态
  need_reset_password BOOLEAN DEFAULT FALSE  -- 存量用户标记
);

-- 索引
CREATE INDEX idx_users_wechat ON users(wechat_name);
CREATE INDEX idx_users_sales ON users(is_sales, sales_type);
CREATE INDEX idx_users_sales_code ON users(sales_code);
```

### 2.2 注册流程
```javascript
// 注册接口
POST /api/auth/register
{
  wechat_name: "用户微信名",
  password: "密码",
  confirm_password: "确认密码",
  referral_code: "推荐人销售代码"  // 可选
}

// 登录接口
POST /api/auth/login
{
  wechat_name: "微信名",
  password: "密码"
}
```

## 三、销售转化体系

### 3.1 返佣规则矩阵

| 销售类型 | 来源 | 默认返佣 | 可调整范围 | 调整权限 |
|---------|------|---------|-----------|----------|
| 一级销售 | 管理员指定 | 40% | 30-50% | 管理员 |
| 二级销售(一级下级) | 一级客户转化 | 25% | 20-35% | 管理员/一级 |
| 独立销售 | 自主注册 | 25% | 20-35% | 管理员 |
| 独立二级 | 独立销售客户转化 | 10% | 5-15% | 管理员/独立销售 |

### 3.2 用户转销售流程

#### 场景1：一级销售的客户转化
1. 用户通过一级销售链接注册
2. 购买产品时选择"成为销售"
3. 填写收款信息（收款码、收款地址）
4. 付款确认后自动成为二级销售
5. 获得专属销售链接
6. 默认25%返佣

#### 场景2：独立销售的客户转化
1. 用户购买7天免费试用
2. 选填收款信息
3. 选择成为销售
4. 成为独立销售的二级
5. 默认10%返佣

### 3.3 链接策略
```javascript
// 链接类型
const LINK_TYPES = {
  PURCHASE_ONLY: 'purchase',      // 仅购买
  PURCHASE_WITH_SALES: 'recruit', // 可成为销售
  TRIAL_ONLY: 'trial',           // 仅试用
  TRIAL_WITH_SALES: 'trial_recruit' // 试用+可成为销售
};

// 链接格式示例
/purchase?code=PRI001&type=recruit  // 一级销售分销链接
/purchase?code=IND001&type=purchase // 独立销售纯购买链接
```

## 四、数据库预留字段

### 4.1 orders表扩展
```sql
ALTER TABLE orders ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE orders ADD COLUMN customer_became_sales BOOLEAN DEFAULT FALSE;
ALTER TABLE orders ADD COLUMN sales_conversion_date TIMESTAMP;
ALTER TABLE orders ADD COLUMN link_type VARCHAR(20);  -- 链接类型
```

### 4.2 customers表扩展
```sql
ALTER TABLE customers ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE customers ADD COLUMN is_sales BOOLEAN DEFAULT FALSE;
ALTER TABLE customers ADD COLUMN payment_qr_code TEXT;
ALTER TABLE customers ADD COLUMN payment_address TEXT;
ALTER TABLE customers ADD COLUMN became_sales_at TIMESTAMP;
ALTER TABLE customers ADD COLUMN sales_link VARCHAR(255);
ALTER TABLE customers ADD COLUMN parent_sales_type VARCHAR(20);
```

### 4.3 销售表扩展
```sql
-- primary_sales表
ALTER TABLE primary_sales ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE primary_sales ADD COLUMN allow_recruit BOOLEAN DEFAULT TRUE;  -- 是否允许下级招募

-- secondary_sales表
ALTER TABLE secondary_sales ADD COLUMN user_id INTEGER REFERENCES users(id);
ALTER TABLE secondary_sales ADD COLUMN source_type VARCHAR(50); -- 'direct', 'customer_upgrade'
ALTER TABLE secondary_sales ADD COLUMN converted_from_order_id INTEGER;  -- 转化来源订单
```

## 五、页面设计

### 5.1 新增页面

#### 注册页面 `/register`
- 微信名输入
- 密码设置
- 确认密码
- 推荐码（自动填充）
- 注册协议

#### 登录页面 `/login`
- 微信名
- 密码
- 记住我
- 忘记密码链接

#### 个人中心 `/user/profile`
- 基本信息展示
- 密码修改
- 订单历史
- 【销售专属】返佣记录
- 【销售专属】推广链接管理
- 【销售专属】下级销售列表
- 【销售专属】收款信息管理

#### 成为销售 `/become-sales`
- 销售政策说明
- 返佣规则介绍
- 收款信息填写
- 服务协议确认

### 5.2 现有页面改造

#### 购买页面改造
```javascript
// 新增字段
{
  become_sales: false,  // 是否成为销售
  payment_qr_code: '',  // 收款码
  payment_address: '',  // 收款地址
  show_sales_option: true  // 是否显示成为销售选项
}
```

## 六、安全机制

### 6.1 防刷单
- 同IP每日注册限制：5个
- 微信名唯一性验证
- 订单人机验证
- 异常行为监控

### 6.2 返佣安全
1. 禁止自购自销
2. 防止循环返佣
3. 订单审核机制
4. 返佣延迟发放

## 七、数据迁移

### 7.1 存量销售迁移
```sql
-- 为现有一级销售创建账号
INSERT INTO users (wechat_name, password_hash, is_sales, sales_type, sales_code, need_reset_password)
SELECT 
  wechat_name,
  MD5(CONCAT(wechat_name, '_temp_', RANDOM()::TEXT)),
  true,
  'primary',
  sales_code,
  true
FROM primary_sales;

-- 为现有二级销售创建账号
INSERT INTO users (wechat_name, password_hash, is_sales, sales_type, sales_code, parent_sales_id, need_reset_password)
SELECT 
  s.wechat_name,
  MD5(CONCAT(s.wechat_name, '_temp_', RANDOM()::TEXT)),
  true,
  CASE 
    WHEN s.primary_sales_id IS NOT NULL THEN 'secondary'
    ELSE 'independent'
  END,
  s.sales_code,
  u.id,
  true
FROM secondary_sales s
LEFT JOIN users u ON u.sales_code = (
  SELECT sales_code FROM primary_sales WHERE id = s.primary_sales_id
);
```

### 7.2 存量客户处理
- 暂不强制要求注册
- 提供激励引导注册
- 保留原有购买流程作为过渡

## 八、实施计划

### Phase 1 - MVP版本（第1周）
1. 用户表设计和API
2. 注册/登录页面
3. Session管理
4. 基础权限控制

### Phase 2 - 核心功能（第2周）
1. 购买流程改造
2. 成为销售功能
3. 销售链接生成
4. 个人中心页面

### Phase 3 - 完善优化（第3周）
1. 数据迁移脚本
2. 管理后台升级
3. 统计报表扩展
4. 性能优化

## 九、统计指标

### 9.1 新增指标
- 注册转化率
- 用户转销售率
- 各级销售活跃度
- 返佣ROI分析
- 销售裂变系数

### 9.2 报表需求
- 用户增长报表
- 销售转化漏斗
- 返佣效率分析
- 异常监控报表

## 十、注意事项

1. **向后兼容**：保证现有业务不受影响
2. **渐进上线**：分阶段推进，降低风险
3. **数据安全**：密码加密，敏感信息保护
4. **性能考虑**：用户量增长后的扩展性
5. **用户体验**：简化注册流程，降低门槛

---
*文档创建：2024-12-19*
*最后更新：2024-12-19*
*状态：待讨论确认*