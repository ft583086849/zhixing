# 📊 数据库完整优化方案 - 基于未来规划

> 创建时间：2025-08-15
> 核心理念：每个表都有完整数据，避免实时计算和关联查询
> 未来规划：用户系统 + 多角色（购买者可成为销售）

---

## 一、🎯 未来业务模型理解

### 用户角色流转：
```
普通用户(注册) → 购买产品(成为客户) → 申请成为销售 → 获得销售资格
                                      ↓
                            继续作为客户购买(给原销售返佣)
```

### 关键点：
1. **一个人可以有多重身份**：既是客户，又是销售
2. **销售关系永久绑定**：即使客户成为销售，其购买仍给原销售返佣
3. **需要账号系统**：用户名、密码、登录

---

## 二、📊 完整表结构设计

### 1️⃣ users表 - 用户账号表（新建）
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  
  -- 账号信息
  username VARCHAR(50) UNIQUE NOT NULL,              -- 用户名（登录用）
  password_hash VARCHAR(255) NOT NULL,               -- 密码哈希
  email VARCHAR(100) UNIQUE,                         -- 邮箱
  phone VARCHAR(20),                                 -- 手机号
  
  -- 基本信息
  wechat_name VARCHAR(100) UNIQUE NOT NULL,          -- 微信号（唯一标识）
  real_name VARCHAR(100),                            -- 真实姓名
  tradingview_username VARCHAR(100),                 -- TradingView用户名
  
  -- 角色信息（一个人可以多个角色）
  is_customer BOOLEAN DEFAULT false,                 -- 是否是客户
  is_sales BOOLEAN DEFAULT false,                    -- 是否是销售
  is_admin BOOLEAN DEFAULT false,                    -- 是否是管理员
  
  -- 状态
  status VARCHAR(20) DEFAULT 'active',               -- 账号状态
  last_login_time TIMESTAMP,                         -- 最后登录时间
  
  -- 预留字段
  extra_field1 VARCHAR(255),
  extra_field2 VARCHAR(255),
  extra_json JSONB,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_wechat ON users(wechat_name);
```

### 2️⃣ customers表 - 客户信息表（新建）
```sql
CREATE TABLE customers (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),              -- 关联用户表
  
  -- 客户基本信息（冗余存储，避免关联查询）
  customer_wechat VARCHAR(100) UNIQUE NOT NULL,      -- 客户微信
  customer_name VARCHAR(100),                        -- 客户姓名
  tradingview_username VARCHAR(100),                 -- TV用户名
  customer_phone VARCHAR(20),                        -- 电话
  customer_email VARCHAR(100),                       -- 邮箱
  
  -- 归属销售信息（冗余存储，永久绑定）
  bound_sales_id INTEGER,                            -- 绑定的销售ID
  bound_sales_code VARCHAR(50),                      -- 绑定的销售代码
  bound_sales_wechat VARCHAR(100),                   -- 绑定的销售微信
  bound_sales_type VARCHAR(20),                      -- 绑定时的销售类型
  bound_primary_sales_id INTEGER,                    -- 绑定的一级销售ID
  bound_primary_sales_wechat VARCHAR(100),           -- 绑定的一级销售微信
  binding_time TIMESTAMP,                            -- 绑定时间
  
  -- 统计信息（定期更新，不用实时计算）
  total_orders INTEGER DEFAULT 0,                    -- 总订单数
  paid_orders INTEGER DEFAULT 0,                     -- 已付款订单数
  total_amount DECIMAL(10,2) DEFAULT 0,              -- 总消费金额
  total_commission_generated DECIMAL(10,2) DEFAULT 0, -- 产生的总佣金
  first_order_time TIMESTAMP,                        -- 首单时间
  last_order_time TIMESTAMP,                         -- 最后下单时间
  
  -- 客户状态
  customer_status VARCHAR(20) DEFAULT 'active',      -- 客户状态
  customer_level VARCHAR(20) DEFAULT 'normal',       -- 客户等级(normal/vip/svip)
  has_free_trial BOOLEAN DEFAULT false,              -- 是否已使用免费试用
  
  -- 成为销售的信息（如果客户申请成为销售）
  apply_sales_time TIMESTAMP,                        -- 申请成为销售时间
  become_sales_time TIMESTAMP,                       -- 成为销售时间
  sales_id INTEGER,                                  -- 对应的销售ID（如果成为销售）
  
  -- 预留字段
  extra_field1 VARCHAR(255),
  extra_field2 VARCHAR(255),
  extra_field3 TEXT,
  extra_json JSONB,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_customers_user_id ON customers(user_id);
CREATE INDEX idx_customers_wechat ON customers(customer_wechat);
CREATE INDEX idx_customers_sales ON customers(bound_sales_id);
```

### 3️⃣ sales表 - 销售信息表（替代secondary_sales）
```sql
CREATE TABLE sales (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),              -- 关联用户表
  
  -- 销售基本信息（冗余存储）
  sales_code VARCHAR(50) UNIQUE NOT NULL,            -- 销售代码
  sales_wechat VARCHAR(100) UNIQUE NOT NULL,         -- 销售微信
  sales_name VARCHAR(100),                           -- 销售姓名
  sales_phone VARCHAR(20),                           -- 销售电话
  sales_email VARCHAR(100),                          -- 销售邮箱
  
  -- 销售类型和层级
  sales_type VARCHAR(20) NOT NULL,                   -- primary/secondary/independent
  sales_level INTEGER DEFAULT 1,                     -- 销售等级(1/2/3...)
  
  -- 上级信息（冗余存储）
  parent_sales_id INTEGER,                           -- 上级销售ID
  parent_sales_code VARCHAR(50),                     -- 上级销售代码
  parent_sales_wechat VARCHAR(100),                  -- 上级销售微信
  primary_sales_id INTEGER,                          -- 一级销售ID（如果是二级）
  primary_sales_code VARCHAR(50),                    -- 一级销售代码
  primary_sales_wechat VARCHAR(100),                 -- 一级销售微信
  
  -- 收款信息
  payment_method VARCHAR(20) DEFAULT 'crypto',       -- 收款方式
  payment_address TEXT,                              -- 收款地址
  chain_name VARCHAR(50),                            -- 链名
  payment_qrcode TEXT,                               -- 收款二维码
  
  -- 佣金设置
  commission_rate DECIMAL(5,4) DEFAULT 0.25,         -- 佣金率(0.25=25%)
  special_commission_rate DECIMAL(5,4),              -- 特殊佣金率
  
  -- 统计信息（定期更新，不用实时计算）
  total_orders INTEGER DEFAULT 0,                    -- 总订单数
  paid_orders INTEGER DEFAULT 0,                     -- 已付款订单数
  total_revenue DECIMAL(10,2) DEFAULT 0,             -- 总销售额
  total_commission DECIMAL(10,2) DEFAULT 0,          -- 总佣金
  paid_commission DECIMAL(10,2) DEFAULT 0,           -- 已付佣金
  pending_commission DECIMAL(10,2) DEFAULT 0,        -- 待付佣金
  
  -- 下级统计（定期更新）
  direct_subordinates INTEGER DEFAULT 0,             -- 直接下级数量
  total_subordinates INTEGER DEFAULT 0,              -- 总下级数量
  team_total_revenue DECIMAL(10,2) DEFAULT 0,        -- 团队总销售额
  
  -- 时间记录
  last_order_time TIMESTAMP,                         -- 最后出单时间
  last_commission_paid_time TIMESTAMP,               -- 最后付佣时间
  
  -- 状态
  sales_status VARCHAR(20) DEFAULT 'active',         -- 销售状态
  
  -- 来源（这个销售是从哪个客户转化来的）
  from_customer_id INTEGER,                          -- 来源客户ID
  from_customer_wechat VARCHAR(100),                 -- 来源客户微信
  
  -- 预留字段
  extra_field1 VARCHAR(255),
  extra_field2 VARCHAR(255),
  extra_field3 TEXT,
  extra_json JSONB,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_sales_user_id ON sales(user_id);
CREATE INDEX idx_sales_code ON sales(sales_code);
CREATE INDEX idx_sales_wechat ON sales(sales_wechat);
CREATE INDEX idx_sales_parent ON sales(parent_sales_id);
```

### 4️⃣ orders表 - 订单表（优化现有表）
```sql
-- 为orders表添加完整信息字段（避免关联查询）
ALTER TABLE orders 
-- 客户完整信息
ADD COLUMN IF NOT EXISTS customer_id INTEGER,                    -- 客户ID
ADD COLUMN IF NOT EXISTS customer_name VARCHAR(100),             -- 客户姓名（冗余）
ADD COLUMN IF NOT EXISTS customer_phone VARCHAR(20),             -- 客户电话（冗余）
ADD COLUMN IF NOT EXISTS customer_email VARCHAR(100),            -- 客户邮箱（冗余）

-- 销售完整信息（冗余存储）
ADD COLUMN IF NOT EXISTS sales_id INTEGER,                       -- 销售ID
ADD COLUMN IF NOT EXISTS sales_wechat_name VARCHAR(100),         -- 销售微信名
ADD COLUMN IF NOT EXISTS sales_type VARCHAR(20),                 -- 销售类型
ADD COLUMN IF NOT EXISTS sales_commission_rate DECIMAL(5,4),     -- 销售佣金率

-- 一级销售信息（如果是二级销售的订单）
ADD COLUMN IF NOT EXISTS primary_sales_id INTEGER,               -- 一级销售ID
ADD COLUMN IF NOT EXISTS primary_sales_code VARCHAR(50),         -- 一级销售代码
ADD COLUMN IF NOT EXISTS primary_sales_wechat VARCHAR(100),      -- 一级销售微信
ADD COLUMN IF NOT EXISTS primary_commission_amount DECIMAL(10,2), -- 一级销售佣金

-- 二级销售信息
ADD COLUMN IF NOT EXISTS secondary_sales_id INTEGER,             -- 二级销售ID
ADD COLUMN IF NOT EXISTS secondary_sales_code VARCHAR(50),       -- 二级销售代码
ADD COLUMN IF NOT EXISTS secondary_sales_wechat VARCHAR(100),    -- 二级销售微信
ADD COLUMN IF NOT EXISTS secondary_commission_amount DECIMAL(10,2), -- 二级销售佣金

-- 分销收益（给一级的分成）
ADD COLUMN IF NOT EXISTS distribution_amount DECIMAL(10,2),      -- 分销收益金额

-- 订单来源
ADD COLUMN IF NOT EXISTS order_source VARCHAR(50),               -- 订单来源(web/app/admin)
ADD COLUMN IF NOT EXISTS order_channel VARCHAR(50),              -- 订单渠道

-- 预留字段
ADD COLUMN IF NOT EXISTS extra_field1 VARCHAR(255),
ADD COLUMN IF NOT EXISTS extra_field2 VARCHAR(255),
ADD COLUMN IF NOT EXISTS extra_field3 TEXT,
ADD COLUMN IF NOT EXISTS extra_json JSONB;

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_orders_customer_id ON orders(customer_id);
CREATE INDEX IF NOT EXISTS idx_orders_sales_id ON orders(sales_id);
```

---

## 三、🔄 数据流转逻辑

### 1. 用户注册流程：
```sql
-- 1. 创建用户账号
INSERT INTO users (username, password_hash, wechat_name, is_customer)
VALUES ('user123', 'hashed_password', 'wx_123', true);

-- 2. 创建客户记录
INSERT INTO customers (user_id, customer_wechat, customer_name)
VALUES (1, 'wx_123', '张三');
```

### 2. 客户购买流程：
```sql
-- 创建订单时，冗余存储所有信息
INSERT INTO orders (
  -- 客户信息
  customer_id, customer_wechat, customer_name,
  -- 销售信息
  sales_id, sales_code, sales_wechat_name, sales_type,
  -- 一级销售信息（如果有）
  primary_sales_id, primary_sales_wechat,
  -- 佣金信息
  commission_rate, commission_amount
) VALUES (
  1, 'wx_123', '张三',
  2, 'SALE001', '销售员A', 'secondary',
  3, '一级销售B',
  0.25, 47
);
```

### 3. 客户转化为销售：
```sql
-- 1. 更新用户角色
UPDATE users SET is_sales = true WHERE id = 1;

-- 2. 创建销售记录
INSERT INTO sales (
  user_id, sales_code, sales_wechat,
  sales_type, from_customer_id,
  parent_sales_id  -- 保持原销售关系
) VALUES (
  1, 'NEW_SALE_001', 'wx_123',
  'secondary', 1,
  2  -- 原销售成为其上级
);

-- 3. 更新客户记录
UPDATE customers 
SET become_sales_time = NOW(), sales_id = 10
WHERE id = 1;
```

---

## 四、✅ 这样设计的优势

### 1. **完整数据，无需关联**
- 每个表都有完整信息
- 订单表直接显示所有需要的字段
- 查询速度快，一次查询搞定

### 2. **支持角色转换**
- 用户可以同时是客户和销售
- 保持原有销售关系不变
- 灵活的角色管理

### 3. **统计信息预存储**
- 不用每次实时计算
- 定期批量更新统计数据
- 大幅提升性能

### 4. **预留扩展空间**
- 每个表都有预留字段
- JSONB字段可存储任意数据
- 未来需求不用改表结构

---

## 五、📋 实施步骤

### 第1步：创建新表（不影响现有系统）
```sql
-- 执行上述CREATE TABLE语句
-- 这些是新表，完全不影响现有功能
```

### 第2步：为orders表添加字段
```sql
-- 执行上述ALTER TABLE语句
-- 只是添加字段，不影响现有数据
```

### 第3步：数据迁移脚本
```sql
-- 从orders表提取客户信息到customers表
INSERT INTO customers (customer_wechat, tradingview_username)
SELECT DISTINCT customer_wechat, tradingview_username
FROM orders
WHERE customer_wechat IS NOT NULL;

-- 从secondary_sales表迁移到新sales表
INSERT INTO sales (sales_code, sales_wechat, sales_type, ...)
SELECT sales_code, wechat_name, sales_type, ...
FROM secondary_sales;
```

### 第4步：更新统计信息
```sql
-- 定期运行的统计更新脚本
UPDATE customers c
SET total_orders = (SELECT COUNT(*) FROM orders WHERE customer_wechat = c.customer_wechat),
    total_amount = (SELECT SUM(amount) FROM orders WHERE customer_wechat = c.customer_wechat);

UPDATE sales s
SET total_orders = (SELECT COUNT(*) FROM orders WHERE sales_code = s.sales_code),
    total_revenue = (SELECT SUM(amount) FROM orders WHERE sales_code = s.sales_code);
```

---

## 六、🎯 总结

这个方案：
1. ✅ **完全满足未来规划** - 支持用户系统和角色转换
2. ✅ **每个表数据完整** - 无需关联查询
3. ✅ **不影响现有系统** - 只加不删
4. ✅ **性能大幅提升** - 预存储统计信息
5. ✅ **扩展性强** - 预留字段应对未来

你觉得这个方案如何？需要调整哪些部分？