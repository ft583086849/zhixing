# 数据概览时间筛选问题分析

## 问题描述
- **数据概览页面**：时间筛选功能不工作
- **资金统计页面**：时间筛选功能正常

## 代码对比分析

### 1. 数据概览（AdminOverview.js）- 不工作

```javascript
// 数据加载逻辑
const loadData = async () => {
  const params = {
    timeRange: 'all',  // ⚠️ 问题在这里！始终固定为'all'
    usePaymentTime: true
  };
  
  return dispatch(getStats(params));
}

// 时间筛选处理
const handleTimeRangeChange = (value) => {
  setTimeRange(value);  // 只是设置了状态，没有重新加载数据
  setCustomRange([]);
}

// useEffect
useEffect(() => {
  loadData();
}, [dispatch]);  // 没有监听timeRange变化
```

**问题根源**：
1. `loadData` 函数始终使用 `timeRange: 'all'`，忽略了用户选择
2. `timeRange` 状态改变后，没有触发数据重新加载
3. useEffect 没有将 `timeRange` 作为依赖项

### 2. 资金统计（AdminFinance.js）- 正常工作

```javascript
// 时间筛选处理
const handleTimeRangeChange = (value) => {
  setTimeRange(value);
  setCustomRange([]);
  // 可能通过其他方式触发数据更新
}

// 数据获取使用的是实时的stats
const { stats, loading } = useSelector((state) => state.admin);

// 计算逻辑
const calculateFinancials = () => {
  // 直接使用 stats 中的数据
  // stats 的更新由其他地方控制
}
```

## 修复方案

### 方案1：修改loadData函数，使用当前timeRange

```javascript
const loadData = async () => {
  const params = {
    timeRange: timeRange,  // 使用当前选中的时间范围
    customRange: customRange,  // 传递自定义时间范围
    usePaymentTime: true
  };
  
  return dispatch(getStats(params));
}
```

### 方案2：添加useEffect监听timeRange变化

```javascript
useEffect(() => {
  loadData();
}, [dispatch, timeRange, customRange]);  // 添加依赖项
```

### 方案3：在handleTimeRangeChange中直接调用loadData

```javascript
const handleTimeRangeChange = (value) => {
  setTimeRange(value);
  setCustomRange([]);
  // 立即加载新数据
  loadData();
}
```

## 销售层级统计显示0的问题

### 问题分析
1月20日左右修复正确，现在又显示0，可能原因：

1. **API返回数据问题**
   - getStats 函数返回的数据中缺少相关字段
   - 字段名不匹配

2. **数据计算逻辑问题**
   - 统计计算逻辑被改动
   - 数据源查询条件变化

### 调试建议

1. 检查API响应：
```javascript
console.log('getStats返回的数据:', stats);
console.log('primary_sales_count:', stats?.primary_sales_count);
console.log('linked_secondary_sales_count:', stats?.linked_secondary_sales_count);
```

2. 检查Redux state：
   - 使用Redux DevTools查看state.admin.stats的实际内容

3. 验证后端查询：
   - 检查api.js中getStats函数的销售统计逻辑

## 建议的完整修复

```javascript
// AdminOverview.js
const AdminOverview = () => {
  const [timeRange, setTimeRange] = useState('all');
  const [customRange, setCustomRange] = useState([]);
  
  const loadData = async () => {
    const params = {
      timeRange: timeRange,  // 使用当前状态
      customRange: customRange,
      usePaymentTime: true
    };
    
    console.log('加载数据，参数:', params);
    
    const result = await dispatch(getStats(params));
    console.log('getStats结果:', result.payload);
    
    // 同时加载销售数据
    await dispatch(getSales(params));
  };
  
  // 监听时间范围变化
  useEffect(() => {
    loadData();
  }, [timeRange, customRange]);
  
  const handleTimeRangeChange = (value) => {
    setTimeRange(value);
    setCustomRange([]);
  };
  
  const handleCustomRangeChange = (dates) => {
    if (dates) {
      setCustomRange(dates);
      setTimeRange('custom');
    }
  };
  
  // 添加确认按钮的处理
  const handleConfirm = () => {
    loadData();  // 手动触发数据加载
    message.success('数据已更新');
  };
}
```