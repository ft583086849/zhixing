# 🔧 订单统计错误修复方案

## 问题描述

管理员销售页面的订单统计存在严重错误，导致数据与实际不符：

| 销售 | 实际数据 | 系统显示 | 问题 |
|------|---------|----------|------|
| WML792355703（一级） | 1个订单，$1588 | 7个订单，$376 | 包含了二级销售的订单 |
| 张子俊（二级） | 1个订单，$188 | 2个订单，$376 | 订单归属或重复计算错误 |

## 问题根源

### 文件：`client/src/services/api.js`

#### 1. 一级销售统计错误（第786-806行）

```javascript
// ❌ 错误：包含了所有二级销售的订单
const saleOrders = orders.filter(order => 
  (order.sales_code === sale.sales_code || 
  order.primary_sales_id === sale.id) &&  // 这里错误地包含了二级销售的订单
  order.status !== 'rejected'
);

// ❌ 错误：重复添加二级销售的订单
const secondaryOrders = [];
managedSecondaries.forEach(secondary => {
  const secOrders = orders.filter(order => 
    order.sales_code === secondary.sales_code &&
    order.status !== 'rejected'
  );
  secondaryOrders.push(...secOrders);
});

// ❌ 错误：合并导致重复计算
const allRelatedOrders = [...saleOrders, ...secondaryOrders];
```

## 修复方案

### 方案一：分离直接订单和团队订单（推荐）

```javascript
// ✅ 一级销售的处理逻辑
const processedPrimarySales = primarySales.map(sale => {
  // 1. 只获取一级销售的直接订单
  const directOrders = orders.filter(order => 
    order.sales_code === sale.sales_code &&  // 只匹配sales_code
    order.status !== 'rejected'
  );
  
  // 2. 单独获取二级销售的订单（不混入统计）
  const managedSecondaries = allSecondarySales.filter(s => s.primary_sales_id === sale.id);
  const teamOrders = [];
  let teamOrdersAmount = 0;
  
  managedSecondaries.forEach(secondary => {
    const secOrders = orders.filter(order => 
      order.sales_code === secondary.sales_code &&
      order.status !== 'rejected'
    );
    teamOrders.push(...secOrders);
    
    // 计算二级销售订单金额（用于佣金计算）
    const secAmount = secOrders
      .filter(o => ['confirmed_config', 'confirmed'].includes(o.status))
      .reduce((sum, order) => {
        const amount = parseFloat(order.actual_payment_amount || order.amount || 0);
        if (order.payment_method === 'alipay') {
          return sum + (amount / 7.15);
        }
        return sum + amount;
      }, 0);
    teamOrdersAmount += secAmount;
  });
  
  // 3. 分别计算直接订单统计
  const directOrdersCount = directOrders.length;
  const validDirectOrders = directOrders.filter(order => 
    ['confirmed', 'confirmed_config', 'confirmed_configuration', 'active'].includes(order.status)
  ).length;
  
  const directOrdersAmount = directOrders.reduce((sum, order) => {
    const amount = parseFloat(order.actual_payment_amount || order.amount || 0);
    if (order.payment_method === 'alipay') {
      return sum + (amount / 7.15);
    }
    return sum + amount;
  }, 0);
  
  // 4. 计算佣金
  // 一级销售的佣金 = 直接订单佣金 + 团队订单差额佣金
  const directCommission = directOrdersAmount * 0.4;  // 40%
  let teamCommission = 0;
  
  if (sale.commission_rate > 0) {  // 只有佣金率>0的一级销售才能获得团队佣金
    managedSecondaries.forEach(secondary => {
      const secRate = secondary.commission_rate || 0.25;
      const rateGap = 0.4 - secRate;  // 40%总池 - 二级佣金率
      teamCommission += teamOrdersAmount * rateGap;
    });
  }
  
  return {
    sales: {
      ...sale,
      sales_type: 'primary'
    },
    // 只显示直接订单的统计
    total_orders: directOrdersCount,
    valid_orders: validDirectOrders,
    total_amount: directOrdersAmount,
    confirmed_amount: directOrdersAmount,  // 简化处理
    
    // 新增字段：团队订单统计（仅供参考，不混入主统计）
    team_orders_count: teamOrders.length,
    team_orders_amount: teamOrdersAmount,
    
    // 佣金计算
    commission_rate: sale.commission_rate || 40,
    commission_amount: directCommission + teamCommission,
    commission_breakdown: {
      direct: directCommission,
      team: teamCommission
    }
  };
});
```

### 方案二：修复二级销售统计

```javascript
// ✅ 二级销售的处理逻辑
const processedSecondarySales = secondarySales.map(sale => {
  // 只获取该二级销售的订单
  const saleOrders = orders.filter(order => 
    order.sales_code === sale.sales_code &&  // 只匹配sales_code，不要用其他条件
    order.status !== 'rejected'
  );
  
  // 正常计算统计数据
  const totalOrders = saleOrders.length;
  const validOrders = saleOrders.filter(order => 
    ['confirmed', 'confirmed_config', 'confirmed_configuration', 'active'].includes(order.status)
  ).length;
  
  const totalAmount = saleOrders.reduce((sum, order) => {
    const amount = parseFloat(order.actual_payment_amount || order.amount || 0);
    if (order.payment_method === 'alipay') {
      return sum + (amount / 7.15);
    }
    return sum + amount;
  }, 0);
  
  // ... 其余逻辑保持不变
});
```

## 实施步骤

1. **备份现有代码**
   ```bash
   cp client/src/services/api.js client/src/services/api.js.backup
   ```

2. **修改`api.js`文件**
   - 修改`getSales`方法中的一级销售处理逻辑（第785-937行）
   - 修改二级销售处理逻辑（第940-1076行）

3. **测试验证**
   - 检查WML792355703是否只显示1个订单，$1588
   - 检查张子俊是否只显示1个订单，$188
   - 验证佣金计算是否正确

4. **UI调整建议**
   - 可以在表格中添加"团队订单"列，显示二级销售的订单统计
   - 在佣金列添加tooltip，显示佣金构成（直接佣金 + 团队佣金）

## 影响范围

- 管理员销售页面的数据显示
- 佣金计算逻辑
- 数据导出功能

## 紧急程度

**🔴 高** - 这是核心业务数据错误，会影响财务结算，需要立即修复。

## 注意事项

1. 修复后需要清除浏览器缓存
2. 建议在测试环境先验证
3. 修复后需要通知相关人员核对历史数据
