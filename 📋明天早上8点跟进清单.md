# 📋 知行财库系统问题跟进清单
> 生成时间：2025-01-13 凌晨
> 提醒时间：2025-01-13 早上8点后
> 项目路径：/Users/zzj/Documents/w/

---

## 🔴 严重问题（影响线上稳定）

### 1. primary_sales表不存在但代码大量引用
**问题描述**：数据库中不存在primary_sales表，但代码有15处直接引用
**影响文件**：
- `client/src/services/supabase.js` - 9处引用（行54, 74, 85, 96, 146, 692, 794, 802, 934, 963, 976, 1098, 1105, 1158）
- `client/src/services/api.js` - 6处引用（行237, 274, 683）

**不修复的影响**：
- 所有一级销售功能完全失效
- 无法创建、查询、更新一级销售
- 用户看到空白页面或错误提示

**建议修复方案**：
```javascript
// 将所有
.from('primary_sales')
// 改为
.from('secondary_sales').eq('sales_type', 'primary')
```

**修复影响**：需要全面测试，确保查询逻辑正确

---

### 2. 截图数据保存失败
**问题描述**：用户上传的付款截图全部丢失，screenshot_data字段全部为NULL
**影响场景**：管理员无法查看用户付款凭证，影响订单确认
**问题位置**：`client/src/pages/PurchasePage.js` 行133-198

**不修复的影响**：
- 管理员无法验证付款
- 可能导致虚假订单
- 用户纠纷无凭证

**建议修复方案**：
1. 改用Supabase Storage存储
2. 数据库只存储文件路径
3. 限制文件大小为5MB

**修复影响**：需要迁移历史数据

---

### 3. 佣金计算逻辑不一致
**问题描述**：不同页面的佣金计算方式不同

| 页面 | 佣金率获取 | 佣金计算方式 | 默认值 |
|------|------------|--------------|--------|
| 订单管理 | 硬编码40% | amount * 0.4 | 40% |
| 销售管理 | 数据库commission_rate | confirmed_amount * rate | 0% |
| 一级对账 | API统计 | 聚合计算 | 40% |
| 二级对账 | 数据库commission_rate | API返回 | 25% |

**不修复的影响**：
- 同一订单在不同页面显示不同佣金
- 财务对账困难
- 用户投诉

**建议修复方案**：
1. 统一使用API计算佣金
2. 移除硬编码逻辑
3. 统一默认值：一级40%，二级25%

---

## 🟡 中等问题（影响功能使用）

### 4. 字段不一致问题
**问题**：sales_id在数据库中分为primary_sales_id和secondary_sales_id
**影响**：代码需要判断使用哪个字段，增加复杂度
**建议**：API层做兼容处理，统一返回sales_id

### 5. 缺失关键字段
**缺失字段**：
- registration_code - 一级销售生成二级注册码
- link_code - API返回购买链接需要

**建议修复**：
```sql
ALTER TABLE secondary_sales 
ADD COLUMN registration_code VARCHAR(50),
ADD COLUMN link_code VARCHAR(50);
```

### 6. 硬编码链接问题
**位置**：`client/src/pages/PurchasePage.js` 行239-256
**问题**：二级销售申请链接硬编码
```javascript
href="https://zhixing-seven.vercel.app/secondary-sales"
```
**建议**：改为动态生成，使用registration_code

---

## 🟢 低优先级问题

### 7. 统计字段性能问题
**问题**：total_orders、total_revenue等需要实时计算
**影响**：数据量大时查询慢
**建议**：创建物化视图或定期更新统计表

---

## ✅ 已修复项目

1. **v2.11.1** - 回滚佣金计算逻辑（2025-01-07）
2. **v2.12.0** - 佣金系统v2.0改进，区分直销和分销
3. 销售管理按创建时间降序排序
4. 客户管理按最新订单时间排序

---

## 📊 修复优先级建议

### 立即修复（影响线上稳定）
1. primary_sales表问题 - **必须今天修复**
2. 截图保存问题 - **本周内修复**
3. 佣金计算一致性 - **本周内修复**

### 计划修复（影响用户体验）
4. 字段不一致问题
5. 缺失字段添加
6. 硬编码链接

### 后续优化
7. 性能优化

---

## 🎯 我的判断和建议

基于**线上稳定**和**正常运营**的核心需求：

1. **今天必须修复**：primary_sales表问题
   - 这是致命问题，会导致功能完全失效
   - 修复方案简单，风险可控

2. **本周内修复**：
   - 截图保存 - 影响订单处理
   - 佣金一致性 - 影响财务对账

3. **可以延后**：
   - 性能优化
   - 字段完善
   - 代码重构

---

## 📝 给MCP的信息

请记录以下关键数据和逻辑：

### 数据库结构
- **主要表**：orders, secondary_sales
- **不存在的表**：primary_sales（代码引用但不存在）
- **问题字段**：screenshot_data（全部NULL），缺少registration_code, link_code

### 佣金计算规则
- 一级销售：40%固定佣金
- 二级销售：0-25%可调
- 独立销售：0-25%可调
- 计算基数：confirmed_amount（已确认金额）

### API端点
- Supabase URL: https://itvmeamoqthfqtkpubdv.supabase.co
- 生产环境：https://zhixing-seven.vercel.app

### 关键文件路径
- 佣金计算：`client/src/services/api.js`
- 数据库操作：`client/src/services/supabase.js`
- 购买页面：`client/src/pages/PurchasePage.js`
- 销售管理：`client/src/components/admin/AdminSales.js`

---

**明天早上8点后，请提醒查看此清单并逐项处理。**