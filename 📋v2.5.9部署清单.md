# 📋 v2.5.9 部署清单

## 🎯 版本目标
修复销售管理页面的5个关键问题

## 📝 修改内容

### 1. 已返佣金额保存功能 ✅
**文件**: `client/src/services/api.js`
- 新增 `updatePaidCommission` API（第1660-1688行）
- AdminAPI 添加调用方法（第1379-1382行）

**文件**: `client/src/components/admin/AdminSales.js`
- 导入 AdminAPI（第36行）
- 确认按钮调用保存API（第533-548行）

**数据库**: 需要执行SQL
```sql
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS paid_commission DECIMAL(10,2) DEFAULT 0;
```

### 2. 搜索改为精确匹配 ✅
**文件**: `client/src/services/api.js`
- 一级销售搜索改为精确匹配（第704-706行）
- 二级销售搜索改为精确匹配（第716-718行）

### 3. 客户管理排除已拒绝订单 ✅
**文件**: `client/src/services/api.js`
- 客户初次创建时排除已拒绝订单（第291-294行）
- 客户订单累加时排除已拒绝订单（第369-372行）

### 4. 收款地址问题说明 📍
- 数据库中所有销售的`payment_account`都是"未设置"
- 需要销售自行补充收款信息
- 代码逻辑正确，数据缺失

### 5. 数据来源说明 📖
- 客户管理：`AdminAPI.getCustomers()` 从orders表提取
- 销售关系：通过`sales_code`匹配销售表
- 层级判断：根据表来源判断一级/二级/独立

## ⚠️ 部署前准备

1. **数据库操作**（必须先执行）：
```bash
# 连接数据库执行SQL添加字段
```

2. **代码检查**：
- [x] ESLint无错误
- [x] 导入语句正确
- [x] API调用正确

## 🚀 部署步骤

```bash
# 1. 提交代码
git add -A
git commit -m "✅ v2.5.9 销售管理5个问题修复

主要修复：
1. 已返佣金额保存功能
   - 新增数据库字段paid_commission
   - 实现updatePaidCommission API
   - 确认按钮调用保存

2. 搜索改为精确匹配
   - includes改为===
   - 输入需完全匹配

3. 客户管理排除已拒绝订单
   - 不统计rejected状态订单
   - 只有已拒绝订单的客户不显示

4. 收款地址数据缺失说明
   - 需要销售补充信息

5. 数据来源文档化"

# 2. 推送代码
git push
```

## ✅ 测试验证

### 功能测试
- [ ] 销售管理搜索"张子俊"精确匹配
- [ ] 已返佣金额填写并保存
- [ ] 刷新后已返佣金额仍显示
- [ ] 客户管理不显示只有已拒绝订单的客户

### 数据验证
- [ ] 统计数据排除已拒绝订单
- [ ] 销售层级关系正确显示

## 📊 影响范围

- 销售管理页面
- 客户管理页面
- 数据统计逻辑
- 搜索功能

## 🔄 回滚方案

如需回滚：
```bash
git revert HEAD
git push
```

## 📝 后续待办

1. 通知销售补充收款地址信息
2. 监控已返佣金额保存功能使用情况
3. 收集用户对精确搜索的反馈
