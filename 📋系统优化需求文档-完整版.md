# ğŸ“‹ çŸ¥è¡Œè´¢åº“ç³»ç»Ÿä¼˜åŒ–éœ€æ±‚æ–‡æ¡£

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
çŸ¥è¡Œè´¢åº“ç³»ç»Ÿæ˜¯ä¸€ä¸ªé”€å”®ç®¡ç†å’Œè®¢å•å¤„ç†å¹³å°ï¼Œç›®å‰å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- é¡µé¢åŠ è½½é€Ÿåº¦æ…¢ï¼ˆ3-5ç§’ï¼‰
- æ•°æ®æŸ¥è¯¢æ•ˆç‡ä½
- ç¼ºå°‘ç¼“å­˜æœºåˆ¶
- å®æ—¶æ€§ä¸è¶³

### 1.2 ä¼˜åŒ–ç›®æ ‡
- é¡µé¢åŠ è½½æ—¶é—´é™è‡³1ç§’ä»¥å†…
- å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°80%ä»¥ä¸Š
- æå‡ç”¨æˆ·ä½“éªŒ
- ä¿è¯æ•°æ®å‡†ç¡®æ€§

## äºŒã€æ•°æ®æ¦‚è§ˆé¡µé¢ä¼˜åŒ–ï¼ˆå·²å®Œæˆï¼‰

### 2.1 é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 3-5ç§’
- **é—®é¢˜åŸå› **: 
  - å®æ—¶JOINå¤šä¸ªè¡¨è®¡ç®—ç»Ÿè®¡æ•°æ®
  - æ¯æ¬¡éƒ½é‡æ–°è®¡ç®—æ‰€æœ‰æŒ‡æ ‡
  - æ— ç¼“å­˜æœºåˆ¶

### 2.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### 2.2.1 æ•°æ®åº“å±‚ä¼˜åŒ–
```sql
-- åˆ›å»ºé¢„è®¡ç®—ç»Ÿè®¡è¡¨
CREATE TABLE overview_stats (
  id SERIAL PRIMARY KEY,
  stat_type VARCHAR(50),
  stat_period VARCHAR(50),
  total_orders INTEGER,
  valid_orders INTEGER,
  rejected_orders INTEGER,
  pending_payment_orders INTEGER,
  pending_config_orders INTEGER,
  confirmed_config_orders INTEGER,
  total_amount DECIMAL(10,2),
  confirmed_amount DECIMAL(10,2),
  total_commission DECIMAL(10,2),
  paid_commission DECIMAL(10,2),
  pending_commission DECIMAL(10,2),
  primary_sales_count INTEGER,
  secondary_sales_count INTEGER,
  independent_sales_count INTEGER,
  free_trial_orders INTEGER,
  one_month_orders INTEGER,
  three_month_orders INTEGER,
  six_month_orders INTEGER,
  yearly_orders INTEGER,
  last_calculated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2.2.2 APIå±‚ä¼˜åŒ–
```javascript
// ç¯å¢ƒå˜é‡æ§åˆ¶æ–°æ—§é€»è¾‘åˆ‡æ¢
REACT_APP_ENABLE_NEW_STATS=true

// å®ç°æ™ºèƒ½ç¼“å­˜
async getStats(params) {
  // 1. ä¼˜å…ˆä»é¢„è®¡ç®—è¡¨è¯»å–
  if (useNewStats) {
    return getStatsFromTable(params);
  }
  // 2. é™çº§åˆ°å®æ—¶æŸ¥è¯¢
  return getStatsRealtime(params);
}
```

#### 2.2.3 å‰ç«¯ä¼˜åŒ–
- ReduxçŠ¶æ€ç®¡ç†ä¼˜åŒ–
- ç§»é™¤ä¸å¿…è¦çš„ä¾èµ–é¿å…å¾ªç¯æ¸²æŸ“
- å¹¶è¡ŒåŠ è½½æ•°æ®

### 2.3 å®æ–½æ•ˆæœ
- âœ… æŸ¥è¯¢æ—¶é—´ï¼š1764ms â†’ 467msï¼ˆ**æå‡73.5%**ï¼‰
- âœ… æ•°æ®åº“æŸ¥è¯¢ï¼š5-10ä¸ª â†’ 1ä¸ªï¼ˆ**å‡å°‘80-90%**ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„

## ä¸‰ã€è®¢å•ç®¡ç†é¡µé¢ä¼˜åŒ–

### 3.1 é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 2-4ç§’
- **æ•°æ®é‡**: 200+ è®¢å•
- **é—®é¢˜åŸå› **:
  - æ¯æ¬¡æŸ¥è¯¢éœ€è¦JOIN ordersã€salesã€customersç­‰å¤šä¸ªè¡¨
  - æ— åˆ†é¡µä¼˜åŒ–ï¼Œä¸€æ¬¡åŠ è½½æ‰€æœ‰æ•°æ®
  - è®¢å•çŠ¶æ€æ›´æ–°éœ€è¦åˆ·æ–°æ•´ä¸ªé¡µé¢
  - ç¼ºå°‘ç´¢å¼•å¯¼è‡´æŸ¥è¯¢æ…¢

### 3.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### 3.2.1 æ•°æ®åº“å±‚ä¼˜åŒ–
```sql
-- 1. åˆ›å»ºè®¢å•ç´¢å¼•
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_sales_code ON orders(sales_code);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_payment_time ON orders(payment_time DESC);

-- 2. åˆ›å»ºè®¢å•ç»Ÿè®¡è§†å›¾
CREATE VIEW orders_with_sales AS
SELECT 
  o.*,
  ps.wechat_name as primary_sales_name,
  ps.commission_rate as primary_commission_rate,
  ss.wechat_name as secondary_sales_name,
  ss.commission_rate as secondary_commission_rate,
  c.wechat_name as customer_wechat_name
FROM orders o
LEFT JOIN primary_sales ps ON o.primary_sales_id = ps.id
LEFT JOIN secondary_sales ss ON o.secondary_sales_id = ss.id
LEFT JOIN customers c ON o.customer_id = c.id;
```

#### 3.2.2 ç¼“å­˜å±‚ä¼˜åŒ–
```javascript
// ordersCache.js - å·²å®ç°
class OrdersCacheManager {
  constructor() {
    this.cacheDuration = 3 * 60 * 1000; // 3åˆ†é’Ÿç¼“å­˜
    this.indexCache = new Map(); // å¤šç»´åº¦ç´¢å¼•
  }
  
  buildIndexes(orders) {
    // æŒ‰çŠ¶æ€ç´¢å¼• - O(1)æŸ¥è¯¢
    const byStatus = new Map();
    // æŒ‰é”€å”®ä»£ç ç´¢å¼• - O(1)æŸ¥è¯¢  
    const bySalesCode = new Map();
    // æŒ‰å®¢æˆ·ç´¢å¼• - O(1)æŸ¥è¯¢
    const byCustomer = new Map();
  }
  
  // æ‰¹é‡å¤„ç†ä¼˜åŒ–
  processOrders(orders, salesData) {
    // ä¸€æ¬¡æ€§å¤„ç†æ‰€æœ‰è®¢å•
    // é¿å…å¾ªç¯æŸ¥è¯¢
  }
}
```

#### 3.2.3 APIå±‚ä¼˜åŒ–
```javascript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
async getOrders(params) {
  const { page = 1, limit = 100 } = params;
  
  // 1. ä½¿ç”¨ç¼“å­˜
  const cached = ordersCacheManager.get(params);
  if (cached) return cached;
  
  // 2. ä¼˜åŒ–æŸ¥è¯¢
  const query = supabase
    .from('orders_with_sales') // ä½¿ç”¨è§†å›¾
    .select('*', { count: 'exact' })
    .range((page-1)*limit, page*limit-1);
    
  // 3. åº”ç”¨ç­›é€‰
  if (params.status) {
    query.eq('status', params.status);
  }
  
  return query;
}
```

#### 3.2.4 å‰ç«¯ä¼˜åŒ–
- è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§æ•°æ®é‡
- çŠ¶æ€æ›´æ–°åªåˆ·æ–°å•æ¡è®°å½•
- æ‰¹é‡æ“ä½œä¼˜åŒ–

### 3.3 é¢„æœŸæ•ˆæœ
- æŸ¥è¯¢æ—¶é—´ï¼š2-4ç§’ â†’ <0.5ç§’
- å‡å°‘80%æ•°æ®åº“æŸ¥è¯¢
- å³æ—¶å“åº”ç”¨æˆ·æ“ä½œ

## å››ã€é”€å”®ç®¡ç†é¡µé¢ä¼˜åŒ–

### 4.1 é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 2-3ç§’
- **æ•°æ®é‡**: 24ä¸ªé”€å”®äººå‘˜
- **é—®é¢˜åŸå› **:
  - å¾ªç¯è®¡ç®—æ¯ä¸ªé”€å”®çš„è®¢å•ç»Ÿè®¡
  - å®æ—¶è®¡ç®—ä½£é‡‘é‡‘é¢
  - é”€å”®å±‚çº§å…³ç³»æŸ¥è¯¢å¤æ‚
  - å…³è”è®¢å•æ•°æ®é‡å¤§

### 4.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### 4.2.1 æ•°æ®åº“å±‚ä¼˜åŒ–
```sql
-- 1. åˆ›å»ºé”€å”®ç»Ÿè®¡è¡¨ï¼ˆå·²å®Œæˆï¼‰
CREATE TABLE sales_statistics (
  id SERIAL PRIMARY KEY,
  sales_id INTEGER,
  sales_type VARCHAR(20),
  sales_code VARCHAR(50),
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  total_amount DECIMAL(10,2) DEFAULT 0,
  confirmed_amount DECIMAL(10,2) DEFAULT 0,
  commission_rate DECIMAL(5,2),
  commission_amount DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  UNIQUE(sales_id, sales_type)
);

-- 2. åˆ›å»ºæ›´æ–°è§¦å‘å™¨
CREATE OR REPLACE FUNCTION update_sales_statistics()
RETURNS TRIGGER AS $$
BEGIN
  -- è®¢å•çŠ¶æ€å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡
  PERFORM update_single_sales_stats(NEW.sales_code);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER orders_change_trigger
AFTER INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION update_sales_statistics();
```

#### 4.2.2 ç¼“å­˜å±‚ä¼˜åŒ–
```javascript
// salesCache.js - å·²å®ç°
class SalesCacheManager {
  constructor() {
    this.cacheDuration = 5 * 60 * 1000; // 5åˆ†é’Ÿç¼“å­˜
  }
  
  // æ‰¹é‡å¤„ç†é”€å”®æ•°æ®
  batchProcessSales(primarySales, secondarySales, orders) {
    // å»ºç«‹è®¢å•æ˜ å°„ - O(n)
    const ordersBySales = new Map();
    
    // ä¸€æ¬¡éå†å®Œæˆæ‰€æœ‰è®¡ç®—
    orders.forEach(order => {
      // ç´¯åŠ åˆ°å¯¹åº”é”€å”®
    });
    
    // å¹¶è¡Œå¤„ç†ä¸€çº§å’ŒäºŒçº§é”€å”®
    return Promise.all([
      processPrimary(primarySales),
      processSecondary(secondarySales)
    ]);
  }
}
```

#### 4.2.3 APIå±‚ä¼˜åŒ–
```javascript
async getSales(params) {
  // 1. å°è¯•ä»ç»Ÿè®¡è¡¨è·å–
  if (ENABLE_SALES_STATS_TABLE) {
    return getSalesFromStatsTable(params);
  }
  
  // 2. ä½¿ç”¨ç¼“å­˜æ‰¹é‡å¤„ç†
  const cached = salesCacheManager.get(params);
  if (cached) return cached;
  
  // 3. æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
  const [primary, secondary, orders] = await Promise.all([
    getPrimarySales(),
    getSecondarySales(),
    getOrders()
  ]);
  
  // 4. æ‰¹é‡å¤„ç†
  return salesCacheManager.batchProcessSales(
    primary, secondary, orders
  );
}
```

### 4.3 é¢„æœŸæ•ˆæœ
- æŸ¥è¯¢æ—¶é—´ï¼š2-3ç§’ â†’ <0.5ç§’
- ç¼“å­˜å‘½ä¸­ç‡ > 90%
- æ‰¹é‡å¤„ç†å‡å°‘70%è®¡ç®—æ—¶é—´

## äº”ã€å®¢æˆ·ç®¡ç†é¡µé¢ä¼˜åŒ–

### 5.1 é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 1-2ç§’
- **æ•°æ®é‡**: 100+ å®¢æˆ·
- **é—®é¢˜åŸå› **:
  - å®¢æˆ·æ•°æ®åˆ†æ•£åœ¨å¤šä¸ªè¡¨
  - éœ€è¦è®¡ç®—æ¯ä¸ªå®¢æˆ·çš„è®¢å•ç»Ÿè®¡
  - æŸ¥è¯¢å®¢æˆ·çš„é”€å”®å½’å±å…³ç³»
  - æœç´¢åŠŸèƒ½æ•ˆç‡ä½

### 5.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### 5.2.1 æ•°æ®åº“å±‚ä¼˜åŒ–
```sql
-- 1. åˆ›å»ºå®¢æˆ·ç»Ÿè®¡è§†å›¾
CREATE VIEW customer_stats AS
SELECT 
  c.id,
  c.wechat_name,
  c.email,
  c.phone,
  c.created_at,
  COUNT(DISTINCT o.id) as total_orders,
  COUNT(DISTINCT CASE WHEN o.status = 'confirmed_config' THEN o.id END) as valid_orders,
  COALESCE(SUM(o.amount), 0) as total_spent,
  COALESCE(SUM(CASE WHEN o.status = 'confirmed_config' THEN o.amount END), 0) as confirmed_spent,
  MAX(o.created_at) as last_order_date,
  MIN(o.created_at) as first_order_date,
  s.sales_code,
  s.wechat_name as sales_name,
  ps.wechat_name as primary_sales_name
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
LEFT JOIN secondary_sales s ON o.sales_code = s.sales_code
LEFT JOIN primary_sales ps ON s.primary_sales_id = ps.id
GROUP BY c.id, s.sales_code, s.wechat_name, ps.wechat_name;

-- 2. åˆ›å»ºæœç´¢ç´¢å¼•
CREATE INDEX idx_customers_wechat ON customers(wechat_name);
CREATE INDEX idx_customers_email ON customers(email);
CREATE INDEX idx_customers_phone ON customers(phone);

-- 3. å…¨æ–‡æœç´¢æ”¯æŒ
CREATE INDEX idx_customers_search ON customers 
USING gin(to_tsvector('simple', wechat_name || ' ' || email || ' ' || phone));
```

#### 5.2.2 ç¼“å­˜å±‚ä¼˜åŒ–
```javascript
class CustomerCacheManager {
  constructor() {
    this.cacheDuration = 10 * 60 * 1000; // 10åˆ†é’Ÿï¼ˆå®¢æˆ·æ•°æ®å˜åŒ–å°‘ï¼‰
    this.searchCache = new Map(); // æœç´¢ç»“æœç¼“å­˜
  }
  
  // å»ºç«‹å®¢æˆ·ç´¢å¼•
  buildIndexes(customers) {
    this.bySalesCode = new Map(); // æŒ‰é”€å”®åˆ†ç»„
    this.bySpending = [...customers].sort((a,b) => b.total_spent - a.total_spent); // æŒ‰æ¶ˆè´¹æ’åº
    this.byDate = [...customers].sort((a,b) => new Date(b.created_at) - new Date(a.created_at)); // æŒ‰æ³¨å†Œæ—¶é—´
  }
  
  // æ™ºèƒ½æœç´¢
  search(keyword) {
    // æ£€æŸ¥ç¼“å­˜
    if (this.searchCache.has(keyword)) {
      return this.searchCache.get(keyword);
    }
    
    // æ¨¡ç³ŠåŒ¹é…
    const results = this.customers.filter(c => 
      c.wechat_name?.includes(keyword) ||
      c.email?.includes(keyword) ||
      c.phone?.includes(keyword)
    );
    
    // ç¼“å­˜ç»“æœ
    this.searchCache.set(keyword, results);
    return results;
  }
}
```

#### 5.2.3 APIå±‚ä¼˜åŒ–
```javascript
async getCustomers(params) {
  // 1. ä½¿ç”¨è§†å›¾æŸ¥è¯¢
  const query = supabase
    .from('customer_stats')
    .select('*');
    
  // 2. åº”ç”¨ç­›é€‰
  if (params.sales_code) {
    query.eq('sales_code', params.sales_code);
  }
  
  if (params.search) {
    // ä½¿ç”¨å…¨æ–‡æœç´¢
    query.textSearch('search_text', params.search);
  }
  
  // 3. æ’åºä¼˜åŒ–
  if (params.sort === 'spending') {
    query.order('total_spent', { ascending: false });
  }
  
  return query;
}
```

### 5.3 é¢„æœŸæ•ˆæœ
- æŸ¥è¯¢æ—¶é—´ï¼š1-2ç§’ â†’ <0.3ç§’
- æœç´¢å“åº”ï¼š<100ms
- æ”¯æŒå®æ—¶ç­›é€‰å’Œæ’åº

## å…­ã€èµ„é‡‘ç»Ÿè®¡é¡µé¢ä¼˜åŒ–

### 6.1 é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 3-5ç§’
- **è®¡ç®—å¤æ‚åº¦**: é«˜
- **é—®é¢˜åŸå› **:
  - å®æ—¶è®¡ç®—æ‰€æœ‰è´¢åŠ¡æŒ‡æ ‡
  - éœ€è¦èšåˆå¤§é‡å†å²æ•°æ®
  - æŒ‰æ—¶é—´ç»´åº¦ç»Ÿè®¡æ•ˆç‡ä½
  - æŠ¥è¡¨ç”Ÿæˆè€—æ—¶é•¿

### 6.2 ä¼˜åŒ–æ–¹æ¡ˆ

#### 6.2.1 æ•°æ®åº“å±‚ä¼˜åŒ–
```sql
-- 1. åˆ›å»ºè´¢åŠ¡æ—¥æŠ¥è¡¨
CREATE TABLE finance_daily_stats (
  stat_date DATE PRIMARY KEY,
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  total_revenue DECIMAL(10,2) DEFAULT 0,
  confirmed_revenue DECIMAL(10,2) DEFAULT 0,
  pending_payment DECIMAL(10,2) DEFAULT 0,
  total_commission DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  profit_amount DECIMAL(10,2) DEFAULT 0,
  profit_margin DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- 2. åˆ›å»ºæœˆåº¦æ±‡æ€»è¡¨
CREATE TABLE finance_monthly_stats (
  stat_month VARCHAR(7) PRIMARY KEY, -- YYYY-MM
  total_days INTEGER,
  total_orders INTEGER,
  total_revenue DECIMAL(10,2),
  total_commission DECIMAL(10,2),
  avg_order_value DECIMAL(10,2),
  growth_rate DECIMAL(5,2), -- ç¯æ¯”å¢é•¿ç‡
  created_at TIMESTAMP DEFAULT NOW()
);

-- 3. åˆ›å»ºå®æ—¶è´¢åŠ¡è§†å›¾
CREATE VIEW finance_realtime AS
SELECT 
  COUNT(*) as total_orders,
  SUM(CASE WHEN status != 'rejected' THEN 1 ELSE 0 END) as valid_orders,
  SUM(amount) as total_amount,
  SUM(CASE WHEN status = 'confirmed_config' THEN amount ELSE 0 END) as confirmed_amount,
  SUM(CASE WHEN status = 'pending_payment' THEN amount ELSE 0 END) as pending_amount,
  SUM(commission_amount) as total_commission,
  SUM(paid_commission) as paid_commission,
  SUM(commission_amount - paid_commission) as pending_commission
FROM orders
WHERE created_at >= CURRENT_DATE - INTERVAL '30 days';
```

#### 6.2.2 ç¼“å­˜å±‚ä¼˜åŒ–
```javascript
class FinanceCacheManager {
  constructor() {
    this.cacheDuration = 15 * 60 * 1000; // 15åˆ†é’Ÿ
    this.dailyCache = new Map(); // æ—¥æŠ¥ç¼“å­˜
    this.monthlyCache = new Map(); // æœˆæŠ¥ç¼“å­˜
    this.realtimeCache = null; // å®æ—¶æ•°æ®ç¼“å­˜
  }
  
  // è·å–æ—¥æŠ¥æ•°æ®
  async getDailyStats(date) {
    const key = date.toISOString().split('T')[0];
    
    // æ£€æŸ¥ç¼“å­˜
    if (this.dailyCache.has(key)) {
      return this.dailyCache.get(key);
    }
    
    // æŸ¥è¯¢æ•°æ®åº“
    const stats = await supabase
      .from('finance_daily_stats')
      .select('*')
      .eq('stat_date', key)
      .single();
      
    // å¦‚æœæ²¡æœ‰ï¼Œè§¦å‘è®¡ç®—
    if (!stats) {
      await this.calculateDailyStats(date);
    }
    
    this.dailyCache.set(key, stats);
    return stats;
  }
  
  // è·å–è¶‹åŠ¿æ•°æ®
  async getTrendData(startDate, endDate, granularity = 'day') {
    const cached = this.getTrendCache(startDate, endDate, granularity);
    if (cached) return cached;
    
    if (granularity === 'day') {
      // ä»æ—¥æŠ¥è¡¨æŸ¥è¯¢
      return supabase
        .from('finance_daily_stats')
        .select('*')
        .gte('stat_date', startDate)
        .lte('stat_date', endDate)
        .order('stat_date');
    } else if (granularity === 'month') {
      // ä»æœˆæŠ¥è¡¨æŸ¥è¯¢
      return supabase
        .from('finance_monthly_stats')
        .select('*')
        .gte('stat_month', startDate.substring(0,7))
        .lte('stat_month', endDate.substring(0,7))
        .order('stat_month');
    }
  }
}
```

#### 6.2.3 APIå±‚ä¼˜åŒ–
```javascript
async getFinanceStats(params) {
  const { timeRange = 'month', startDate, endDate } = params;
  
  // 1. å®æ—¶æ•°æ®ï¼ˆä»Šæ—¥ï¼‰
  if (timeRange === 'today') {
    return getRealtimeStats();
  }
  
  // 2. å†å²æ•°æ®ï¼ˆä»é¢„è®¡ç®—è¡¨ï¼‰
  if (timeRange === 'custom') {
    return financeCacheManager.getTrendData(startDate, endDate);
  }
  
  // 3. å¿«é€Ÿèšåˆ
  const stats = await supabase
    .from('finance_daily_stats')
    .select('*')
    .order('stat_date', { ascending: false })
    .limit(30);
    
  // æ±‡æ€»è®¡ç®—
  return aggregateStats(stats);
}

// å®šæ—¶ä»»åŠ¡ - æ¯æ—¥å‡Œæ™¨æ›´æ–°
async function updateDailyFinanceStats() {
  const yesterday = new Date();
  yesterday.setDate(yesterday.getDate() - 1);
  
  const stats = await calculateFinanceStats(yesterday);
  
  await supabase
    .from('finance_daily_stats')
    .upsert(stats);
}
```

### 6.3 é¢„æœŸæ•ˆæœ
- æŸ¥è¯¢æ—¶é—´ï¼š3-5ç§’ â†’ <1ç§’
- æŠ¥è¡¨ç”Ÿæˆï¼šå³æ—¶è¿”å›
- æ”¯æŒå¤šç»´åº¦ç»Ÿè®¡åˆ†æ

## ä¸ƒã€å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæœ¬åœ°æµ‹è¯•ï¼ˆ1-2å¤©ï¼‰
1. âœ… å®Œæˆç¼“å­˜ç®¡ç†å™¨å¼€å‘
2. âœ… ä¼˜åŒ–APIæŸ¥è¯¢é€»è¾‘
3. â³ æœ¬åœ°éªŒè¯æ€§èƒ½æå‡

### ç¬¬äºŒé˜¶æ®µï¼šæ•°æ®åº“ä¼˜åŒ–ï¼ˆéœ€è¦æ‚¨åŒæ„ï¼‰
1. â³ åœ¨Supabaseåˆ›å»ºç»Ÿè®¡è¡¨
2. â³ æ·»åŠ å¿…è¦çš„ç´¢å¼•
3. â³ åˆ›å»ºè§†å›¾å’Œè§¦å‘å™¨
4. â³ è¿è¡Œæ•°æ®è¿ç§»è„šæœ¬

### ç¬¬ä¸‰é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
1. â³ åŠŸèƒ½æµ‹è¯•
2. â³ æ€§èƒ½æµ‹è¯•
3. â³ æ•°æ®å‡†ç¡®æ€§éªŒè¯

### ç¬¬å››é˜¶æ®µï¼šéƒ¨ç½²ä¸Šçº¿ï¼ˆéœ€è¦æ‚¨åŒæ„ï¼‰
1. â³ éƒ¨ç½²åˆ°é¢„å‘ç¯å¢ƒ
2. â³ é¢„å‘ç¯å¢ƒéªŒè¯
3. â³ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
4. â³ ç›‘æ§å’Œä¼˜åŒ–

## å…«ã€é£é™©æ§åˆ¶

### 8.1 æŠ€æœ¯é£é™©
- **é£é™©**: ç»Ÿè®¡æ•°æ®ä¸ä¸€è‡´
- **æªæ–½**: ä¿ç•™å®æ—¶æŸ¥è¯¢é™çº§æ–¹æ¡ˆï¼Œä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶

### 8.2 æ•°æ®é£é™©
- **é£é™©**: ç¼“å­˜æ•°æ®è¿‡æœŸ
- **æªæ–½**: è®¾ç½®åˆç†çš„ç¼“å­˜æ—¶é—´ï¼Œæ”¯æŒæ‰‹åŠ¨åˆ·æ–°

### 8.3 æ€§èƒ½é£é™©
- **é£é™©**: é¢„è®¡ç®—è¡¨æ›´æ–°å»¶è¿Ÿ
- **æªæ–½**: ä½¿ç”¨å¼‚æ­¥æ›´æ–°ï¼Œä¸å½±å“ä¸»æµç¨‹

## ä¹ã€ç›‘æ§æŒ‡æ ‡

### 9.1 æ€§èƒ½æŒ‡æ ‡
- é¡µé¢åŠ è½½æ—¶é—´ < 1ç§’
- APIå“åº”æ—¶é—´ < 500ms
- æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ < 100ms

### 9.2 ä¸šåŠ¡æŒ‡æ ‡
- æ•°æ®å‡†ç¡®ç‡ 100%
- ç¼“å­˜å‘½ä¸­ç‡ > 80%
- ç”¨æˆ·æ»¡æ„åº¦æå‡

## åã€æ€»ç»“

é€šè¿‡ä»¥ä¸Šä¼˜åŒ–æ–¹æ¡ˆï¼Œé¢„æœŸå¯ä»¥å®ç°ï¼š
1. **æ€§èƒ½æå‡70-90%**
2. **æ•°æ®åº“æŸ¥è¯¢å‡å°‘80%**
3. **ç”¨æˆ·ä½“éªŒæ˜¾è‘—æ”¹å–„**
4. **ç³»ç»Ÿå¯ç»´æŠ¤æ€§å¢å¼º**

æ‰€æœ‰ä¼˜åŒ–éƒ½æ˜¯æ¸è¿›å¼çš„ï¼Œå¯ä»¥æ ¹æ®å®é™…æ•ˆæœé€æ­¥æ¨è¿›ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§ã€‚

---
*æ–‡æ¡£ç‰ˆæœ¬ï¼šv1.0*
*æ›´æ–°æ—¶é—´ï¼š2024-12-19*
*ä½œè€…ï¼šClaude Assistant*