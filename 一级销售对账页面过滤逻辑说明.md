# 📊 一级销售对账页面过滤逻辑说明

## 🔍 当前过滤逻辑

### 1️⃣ 我的订单列表
**过滤条件：**
- ✅ **只显示已确认的订单**
  - `confirmed` - 已确认
  - `confirmed_config` - 已配置确认
  - `confirmed_configuration` - 已配置确认（兼容）
  - `active` - 活跃订单
- ❌ **不显示的订单状态：**
  - `pending_payment` - 待支付
  - `pending_config` - 待配置
  - `cancelled` - 已取消
  - `rejected` - 已拒绝
  - `refunded` - 已退款

**排序规则：**
- 按创建时间倒序（最新的在前）
- 最多显示100条记录

**数据来源：**
```sql
SELECT * FROM orders 
WHERE sales_code IN (一级销售及其下属二级销售的sales_code)
AND status IN ('confirmed', 'confirmed_config', 'confirmed_configuration', 'active')
ORDER BY created_at DESC
LIMIT 100
```

### 2️⃣ 二级销售管理列表
**过滤条件：**
- 显示该一级销售管理的所有二级销售
- 条件：`primary_sales_id = 当前一级销售ID`

**统计数据：**
- **总订单数**：该二级销售的所有订单数量
- **已确认订单数**：状态为已确认的订单数量
- **总金额**：已确认订单的总金额
- **佣金**：总金额 × 佣金率

**特点：**
- 显示所有二级销售，不管有没有订单
- 实时计算统计数据

### 3️⃣ 待催单订单列表
**过滤条件：**
- 状态为待处理的订单：
  - `pending_payment` - 待支付
  - `pending_config` - 待配置

**用途：**
- 需要销售人员跟进的订单
- 提醒销售联系客户完成支付或配置

## 📝 更新说明

### 已完成的修改：
1. ✅ **移除了"我的订单列表"的操作列**
   - 不再显示催单按钮
   - 简化界面显示

2. ✅ **销售人员列显示优化**
   - 显示具体的销售微信号
   - 直接销售显示"直接销售"标签
   - 二级销售显示其微信号

## 💡 使用说明

### 查询一级销售数据：
1. 输入一级销售微信号
2. 点击查询
3. 系统会显示：
   - 该一级销售的直接订单
   - 所有下属二级销售的订单
   - 综合统计数据

### 数据刷新：
- 每30秒自动刷新一次
- 可点击"刷新"按钮手动刷新

### 佣金计算：
- **一级销售佣金**：基于动态公式计算
- **二级销售佣金**：由一级销售设置（默认30%）

## 🔧 技术细节

### 数据获取流程：
1. 查询一级销售信息
2. 获取所有关联的二级销售
3. 收集所有销售代码
4. 查询符合条件的订单
5. 计算统计数据
6. 返回给前端显示

### 性能优化：
- 限制订单返回数量（100条）
- 使用索引查询
- 并行获取数据
- 缓存30秒自动更新

## 📌 注意事项
- 订单金额优先使用`actual_payment_amount`（实付金额）
- 如果没有实付金额，则使用`amount`（订单金额）
- 支付宝订单自动转换汇率（7.15）
- 佣金率为0时正常显示，不会显示"未设置"
