# ğŸ“ å‰ç«¯ä½£é‡‘ç‡ä¿®å¤ç¤ºä¾‹

## éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶å’Œå…·ä½“æ”¹åŠ¨

### 1. AdminSales.js - ç®¡ç†å‘˜é”€å”®ç®¡ç†é¡µé¢

```javascript
// åœ¨æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥å·¥å…·å‡½æ•°
import { 
  formatCommissionRate, 
  calculatePrimaryCommissionRate as calculateRate,
  percentToDecimal 
} from '../../utils/commissionUtils';

// ä¿®æ”¹ä½£é‡‘ç‡è®¡ç®—å‡½æ•°ï¼ˆçº¦102-148è¡Œï¼‰
const calculatePrimaryCommissionRate = (record) => {
  if (!record.orders || record.orders.length === 0) {
    return 40; // è¿”å›ç™¾åˆ†æ¯”æ•°å­—ç”¨äºæ˜¾ç¤º
  }
  
  const confirmedOrders = record.orders;
  if (confirmedOrders.length === 0) {
    return 40;
  }
  
  // è®¡ç®—å„é¡¹é‡‘é¢
  const primaryDirectOrders = confirmedOrders.filter(order => !order.secondary_sales_name);
  const primaryDirectAmount = primaryDirectOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  const secondaryOrders = confirmedOrders.filter(order => order.secondary_sales_name);
  const secondaryTotalAmount = secondaryOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  // è·å–äºŒçº§é”€å”®ä½£é‡‘ç‡ï¼ˆç¡®ä¿æ˜¯å°æ•°æ ¼å¼ï¼‰
  const secondaryRates = record.secondary_sales?.map(sales => {
    const rate = sales.commission_rate || 0.3;
    // å…¼å®¹å¤„ç†ï¼šå¦‚æœæ˜¯ç™¾åˆ†æ¯”åˆ™è½¬æ¢
    return rate > 1 ? rate / 100 : rate;
  }) || [];
  
  // ä½¿ç”¨å·¥å…·å‡½æ•°è®¡ç®—
  const rate = calculateRate({
    primaryDirectAmount,
    secondaryTotalAmount,
    secondaryRates
  });
  
  // è¿”å›ç™¾åˆ†æ¯”æ•°å­—ç”¨äºæ˜¾ç¤º
  return (rate * 100).toFixed(1);
};

// ä¿®æ”¹è¡¨æ ¼åˆ—ä¸­çš„ä½£é‡‘ç‡æ˜¾ç¤ºï¼ˆçº¦375è¡Œï¼‰
{
  title: 'ä½£é‡‘ç‡',
  key: 'commission_rate',
  width: 120,
  render: (_, record) => {
    if (record.sales_type === 'primary') {
      const rate = calculatePrimaryCommissionRate(record);
      return `${rate}%`;
    }
    
    // äºŒçº§é”€å”®ç›´æ¥æ˜¾ç¤º
    const rate = record.sales?.commission_rate || 0.3;
    return formatCommissionRate(rate);
  }
}

// ä¿®æ”¹ä½£é‡‘ç‡æ›´æ–°å¤„ç†ï¼ˆçº¦255è¡Œï¼‰
const handleCommissionUpdate = async (salesId) => {
  const newRate = editingCommissionRates[salesId];
  if (newRate === undefined) return;
  
  // è½¬æ¢ä¸ºå°æ•°æ ¼å¼å†ä¿å­˜
  const decimalRate = percentToDecimal(newRate);
  
  try {
    await dispatch(updateSalesCommissionRate({ 
      salesId, 
      salesType: 'secondary',
      commissionRate: decimalRate  // ä¼ é€’å°æ•°æ ¼å¼
    })).unwrap();
    
    message.success('ä½£é‡‘ç‡æ›´æ–°æˆåŠŸ');
    setEditingCommissionRates({});
    dispatch(getAdminSales());
  } catch (error) {
    message.error('æ›´æ–°å¤±è´¥');
  }
};
```

### 2. AdminCustomers.js - å®¢æˆ·ç®¡ç†é¡µé¢

```javascript
// å¯¼å…¥å·¥å…·å‡½æ•°
import { formatCommissionAmount } from '../../utils/commissionUtils';

// ä¿®æ”¹è¿”ä½£é‡‘é¢æ˜¾ç¤ºï¼ˆçº¦136è¡Œï¼‰
{
  title: 'è¿”ä½£é‡‘é¢',
  dataIndex: 'commission_amount',
  key: 'commission_amount',
  width: 100,
  render: (amount) => formatCommissionAmount(amount)
}
```

### 3. PrimarySalesSettlementPage.js - ä¸€çº§é”€å”®ç»“ç®—é¡µé¢

```javascript
// å¯¼å…¥å·¥å…·å‡½æ•°
import { 
  formatCommissionRate,
  percentToDecimal,
  decimalToPercent,
  calculatePrimaryCommissionRate
} from '../utils/commissionUtils';

// ä¿®æ”¹ä½£é‡‘ç‡è¾“å…¥è¡¨å•ï¼ˆçº¦766è¡Œï¼‰
<Form.Item
  name="commission_rate"
  label="ä½£é‡‘ç‡ (%)"
  rules={[
    { required: true, message: 'è¯·è¾“å…¥ä½£é‡‘ç‡' },
    { type: 'number', min: 0, max: 40, message: 'ä½£é‡‘ç‡å¿…é¡»åœ¨0-40%ä¹‹é—´' }
  ]}
>
  <InputNumber
    min={0}
    max={40}
    step={0.1}
    precision={1}
    placeholder="è¯·è¾“å…¥ä½£é‡‘ç‡"
    addonAfter="%"
  />
</Form.Item>

// ä¿®æ”¹æäº¤å¤„ç†ï¼ˆçº¦420è¡Œï¼‰
const handleCommissionSubmit = async () => {
  try {
    const values = await commissionForm.validateFields();
    const commissionRate = percentToDecimal(values.commission_rate); // è½¬æ¢ä¸ºå°æ•°
    
    // è°ƒç”¨APIæ›´æ–°
    await dispatch(updateSecondaryCommissionRate({
      secondarySalesId: selectedSecondarySales.id,
      commissionRate  // ä¼ é€’å°æ•°æ ¼å¼
    })).unwrap();
    
    message.success('ä½£é‡‘ç‡è®¾ç½®æˆåŠŸ');
    setCommissionModalVisible(false);
  } catch (error) {
    message.error('è®¾ç½®å¤±è´¥');
  }
};

// ä¿®æ”¹è¡¨æ ¼æ˜¾ç¤ºï¼ˆçº¦350è¡Œï¼‰
{
  title: 'å½“å‰ä½£é‡‘ç‡',
  dataIndex: 'commission_rate',
  key: 'commission_rate',
  width: 100,
  render: (rate) => formatCommissionRate(rate || 0.3)
}

// ç¼–è¾‘æ—¶è®¾ç½®åˆå§‹å€¼ï¼ˆçº¦413è¡Œï¼‰
const handleEditCommission = (secondarySales) => {
  setSelectedSecondarySales(secondarySales);
  commissionForm.setFieldsValue({
    commission_rate: decimalToPercent(secondarySales.commission_rate || 0.3)
  });
  setCommissionModalVisible(true);
};
```

### 4. api.js - APIå±‚å¤„ç†

```javascript
// ä¿®æ”¹ä½£é‡‘è®¡ç®—å‡½æ•°ï¼ˆçº¦1230è¡Œï¼‰
async calculateCommission(salesCode, amount) {
  const salesResult = await SalesAPI.getSalesByCode(salesCode);
  if (!salesResult.success) {
    throw new Error('é”€å”®ä»£ç ä¸å­˜åœ¨');
  }
  
  const sale = salesResult.data;
  // ç¡®ä¿ä½£é‡‘ç‡æ˜¯å°æ•°æ ¼å¼
  let commissionRate = sale.commission_rate;
  
  // å…¼å®¹æ€§å¤„ç†ï¼ˆè™½ç„¶ä¸éœ€è¦ï¼Œä½†ä»¥é˜²ä¸‡ä¸€ï¼‰
  if (commissionRate > 1) {
    commissionRate = commissionRate / 100;
  }
  
  // é»˜è®¤å€¼ï¼šä¸€çº§40%ï¼ŒäºŒçº§30%
  if (!commissionRate) {
    commissionRate = sale.type === 'primary' ? 0.4 : 0.3;
  }
  
  const commission = parseFloat(amount) * commissionRate;
  
  return {
    commission,
    type: sale.type,
    rate: commissionRate  // è¿”å›å°æ•°æ ¼å¼
  };
}

// ä¿®æ”¹é”€å”®æ•°æ®å¤„ç†ï¼ˆçº¦511è¡Œï¼‰
// äºŒçº§é”€å”®ä½£é‡‘ç‡å¤„ç†
let commissionRate = sale.commission_rate || 0.3; // é»˜è®¤30%

// ç¡®ä¿æ˜¯å°æ•°æ ¼å¼ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰
if (commissionRate > 1) {
  commissionRate = commissionRate / 100;
}
```

## ä½¿ç”¨ç¤ºä¾‹

### æ˜¾ç¤ºä½£é‡‘ç‡
```javascript
// ä»æ•°æ®åº“è·å–ï¼š0.3
// æ˜¾ç¤ºç»™ç”¨æˆ·ï¼š30%
<span>{formatCommissionRate(record.commission_rate)}</span>
```

### ç”¨æˆ·è¾“å…¥ä½£é‡‘ç‡
```javascript
// ç”¨æˆ·è¾“å…¥ï¼š30
// è½¬æ¢å­˜å‚¨ï¼š0.3
<InputNumber
  onChange={(value) => {
    const decimalRate = percentToDecimal(value);
    // ä¿å­˜ decimalRate åˆ°æ•°æ®åº“
  }}
/>
```

### ç¼–è¾‘æ—¶å›æ˜¾
```javascript
// æ•°æ®åº“å€¼ï¼š0.3
// è¡¨å•æ˜¾ç¤ºï¼š30
form.setFieldsValue({
  commission_rate: decimalToPercent(data.commission_rate)
});
```

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“å­˜å‚¨**ï¼šå§‹ç»ˆä½¿ç”¨å°æ•°æ ¼å¼ï¼ˆ0.3ï¼‰
2. **APIä¼ è¾“**ï¼šä½¿ç”¨å°æ•°æ ¼å¼
3. **ç”¨æˆ·ç•Œé¢**ï¼š
   - æ˜¾ç¤ºæ—¶è½¬æ¢ä¸ºç™¾åˆ†æ¯”ï¼ˆ30%ï¼‰
   - è¾“å…¥æ—¶æ¥å—ç™¾åˆ†æ¯”æ•°å­—ï¼ˆ30ï¼‰ï¼Œå­˜å‚¨å‰è½¬æ¢ä¸ºå°æ•°
4. **è®¡ç®—é€»è¾‘**ï¼šå…¨éƒ¨ä½¿ç”¨å°æ•°è¿›è¡Œè®¡ç®—ï¼Œé¿å…æ··ä¹±
5. **ç²¾åº¦å¤„ç†**ï¼šä½£é‡‘é‡‘é¢ä¿ç•™2ä½å°æ•°ï¼Œä½£é‡‘ç‡æ˜¾ç¤ºä¿ç•™1ä½å°æ•°
