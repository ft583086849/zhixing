# 📝 前端佣金率修复示例

## 需要修改的文件和具体改动

### 1. AdminSales.js - 管理员销售管理页面

```javascript
// 在文件顶部导入工具函数
import { 
  formatCommissionRate, 
  calculatePrimaryCommissionRate as calculateRate,
  percentToDecimal 
} from '../../utils/commissionUtils';

// 修改佣金率计算函数（约102-148行）
const calculatePrimaryCommissionRate = (record) => {
  if (!record.orders || record.orders.length === 0) {
    return 40; // 返回百分比数字用于显示
  }
  
  const confirmedOrders = record.orders;
  if (confirmedOrders.length === 0) {
    return 40;
  }
  
  // 计算各项金额
  const primaryDirectOrders = confirmedOrders.filter(order => !order.secondary_sales_name);
  const primaryDirectAmount = primaryDirectOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  const secondaryOrders = confirmedOrders.filter(order => order.secondary_sales_name);
  const secondaryTotalAmount = secondaryOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
  
  // 获取二级销售佣金率（确保是小数格式）
  const secondaryRates = record.secondary_sales?.map(sales => {
    const rate = sales.commission_rate || 0.3;
    // 兼容处理：如果是百分比则转换
    return rate > 1 ? rate / 100 : rate;
  }) || [];
  
  // 使用工具函数计算
  const rate = calculateRate({
    primaryDirectAmount,
    secondaryTotalAmount,
    secondaryRates
  });
  
  // 返回百分比数字用于显示
  return (rate * 100).toFixed(1);
};

// 修改表格列中的佣金率显示（约375行）
{
  title: '佣金率',
  key: 'commission_rate',
  width: 120,
  render: (_, record) => {
    if (record.sales_type === 'primary') {
      const rate = calculatePrimaryCommissionRate(record);
      return `${rate}%`;
    }
    
    // 二级销售直接显示
    const rate = record.sales?.commission_rate || 0.3;
    return formatCommissionRate(rate);
  }
}

// 修改佣金率更新处理（约255行）
const handleCommissionUpdate = async (salesId) => {
  const newRate = editingCommissionRates[salesId];
  if (newRate === undefined) return;
  
  // 转换为小数格式再保存
  const decimalRate = percentToDecimal(newRate);
  
  try {
    await dispatch(updateSalesCommissionRate({ 
      salesId, 
      salesType: 'secondary',
      commissionRate: decimalRate  // 传递小数格式
    })).unwrap();
    
    message.success('佣金率更新成功');
    setEditingCommissionRates({});
    dispatch(getAdminSales());
  } catch (error) {
    message.error('更新失败');
  }
};
```

### 2. AdminCustomers.js - 客户管理页面

```javascript
// 导入工具函数
import { formatCommissionAmount } from '../../utils/commissionUtils';

// 修改返佣金额显示（约136行）
{
  title: '返佣金额',
  dataIndex: 'commission_amount',
  key: 'commission_amount',
  width: 100,
  render: (amount) => formatCommissionAmount(amount)
}
```

### 3. PrimarySalesSettlementPage.js - 一级销售结算页面

```javascript
// 导入工具函数
import { 
  formatCommissionRate,
  percentToDecimal,
  decimalToPercent,
  calculatePrimaryCommissionRate
} from '../utils/commissionUtils';

// 修改佣金率输入表单（约766行）
<Form.Item
  name="commission_rate"
  label="佣金率 (%)"
  rules={[
    { required: true, message: '请输入佣金率' },
    { type: 'number', min: 0, max: 40, message: '佣金率必须在0-40%之间' }
  ]}
>
  <InputNumber
    min={0}
    max={40}
    step={0.1}
    precision={1}
    placeholder="请输入佣金率"
    addonAfter="%"
  />
</Form.Item>

// 修改提交处理（约420行）
const handleCommissionSubmit = async () => {
  try {
    const values = await commissionForm.validateFields();
    const commissionRate = percentToDecimal(values.commission_rate); // 转换为小数
    
    // 调用API更新
    await dispatch(updateSecondaryCommissionRate({
      secondarySalesId: selectedSecondarySales.id,
      commissionRate  // 传递小数格式
    })).unwrap();
    
    message.success('佣金率设置成功');
    setCommissionModalVisible(false);
  } catch (error) {
    message.error('设置失败');
  }
};

// 修改表格显示（约350行）
{
  title: '当前佣金率',
  dataIndex: 'commission_rate',
  key: 'commission_rate',
  width: 100,
  render: (rate) => formatCommissionRate(rate || 0.3)
}

// 编辑时设置初始值（约413行）
const handleEditCommission = (secondarySales) => {
  setSelectedSecondarySales(secondarySales);
  commissionForm.setFieldsValue({
    commission_rate: decimalToPercent(secondarySales.commission_rate || 0.3)
  });
  setCommissionModalVisible(true);
};
```

### 4. api.js - API层处理

```javascript
// 修改佣金计算函数（约1230行）
async calculateCommission(salesCode, amount) {
  const salesResult = await SalesAPI.getSalesByCode(salesCode);
  if (!salesResult.success) {
    throw new Error('销售代码不存在');
  }
  
  const sale = salesResult.data;
  // 确保佣金率是小数格式
  let commissionRate = sale.commission_rate;
  
  // 兼容性处理（虽然不需要，但以防万一）
  if (commissionRate > 1) {
    commissionRate = commissionRate / 100;
  }
  
  // 默认值：一级40%，二级30%
  if (!commissionRate) {
    commissionRate = sale.type === 'primary' ? 0.4 : 0.3;
  }
  
  const commission = parseFloat(amount) * commissionRate;
  
  return {
    commission,
    type: sale.type,
    rate: commissionRate  // 返回小数格式
  };
}

// 修改销售数据处理（约511行）
// 二级销售佣金率处理
let commissionRate = sale.commission_rate || 0.3; // 默认30%

// 确保是小数格式（兼容性处理）
if (commissionRate > 1) {
  commissionRate = commissionRate / 100;
}
```

## 使用示例

### 显示佣金率
```javascript
// 从数据库获取：0.3
// 显示给用户：30%
<span>{formatCommissionRate(record.commission_rate)}</span>
```

### 用户输入佣金率
```javascript
// 用户输入：30
// 转换存储：0.3
<InputNumber
  onChange={(value) => {
    const decimalRate = percentToDecimal(value);
    // 保存 decimalRate 到数据库
  }}
/>
```

### 编辑时回显
```javascript
// 数据库值：0.3
// 表单显示：30
form.setFieldsValue({
  commission_rate: decimalToPercent(data.commission_rate)
});
```

## 注意事项

1. **数据库存储**：始终使用小数格式（0.3）
2. **API传输**：使用小数格式
3. **用户界面**：
   - 显示时转换为百分比（30%）
   - 输入时接受百分比数字（30），存储前转换为小数
4. **计算逻辑**：全部使用小数进行计算，避免混乱
5. **精度处理**：佣金金额保留2位小数，佣金率显示保留1位小数
