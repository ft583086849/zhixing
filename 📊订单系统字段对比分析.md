# 📊 订单系统字段对比分析

> 创建时间：2025-08-15
> 目的：对比后台订单管理页面显示的字段与数据库实际存储的字段

## 一、订单管理页面显示的字段

### 前端AdminOrders.js中展示的列：
1. **用户微信号** - customer_wechat ✅
2. **销售类型** - 通过逻辑判断（不是直接字段）⚠️
3. **销售微信号** - 从关联表获取 ⚠️
4. **一级销售微信** - 从关联表获取 ⚠️
5. **TradingView用户** - tradingview_username ✅
6. **购买时长** - duration ✅
7. **购买方式** - purchase_type ✅
8. **生效时间** - effective_time ✅
9. **到期时间** - expiry_time ✅
10. **应付金额** - amount ✅
11. **实付金额** - alipay_amount/crypto_amount ✅
12. **一级销售佣金额** - 计算得出（amount * 0.4）⚠️
13. **二级分销佣金额** - commission_amount ✅
14. **付款方式** - payment_method ✅
15. **订单状态** - status ✅
16. **付款截图** - screenshot_data ✅
17. **配置确认时间** - effective_time（重复）✅
18. **操作** - 按钮操作

## 二、数据库orders表实际字段

### 存在且使用的字段：
✅ customer_wechat - 客户微信
✅ tradingview_username - TradingView用户名
✅ amount - 订单金额
✅ actual_payment_amount - 实际支付金额
✅ alipay_amount - 支付宝金额
✅ crypto_amount - 加密货币金额
✅ status - 订单状态
✅ payment_method - 支付方式
✅ payment_time - 支付时间
✅ duration - 订阅时长
✅ purchase_type - 购买类型
✅ effective_time - 生效时间
✅ expiry_time - 到期时间
✅ commission_rate - 佣金率
✅ commission_amount - 佣金金额
✅ screenshot_data - 截图数据
✅ config_confirmed - 配置确认

### 存在但页面未直接显示的字段：
- id - 主键
- order_number - 订单号
- customer_name - 客户姓名
- customer_phone - 客户电话
- customer_email - 客户邮箱
- payment_status - 支付状态
- sales_code - 销售代码
- link_code - 链接代码
- sales_type - 销售类型
- primary_sales_id - 一级销售ID
- secondary_sales_id - 二级销售ID
- screenshot_path - 截图路径
- created_at - 创建时间
- updated_at - 更新时间
- submit_time - 提交时间

## 三、问题分析

### 1. 字段冗余问题
- **screenshot_path** 和 **screenshot_data** 都存在，但只用了screenshot_data
- **link_code** 字段全是NULL，实际用sales_code
- **customer_name/phone/email** 基本不用，只用customer_wechat

### 2. 关联查询问题
页面显示的以下信息需要关联查询：
- **销售微信号** - 需要通过sales_code或sales_id关联secondary_sales表
- **销售类型** - 需要判断逻辑，不是直接从字段获取
- **一级销售微信** - 需要通过primary_sales_id关联

### 3. 计算字段问题
- **一级销售佣金** - 硬编码40%计算，没有从数据库读取
- **销售类型判断** - 通过复杂逻辑判断，不是直接字段

## 四、优化建议

### 1. 清理冗余字段
建议删除或标记为废弃：
- customer_name（用customer_wechat即可）
- customer_phone（基本不用）
- customer_email（基本不用）
- screenshot_path（用screenshot_data）
- link_code（用sales_code）

### 2. 添加必要字段
建议在orders表直接存储：
```sql
ALTER TABLE orders ADD COLUMN IF NOT EXISTS sales_wechat_name VARCHAR(100);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS primary_sales_wechat_name VARCHAR(100);
ALTER TABLE orders ADD COLUMN IF NOT EXISTS calculated_sales_type VARCHAR(20);
```

### 3. 优化关联查询
创建视图简化查询：
```sql
CREATE VIEW order_details AS
SELECT 
  o.*,
  s.wechat_name as sales_wechat_name,
  ps.wechat_name as primary_sales_wechat_name,
  CASE 
    WHEN s.sales_type = 'primary' THEN 'primary'
    WHEN s.primary_sales_id IS NOT NULL THEN 'secondary'
    ELSE 'independent'
  END as calculated_sales_type
FROM orders o
LEFT JOIN secondary_sales s ON o.sales_code = s.sales_code
LEFT JOIN secondary_sales ps ON s.primary_sales_id = ps.id;
```

## 五、销售表（secondary_sales）分析

### 使用的字段：
✅ sales_code - 销售代码
✅ wechat_name - 微信名称
✅ payment_method - 支付方式
✅ payment_address - 收款地址
✅ chain_name - 链名
✅ sales_type - 销售类型
✅ primary_sales_id - 上级销售ID
✅ commission_rate - 佣金率

### 废弃但存在的字段：
- name - 姓名
- phone - 电话
- email - 邮箱
- alipay_account - 支付宝账号
- alipay_surname - 支付宝姓氏
- line_address_code - 线上地址码
- line_name - 线名

## 六、用户表分析

**问题：系统中没有独立的用户表！**

当前用户信息分散在orders表中：
- customer_wechat - 客户微信
- customer_name - 客户姓名（基本不用）
- tradingview_username - TradingView用户名

### 建议创建用户表：
```sql
CREATE TABLE customers (
  id SERIAL PRIMARY KEY,
  wechat_name VARCHAR(100) UNIQUE NOT NULL,
  tradingview_username VARCHAR(100),
  total_orders INTEGER DEFAULT 0,
  total_amount DECIMAL(10,2) DEFAULT 0,
  first_order_date TIMESTAMP,
  last_order_date TIMESTAMP,
  status VARCHAR(20) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 七、总结与建议

### 当前问题：
1. ❌ **没有独立的用户表** - 用户信息散落在订单表中
2. ⚠️ **字段冗余** - 多个未使用的字段
3. ⚠️ **关联查询复杂** - 销售信息需要多表关联
4. ⚠️ **计算逻辑分散** - 佣金计算硬编码在前端

### 改进方案：
1. **创建customers表** - 集中管理用户信息
2. **清理冗余字段** - 删除未使用的字段
3. **优化表结构** - 在orders表添加常用的关联信息
4. **创建视图** - 简化复杂查询
5. **统一计算逻辑** - 佣金计算放在数据库或后端

### 数据一致性原则：
- **订单表**应包含所有订单相关字段
- **销售表**应包含所有销售人员信息
- **用户表**应包含所有客户信息
- 避免跨表存储同一类信息