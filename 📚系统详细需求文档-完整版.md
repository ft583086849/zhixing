# 📚 知行财库系统详细需求文档 - 完整版

> 创建时间：2025-08-15  
> 系统版本：v2.12.0  
> 文档状态：详细版本（包含所有字段和逻辑）

---

## 第一部分：产品与定价

### 1.1 产品定价（基于PurchasePage.js实际代码）
```javascript
const durationOptions = [
  { value: '7days', label: '7天免费', price: 0 },
  { value: '1month', label: '1个月', price: 188 },
  { value: '3months', label: '3个月', price: 488 },
  { value: '6months', label: '6个月', price: 888 },
  { value: '1year', label: '1年', price: 1588 }
];
```
**中文解释**：产品时长选项数组，包含5个套餐：7天免费试用、1个月188美元、3个月488美元、6个月888美元、1年1588美元。

| 产品类型 | 实际价格 | 说明 |
|---------|---------|------|
| 7天免费 | $0 | 新用户试用，自动选择即时购买 |
| 1个月 | $188 | 基础套餐 |
| 3个月 | $488 | 标准套餐 |
| 6个月 | $888 | 高级套餐 |
| 1年 | $1588 | 年费套餐 |

---

## 第二部分：订单流转逻辑

### 2.1 完整订单流程

```
1. 客户通过销售链接进入购买页面
   └─ 链接格式：/purchase?sales_code={销售代码}

2. 客户填写订单信息
   ├─ 客户微信号（必填）
   ├─ TradingView用户名（必填）
   ├─ 选择套餐时长
   ├─ 选择购买方式（即时/延期）
   ├─ 上传付款截图
   └─ 填写实付金额

3. 订单创建
   ├─ 状态：pending_payment（待付款确认）
   ├─ 生成订单号：ORD + 时间戳
   └─ 记录销售代码

4. 管理员确认付款
   ├─ 查看付款截图
   ├─ 核对金额
   └─ 状态变更：confirmed_payment（已付款确认）

5. 管理员确认配置
   ├─ 在TradingView配置权限
   └─ 状态变更：confirmed_config（已配置确认）

6. 订单生效
   └─ 状态：active（已生效）

异常流程：
- 任何阶段都可以拒绝：→ rejected（已拒绝）
- 7天免费订单跳过付款确认：直接进入pending_config
```

### 2.2 销售归属判定逻辑

```javascript
// AdminOrders.js中的销售类型判断逻辑
if (record.secondary_sales) {
  if (record.secondary_sales.primary_sales_id) {
    return "二级销售";  // 有上级的二级销售
  } else {
    return "独立销售";  // 没有上级的独立销售
  }
} else if (record.primary_sales) {
  return "一级销售";    // 一级销售直销
}
```
**中文解释**：判断订单的销售类型逻辑：先检查是否有二级销售信息，如果有再看是否有上级（有上级=二级销售，无上级=独立销售）；如果没有二级销售信息但有一级销售信息，则为一级销售直销。

---

## 第三部分：管理员功能详细字段

### 3.1 数据概览页面（AdminOverview.js）

#### 3.1.1 核心统计卡片
| 字段名 | 显示标题 | 数据来源 | 计算逻辑 | 交互 |
|--------|---------|---------|---------|------|
| total_orders | 总订单数 | stats.total_orders | COUNT(orders) WHERE status != 'rejected' | 无 |
| pending_payment_orders | 待付款确认订单 | stats.pending_payment_orders | COUNT WHERE status='pending_payment' | 点击跳转订单页面 |
| pending_config_orders | 待配置确认订单 | stats.pending_config_orders | COUNT WHERE status='pending_config' | 点击跳转订单页面 |
| confirmed_config_orders | 已配置确认订单 | stats.confirmed_config_orders | COUNT WHERE status='confirmed_config' | 无 |
| total_amount | 总收入 | stats.total_amount | SUM(amount) WHERE status='confirmed_config' | 无 |
| commission_amount | 销售返佣金额 | stats.commission_amount | SUM(commission_amount) | 点击跳转销售管理 |
| pending_commission_amount | 待返佣金金额 | stats.pending_commission_amount | SUM WHERE settlement_status='pending' | 无 |

#### 3.1.2 销售层级统计
| 字段组 | 包含字段 | 计算逻辑 |
|--------|---------|---------|
| 一级销售 | primary_sales_count（数量）<br>primary_sales_amount（业绩） | COUNT WHERE sales_type='primary'<br>SUM(amount) WHERE sales_type='primary' |
| 二级销售 | linked_secondary_sales_count（数量）<br>linked_secondary_sales_amount（业绩） | COUNT WHERE sales_type='secondary' AND primary_sales_id IS NOT NULL<br>SUM(amount) |
| 独立销售 | independent_sales_count（数量）<br>independent_sales_amount（业绩） | COUNT WHERE sales_type='secondary' AND primary_sales_id IS NULL<br>SUM(amount) |

#### 3.1.3 订单分类统计（按时长）
| 时长类型 | 字段 | 显示格式 |
|---------|------|---------|
| 7天免费 | free_trial_orders / free_trial_percentage | 订单数 + 百分比进度圈 |
| 1个月 | one_month_orders / one_month_percentage | 订单数 + 百分比进度圈 |
| 3个月 | three_month_orders / three_month_percentage | 订单数 + 百分比进度圈 |
| 6个月 | six_month_orders / six_month_percentage | 订单数 + 百分比进度圈 |
| 年费 | yearly_orders / yearly_percentage | 订单数 + 百分比进度圈 |

#### 3.1.4 Top5销售排行榜
```javascript
// 智能去重逻辑（AdminOverview.js line 66-98）
// 如果二级销售金额 >= 一级销售自营金额，只显示二级销售
// 避免一级和其二级重复上榜
```
**中文解释**：Top5排行榜的智能去重机制：当某个二级销售的业绩超过或等于其所属一级销售的自营业绩时，只显示二级销售在榜单上，避免同一个销售团队重复占榜。

| 列名 | 字段 | 显示逻辑 |
|------|------|---------|
| 排名 | rank | 1-3显示奖牌图标 |
| 销售类型 | sales_type | Tag颜色：一级(blue)/二级(orange)/独立(green) |
| 销售名称 | sales_name | sales.wechat_name或sales.name |
| 所属一级 | primary_sales_name | 仅二级销售显示 |
| 销售金额 | total_amount | 格式化为美元 |
| 占比 | percentage | 占总销售额百分比 |
| 返佣金额 | commission_amount | 格式化为美元 |

### 3.2 订单管理页面（AdminOrders.js）

#### 订单列表字段
| 列名 | 字段/逻辑 | 显示说明 |
|------|----------|---------|
| 用户微信号 | customer_wechat | 客户微信 |
| 销售类型 | 判断逻辑见2.2 | Tag显示：一级/二级/独立 |
| 销售微信号 | 优先secondary_sales.wechat_name<br>其次primary_sales.wechat_name | 实际出单的销售 |
| 一级销售微信 | 如果是二级订单显示上级<br>如果是一级订单显示自己 | 一级销售信息 |
| TradingView用户 | tradingview_username | TV账号 |
| 购买时长 | duration | 7days/1month/3months/6months/1year |
| 购买方式 | purchase_type | immediate（即时）/scheduled（延期） |
| 生效时间 | effective_time | 权限生效时间 |
| 到期时间 | expiry_time | 权限到期时间 |
| 应付金额 | amount | 订单原价 |
| 实付金额 | crypto_amount | 实际支付金额 |
| 一级销售佣金额 | 计算：amount × 0.4（一级直销）<br>或 amount × (0.4 - 二级佣金率) | 一级销售获得的佣金 |
| 二级分销佣金额 | commission_amount | 二级销售获得的佣金 |
| 付款方式 | payment_method | crypto（加密货币） |
| 订单状态 | status | pending_payment/confirmed_payment等 |
| 付款截图 | screenshot_data | 可点击查看大图 |
| 配置确认时间 | effective_time | 配置完成时间 |
| 操作 | - | 确认付款/确认配置/拒绝按钮 |

### 3.3 销售管理页面字段

需要区分：
- 一级销售：显示直销订单金额 + 二级分销收益
- 二级销售：显示自己的订单金额
- 独立销售：显示自己的订单金额

### 3.4 资金统计页面（AdminFinance.js）

#### 核心财务指标表
| 指标 | 计算逻辑 | 说明 |
|------|---------|------|
| 总收入 | 所有订单金额总和 | 包含未确认订单 |
| 总实付金额 | 已确认订单的实付金额 | 只算confirmed_config |
| 销售返佣金额 | 基于实付金额计算的返佣 | 总佣金池 |
| 待返佣金额 | 未确认订单的佣金 | 待结算部分 |
| 营利金额 | 总实付金额 - 销售返佣金额 | 公司净收入 |

#### 收益分配方案（基于总实付金额）
```javascript
// 默认分配比例
profitRatios = {
  public: 40,     // 公户占比（包含子项）
  marketing: 10,  // 营销费用（公户子项）
  dividend: 15,   // 分红（公户子项）
  development: 15,// 开发费用（公户子项）
  zhixing: 35,    // 知行占比
  zijun: 25       // 子俊占比
}
// 总和 = 100%
```
**中文解释**：收益分配方案的默认比例设置。总收入按以下比例分配：公户40%（其中营销10%、分红15%、开发15%），知行个人35%，子俊个人25%，总计100%。

---

## 第四部分：一级销售功能详细

### 4.1 一级销售对账页面（PrimarySalesSettlementPage.js）

#### 4.1.1 统计卡片
| 卡片标题 | 字段 | 计算逻辑 | 新增标记 |
|---------|------|---------|---------|
| 总佣金收入 | totalCommission | 直销佣金 + 分销收益 | |
| 本月佣金 | monthlyCommission | 当月所有佣金 | |
| 当日佣金 | todayCommission | 今日佣金 | |
| 一级销售佣金额 | direct_commission | 直销订单 × 40% | |
| 平均二级佣金率 | secondary_avg_rate | AVG(二级佣金率) | |
| 二级佣金收益额 | secondary_share_commission | 分销差额收益 | |
| 二级销售订单总额 | secondary_orders_amount | 所有二级订单金额 | |

#### 4.1.2 链接展示
- 用户购买链接：`/purchase?sales_code={sales_code}`
- 二级销售注册链接：`/secondary-sales?registration_code={sales_code}`

#### 4.1.3 二级销售管理表格
| 列名 | 字段 | 功能 |
|------|------|------|
| 微信号 | wechat_name | 二级销售微信 |
| 收款方式 | payment_method | crypto/alipay/wechat |
| 总订单金额 | total_amount | 该二级的总业绩 |
| 当前佣金率 | commission_rate | 可调整（0-40%） |
| 累计佣金 | total_commission | 该二级获得的总佣金 |
| 订单数量 | order_count | 订单数 |
| 注册时间 | created_at | 加入时间 |
| 购买链接 | - | 复制该二级的购买链接 |
| 操作 | - | 设置佣金/移除按钮 |

#### 4.1.4 订单列表（新增需求）🆕
显示所有相关订单，包含状态变更通知：
- 哪些订单被确认了
- 哪些订单被拒绝了
- 实时推送通知

### 4.2 二级销售对账页面（SalesReconciliationPage.js）

#### 4.2.1 实时对账明细 🆕
| 列名 | 说明 |
|------|------|
| 时间 | 订单创建时间 |
| 订单号 | 订单编号 |
| 客户 | customer_wechat |
| 订单金额 | amount |
| 佣金率 | commission_rate |
| 佣金 | +$金额（实时显示） |
| 余额 | 当前余额（实时更新） |
| 状态 | 待确认/已确认/已结算/已支付 |

#### 4.2.2 余额卡片 🆕
- 当前余额（可提现）
- 待确认金额
- 今日收入
- 本月收入

---

## 第五部分：转化率统计需求 🆕

### 5.1 转化率排行榜位置
- 位置：AdminOverview.js的Top5销售排行榜下方
- 标题：销售转化率排行榜

### 5.2 转化率统计字段
| 字段 | 计算逻辑 | 显示格式 |
|------|---------|---------|
| 免费订单数 | COUNT WHERE duration='7days' | 数字 |
| 转化订单数 | COUNT 转为付费的订单 | 数字 |
| 转化率 | (转化订单/免费订单) × 100% | 进度条 + 百分比 |
| 转化分布 | 转为1个月/3个月/6个月/年费的数量 | 分层可视化图表 |
| 平均转化天数 | AVG(转化时间 - 试用开始时间) | X天 |
| 转化金额 | SUM(转化订单金额) | $金额 |

### 5.3 筛选功能
- 全部销售
- 一级销售
- 二级销售  
- 独立销售

---

## 第六部分：API与数据流

### 6.1 主要API端点

#### 6.1.1 统计API
```javascript
// getStats - 获取统计数据
GET /api/admin/stats
参数：{ timeRange: 'all/today/week/month/year', usePaymentTime: true }
返回：{
  total_orders, pending_payment_orders, pending_config_orders,
  confirmed_config_orders, total_amount, commission_amount,
  pending_commission_amount, primary_sales_count, primary_sales_amount,
  linked_secondary_sales_count, linked_secondary_sales_amount,
  independent_sales_count, independent_sales_amount,
  free_trial_orders, free_trial_percentage, // ... 各时长订单统计
}
```
**中文解释**：获取系统统计数据的API接口。支持按时间范围筛选（全部/今天/本周/本月/本年），返回包括订单总数、待处理订单、总收入、佣金、销售层级统计等所有核心指标数据。

#### 6.1.2 销售API
```javascript
// getSales - 获取销售列表
GET /api/admin/sales
返回：[{
  id, sales_code, wechat_name, sales_type,
  total_amount, commission_amount, order_count,
  primary_sales_id, commission_rate
}]
```
**中文解释**：获取销售人员列表的API接口。返回每个销售的基本信息（ID、代码、微信号）、业绩数据（总金额、佣金、订单数）以及层级关系（上级ID、佣金率）。

#### 6.1.3 对账API
```javascript
// getPrimarySalesSettlement - 一级销售对账
GET /api/sales/primary-settlement
参数：{ wechat_name, sales_code }
返回：{
  sales: {...},           // 销售信息
  orders: [...],          // 相关订单
  secondarySales: [...],  // 下属二级销售
  reminderOrders: [...],  // 待催单订单
  stats: {                // 统计数据
    totalCommission, monthCommission, todayCommission,
    totalOrders, monthOrders, todayOrders,
    currentCommissionRate, direct_commission,
    secondary_avg_rate, secondary_share_commission
  }
}
```
**中文解释**：一级销售对账页面的API接口。通过微信号或销售代码查询，返回包括销售个人信息、所有相关订单、管理的二级销售团队、需要催单的订单，以及各项统计数据（总佣金、月佣金、今日佣金、平均二级佣金率、分销收益等）。

### 6.2 实时数据流（Supabase Realtime）

```javascript
// 订阅订单变化
supabase.channel('orders')
  .on('postgres_changes', { 
    event: '*', 
    schema: 'public', 
    table: 'orders' 
  }, handleOrderChange)
  
// 订阅对账记录（新增）
supabase.channel('reconciliation')
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'sales_reconciliation',
    filter: `sales_code=eq.${salesCode}`
  }, handleNewReconciliation)
```
**中文解释**：Supabase实时数据订阅配置。第一个订阅监听orders表的所有变化（新增、更新、删除），用于实时更新订单状态。第二个订阅监听sales_reconciliation表的新增记录，通过sales_code过滤只接收当前销售的对账记录，实现实时对账更新。

---

## 第七部分：数据库触发器

### 7.1 订单创建触发器
```sql
CREATE TRIGGER on_order_created
AFTER INSERT ON orders
FOR EACH ROW EXECUTE FUNCTION (
  - 创建对账记录
  - 更新销售余额
  - 更新统计表
  - 创建资金流水
  - 如果是二级订单，给一级创建分销对账记录
)
```
**中文解释**：订单创建触发器，在orders表插入新记录后自动执行：1.创建对应的对账记录 2.更新销售人员的余额 3.更新各类统计表数据 4.创建资金流水记录 5.如果是二级销售的订单，同时为其上级一级销售创建分销收益对账记录。

### 7.2 订单状态变更触发器
```sql
CREATE TRIGGER on_order_status_changed
AFTER UPDATE ON orders
WHEN (NEW.status != OLD.status)
FOR EACH ROW EXECUTE FUNCTION (
  - 更新对账状态
  - 更新可提现余额
  - 发送实时通知
)
```
**中文解释**：订单状态变更触发器，当orders表的status字段发生变化时自动执行：1.更新相关对账记录的状态 2.如果订单确认则更新销售的可提现余额 3.通过WebSocket向前端发送实时状态变更通知。

---

## 第八部分：关键业务规则汇总

### 8.1 佣金计算规则（核心）
```
总佣金池 = 订单金额 × 40%

分配规则：
1. 一级销售直销订单：
   一级销售获得 = 订单金额 × 40%

2. 二级销售订单（设二级佣金率为R）：
   二级销售获得 = 订单金额 × R（默认25%，可调0-40%）
   一级销售获得 = 订单金额 × (40% - R)

3. 独立销售订单：
   独立销售获得 = 订单金额 × 25%
```
**中文解释**：佣金计算的核心规则。系统总佣金池为订单金额的40%。一级销售直销获得全部40%；二级销售订单中，二级获得可调比例R（默认25%），其上级一级获得剩余部分(40%-R)；独立销售固定获得25%。这种设计确保了总佣金支出不超过40%，同时激励一级销售发展二级团队。

#### 佣金率调整权限（重要）

**二级销售佣金率可动态调整，调整权限如下：**

| 调整主体 | 权限范围 | 调整对象 | 调整范围 | 说明 |
|---------|---------|---------|---------|------|
| **管理员** | 全局权限 | 所有二级销售 | 0%-40% | 可调整任何二级销售的佣金率 |
| **一级销售** | 团队权限 | 自己的二级销售 | 0%-40% | 只能调整属于自己团队的二级销售佣金率 |
| **二级销售** | 无权限 | - | - | 不能自行调整佣金率 |
| **独立销售** | 无权限 | - | - | 固定25%，不可调整 |

**调整规则：**
1. 二级销售佣金率默认25%，可在0%-40%之间调整
2. 调整后立即生效，应用于新订单
3. 历史订单的佣金不受影响
4. 总佣金池始终保持40%（二级佣金 + 一级抽成 = 40%）
5. 一级销售调整二级佣金率时，自己的抽成自动调整（40% - 二级佣金率）

**实例说明：**
- 二级销售佣金率调整为30%，则一级抽成变为10%
- 二级销售佣金率调整为20%，则一级抽成变为20%
- 二级销售佣金率调整为35%，则一级抽成变为5%

### 8.2 特殊规则
1. 7天免费订单：
   - 价格为0
   - 跳过付款确认，直接进入待配置
   - 不产生佣金
   - 需要统计转化率

2. 订单拒绝：
   - 任何阶段都可以拒绝
   - 拒绝的订单不计入统计
   - 不产生佣金

3. 佣金结算：
   - 订单状态为confirmed_config才算确认
   - 确认后佣金进入可提现余额
   - 支持批量结算

---

## 附录：待完善内容

1. ✅ 产品定价已更正（188/488/888/1588）
2. ✅ 数据概览字段已详细列出
3. ✅ Top5排行榜逻辑已说明（智能去重）
4. ✅ 转化率分层可视化需求已添加
5. ✅ 订单管理的销售归属逻辑已完善
6. ✅ 一级销售订单状态通知需求已添加
7. ✅ 二级销售注册链接说明已更正
8. ✅ 每个页面的字段和计算逻辑已详细列出

---

## 第九部分：数据概览页面(AdminOverview)完整需求

### 9.1 overview_stats表（核心统计表）

```sql
CREATE TABLE overview_stats (
  id SERIAL PRIMARY KEY,
  
  -- 统计维度
  stat_type VARCHAR(20) NOT NULL,        -- 'realtime'实时 / 'daily'每日 / 'period'周期
  stat_period VARCHAR(20) NOT NULL,      -- 'all' / 'today' / 'week' / 'month' / 'year' / 'custom'
  start_date DATE,                       -- 统计开始日期
  end_date DATE,                         -- 统计结束日期
  
  -- 订单统计字段
  total_orders INTEGER DEFAULT 0,                    -- 总订单数（所有状态）
  today_orders INTEGER DEFAULT 0,                    -- 今日新增订单
  pending_payment_orders INTEGER DEFAULT 0,          -- 待付款确认订单数
  confirmed_payment_orders INTEGER DEFAULT 0,        -- 已付款确认订单数
  pending_config_orders INTEGER DEFAULT 0,           -- 待配置确认订单数  
  confirmed_config_orders INTEGER DEFAULT 0,         -- 已配置确认订单数
  rejected_orders INTEGER DEFAULT 0,                 -- 已拒绝订单数
  active_orders INTEGER DEFAULT 0,                   -- 活跃订单数
  
  -- 金额统计字段（美元）
  total_amount DECIMAL(10,2) DEFAULT 0,             -- 总收入金额
  today_amount DECIMAL(10,2) DEFAULT 0,             -- 今日收入
  confirmed_amount DECIMAL(10,2) DEFAULT 0,         -- 已确认订单金额
  
  -- 佣金统计字段
  total_commission DECIMAL(10,2) DEFAULT 0,         -- 应返佣金总额
  paid_commission DECIMAL(10,2) DEFAULT 0,          -- 已返佣金总额
  pending_commission DECIMAL(10,2) DEFAULT 0,       -- 待返佣金总额
  
  -- 销售层级统计
  primary_sales_count INTEGER DEFAULT 0,            -- 一级销售数量
  secondary_sales_count INTEGER DEFAULT 0,          -- 二级销售数量
  independent_sales_count INTEGER DEFAULT 0,        -- 独立销售数量
  active_sales_count INTEGER DEFAULT 0,             -- 活跃销售数（有订单的）
  
  -- 时长分布统计
  free_trial_orders INTEGER DEFAULT 0,              -- 7天免费试用订单数
  one_month_orders INTEGER DEFAULT 0,               -- 1个月订单数
  three_month_orders INTEGER DEFAULT 0,             -- 3个月订单数
  six_month_orders INTEGER DEFAULT 0,               -- 6个月订单数
  yearly_orders INTEGER DEFAULT 0,                  -- 年费订单数
  
  -- 时长占比（百分比）
  free_trial_percentage DECIMAL(5,2) DEFAULT 0,     -- 7天占比
  one_month_percentage DECIMAL(5,2) DEFAULT 0,      -- 1个月占比
  three_month_percentage DECIMAL(5,2) DEFAULT 0,    -- 3个月占比
  six_month_percentage DECIMAL(5,2) DEFAULT 0,      -- 6个月占比
  yearly_percentage DECIMAL(5,2) DEFAULT 0,         -- 年费占比
  
  -- 元数据
  last_calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  calculation_duration_ms INTEGER,                  -- 计算耗时（毫秒）
  data_version INTEGER DEFAULT 1,                   -- 数据版本号
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE UNIQUE INDEX idx_overview_stats_unique ON overview_stats(stat_type, stat_period, start_date, end_date);
CREATE INDEX idx_overview_stats_calculated ON overview_stats(last_calculated_at);
```

### 9.2 sales_ranking表（销售排行榜）

```sql
CREATE TABLE sales_ranking (
  id SERIAL PRIMARY KEY,
  
  -- 排行榜维度
  ranking_type VARCHAR(20) NOT NULL,      -- 'amount'金额 / 'orders'订单数 / 'commission'佣金
  ranking_period VARCHAR(20) NOT NULL,    -- 'all' / 'today' / 'week' / 'month' / 'year'
  rank_position INTEGER NOT NULL,         -- 排名位置 1-N
  
  -- 销售信息
  sales_id INTEGER,
  sales_code VARCHAR(50),
  sales_wechat VARCHAR(100),
  sales_type VARCHAR(20),                 -- 'primary' / 'secondary' / 'independent'
  
  -- 归属信息（二级销售显示所属一级）
  primary_sales_id INTEGER,
  primary_sales_wechat VARCHAR(100),
  
  -- 业绩数据
  total_orders INTEGER DEFAULT 0,         -- 订单数量
  total_amount DECIMAL(10,2) DEFAULT 0,   -- 销售金额
  commission_amount DECIMAL(10,2) DEFAULT 0, -- 佣金金额
  sales_percentage DECIMAL(5,2) DEFAULT 0,   -- 占总销售额百分比
  
  -- 时间范围
  start_date DATE,
  end_date DATE,
  
  -- 元数据
  last_calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_sales_ranking ON sales_ranking(ranking_type, ranking_period, rank_position);
```

### 9.3 字段计算逻辑说明

#### 订单统计逻辑

| 字段 | 计算逻辑 | SQL示例 |
|------|---------|---------|
| **total_orders** | 所有订单（包括所有状态） | `COUNT(*)` |
| **today_orders** | 今日新增（按payment_time） | `COUNT(*) WHERE DATE(payment_time) = TODAY` |
| **pending_payment_orders** | 待付款状态 | `COUNT(*) WHERE status = 'pending_payment'` |
| **pending_config_orders** | 待配置状态 | `COUNT(*) WHERE status = 'pending_config'` |
| **confirmed_config_orders** | 已确认配置 | `COUNT(*) WHERE status IN ('confirmed_config', 'active')` |
| **rejected_orders** | 已拒绝订单 | `COUNT(*) WHERE status = 'rejected'` |

#### 金额统计逻辑

| 字段 | 计算逻辑 | 说明 |
|------|---------|------|
| **total_amount** | `SUM(actual_payment_amount)` | 直接美元金额，不需要转换 |
| **today_amount** | 今日付款订单金额总和 | 按payment_time计算，美元 |
| **confirmed_amount** | 已确认订单金额 | 只计算confirmed_config状态的订单 |

#### 佣金统计逻辑

| 字段 | 计算逻辑 | 说明 |
|------|---------|------|
| **total_commission** | 所有已配置订单的佣金总和 | `SUM(amount * commission_rate)` |
| **paid_commission** | 从销售表获取已支付佣金 | `SUM(sales.paid_commission)` |
| **pending_commission** | `total_commission - paid_commission` | 待返佣金 |

#### 销售统计逻辑

| 字段 | 计算逻辑 | 说明 |
|------|---------|------|
| **primary_sales_count** | `COUNT(*) WHERE primary_sales_id IS NULL AND sales_type='primary'` | 一级销售数量 |
| **secondary_sales_count** | `COUNT(*) WHERE primary_sales_id IS NOT NULL` | 二级销售数量 |
| **independent_sales_count** | `COUNT(*) WHERE sales_type='independent'` | 独立销售数量 |
| **active_sales_count** | 有订单的销售数 | 去重sales_code |

#### 时长分布逻辑

| 字段 | 计算逻辑 | 百分比计算 |
|------|---------|-----------|
| **free_trial_orders** | `COUNT(*) WHERE duration = '7days'` | `(count/total)*100` |
| **one_month_orders** | `COUNT(*) WHERE duration = '1month'` | `(count/total)*100` |
| **three_month_orders** | `COUNT(*) WHERE duration = '3months'` | `(count/total)*100` |
| **six_month_orders** | `COUNT(*) WHERE duration = '6months'` | `(count/total)*100` |
| **yearly_orders** | `COUNT(*) WHERE duration = '1year'` | `(count/total)*100` |

### 9.4 数据更新策略

1. **实时更新触发器**（订单状态变化时）
2. **定时任务**（每5分钟更新一次）
3. **手动刷新**（管理员点击刷新按钮）

### 9.5 性能提升预期

| 指标 | 当前 | 优化后 | 提升 |
|------|------|--------|------|
| 首页加载时间 | 3-5秒 | <500ms | 90% |
| 数据库查询数 | 10+ | 2 | 80% |
| CPU使用率 | 高 | 低 | 70% |

---

## 第十部分：销售层级关系说明

### 9.1 三种销售类型定义

| 销售类型 | sales_type | primary_sales_code | 佣金模式 | 说明 |
|---------|------------|-------------------|----------|------|
| **一级销售** | 'primary' | NULL | 直销获40%全额 | 团队长，可管理二级销售 |
| **二级销售** | 'secondary' | 上级销售代码 | 获25%（可调），上级获15% | 属于某一级销售团队 |
| **独立销售** | 'independent' | NULL | 固定25% | 独立运营，无团队关系 |

### 9.2 销售关系示例

```
一级销售（张三：PRI001）
    ├── 二级销售（李四：SEC001，primary_sales_code=PRI001）
    ├── 二级销售（王五：SEC002，primary_sales_code=PRI001）
    └── 二级销售（赵六：SEC003，primary_sales_code=PRI001）

独立销售（孙七：IND001，primary_sales_code=NULL）
```

---

## 第十部分：7天免费试用转化统计需求

### 10.1 转化统计表设计

#### trial_conversion_stats表（试用转化统计）
```sql
CREATE TABLE trial_conversion_stats (
  id SERIAL PRIMARY KEY,
  
  -- 统计维度
  stat_period VARCHAR(20) NOT NULL,              -- 时间范围
  start_date DATE,                               -- 基于付费订单创建时间
  end_date DATE,
  
  -- 销售维度筛选
  sales_type VARCHAR(20),                        -- 销售类型筛选
  sales_code VARCHAR(50),                        -- 具体销售筛选
  
  -- 核心转化统计
  total_trial_orders INTEGER DEFAULT 0,          -- 7天免费试用订单总数
  converted_orders INTEGER DEFAULT 0,            -- 成功转化为付费的订单数
  conversion_rate DECIMAL(5,2) DEFAULT 0,        -- 转化率（百分比）
  
  -- 转化金额统计（美元）
  total_converted_amount DECIMAL(10,2) DEFAULT 0,
  avg_converted_amount DECIMAL(10,2) DEFAULT 0,
  
  -- 按销售类型分布
  primary_sales_conversions INTEGER DEFAULT 0,
  secondary_sales_conversions INTEGER DEFAULT 0,
  independent_sales_conversions INTEGER DEFAULT 0,
  
  -- 按时长分布（转化后购买的时长）
  converted_to_1month INTEGER DEFAULT 0,
  converted_to_3months INTEGER DEFAULT 0,
  converted_to_6months INTEGER DEFAULT 0,
  converted_to_1year INTEGER DEFAULT 0,
  
  -- 时间分析
  avg_conversion_days DECIMAL(5,2) DEFAULT 0,
  
  last_calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 10.2 转化明细表设计

#### trial_conversion_details表（转化明细）
```sql
CREATE TABLE trial_conversion_details (
  id SERIAL PRIMARY KEY,
  
  -- 试用订单信息
  trial_order_id INTEGER NOT NULL,
  trial_customer_wechat VARCHAR(100),
  trial_tradingview_username VARCHAR(100),
  trial_created_at TIMESTAMP,
  
  -- 付费订单信息
  paid_order_id INTEGER,
  paid_created_at TIMESTAMP,
  paid_amount DECIMAL(10,2),
  paid_duration VARCHAR(20),
  
  -- 销售信息
  sales_code VARCHAR(50),
  sales_type VARCHAR(20),
  primary_sales_code VARCHAR(50),  -- 仅二级销售有值
  
  -- 转化分析
  conversion_days INTEGER,
  is_converted BOOLEAN DEFAULT FALSE,
  conversion_status VARCHAR(20),
  
  converted_at TIMESTAMP
);
```

### 10.3 查询需求

**双维度筛选支持：**
1. **时间维度**：基于付费订单创建时间筛选
2. **销售维度**：支持按销售类型、具体销售筛选

**统计指标：**
- 试用订单总数
- 转化订单数和转化率
- 各销售类型的转化分布
- 平均转化天数
- 转化后的套餐分布

---

## 第十一部分：系统性能优化方案

### 11.1 数据概览页面优化（AdminOverview）

#### 11.1.1 现状问题
- **加载时间**: 3-5秒
- **问题原因**: 实时JOIN多个表，每次重新计算所有指标，无缓存机制

#### 11.1.2 优化方案

**数据库层优化：**
```sql
-- 创建预计算统计表
CREATE TABLE overview_stats (
  id SERIAL PRIMARY KEY,
  stat_type VARCHAR(50),
  stat_period VARCHAR(50),
  total_orders INTEGER,
  valid_orders INTEGER,
  rejected_orders INTEGER,
  pending_payment_orders INTEGER,
  pending_config_orders INTEGER,
  confirmed_config_orders INTEGER,
  total_amount DECIMAL(10,2),
  confirmed_amount DECIMAL(10,2),
  total_commission DECIMAL(10,2),
  paid_commission DECIMAL(10,2),
  pending_commission DECIMAL(10,2),
  primary_sales_count INTEGER,
  secondary_sales_count INTEGER,
  independent_sales_count INTEGER,
  free_trial_orders INTEGER,
  one_month_orders INTEGER,
  three_month_orders INTEGER,
  six_month_orders INTEGER,
  yearly_orders INTEGER,
  last_calculated_at TIMESTAMP DEFAULT NOW()
);
```

**API层优化：**
- 环境变量控制：REACT_APP_ENABLE_NEW_STATS=true
- 优先从预计算表读取，降级到实时查询
- 5分钟自动更新策略

**优化效果：**
- ✅ 查询时间：1764ms → 467ms（提升73.5%）
- ✅ 数据库查询：5-10个 → 1个（减少80-90%）

### 11.2 订单管理页面优化（AdminOrders）

#### 11.2.1 现状问题
- **加载时间**: 2-4秒
- **问题原因**: JOIN多表查询，无分页优化，缺少索引

#### 11.2.2 优化方案

**数据库层优化：**
```sql
-- 创建订单索引
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_sales_code ON orders(sales_code);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX idx_orders_payment_time ON orders(payment_time DESC);

-- 创建订单视图
CREATE VIEW orders_with_sales AS
SELECT 
  o.*,
  ps.wechat_name as primary_sales_name,
  ss.wechat_name as secondary_sales_name,
  c.wechat_name as customer_wechat_name
FROM orders o
LEFT JOIN primary_sales ps ON o.primary_sales_id = ps.id
LEFT JOIN secondary_sales ss ON o.secondary_sales_id = ss.id
LEFT JOIN customers c ON o.customer_id = c.id;
```

**缓存层优化：**
- OrdersCacheManager：3分钟缓存
- 多维度索引：状态、销售、客户、订单号
- 批量处理优化

**预期效果：**
- 查询时间：2-4秒 → <0.5秒
- 即时响应用户操作

### 11.3 销售管理页面优化（AdminSales）

#### 11.3.1 现状问题
- **加载时间**: 2-3秒
- **问题原因**: 循环计算每个销售业绩，实时计算佣金

#### 11.3.2 优化方案

**数据库层优化：**
```sql
-- 创建销售统计表
CREATE TABLE sales_statistics (
  id SERIAL PRIMARY KEY,
  sales_id INTEGER,
  sales_type VARCHAR(20),
  sales_code VARCHAR(50),
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  total_amount DECIMAL(10,2) DEFAULT 0,
  confirmed_amount DECIMAL(10,2) DEFAULT 0,
  commission_rate DECIMAL(5,2),
  commission_amount DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  UNIQUE(sales_id, sales_type)
);

-- 创建更新触发器
CREATE TRIGGER orders_change_trigger
AFTER INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION update_sales_statistics();
```

**缓存层优化：**
- SalesCacheManager：5分钟缓存
- 批量处理销售数据
- 并行计算优化

**预期效果：**
- 查询时间：2-3秒 → <0.5秒
- 缓存命中率 > 90%

### 11.4 客户管理页面优化（AdminCustomers）

#### 11.4.1 现状问题
- **加载时间**: 1-2秒
- **问题原因**: 客户数据分散，需计算订单统计

#### 11.4.2 优化方案

**数据库层优化：**
```sql
-- 创建客户统计视图
CREATE VIEW customer_stats AS
SELECT 
  c.id,
  c.wechat_name,
  c.email,
  COUNT(DISTINCT o.id) as total_orders,
  COUNT(DISTINCT CASE WHEN o.status = 'confirmed_config' THEN o.id END) as valid_orders,
  COALESCE(SUM(o.amount), 0) as total_spent,
  MAX(o.created_at) as last_order_date,
  s.sales_code,
  s.wechat_name as sales_name
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
LEFT JOIN secondary_sales s ON o.sales_code = s.sales_code
GROUP BY c.id, s.sales_code, s.wechat_name;

-- 创建搜索索引
CREATE INDEX idx_customers_search ON customers 
USING gin(to_tsvector('simple', wechat_name || ' ' || email || ' ' || phone));
```

**缓存层优化：**
- CustomerCacheManager：10分钟缓存
- 搜索结果缓存
- 多维度排序索引

**预期效果：**
- 查询时间：1-2秒 → <0.3秒
- 搜索响应：<100ms

### 11.5 资金统计页面优化（AdminFinance）

#### 11.5.1 现状问题
- **加载时间**: 3-5秒
- **问题原因**: 实时计算财务指标，聚合历史数据慢

#### 11.5.2 优化方案

**数据库层优化：**
```sql
-- 创建财务日报表
CREATE TABLE finance_daily_stats (
  stat_date DATE PRIMARY KEY,
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  total_revenue DECIMAL(10,2) DEFAULT 0,
  confirmed_revenue DECIMAL(10,2) DEFAULT 0,
  pending_payment DECIMAL(10,2) DEFAULT 0,
  total_commission DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  profit_amount DECIMAL(10,2) DEFAULT 0,
  profit_margin DECIMAL(5,2) DEFAULT 0,
  created_at TIMESTAMP DEFAULT NOW()
);

-- 创建月度汇总表
CREATE TABLE finance_monthly_stats (
  stat_month VARCHAR(7) PRIMARY KEY,
  total_orders INTEGER,
  total_revenue DECIMAL(10,2),
  total_commission DECIMAL(10,2),
  avg_order_value DECIMAL(10,2),
  growth_rate DECIMAL(5,2)
);
```

**缓存层优化：**
- FinanceCacheManager：15分钟缓存
- 日报、月报分级缓存
- 趋势数据预计算

**预期效果：**
- 查询时间：3-5秒 → <1秒
- 报表生成：即时返回

### 11.6 实施计划

#### 第一阶段：本地测试环境（已完成）
1. ✅ 完成缓存管理器开发
2. ✅ 优化API查询逻辑
3. ✅ 本地验证性能提升

#### 第二阶段：数据库优化（待执行，需同意）
1. ⏳ 在Supabase创建统计表
2. ⏳ 添加必要的索引
3. ⏳ 创建视图和触发器
4. ⏳ 运行数据迁移脚本

#### 第三阶段：测试验证
1. ⏳ 功能测试
2. ⏳ 性能测试
3. ⏳ 数据准确性验证

#### 第四阶段：部署上线（需同意）
1. ⏳ 部署到预发环境
2. ⏳ 预发环境验证
3. ⏳ 部署到生产环境

### 11.7 优化效果总结

| 页面 | 优化前 | 优化后 | 提升幅度 |
|------|--------|--------|----------|
| 数据概览 | 3-5秒 | <1秒 | 70-80% |
| 订单管理 | 2-4秒 | <0.5秒 | 75-90% |
| 销售管理 | 2-3秒 | <0.5秒 | 75-85% |
| 客户管理 | 1-2秒 | <0.3秒 | 70-85% |
| 资金统计 | 3-5秒 | <1秒 | 70-80% |

---

**文档版本**：v3.0  
**最后更新**：2025-08-16  
**更新内容**：新增销售层级关系说明、佣金率调整权限、7天免费试用转化统计需求、系统性能优化方案  
**编写进度**：95%（待补充更多API细节）