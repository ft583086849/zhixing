# 销售佣金管理系统文档

## 一、系统架构

### 1. 数据库表结构

#### 核心表
- **primary_sales**: 一级销售原始数据表
- **secondary_sales**: 二级销售原始数据表
- **orders_optimized**: 订单数据表（主表）
- **sales_optimized**: 销售汇总表（预计算表，用于前端展示）

#### 表关系
```
primary_sales (一级销售)
    ↓
secondary_sales (二级销售)
    ↓
orders_optimized (订单)
    ↓
sales_optimized (汇总统计)
```

### 2. 佣金率管理

#### 默认佣金率
- **一级销售**: 40%（直销订单）
- **二级销售**: 25%（默认值，可调整）
- **一级销售差价**: 15%（从二级销售订单获得的差价）

#### 佣金率修改权限

1. **管理员**（从销售管理页面）：
   - 可以修改所有销售的佣金率
   - 修改位置：`/admin/sales` 或 `/admin/sales-test`
   - 操作：点击"编辑佣金"按钮

2. **一级销售**（从对账页面）：
   - 只能修改其下属二级销售的佣金率
   - 修改位置：一级销售对账页面
   - 权限范围：仅限其团队成员

## 二、数据流程

### 1. 佣金率修改流程

```
用户界面（AdminSalesOptimized）
    ↓
API层（api.js: updateSalesCommission）
    ↓
数据库更新：
    1. sales_optimized表（主要显示表）
    2. primary_sales 或 secondary_sales（原始数据表）
    ↓
重新计算（update-sales-optimized.js）
```

### 2. 数据同步机制

#### 修改佣金率时：
1. 首先更新 `sales_optimized` 表的 `commission_rate` 字段
2. 同步更新原始表（`primary_sales` 或 `secondary_sales`）
3. 需要运行 `update-sales-optimized.js` 重新计算佣金金额

#### 表字段映射：
- `sales_optimized.original_table`: 指向原始表名（'primary_sales' 或 'secondary_sales'）
- `sales_optimized.original_id`: 指向原始表的记录ID
- `sales_optimized.commission_rate`: 当前佣金率

## 三、前端实现

### 1. 组件：AdminSalesOptimized.js

#### 关键功能：
- **查看佣金率**: 在"佣金率"列显示
- **编辑佣金率**: 点击"编辑佣金"按钮
- **保存修改**: 调用 `AdminAPI.updateSalesCommission`

#### 编辑模式：
```javascript
// 进入编辑模式
handleEditCommission(record) {
  editForm.setFieldsValue({
    commission_rate: record.commission_rate * 100 // 转换为百分比
  });
  setEditingKey(record.id);
}

// 保存佣金率
handleSaveCommission(record) {
  const newRate = values.commission_rate / 100; // 转换为小数
  AdminAPI.updateSalesCommission(record.id, newRate);
}
```

### 2. API接口：api.js

```javascript
updateSalesCommission(salesId, commissionRate) {
  // 1. 获取销售信息
  // 2. 更新 sales_optimized 表
  // 3. 同步更新原始表（primary_sales 或 secondary_sales）
  // 4. 返回结果
}
```

## 四、计算逻辑

### 1. 一级销售佣金计算

```
直销佣金 = 直销订单金额 × 40%
团队差价 = 团队订单金额 × 15%（40% - 25%）
总佣金 = 直销佣金 + 团队差价
```

### 2. 二级销售佣金计算

```
佣金 = 订单金额 × commission_rate（默认25%，可调整）
```

### 3. 独立销售佣金计算

```
佣金 = 订单金额 × commission_rate（可自定义）
```

## 五、注意事项

1. **数据一致性**：
   - 修改佣金率后需要重新计算佣金金额
   - 建议运行 `node update-sales-optimized.js` 更新统计数据

2. **权限控制**：
   - 管理员可以修改所有人的佣金率
   - 一级销售只能修改其团队成员的佣金率
   - 二级销售无权修改佣金率

3. **佣金率范围**：
   - 最小值：0%
   - 最大值：100%
   - 建议范围：10% - 50%

4. **平均二级佣金率显示**：
   - 当前显示的是差价率（15%）
   - 不是二级销售的实际佣金率（25%）

## 六、常用维护脚本

```bash
# 重新计算所有销售数据
node update-sales-optimized.js

# 修复佣金计算
node recalculate-sales-optimized.js

# 验证数据一致性
node verify-all-logic.js
```

---
*更新时间：2025-01-18*