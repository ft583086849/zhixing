# 📋 v2.5.3 数据一致性修复清单

## 🔴 发现的问题

### 1. 重复记录问题
- **原因**：`getSales` 同时从 `primary_sales` 和 `secondary_sales` 表查询并合并显示
- **表现**：如果一个人在两个表都有记录，会显示多次
- **解决**：需要去重或添加表来源标识

### 2. 佣金率更新后数据不刷新
- **原因**：更新后立即刷新，可能数据库还没完成更新
- **表现**：显示"更新成功"但数据没变化
- **解决**：添加延迟刷新（已修复）

### 3. 动态佣金率出现负数（-12.5%）
- **原因**：动态计算公式可能产生负值
- **公式**：净佣金 = 一级直接订单佣金 + (二级订单×40% - 二级实际佣金)
- **问题**：如果二级佣金率>40%或一级没有直接订单，会出现负数
- **解决**：添加最小值限制（已修复）

### 4. 管理员后台与一级销售对账数据不一致
- **原因**：两个页面使用不同的数据源和计算逻辑
  - 管理员：`AdminAPI.getSales()` - 动态计算
  - 一级对账：`SupabaseService.getPrimarySalesSettlement()` - 后端计算
- **解决**：统一数据源或同步机制

## 🔧 修复方案

### 立即修复
1. ✅ 延迟刷新数据（500ms）
2. ✅ 限制佣金率最小值为0
3. 🔄 去重销售记录
4. 🔄 统一数据计算逻辑

### SQL查询脚本
```sql
-- 查看重复记录
SELECT 'primary_sales' as source, * FROM primary_sales WHERE wechat_name LIKE '%张%'
UNION ALL
SELECT 'secondary_sales' as source, * FROM secondary_sales WHERE wechat_name LIKE '%张%';

-- 清理重复（谨慎操作）
-- DELETE FROM secondary_sales WHERE wechat_name = '张子俊' AND id NOT IN (
--   SELECT MIN(id) FROM secondary_sales WHERE wechat_name = '张子俊'
-- );
```

### 诊断脚本
运行 `诊断销售数据问题.js` 查看详细信息

## 🎯 根本解决方案

### 1. 数据结构优化
- 考虑合并销售表或添加类型字段
- 明确区分一级/二级/独立销售

### 2. 计算逻辑统一
- 将动态佣金计算移到后端
- 前端只负责显示，不做复杂计算

### 3. 缓存策略优化
- 更新操作后清除相关缓存
- 使用版本号或时间戳控制缓存

## 📊 预期效果

1. 销售记录不重复
2. 佣金率更新即时生效
3. 不会出现负数佣金率
4. 所有页面数据一致

## ⚠️ 注意事项

- 删除数据前务必备份
- 修改计算逻辑要全面测试
- 确保所有相关页面同步更新
