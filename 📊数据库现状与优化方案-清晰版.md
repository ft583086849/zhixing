# 📊 数据库现状与优化方案（清晰版）

> 创建时间：2025-08-15
> 目的：清晰对比系统显示内容与数据库存储内容，提出不影响线上的优化方案

---

## 一、🔍 订单管理系统 - 现状对比

### 📱 后台订单管理页面【显示】的内容：
| 页面显示 | 数据来源 | 问题 |
|---------|---------|------|
| 用户微信号 | ✅ orders表有 `customer_wechat` | 正常 |
| 销售类型（一级/二级/独立） | ❌ 数据库没有直接存储 | 通过复杂逻辑判断得出 |
| 销售微信号 | ❌ orders表没有 | 需要关联secondary_sales表查询 |
| 一级销售微信 | ❌ orders表没有 | 需要关联查询两次 |
| TradingView用户 | ✅ orders表有 `tradingview_username` | 正常 |
| 购买时长 | ✅ orders表有 `duration` | 正常 |
| 生效时间 | ✅ orders表有 `effective_time` | 正常 |
| 到期时间 | ✅ orders表有 `expiry_time` | 正常 |
| 应付金额 | ✅ orders表有 `amount` | 正常 |
| 实付金额 | ✅ orders表有 `crypto_amount` | 正常 |
| 一级销售佣金 | ❌ 数据库没有存储 | 前端硬编码计算(40%) |
| 二级销售佣金 | ✅ orders表有 `commission_amount` | 正常 |
| 付款方式 | ✅ orders表有 `payment_method` | 正常 |
| 订单状态 | ✅ orders表有 `status` | 正常 |
| 付款截图 | ✅ orders表有 `screenshot_data` | 正常 |

### 📊 数据库orders表【实际存储】但页面【没显示】的：
- `order_number` - 订单号（有存储，但页面没显示）
- `customer_name` - 客户姓名（几乎全是NULL）
- `customer_phone` - 客户电话（几乎全是NULL）
- `customer_email` - 客户邮箱（几乎全是NULL）
- `sales_code` - 销售代码（有值，但页面不显示）
- `link_code` - 链接代码（全是NULL，废弃字段）
- `screenshot_path` - 截图路径（全是NULL，用screenshot_data代替）

---

## 二、👥 销售管理系统 - 现状对比

### 📱 后台销售管理页面【显示】的内容：
| 页面显示 | 数据来源 | 问题 |
|---------|---------|------|
| 销售微信号 | ✅ secondary_sales表有 `wechat_name` | 正常 |
| 销售类型 | ✅ secondary_sales表有 `sales_type` | 正常 |
| 上级销售 | ⚠️ secondary_sales表有 `primary_sales_id` | 需要关联查询名称 |
| 收款方式 | ✅ secondary_sales表有 `payment_method` | 正常 |
| 收款地址 | ✅ secondary_sales表有 `payment_address` | 正常 |
| 链名 | ✅ secondary_sales表有 `chain_name` | 正常 |
| 佣金率 | ✅ secondary_sales表有 `commission_rate` | 正常 |
| 总订单数 | ❌ 数据库没有存储 | 需要实时统计 |
| 总收入 | ❌ 数据库没有存储 | 需要实时统计 |
| 已付佣金 | ✅ secondary_sales表有 `paid_commission` | 正常 |

### 📊 数据库secondary_sales表【实际存储】但页面【没用】的：
- `name` - 姓名（废弃）
- `phone` - 电话（废弃）
- `email` - 邮箱（废弃）
- `alipay_account` - 支付宝账号（废弃）
- `alipay_surname` - 支付宝姓氏（废弃）
- `line_address_code` - 线上地址码（废弃）
- `line_name` - 线名（废弃）

### ⚠️ 重要问题：
**primary_sales表不存在！** 代码中有17处引用primary_sales表，但实际不存在。

---

## 三、🧑 客户管理系统 - 现状对比

### 📱 后台客户管理页面【显示】的内容：
| 页面显示 | 数据来源 | 问题 |
|---------|---------|------|
| 客户微信 | ✅ orders表有 `customer_wechat` | 分散在订单表 |
| TradingView用户名 | ✅ orders表有 `tradingview_username` | 分散在订单表 |
| 订单数量 | ❌ 没有存储 | 需要统计orders表 |
| 总消费金额 | ❌ 没有存储 | 需要统计orders表 |
| 最后订单时间 | ❌ 没有存储 | 需要查询orders表 |
| 客户状态 | ❌ 没有存储 | 需要判断 |

### ⚠️ 核心问题：
**系统没有customers表！** 所有客户信息都分散存储在orders表中，每个订单都重复存储客户信息。

---

## 四、🎯 优化方案（不影响线上）

### 方案原则：
1. ✅ **不删除现有字段** - 保持向后兼容
2. ✅ **只新增字段和表** - 不破坏现有功能
3. ✅ **预留扩展字段** - 方便未来升级

### 1️⃣ 第一步：在orders表新增常用字段（避免关联查询）

```sql
-- 这些字段可以减少关联查询，提高性能
ALTER TABLE orders 
ADD COLUMN IF NOT EXISTS sales_wechat_name VARCHAR(100),        -- 销售微信名
ADD COLUMN IF NOT EXISTS primary_sales_wechat VARCHAR(100),      -- 一级销售微信
ADD COLUMN IF NOT EXISTS calculated_sales_type VARCHAR(20),      -- 计算后的销售类型
ADD COLUMN IF NOT EXISTS primary_commission_amount DECIMAL(10,2), -- 一级销售佣金
ADD COLUMN IF NOT EXISTS reserved_field1 VARCHAR(255),           -- 预留字段1
ADD COLUMN IF NOT EXISTS reserved_field2 VARCHAR(255),           -- 预留字段2
ADD COLUMN IF NOT EXISTS reserved_field3 TEXT,                   -- 预留字段3
ADD COLUMN IF NOT EXISTS reserved_json JSONB;                    -- 预留JSON字段（灵活存储）
```

### 2️⃣ 第二步：创建新的customers表（不影响现有orders表）

```sql
-- 新建客户表，集中管理客户信息
CREATE TABLE IF NOT EXISTS customers (
  id SERIAL PRIMARY KEY,
  customer_wechat VARCHAR(100) UNIQUE NOT NULL,      -- 客户微信（唯一）
  tradingview_username VARCHAR(100),                 -- TV用户名
  customer_name VARCHAR(100),                        -- 真实姓名
  customer_phone VARCHAR(50),                        -- 电话
  customer_email VARCHAR(100),                       -- 邮箱
  
  -- 统计字段（定期更新）
  total_orders INTEGER DEFAULT 0,                    -- 总订单数
  total_amount DECIMAL(10,2) DEFAULT 0,             -- 总消费金额
  first_order_date TIMESTAMP,                       -- 首次下单时间
  last_order_date TIMESTAMP,                        -- 最后下单时间
  
  -- 客户状态
  customer_status VARCHAR(20) DEFAULT 'active',      -- 客户状态
  customer_level VARCHAR(20),                        -- 客户等级（VIP等）
  customer_tag VARCHAR(255),                         -- 客户标签
  
  -- 预留字段
  extra_field1 VARCHAR(255),                        -- 预留字段1
  extra_field2 VARCHAR(255),                        -- 预留字段2
  extra_field3 TEXT,                                -- 预留字段3
  extra_json JSONB,                                 -- 预留JSON字段
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引提高查询性能
CREATE INDEX idx_customers_wechat ON customers(customer_wechat);
CREATE INDEX idx_customers_tv ON customers(tradingview_username);
```

### 3️⃣ 第三步：优化secondary_sales表（新增字段，不删除旧字段）

```sql
-- 为销售表新增统计和预留字段
ALTER TABLE secondary_sales 
ADD COLUMN IF NOT EXISTS total_orders INTEGER DEFAULT 0,         -- 总订单数
ADD COLUMN IF NOT EXISTS total_revenue DECIMAL(10,2) DEFAULT 0,  -- 总收入
ADD COLUMN IF NOT EXISTS pending_commission DECIMAL(10,2) DEFAULT 0, -- 待结佣金
ADD COLUMN IF NOT EXISTS sales_level VARCHAR(20),                -- 销售等级
ADD COLUMN IF NOT EXISTS sales_tag VARCHAR(255),                 -- 销售标签
ADD COLUMN IF NOT EXISTS extra_field1 VARCHAR(255),              -- 预留字段1
ADD COLUMN IF NOT EXISTS extra_field2 VARCHAR(255),              -- 预留字段2
ADD COLUMN IF NOT EXISTS extra_json JSONB;                       -- 预留JSON字段
```

### 4️⃣ 第四步：创建视图简化查询（只读，不影响数据）

```sql
-- 创建订单详情视图，包含所有需要显示的信息
CREATE OR REPLACE VIEW order_details_view AS
SELECT 
  o.*,
  -- 销售信息
  s.wechat_name as sales_wechat_name,
  s.sales_type as sales_type_from_table,
  ps.wechat_name as primary_sales_wechat_name,
  
  -- 计算销售类型
  CASE 
    WHEN s.sales_type = 'primary' THEN '一级销售'
    WHEN s.primary_sales_id IS NOT NULL THEN '二级销售'
    WHEN s.sales_type = 'independent' THEN '独立销售'
    ELSE '未知'
  END as display_sales_type,
  
  -- 计算佣金
  CASE 
    WHEN s.sales_type = 'primary' THEN o.amount * 0.4
    ELSE 0
  END as calculated_primary_commission,
  
  -- 客户信息（如果有customers表）
  c.customer_name,
  c.customer_level,
  c.total_orders as customer_total_orders
  
FROM orders o
LEFT JOIN secondary_sales s ON o.sales_code = s.sales_code
LEFT JOIN secondary_sales ps ON s.primary_sales_id = ps.id
LEFT JOIN customers c ON o.customer_wechat = c.customer_wechat;
```

---

## 五、📋 实施步骤（安全渐进）

### 第1阶段：只加不删（完全安全）
1. 执行上述ADD COLUMN语句，添加新字段
2. 创建customers表（新表，不影响现有系统）
3. 创建视图（只读，不影响数据）

### 第2阶段：数据迁移（后台进行）
1. 将orders表的客户信息同步到customers表
2. 更新orders表的新字段（sales_wechat_name等）
3. 定期更新统计字段

### 第3阶段：代码适配（逐步切换）
1. 新功能使用新表和新字段
2. 旧功能保持不变
3. 逐步迁移旧代码

---

## 六、🎯 预留字段说明

### 为什么要预留字段？
避免频繁修改表结构，为未来需求预留空间。

### 预留字段类型：
1. **VARCHAR(255)** - 存储短文本信息
2. **TEXT** - 存储长文本
3. **JSONB** - 最灵活，可存储任何结构化数据

### 使用示例：
```sql
-- 未来需要存储新信息时，直接使用预留字段
UPDATE orders 
SET reserved_json = '{"vip_level": "gold", "special_note": "重要客户"}'
WHERE id = 1;
```

---

## 七、✅ 这样做的好处

1. **不影响线上** - 只增不删，完全向后兼容
2. **性能提升** - 减少关联查询
3. **扩展性好** - 预留字段应对未来需求
4. **逐步迁移** - 可以慢慢切换，没有风险
5. **数据完整** - 客户信息集中管理

---

## 八、❓ 需要你决定的问题

1. **是否创建customers表？**
   - 好处：客户信息集中管理
   - 坏处：需要同步数据

2. **是否在orders表加新字段？**
   - 好处：查询更快
   - 坏处：有冗余

3. **预留字段要几个？**
   - 建议至少3个VARCHAR + 1个JSONB

4. **是否创建视图？**
   - 好处：简化查询
   - 坏处：需要维护

请告诉我你的想法，我们可以进一步讨论细节。