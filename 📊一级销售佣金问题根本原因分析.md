# ğŸ“Š ä¸€çº§é”€å”®ä½£é‡‘é—®é¢˜æ ¹æœ¬åŸå› åˆ†æ

## ğŸ” é—®é¢˜å‘ç°

### è®¢å•ID 27çš„å¼‚å¸¸
- **è®¢å•é‡‘é¢**ï¼š$188
- **é”€å”®äºº**ï¼šWML792355703ï¼ˆä¸€çº§é”€å”®ï¼‰
- **å®é™…ä½£é‡‘**ï¼š$28.2ï¼ˆ15%ï¼‰
- **åº”å¾—ä½£é‡‘**ï¼š$75.2ï¼ˆ40%ï¼‰

## ğŸ’¡ æ ¹æœ¬åŸå› 

### ä¸€çº§é”€å”®çš„ä¸¤ç§ä½£é‡‘åœºæ™¯
1. **è‡ªå·±ç›´æ¥é”€å”®çš„è®¢å•**ï¼šåº”è·å¾— **40%** ä½£é‡‘
2. **ä¸‹å±äºŒçº§é”€å”®çš„è®¢å•**ï¼šåªè·å¾— **15%** å·®é¢ä½£é‡‘ï¼ˆ40% - 25% = 15%ï¼‰

### å½“å‰ç³»ç»Ÿè®¾è®¡ç¼ºé™·

#### 1. æ•°æ®åº“è®¾è®¡é—®é¢˜
`primary_sales`è¡¨åªæœ‰ä¸€ä¸ª`commission_rate`å­—æ®µï¼š
```sql
-- å½“å‰ç»“æ„
commission_rate DECIMAL(5,2) DEFAULT 40.00  -- åªæœ‰ä¸€ä¸ªä½£é‡‘ç‡å­—æ®µ
```

#### 2. é”™è¯¯çš„ä½£é‡‘ç‡è®¾ç½®
WML792355703çš„`commission_rate`è¢«è®¾ç½®ä¸º**0.15**ï¼š
- å¯èƒ½æ˜¯ä¸ºäº†å¤„ç†äºŒçº§é”€å”®è®¢å•çš„å·®é¢ä½£é‡‘
- ä½†è¿™å¯¼è‡´è‡ªå·±çš„è®¢å•ä¹Ÿåªèƒ½è·å¾—15%ä½£é‡‘

#### 3. è®¢å•åˆ›å»ºæ—¶çš„è®¡ç®—é€»è¾‘
```javascript
// calculateCommissionå‡½æ•°
const commission = amount * commissionRate;
// æ²¡æœ‰åŒºåˆ†æ˜¯è‡ªå·±çš„è®¢å•è¿˜æ˜¯äºŒçº§é”€å”®çš„è®¢å•
```

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šçŸ­æœŸå¿«é€Ÿä¿®å¤ï¼ˆæ¨èï¼‰

#### 1. ç«‹å³ä¿®å¤WML792355703çš„ä½£é‡‘ç‡
```sql
-- æ¢å¤æ­£ç¡®çš„ä½£é‡‘ç‡
UPDATE primary_sales 
SET commission_rate = 0.4  -- æ¢å¤ä¸º40%
WHERE sales_code = 'WML792355703';

-- ä¿®å¤å·²æœ‰è®¢å•
UPDATE orders 
SET 
  commission_rate = 0.4,
  commission_amount = amount * 0.4
WHERE sales_code = 'WML792355703' 
  AND secondary_sales_id IS NULL;  -- åªä¿®å¤è‡ªå·±çš„è®¢å•
```

#### 2. ä¿®æ”¹è®¢å•åˆ›å»ºé€»è¾‘
```javascript
// åœ¨calculateCommissionå‡½æ•°ä¸­
async calculateCommission(salesCode, amount, orderData) {
  const salesResult = await SalesAPI.getSalesByCode(salesCode);
  const sale = salesResult.data;
  
  let commissionRate;
  
  // åˆ¤æ–­æ˜¯å¦æ˜¯äºŒçº§é”€å”®çš„è®¢å•
  if (orderData.secondary_sales_id) {
    // äºŒçº§é”€å”®çš„è®¢å•ï¼Œä¸€çº§åªè·å¾—å·®é¢ä½£é‡‘
    commissionRate = 0.15;  // 40% - 25% = 15%
  } else {
    // è‡ªå·±çš„è®¢å•ï¼Œè·å¾—å®Œæ•´ä½£é‡‘
    commissionRate = sale.commission_rate || 0.4;
  }
  
  const commission = amount * commissionRate;
  return { commission, rate: commissionRate };
}
```

### æ–¹æ¡ˆäºŒï¼šé•¿æœŸæ¶æ„ä¼˜åŒ–

#### 1. æ‰©å±•æ•°æ®åº“ç»“æ„
```sql
-- ä¸ºprimary_salesè¡¨æ·»åŠ ä¸¤ä¸ªä½£é‡‘ç‡å­—æ®µ
ALTER TABLE primary_sales 
ADD COLUMN IF NOT EXISTS self_commission_rate DECIMAL(5,4) DEFAULT 0.4,  -- è‡ªå”®ä½£é‡‘ç‡
ADD COLUMN IF NOT EXISTS override_commission_rate DECIMAL(5,4) DEFAULT 0.15;  -- å·®é¢ä½£é‡‘ç‡

-- è¿ç§»ç°æœ‰æ•°æ®
UPDATE primary_sales 
SET 
  self_commission_rate = 0.4,
  override_commission_rate = 0.15,
  commission_rate = 0.4  -- ä¿æŒå…¼å®¹
WHERE commission_rate = 0.15;  -- ä¿®å¤é”™è¯¯è®¾ç½®çš„
```

#### 2. åˆ›å»ºä½£é‡‘è§„åˆ™è¡¨
```sql
-- åˆ›å»ºä½£é‡‘è§„åˆ™è¡¨
CREATE TABLE IF NOT EXISTS commission_rules (
  id SERIAL PRIMARY KEY,
  sales_id INTEGER NOT NULL,
  sales_type VARCHAR(20) NOT NULL,  -- 'primary' or 'secondary'
  rule_type VARCHAR(30) NOT NULL,   -- 'self_sale' or 'subordinate_sale'
  commission_rate DECIMAL(5,4) NOT NULL,
  effective_date DATE DEFAULT CURRENT_DATE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(sales_id, sales_type, rule_type)
);

-- æ’å…¥é»˜è®¤è§„åˆ™
INSERT INTO commission_rules (sales_id, sales_type, rule_type, commission_rate)
SELECT 
  id, 
  'primary', 
  'self_sale', 
  0.4
FROM primary_sales
ON CONFLICT DO NOTHING;

INSERT INTO commission_rules (sales_id, sales_type, rule_type, commission_rate)
SELECT 
  id, 
  'primary', 
  'subordinate_sale', 
  0.15
FROM primary_sales
ON CONFLICT DO NOTHING;
```

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç´§æ€¥ä¿®å¤ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. åœ¨Supabaseæ‰§è¡ŒSQLä¿®å¤WML792355703çš„ä½£é‡‘ç‡
2. ä¿®å¤è®¢å•ID 27çš„ä½£é‡‘

### ç¬¬äºŒæ­¥ï¼šä»£ç ä¼˜åŒ–ï¼ˆ1å¤©å†…ï¼‰
1. ä¿®æ”¹`calculateCommission`å‡½æ•°é€»è¾‘
2. åŒºåˆ†è‡ªå”®è®¢å•å’ŒäºŒçº§é”€å”®è®¢å•

### ç¬¬ä¸‰æ­¥ï¼šæ¶æ„å‡çº§ï¼ˆå¯é€‰ï¼‰
1. æ‰©å±•æ•°æ®åº“ç»“æ„
2. å®ç°æ›´çµæ´»çš„ä½£é‡‘è§„åˆ™ç³»ç»Ÿ

## âš ï¸ å½±å“èŒƒå›´è¯„ä¼°

### éœ€è¦æ£€æŸ¥çš„å…¶ä»–ä¸€çº§é”€å”®
```sql
-- æŸ¥æ‰¾ä½£é‡‘ç‡å¼‚å¸¸çš„ä¸€çº§é”€å”®
SELECT 
  id,
  wechat_name,
  sales_code,
  commission_rate,
  CASE 
    WHEN commission_rate < 0.3 THEN 'âš ï¸ ä½£é‡‘ç‡è¿‡ä½ï¼Œå¯èƒ½æœ‰é—®é¢˜'
    WHEN commission_rate = 0.15 THEN 'âŒ å¯èƒ½è¢«é”™è¯¯è®¾ç½®ä¸ºå·®é¢ä½£é‡‘ç‡'
    ELSE 'âœ… æ­£å¸¸'
  END as status
FROM primary_sales
WHERE commission_rate < 0.4
ORDER BY commission_rate;
```

### éœ€è¦ä¿®å¤çš„è®¢å•
```sql
-- æŸ¥æ‰¾å¯èƒ½å—å½±å“çš„è®¢å•
SELECT 
  o.id,
  o.sales_code,
  o.amount,
  o.commission_rate,
  o.commission_amount,
  o.amount * 0.4 as should_be_commission,
  (o.amount * 0.4) - o.commission_amount as difference
FROM orders o
INNER JOIN primary_sales ps ON o.sales_code = ps.sales_code
WHERE o.secondary_sales_id IS NULL  -- ä¸€çº§é”€å”®è‡ªå·±çš„è®¢å•
  AND o.commission_rate < 0.4  -- ä½£é‡‘ç‡ä½äº40%
  AND o.amount > 0
ORDER BY difference DESC;
```

## ğŸ¯ ç«‹å³è¡ŒåŠ¨

### 1. æ‰§è¡Œç´§æ€¥ä¿®å¤SQL
```sql
-- ç«‹å³åœ¨Supabaseæ‰§è¡Œ
BEGIN;

-- ä¿®å¤WML792355703çš„ä½£é‡‘ç‡
UPDATE primary_sales 
SET commission_rate = 0.4
WHERE sales_code = 'WML792355703';

-- ä¿®å¤è®¢å•27
UPDATE orders 
SET 
  commission_rate = 0.4,
  commission_amount = 75.2
WHERE id = 27;

-- ä¿®å¤å…¶ä»–å—å½±å“çš„è®¢å•
UPDATE orders o
SET 
  commission_rate = 0.4,
  commission_amount = o.amount * 0.4
FROM primary_sales ps
WHERE o.sales_code = ps.sales_code
  AND o.secondary_sales_id IS NULL
  AND ps.commission_rate = 0.15
  AND o.commission_rate = 0.15;

COMMIT;
```

### 2. éªŒè¯ä¿®å¤ç»“æœ
```sql
-- éªŒè¯ä¿®å¤
SELECT 
  'WML792355703ä½£é‡‘ç‡' as check_item,
  commission_rate,
  CASE 
    WHEN commission_rate = 0.4 THEN 'âœ… ä¿®å¤æˆåŠŸ'
    ELSE 'âŒ ä»æœ‰é—®é¢˜'
  END as status
FROM primary_sales 
WHERE sales_code = 'WML792355703'

UNION ALL

SELECT 
  'è®¢å•27ä½£é‡‘' as check_item,
  commission_amount,
  CASE 
    WHEN commission_amount = 75.2 THEN 'âœ… ä¿®å¤æˆåŠŸ'
    ELSE 'âŒ ä»æœ‰é—®é¢˜'
  END as status
FROM orders 
WHERE id = 27;
```