# 📚 知行财库系统完整需求文档 - 最新版

> 创建时间：2025-08-15  
> 系统版本：v2.12.0  
> 文档状态：详细完整版（包含所有页面所有字段）

---

## 第一部分：系统概述

### 1.1 系统简介
**系统名称**：知行财库（TradingView指标订阅销售管理系统）

**核心功能**：
- TradingView指标订阅销售
- 多层级销售体系管理
- 实时佣金计算与对账
- 资金统计与分配

**技术架构**：
- 前端：React 18.2.0 + Redux Toolkit + Ant Design
- 后端：Supabase (PostgreSQL + Realtime)
- 部署：Vercel
- 支付：加密货币（USDT）

### 1.2 用户角色
1. **管理员**：系统最高权限，管理所有功能
2. **一级销售**：直销 + 管理二级销售
3. **二级销售**：在一级销售下进行销售
4. **独立销售**：独立进行销售
5. **客户**：购买订阅的用户

---

## 第二部分：产品定价与套餐

### 2.1 产品定价表（基于PurchasePage.js实际代码）
```javascript
const durationOptions = [
  { value: '7days', label: '7天免费', price: 0 },
  { value: '1month', label: '1个月', price: 188 },
  { value: '3months', label: '3个月', price: 488 },
  { value: '6months', label: '6个月', price: 888 },
  { value: '1year', label: '1年', price: 1588 }
];
```

| 套餐类型 | 时长值 | 显示名称 | 价格(USD) | 特殊规则 |
|---------|--------|---------|-----------|---------|
| 免费试用 | 7days | 7天免费 | $0 | 1. 自动选择即时购买<br>2. 跳过付款确认<br>3. 不产生佣金<br>4. 需统计转化率 |
| 基础套餐 | 1month | 1个月 | $188 | 标准流程 |
| 标准套餐 | 3months | 3个月 | $488 | 标准流程 |
| 高级套餐 | 6months | 6个月 | $888 | 标准流程 |
| 年费套餐 | 1year | 1年 | $1588 | 标准流程 |

---

## 第三部分：管理员功能模块详细说明

### 3.1 数据概览页面（AdminOverview.js）

#### 3.1.1 核心统计卡片（第一行）

| 卡片标题 | 字段名 | 数据来源API | 计算逻辑 | 显示格式 | 交互功能 |
|---------|--------|------------|---------|---------|---------|
| 总订单数 | total_orders | getStats() | `SELECT COUNT(*) FROM orders WHERE status != 'rejected'` | 数字 + 购物车图标<br>绿色 #3f8600 | 无点击事件 |
| 待付款确认订单 | pending_payment_orders | getStats() | `SELECT COUNT(*) FROM orders WHERE status = 'pending_payment'` | 数字 + 时钟图标<br>黄色 #faad14 | 点击跳转：`/admin/orders?status=pending_payment` |
| 待配置确认订单 | pending_config_orders | getStats() | `SELECT COUNT(*) FROM orders WHERE status = 'pending_config'` | 数字 + 时钟图标<br>橙色 #fa8c16 | 点击跳转：`/admin/orders?status=pending_config` |
| 已配置确认订单 | confirmed_config_orders | getStats() | `SELECT COUNT(*) FROM orders WHERE status = 'confirmed_config'` | 数字 + 勾号图标<br>绿色 #52c41a | 无点击事件 |

#### 3.1.2 财务统计卡片（第二行）

| 卡片标题 | 字段名 | 数据来源API | 计算逻辑 | 显示格式 | 交互功能 |
|---------|--------|------------|---------|---------|---------|
| 总收入 | total_amount | getStats() | `SELECT SUM(amount) FROM orders WHERE status = 'confirmed_config'` | $金额 + 美元图标<br>蓝色 #1890ff<br>后缀"美元" | 无点击事件 |
| 销售返佣金额 | commission_amount | getStats() | `SELECT SUM(commission_amount) FROM orders WHERE status = 'confirmed_config'` | $金额 + 美元图标<br>紫色 #722ed1<br>后缀"美元" | 点击跳转：`/admin/sales?filter=pending_commission` |
| 待返佣金金额 | pending_commission_amount | getStats() | `SELECT SUM(commission_amount) FROM orders WHERE settlement_status = 'pending'` | $金额 + 美元图标<br>红色 #ff4d4f<br>后缀"美元" | 无点击事件 |

#### 3.1.3 销售层级统计卡片

| 销售类型 | 包含字段 | 计算逻辑 | 显示样式 |
|---------|---------|---------|---------|
| 一级销售 | primary_sales_count（数量）<br>primary_sales_amount（业绩） | 数量：`COUNT(*) WHERE sales_type='primary'`<br>业绩：`SUM(amount) WHERE 一级直销订单` | 背景：#e6f4ff<br>边框：#1890ff<br>图标：👑 |
| 二级销售 | linked_secondary_sales_count（数量）<br>linked_secondary_sales_amount（业绩） | 数量：`COUNT(*) WHERE sales_type='secondary' AND primary_sales_id IS NOT NULL`<br>业绩：`SUM(amount) WHERE 二级销售订单` | 背景：#fff7e6<br>边框：#fa8c16<br>图标：👥 |
| 独立销售 | independent_sales_count（数量）<br>independent_sales_amount（业绩） | 数量：`COUNT(*) WHERE sales_type='secondary' AND primary_sales_id IS NULL`<br>业绩：`SUM(amount) WHERE 独立销售订单` | 背景：#f6ffed<br>边框：#52c41a<br>图标：👤 |

#### 3.1.4 订单分类统计（按时长）

| 时长类型 | 订单数字段 | 百分比字段 | 计算逻辑 | 显示格式 |
|---------|-----------|-----------|---------|---------|
| 7天免费 | free_trial_orders | free_trial_percentage | COUNT WHERE duration='7days' | 进度圈(绿色) + 订单数 + 占比% |
| 1个月 | one_month_orders | one_month_percentage | COUNT WHERE duration='1month' | 进度圈(蓝色) + 订单数 + 占比% |
| 3个月 | three_month_orders | three_month_percentage | COUNT WHERE duration='3months' | 进度圈(青色) + 订单数 + 占比% |
| 6个月 | six_month_orders | six_month_percentage | COUNT WHERE duration='6months' | 进度圈(橙色) + 订单数 + 占比% |
| 年费 | yearly_orders | yearly_percentage | COUNT WHERE duration='1year' | 进度圈(紫色) + 订单数 + 占比% |

#### 3.1.5 Top5销售排行榜

**数据处理逻辑**（AdminOverview.js line 62-118）：
```javascript
// 1. 获取所有销售数据并按金额排序
// 2. 智能去重逻辑：
//    - 如果二级销售金额 >= 其一级销售的自营金额
//    - 只显示二级销售，隐藏一级销售
//    - 避免同一团队重复上榜
// 3. 取前5名
```

| 列名 | 字段名 | 数据来源 | 显示逻辑 | 样式 |
|------|--------|---------|---------|------|
| 排名 | rank | 计算生成 | 1:🥇 2:🥈 3:🥉 4-5:数字 | 1:金色 2:银色 3:铜色 |
| 销售类型 | sales_type | sales.sales_type | 一级销售/二级销售/独立销售 | Tag颜色：blue/orange/green |
| 销售名称 | sales_name | sales.wechat_name 或 sales.name | 优先显示wechat_name | 字体加粗 |
| 所属一级 | primary_sales_name | 关联查询 | 仅二级销售显示，其他显示"-" | 灰色 #666 |
| 销售金额 | total_amount | 统计计算 | 格式：$X,XXX.XX | 蓝色 #1890ff 加粗 |
| 占比 | percentage | total_amount/总销售额*100 | 格式：XX.XX% | 紫色 #722ed1 |
| 返佣金额 | commission_amount | 统计计算 | 格式：$X,XXX.XX | 绿色 #52c41a 加粗 |

### 3.2 订单管理页面（AdminOrders.js）

#### 3.2.1 订单列表所有字段

| 列名 | 数据库字段 | 显示逻辑 | 数据处理 | 宽度 |
|------|-----------|---------|---------|------|
| 用户微信号 | customer_wechat | 直接显示，无则显示"-" | 原始值 | 130px |
| 销售类型 | 无直接字段 | **判断逻辑**：<br>1. 如有secondary_sales且有primary_sales_id → 二级销售(橙色)<br>2. 如有secondary_sales但无primary_sales_id → 独立销售(绿色)<br>3. 如有primary_sales → 一级销售(蓝色)<br>4. 其他 → 未知 | Tag组件显示 | 100px |
| 销售微信号 | 多字段判断 | **优先级**：<br>1. secondary_sales.wechat_name<br>2. primary_sales.wechat_name<br>3. sales_wechat_name字段<br>4. 默认"-" | 实际出单人 | 150px |
| 一级销售微信 | 多字段判断 | **逻辑**：<br>1. 二级订单：显示其primary_sales.wechat_name<br>2. 一级订单：显示自己<br>3. 独立订单：显示"-" | 一级销售信息 | 150px |
| TradingView用户 | tradingview_username | 直接显示 | 原始值 | 150px |
| 购买时长 | duration | 映射显示：<br>7days→7天免费<br>1month→1个月<br>3months→3个月<br>6months→6个月<br>1year→1年 | 中文显示 | 100px |
| 购买方式 | purchase_type | immediate→即时购买<br>scheduled→延期购买 | Tag显示 | 100px |
| 生效时间 | effective_time | 格式化为YYYY-MM-DD HH:mm | dayjs格式化 | 150px |
| 到期时间 | expiry_time | 格式化为YYYY-MM-DD HH:mm | dayjs格式化 | 150px |
| 应付金额 | amount | 订单原价，格式：$XXX.XX | 美元格式 | 100px |
| 实付金额 | crypto_amount | 实际支付金额，格式：$XXX.XX | 美元格式 | 100px |
| 一级销售佣金额 | 计算字段 | **计算逻辑**：<br>1. 一级直销：amount × 0.4<br>2. 二级订单：amount × (0.4 - 二级佣金率) | 实时计算 | 120px |
| 二级分销佣金额 | commission_amount | 二级销售获得的佣金 | 美元格式 | 120px |
| 付款方式 | payment_method | crypto→加密货币<br>alipay→支付宝(已废弃) | 中文显示 | 100px |
| 订单状态 | status | pending_payment→待付款确认(橙色)<br>confirmed_payment→已付款确认(蓝色)<br>pending_config→待配置确认(紫色)<br>confirmed_config→已配置确认(绿色)<br>rejected→已拒绝(红色) | Tag颜色 | 120px |
| 付款截图 | screenshot_data | Base64图片数据 | 点击查看大图Modal | 100px |
| 配置确认时间 | effective_time | 同生效时间 | dayjs格式化 | 150px |
| 操作 | - | **按钮逻辑**：<br>1. pending_payment→显示"确认付款"+"拒绝"<br>2. confirmed_payment→显示"确认配置"+"拒绝"<br>3. pending_config→显示"确认配置"+"拒绝"<br>4. 其他状态→不显示按钮 | 按钮组 | 200px |

### 3.3 销售管理页面（AdminSales.js）

#### 3.3.1 销售列表所有字段

| 列名 | 数据库字段 | 显示逻辑 | 计算方式 | 宽度 |
|------|-----------|---------|---------|------|
| 销售微信号 | wechat_name | 直接显示 | 原始值 | 150px |
| 销售类型 | sales_type + primary_sales_id | **判断逻辑**：<br>1. sales_type='primary' → 一级销售(蓝色)<br>2. sales_type='secondary' AND primary_sales_id NOT NULL → 二级销售(绿色)<br>3. sales_type='secondary' AND primary_sales_id NULL → 独立销售(橙色) | Tag显示 | 120px |
| 上级销售 | primary_sales_id | 关联查询primary_sales表的wechat_name<br>无上级显示"-" | JOIN查询 | 150px |
| 收款方式 | payment_method | crypto→加密货币<br>alipay→支付宝<br>wechat→微信 | 映射显示 | 120px |
| 收款地址 | payment_address | 截取显示前10位...后6位 | 字符串处理 | 200px |
| 链名 | chain_name | TRC20/ERC20/BSC等 | 原始值 | 100px |
| 佣金率 | commission_rate | 格式：XX.X%<br>例：0.25→25.0% | ×100 + % | 100px |
| 已配置确认订单数 | 统计字段 | COUNT(orders) WHERE status='confirmed_config' AND sales_code=当前销售 | 实时统计 | 140px |
| 已配置确认订单金额 | 统计字段 | **区分显示**：<br>1. 一级销售：只显示直销订单金额<br>2. 二级/独立：显示自己的订单金额 | SUM(amount) | 160px |
| 总佣金 | 统计字段 | **计算逻辑**：<br>1. 一级：直销佣金+分销收益<br>2. 二级/独立：自己的佣金 | SUM计算 | 120px |
| 已付佣金 | paid_commission | 数据库字段直接读取 | 原始值 | 120px |
| 操作 | - | 编辑按钮：修改佣金率和收款信息 | 弹窗表单 | 100px |

### 3.4 客户管理页面（AdminCustomers.js）

#### 3.4.1 客户列表所有字段

| 列名 | 数据来源 | 显示逻辑 | 计算方式 | 宽度 |
|------|---------|---------|---------|------|
| 客户微信 | orders.customer_wechat（去重） | DISTINCT customer_wechat | 去重显示 | 150px |
| TradingView用户名 | orders.tradingview_username | 最新的一条订单的TV用户名 | 最新值 | 180px |
| 订单数量 | 统计计算 | COUNT(*) GROUP BY customer_wechat | 分组统计 | 100px |
| 总消费金额 | 统计计算 | SUM(amount) WHERE status='confirmed_config' | 分组求和 | 120px |
| 最后订单时间 | 统计计算 | MAX(created_at) | 最大值 | 150px |
| 客户状态 | 计算字段 | 有效期内→活跃(绿色)<br>已过期→流失(灰色)<br>即将过期→预警(橙色) | 日期判断 | 100px |
| 操作 | - | 查看订单：跳转到订单页面筛选该客户 | 路由跳转 | 100px |

### 3.5 资金统计页面（AdminFinance.js）

#### 3.5.1 核心财务指标表

| 指标名称 | 字段名 | 计算逻辑 | 说明 | 显示颜色 |
|---------|--------|---------|------|---------|
| 总收入 | totalRevenue | 所有订单金额总和（含未确认） | `SUM(amount) FROM orders` | 蓝色 #1890ff |
| 总实付金额 | totalPaid | 已确认订单的实付金额 | `SUM(amount) WHERE status='confirmed_config'` | 绿色 #52c41a |
| 销售返佣金额 | salesCommission | 基于实付金额计算的返佣 | `SUM(commission_amount)` | 青色 #13c2c2 |
| 待返佣金额 | pendingCommission | 未确认订单的佣金 | `SUM WHERE settlement_status='pending'` | 粉色 #eb2f96 |
| 营利金额 | netProfit | 总实付金额 - 销售返佣金额 | `totalPaid - salesCommission` | 黄色 #faad14 |

#### 3.5.2 收益分配方案（基于总实付金额）

| 分配对象 | 字段名 | 默认比例 | 计算公式 | 可调整 | 显示样式 |
|---------|--------|---------|---------|--------|---------|
| 公户(总) | public | 40% | totalPaid × 0.40 | 是 | 背景#e6f7ff 图标🏢 |
| ├─营销费用 | marketing | 10% | totalPaid × 0.10 | 是 | 公户子项 |
| ├─分红 | dividend | 15% | totalPaid × 0.15 | 是 | 公户子项 |
| └─开发费用 | development | 15% | totalPaid × 0.15 | 是 | 公户子项 |
| 知行 | zhixing | 35% | totalPaid × 0.35 | 是 | 背景#f6ffed 图标📚 |
| 子俊 | zijun | 25% | totalPaid × 0.25 | 是 | 背景#fff1f0 图标👤 |

**总和必须=100%**，支持手动调整比例并保存到数据库

---

## 第四部分：一级销售功能模块详细说明

### 4.1 一级销售对账页面（PrimarySalesSettlementPage.js）

#### 4.1.1 查询表单

| 字段 | 输入类型 | 必填 | 说明 |
|------|---------|------|------|
| 微信号 | Input | 是（二选一） | 一级销售的微信号 |
| 销售代码 | Input | 是（二选一） | 一级销售的代码 |

#### 4.1.2 链接展示区

| 链接类型 | 格式 | 功能 | 复制按钮 |
|---------|------|------|---------|
| 用户购买链接 | `/purchase?sales_code={sales_code}` | 客户通过此链接购买 | ✓ |
| 二级销售注册链接 | `/secondary-sales?registration_code={sales_code}` | 邀请二级销售加入 | ✓ |

#### 4.1.3 佣金统计卡片（3行布局）

**第一行：核心佣金数据**
| 卡片标题 | 字段 | 计算逻辑 | 渐变背景色 |
|---------|------|---------|-----------|
| 总佣金收入 | totalCommission | 直销佣金 + 分销收益（历史总和） | 紫色渐变 |
| 本月佣金 | monthlyCommission | 当月所有佣金 | 粉色渐变 |
| 当日佣金 | todayCommission | 今日佣金 | 黄色渐变 |

**第二行：佣金明细**
| 卡片标题 | 字段 | 计算逻辑 | 边框颜色 |
|---------|------|---------|---------|
| 一级销售佣金额 | direct_commission | 直销订单 × 40% | 蓝色 #1890ff |
| 平均二级佣金率 | secondary_avg_rate | AVG(所有二级的佣金率) | 紫色 #722ed1 |
| 二级佣金收益额 | secondary_share_commission | SUM(二级订单 × (40% - 二级佣金率)) | 青色 #13c2c2 |
| 二级销售订单总额 | secondary_orders_amount | SUM(所有二级的订单金额) | 粉色 #eb2f96 |

**第三行：业务指标**
| 卡片标题 | 字段 | 计算逻辑 | 边框颜色 |
|---------|------|---------|---------|
| 二级销售 | secondarySales.length | COUNT(二级销售) | 紫色 #722ed1 |
| 总订单数 | totalOrders | COUNT(所有相关订单) | 蓝色 #1890ff |

#### 4.1.4 二级销售管理表格

| 列名 | 字段 | 功能说明 | 操作 |
|------|------|---------|------|
| 微信号 | wechat_name | 二级销售微信 | - |
| 收款方式 | payment_method | crypto/alipay/wechat映射显示 | - |
| 总订单金额 | total_amount | 该二级的总业绩 | - |
| 当前佣金率 | commission_rate | 显示XX.X%，0也要显示 | - |
| 累计佣金 | total_commission | 该二级获得的总佣金 | - |
| 订单数量 | order_count | 订单数 | - |
| 注册时间 | created_at | 格式化显示 | - |
| 购买链接 | - | 该二级的专属链接 | 复制/查看 |
| 操作 | - | - | 设置佣金/移除 |

**设置佣金弹窗**：
- 输入范围：0-100%
- 默认值：25%
- 实时更新数据库

#### 4.1.5 我的订单列表（含状态通知）🆕

| 列名 | 字段 | 说明 | 新增功能 |
|------|------|------|---------|
| 订单ID | id | 订单编号 | - |
| 客户微信 | customer_wechat | 客户信息 | - |
| TradingView用户名 | tradingview_username | TV账号 | - |
| 套餐类型 | duration | 时长映射显示 | - |
| 订单金额 | amount | 美元格式 | - |
| 佣金金额 | commission_amount | 美元格式 | - |
| 销售人员 | sales_wechat_name | 显示是谁出的单 | - |
| 订单状态 | status | Tag颜色显示 | **实时推送通知** |
| 创建时间 | created_at | 时间格式化 | - |

**新增：订单状态变更通知**
- 订单被确认 → 推送通知 + 余额更新
- 订单被拒绝 → 推送通知 + 标红显示

#### 4.1.6 催单功能

| 字段 | 说明 |
|------|------|
| 待催单客户数 | 7天内到期的客户数量 |
| 催单列表 | 显示即将到期的订单 |
| 催单操作 | 记录已联系客户 |

### 4.2 二级销售对账页面（SalesReconciliationPage.js）

#### 4.2.1 查询表单

| 字段 | 输入类型 | 说明 |
|------|---------|------|
| 微信号 | Input | 二级销售微信号 |
| 付款时间 | RangePicker | 时间范围筛选 |

#### 4.2.2 购买链接展示

| 内容 | 格式 | 功能 |
|------|------|------|
| 用户购买链接 | `/purchase?sales_code={sales_code}` | 专属销售链接 |

#### 4.2.3 余额统计卡片 🆕

| 卡片标题 | 字段 | 说明 | 颜色 |
|---------|------|------|------|
| 当前余额 | current_balance | 可提现金额 | 绿色 |
| 待确认 | pending_amount | 待确认的佣金 | 黄色 |
| 今日收入 | today_earned | 今日佣金 | 默认 |
| 本月收入 | month_earned | 本月佣金 | 默认 |

#### 4.2.4 实时对账明细表 🆕

| 列名 | 字段 | 说明 | 实时性 |
|------|------|------|--------|
| 时间 | created_at | MM-DD HH:mm:ss格式 | 实时推送 |
| 订单号 | order_number | 订单编号 | - |
| 客户 | customer_wechat | 客户微信 | - |
| 订单金额 | order_amount | 美元格式 | - |
| 佣金率 | commission_rate | XX.X%格式 | - |
| 佣金 | commission_amount | +$XX.XX格式 | 实时显示 |
| 余额 | balance_after | 当前余额 | 实时更新 |
| 状态 | settlement_status | 待确认/已确认/已结算/已支付 | Tag颜色 |

**实时推送通知**：
- 新订单 → 弹出通知 + 播放提示音
- 佣金入账 → 余额实时更新
- 状态变更 → 自动刷新显示

#### 4.2.5 催单功能

| 功能 | 说明 |
|------|------|
| 待催单列表 | 显示7天内到期的客户 |
| 剩余天数标记 | 已过期(红)/3天内(橙)/7天内(蓝) |
| 催单按钮 | 记录已联系客户 |

---

## 第五部分：客户功能模块

### 5.1 购买页面（PurchasePage.js）

#### 5.1.1 订单表单字段

| 字段名 | 输入类型 | 必填 | 验证规则 | 说明 |
|--------|---------|------|---------|------|
| 客户微信号 | Input | ✓ | 非空 | 用于身份识别 |
| TradingView用户名 | Input | ✓ | 非空 | 用于配置权限 |
| 选择时长 | Select | ✓ | 必选 | 7天/1月/3月/6月/1年 |
| 购买方式 | Radio | ✓ | - | 即时购买/延期购买 |
| 生效时间 | DatePicker | 延期时必填 | - | 选择生效日期 |
| 付款方式 | Radio | ✓ | - | 加密货币(唯一) |
| 实付金额 | InputNumber | ✓ | >0 | USDT金额 |
| 付款截图 | Upload | ✓ | 图片格式 | 支付凭证 |

#### 5.1.2 价格展示

| 时长 | 显示价格 | 特殊规则 |
|------|---------|---------|
| 7天免费 | $0 | 自动选择即时购买，禁用延期 |
| 1个月 | $188 | - |
| 3个月 | $488 | - |
| 6个月 | $888 | - |
| 1年 | $1588 | - |

#### 5.1.3 支付信息展示

| 信息类型 | 显示内容 |
|---------|---------|
| 收款地址 | 管理员配置的USDT地址 |
| 链名 | TRC20/ERC20等 |
| 二维码 | 收款地址二维码 |

---

## 第六部分：转化率统计需求（新增）🆕

### 6.1 转化率排行榜

**位置**：AdminOverview.js中，Top5销售排行榜下方

#### 6.1.1 筛选器

| 选项 | 值 | 说明 |
|------|---|------|
| 全部 | all | 显示所有销售 |
| 一级销售 | primary | 只显示一级销售 |
| 二级销售 | secondary | 只显示二级销售 |
| 独立销售 | independent | 只显示独立销售 |

#### 6.1.2 排行榜表格字段

| 列名 | 字段 | 计算逻辑 | 显示格式 |
|------|------|---------|---------|
| 排名 | conversion_rank | 按转化率降序排名 | 1-3显示奖牌 |
| 销售类型 | sales_type | 数据库字段 | Tag颜色 |
| 销售名称 | sales_wechat | 销售微信名 | 文本 |
| 免费订单数 | free_orders_count | COUNT WHERE duration='7days' | 数字 |
| 转化订单数 | converted_orders_count | COUNT 转为付费的订单 | 数字 |
| 转化率 | user_conversion_rate | (转化/免费)×100% | Progress进度条 |
| 转化金额 | conversion_amount | SUM(转化订单金额) | $XXX.XX |
| 平均转化天数 | avg_conversion_days | AVG(转化时间-试用时间) | X天 |

#### 6.1.3 转化分层可视化

| 转化目标 | 统计字段 | 显示方式 |
|---------|---------|---------|
| 转为1个月 | converted_to_1month | 柱状图/饼图 |
| 转为3个月 | converted_to_3months | 柱状图/饼图 |
| 转为6个月 | converted_to_6months | 柱状图/饼图 |
| 转为年费 | converted_to_yearly | 柱状图/饼图 |

---

## 第七部分：实时数据流架构 🆕

### 7.1 订单创建时的完整数据流

```
用户提交订单
    ↓
创建订单记录（orders表）
    ↓
PostgreSQL触发器自动执行：
    ├─ 创建对账记录（sales_reconciliation）
    ├─ 更新销售余额（sales_balance）
    ├─ 更新转化统计（conversion_stats）
    ├─ 更新资金统计（fund_statistics）
    ├─ 创建资金流水（fund_flow）
    ├─ 更新排行榜（sales_ranking）
    └─ 如果是二级销售订单：
        └─ 给一级销售创建分销对账记录
    ↓
Supabase Realtime推送
    ├─ 推送给相关销售
    ├─ 推送给管理员
    └─ 更新前端显示
```

### 7.2 实时推送配置

```javascript
// 订单变化订阅
supabase.channel('orders')
  .on('postgres_changes', { 
    event: '*', 
    schema: 'public', 
    table: 'orders' 
  }, (payload) => {
    // 更新统计数据
    // 更新余额显示
    // 弹出通知
  })

// 对账记录订阅（销售专属）
supabase.channel(`reconciliation-${salesCode}`)
  .on('postgres_changes', {
    event: 'INSERT',
    schema: 'public',
    table: 'sales_reconciliation',
    filter: `sales_code=eq.${salesCode}`
  }, (payload) => {
    // 显示新佣金
    // 更新余额
    // 播放提示音
  })
```

---

## 第八部分：佣金计算核心逻辑

### 8.1 佣金计算公式（最重要）

```
总佣金池 = 订单金额 × 40%（固定）

分配规则：

1. 一级销售直销订单：
   一级销售佣金 = 订单金额 × 40%
   
2. 二级销售订单（设二级佣金率为R，默认25%）：
   二级销售佣金 = 订单金额 × R
   一级销售分销收益 = 订单金额 × (40% - R)
   
3. 独立销售订单：
   独立销售佣金 = 订单金额 × 25%（固定）

示例：$100订单
- 一级直销：一级得$40
- 二级销售（25%）：二级得$25，一级得$15
- 独立销售：独立得$25
```

### 8.2 佣金率设置权限

| 角色 | 可设置对象 | 设置范围 | 设置位置 |
|------|-----------|---------|---------|
| 管理员 | 所有销售 | 0-100% | 销售管理页面 |
| 一级销售 | 所属二级销售 | 0-40% | 一级销售对账页面 |
| 二级销售 | 无 | - | - |
| 独立销售 | 无 | - | - |

---

## 第九部分：数据库新增需求 🆕

### 9.1 需要新建的表（16个）

| 表名 | 用途 | 优先级 |
|------|------|--------|
| users | 用户账号系统 | 低 |
| customers | 客户信息集中管理 | 高 |
| sales | 销售信息（替代secondary_sales） | 中 |
| overview_stats | 预计算的统计数据 | 高 |
| sales_ranking | 销售排行榜 | 高 |
| daily_stats | 每日统计快照 | 中 |
| conversion_stats | 转化率统计 | 高 |
| fund_statistics | 资金统计 | 高 |
| sales_reconciliation | 实时对账明细 | 高 |
| sales_balance | 销售余额 | 高 |
| fund_flow | 资金流水 | 中 |
| commission_rules | 佣金规则配置 | 中 |
| commission_records | 佣金计算记录 | 高 |
| reminder_records | 催单记录 | 低 |
| user_conversion_journey | 用户转化旅程 | 中 |
| daily_reconciliation_summary | 每日对账汇总 | 低 |

### 9.2 现有表需要添加的字段

**orders表添加**：
- sales_wechat_name（销售微信名）
- primary_sales_wechat（一级销售微信）
- primary_commission_amount（一级销售佣金）
- customer_id（客户ID）
- extra_json（扩展字段）

---

## 附录：关键问题修复记录

1. ✅ 产品定价已更正为188/488/888/1588
2. ✅ 数据概览每个字段都已详细说明
3. ✅ 订单管理所有字段含义已列出
4. ✅ 销售管理的区分逻辑已说明
5. ✅ Top5排行榜去重逻辑已解释
6. ✅ 转化率分层可视化已添加
7. ✅ 一级销售订单状态通知已添加
8. ✅ 实时对账系统已详细设计
9. ✅ 每个页面每个板块的所有字段和逻辑都已列出

---

**文档版本**：v3.0.0  
**最后更新**：2025-08-15  
**文档状态**：详细完整版