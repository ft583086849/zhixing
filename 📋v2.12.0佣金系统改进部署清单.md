# 📋 v2.12.0 佣金系统改进部署清单

> 版本：v2.12.0
> 日期：2025-01-07
> 状态：待测试

## 🎯 改进目标
- 明确区分一级直销和二级分销佣金
- 让每个销售清楚看到收益构成
- 统一佣金率管理

## 📝 修改内容

### 1. 后端API修改

#### client/src/services/supabase.js
- **getPrimarySalesSettlement方法**（第360-432行）
  - ✅ 分别计算一级直销佣金和二级分销收益
  - ✅ 计算加权平均二级佣金率
  - ✅ 添加详细的佣金拆分数据返回

#### client/src/services/api.js
- **getSales方法**（第905-959行）
  - ✅ 计算一级直销订单金额和佣金
  - ✅ 计算二级分销订单金额和收益
  - ✅ 计算加权平均二级佣金率
- **返回数据结构更新**（第1010-1023行，第1172-1184行）
  - ✅ 新增字段：base_commission_rate、primary_direct_amount、secondary_orders_amount等

### 2. 前端页面修改

#### client/src/pages/PrimarySalesSettlementPage.js
- **新增佣金明细卡片**（第226-300行）
  - ✅ 一级销售佣金额
  - ✅ 平均二级佣金率
  - ✅ 二级佣金收益额
  - ✅ 二级销售订单总额

#### client/src/components/admin/AdminSales.js
- **表格列调整**（第482-601行）
  - ❌ 删除："佣金率"列
  - ✅ 新增："平均二级佣金率"列
  - ✅ 新增："一级销售配置确认订单金额"列
  - ✅ 新增："二级销售配置确认订单金额"列
  - ✅ 新增："一级直销佣金"列
  - ✅ 新增："二级分销收益"列

#### client/src/components/admin/AdminOrders.js
- **佣金列拆分**（第386-412行）
  - ❌ 删除："佣金"列
  - ✅ 新增："一级销售佣金额"列
  - ✅ 新增："二级分销佣金额"列

## 🔢 新增字段说明

### API返回的新字段
| 字段名 | 类型 | 说明 |
|--------|------|------|
| base_commission_rate | number | 基础佣金率（一级固定0.4） |
| primary_direct_amount | number | 一级直销订单金额 |
| secondary_orders_amount | number | 二级销售订单总额 |
| secondary_avg_rate | number | 加权平均二级佣金率 |
| primary_direct_commission | number | 一级直销佣金 |
| secondary_share_commission | number | 二级分销收益 |

### 计算逻辑
```javascript
// 一级销售
直销佣金 = 直销订单 × 40%
分销收益 = 二级订单 × (40% - 二级佣金率)
总佣金 = 直销佣金 + 分销收益

// 二级销售
佣金 = 订单总额 × 自己的佣金率
```

## ✅ 测试清单

### 数据正确性测试
- [ ] 一级销售直销佣金计算正确（40%）
- [ ] 二级分销收益计算正确（差额）
- [ ] 加权平均佣金率显示正确
- [ ] 订单金额拆分正确

### 页面显示测试
- [ ] 一级销售对账页面佣金明细显示正常
- [ ] 销售管理页面新列显示正常
- [ ] 订单管理页面佣金拆分显示正常

### 兼容性测试
- [ ] 原有功能不受影响
- [ ] 数据刷新正常
- [ ] 编辑功能正常

## 🚀 部署步骤

1. **本地测试**
```bash
npm run test
```

2. **提交代码**
```bash
git add .
git commit -m "feat: v2.12.0 佣金系统改进 - 区分直销和分销"
git push
```

3. **部署到Vercel**
- 等待自动部署完成
- 清除Vercel缓存

4. **线上验证**
- 检查各页面显示
- 验证计算逻辑
- 确认数据准确性

## ⚠️ 注意事项

1. **数据库无需修改**：本次更新仅涉及前端显示和计算逻辑
2. **佣金率格式**：确保数据库中佣金率为小数格式（0.4而非40）
3. **缓存清理**：部署后需要清理浏览器缓存

## 📌 待办事项

- [ ] 实现佣金率调整功能（一级可调二级）
- [ ] 添加7天免费转收费统计页面
- [ ] 优化移动端显示

## 🔄 回滚方案

如需回滚，执行：
```bash
git revert HEAD
git push
```

---

**部署负责人**：___________
**部署时间**：___________
**验证结果**：□ 通过 □ 失败
