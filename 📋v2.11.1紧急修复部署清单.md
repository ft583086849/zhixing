# 📋 v2.11.1 紧急修复部署清单

## 🎯 修复内容

### 1. ✅ 回滚WML792355703佣金计算逻辑
**问题**：v2.10.3的修改导致佣金计算错误，总金额和已配置确认订单金额显示异常
**解决方案**：
- 恢复到v2.10.3之前的逻辑
- 优先使用数据库中的`confirmed_amount`字段
- 只有当数据库没有值时才实时计算
- 适用于一级销售和二级销售

**修改文件**：
- `client/src/services/api.js`（行873-891, 行1027-1046）

### 2. ✅ 销售管理排序优化
**需求**：按创建时间降序排序（最新的在前）
**实现**：
- 10月10日 17:00创建的销售排第1位
- 10月10日 16:00创建的销售排第2位
- 依此类推，新的在上，旧的在下

**修改文件**：
- `client/src/services/api.js`（行1154-1159）

### 3. ✅ 客户管理排序验证
**需求**：按最新订单时间降序排序
**状态**：已正确实现
- 优先使用`latest_order_time`
- 其次使用`first_order`
- 最新下单的客户排在最前面

**位置**：
- `client/src/services/api.js`（行464-473）

## 📝 修改详情

### api.js佣金计算回滚
```javascript
// 旧逻辑（v2.10.3）- 有问题
const confirmedOrders = allRelatedOrders.filter(order => 
  ['confirmed', 'confirmed_configuration', 'confirmed_config', 'active'].includes(order.status)
);
const confirmedAmount = confirmedOrders.reduce(/*...*/)

// 新逻辑（回滚后）- 修复
let confirmedAmount = 0;
// 优先使用数据库值
if (sale.confirmed_amount !== undefined && sale.confirmed_amount !== null) {
  confirmedAmount = sale.confirmed_amount;
} else {
  // 数据库没有才计算
  const confirmedOrders = allRelatedOrders.filter(/*...*/)
  confirmedAmount = confirmedOrders.reduce(/*...*/)
}
```

### 销售排序实现
```javascript
// 按创建时间降序排序
allSales.sort((a, b) => {
  const timeA = new Date(a.created_at || 0);
  const timeB = new Date(b.created_at || 0);
  return timeB - timeA; // 降序：新的在前
});
```

## ✅ 验证步骤

1. **佣金计算验证**
   - 访问销售管理页面
   - 查看WML792355703的数据
   - 确认总金额、已配置确认订单金额显示正确
   - 确认应返佣金额按正确比例计算

2. **销售排序验证**
   - 访问销售管理页面
   - 确认列表按创建时间从新到旧排序
   - 最新创建的销售应该在最上面

3. **客户排序验证**
   - 访问客户管理页面
   - 确认列表按最新订单时间排序
   - 最近下单的客户应该在最上面

## 🚀 部署信息

- **版本号**：v2.11.1
- **部署时间**：2025-01-07
- **提交信息**：
  - 回滚佣金计算逻辑
  - 实现销售管理排序
  - 验证客户管理排序

## ⚠️ 注意事项

1. 本次修复主要解决v2.10.3引入的问题
2. 佣金计算逻辑回滚不影响其他功能
3. 排序功能为新增优化，不影响现有数据
