# 📋 v2.8.0 待修复问题清单

## 📊 问题列表

### 1. 待付款确认订单统计优化 ⚠️

**问题描述**：
- 7天免费订单进来就是待配置确认状态
- 但统计时被计入"待付款确认订单"
- 7天免费订单不需要付款，不应该计入该统计

**当前逻辑**：
```javascript
// api.js 第1254-1256行
const pending_payment_orders = ordersToProcess.filter(order => 
  ['pending_payment', 'pending', 'pending_review'].includes(order.status)
).length;
```

**修复方案**：
```javascript
// 排除7天免费订单
const pending_payment_orders = ordersToProcess.filter(order => 
  ['pending_payment', 'pending', 'pending_review'].includes(order.status) &&
  order.duration !== '7days'  // 排除7天免费订单
).length;
```

**影响文件**：
- `client/src/services/api.js` - AdminAPI.getStats 方法

---

### 2. 二级销售佣金率文档更新 📝

**需要更新的文档**：

| 文件 | 位置 | 原内容 | 应改为 |
|-----|------|--------|--------|
| 一级销售对账页面过滤逻辑说明.md | 第85行 | 默认30% | 默认25% |
| 生产环境操作手册.md | 第43行 | 二级销售默认：30% | 二级销售默认：25% |

---

### 3. 资金统计收益分配增强 💰

**需求**：
1. 添加"已分配"列
2. 添加"待分配"列
3. 已分配要能手动修改记录

**数据库修改**：
```sql
-- 创建收益分配记录表
CREATE TABLE IF NOT EXISTS profit_distributions (
  id SERIAL PRIMARY KEY,
  category VARCHAR(50) NOT NULL, -- 'public', 'zhixing', 'zijun'
  allocated_amount DECIMAL(10,2) DEFAULT 0, -- 已分配金额
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 插入初始数据
INSERT INTO profit_distributions (category, allocated_amount) 
VALUES 
  ('public', 0),
  ('zhixing', 0),
  ('zijun', 0)
ON CONFLICT DO NOTHING;
```

**前端修改**：
1. `AdminFinance.js` - 添加新列和编辑功能
   - 添加"已分配"列（InputNumber可编辑）
   - 添加"待分配"列（分配金额 - 已分配）
   - 添加保存已分配金额的功能

2. `api.js` - 添加API方法
   - `updateAllocatedAmount(category, amount)` - 更新已分配金额
   - `getAllocatedAmounts()` - 获取所有已分配金额

---

## 🚀 实施计划

### 第一步：修复待付款确认订单统计
- 修改 `api.js` 的统计逻辑
- 测试7天免费订单不被计入

### 第二步：更新文档
- 更新所有提到30%默认佣金率的文档
- 统一为25%

### 第三步：增强资金统计（需要数据库支持）
- 执行SQL创建表
- 修改前端组件
- 添加API接口

## ⚠️ 注意事项

1. **数据库修改需要在 Supabase 执行**
2. **已分配金额需要持久化存储**
3. **确保所有佣金率统一为25%**

## 📋 测试要点

- [ ] 创建7天免费订单，验证不计入"待付款确认订单"
- [ ] 验证所有二级销售默认佣金率为25%
- [ ] 测试已分配金额的修改和保存
- [ ] 验证待分配金额的自动计算

---

**版本**：v2.8.0
**创建时间**：2025-01-07
**状态**：待实施
