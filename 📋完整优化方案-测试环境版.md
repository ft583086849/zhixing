# ğŸ“‹ çŸ¥è¡Œè´¢åº“ç³»ç»Ÿå®Œæ•´ä¼˜åŒ–æ–¹æ¡ˆ - æµ‹è¯•ç¯å¢ƒç‰ˆ

> âš ï¸ **é‡è¦è¯´æ˜**ï¼šæ‰€æœ‰ä¼˜åŒ–æ–¹æ¡ˆä»…åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œï¼Œéœ€è¦æ‚¨æ˜ç¡®åŒæ„åæ‰èƒ½ä¸Šçº¿
> åˆ›å»ºæ—¶é—´ï¼š2024-12-19
> ç‰ˆæœ¬ï¼šv1.0
> çŠ¶æ€ï¼šæµ‹è¯•ç¯å¢ƒæ–¹æ¡ˆ

---

## ä¸€ã€è®¢å•ç®¡ç†é¡µé¢ä¼˜åŒ–ï¼ˆAdminOrdersï¼‰

### 1.1 ç°çŠ¶é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 2-4ç§’
- **æ•°æ®é‡**: 291ä¸ªè®¢å•ï¼Œæ¯ä¸ªè®¢å•éœ€JOIN 4ä¸ªè¡¨
- **æ€§èƒ½ç“¶é¢ˆ**:
  - æ¯æ¬¡æŸ¥è¯¢JOIN ordersã€primary_salesã€secondary_salesã€customersè¡¨
  - æ— åˆ†é¡µä¼˜åŒ–ï¼Œä¸€æ¬¡åŠ è½½æ‰€æœ‰æ•°æ®
  - ç¼ºå°‘ç´¢å¼•å¯¼è‡´å…¨è¡¨æ‰«æ
  - çŠ¶æ€æ›´æ–°éœ€è¦åˆ·æ–°æ•´ä¸ªé¡µé¢

### 1.2 æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

#### 1.2.1 é¢„ç•™å­—æ®µï¼ˆä¸ºç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å‡†å¤‡ï¼‰
```sql
-- ordersè¡¨é¢„ç•™å­—æ®µ
ALTER TABLE orders ADD COLUMN IF NOT EXISTS user_id INTEGER;  -- ç”¨æˆ·è´¦å·ID
ALTER TABLE orders ADD COLUMN IF NOT EXISTS customer_became_sales BOOLEAN DEFAULT FALSE;  -- å®¢æˆ·æ˜¯å¦è½¬é”€å”®
ALTER TABLE orders ADD COLUMN IF NOT EXISTS sales_conversion_date TIMESTAMP;  -- è½¬åŒ–æ—¶é—´
ALTER TABLE orders ADD COLUMN IF NOT EXISTS link_type VARCHAR(20);  -- é“¾æ¥ç±»å‹: purchase/recruit
ALTER TABLE orders ADD COLUMN IF NOT EXISTS parent_sales_type VARCHAR(20);  -- ä¸Šçº§é”€å”®ç±»å‹
ALTER TABLE orders ADD COLUMN IF NOT EXISTS commission_rate_snapshot DECIMAL(5,2);  -- è¿”ä½£ç‡å¿«ç…§
ALTER TABLE orders ADD COLUMN IF NOT EXISTS is_first_order BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦é¦–å•
ALTER TABLE orders ADD COLUMN IF NOT EXISTS referral_source VARCHAR(50);  -- æ¨èæ¥æº
ALTER TABLE orders ADD COLUMN IF NOT EXISTS auto_renewal BOOLEAN DEFAULT FALSE;  -- æ˜¯å¦è‡ªåŠ¨ç»­è´¹
ALTER TABLE orders ADD COLUMN IF NOT EXISTS renewal_from_order_id INTEGER;  -- ç»­è´¹æ¥æºè®¢å•
```

#### 1.2.2 åˆ›å»ºé«˜æ€§èƒ½ç´¢å¼•
```sql
-- æ ¸å¿ƒç´¢å¼•
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_status ON orders(status) WHERE status != 'rejected';
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_sales_code ON orders(sales_code);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_created_at ON orders(created_at DESC);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_payment_time ON orders(payment_time DESC) WHERE payment_time IS NOT NULL;

-- å¤åˆç´¢å¼•ï¼ˆå¸¸ç”¨ç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_status_created ON orders(status, created_at DESC);
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_sales_created ON orders(sales_code, created_at DESC);

-- é¢„ç•™ç´¢å¼•
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_user_id ON orders(user_id) WHERE user_id IS NOT NULL;
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_orders_conversion ON orders(customer_became_sales) WHERE customer_became_sales = TRUE;
```

#### 1.2.3 åˆ›å»ºç‰©åŒ–è§†å›¾
```sql
CREATE MATERIALIZED VIEW IF NOT EXISTS orders_with_details AS
SELECT 
  o.*,
  -- é”€å”®ä¿¡æ¯
  COALESCE(ps.wechat_name, ss.wechat_name) as sales_name,
  COALESCE(ps.commission_rate, ss.commission_rate, 0) as commission_rate,
  CASE 
    WHEN ps.id IS NOT NULL THEN 'primary'
    WHEN ss.primary_sales_id IS NOT NULL THEN 'secondary'
    WHEN ss.id IS NOT NULL THEN 'independent'
    ELSE 'direct'
  END as sales_type,
  -- å®¢æˆ·ä¿¡æ¯
  c.wechat_name as customer_name,
  c.email as customer_email,
  c.is_sales as customer_is_sales,  -- é¢„ç•™
  -- è®¡ç®—ä½£é‡‘
  CASE
    WHEN o.status IN ('confirmed_config', 'active') THEN
      COALESCE(o.actual_payment_amount, o.amount, 0) * 
      COALESCE(ps.commission_rate, ss.commission_rate, 0) / 100
    ELSE 0
  END as calculated_commission
FROM orders o
LEFT JOIN primary_sales ps ON o.primary_sales_id = ps.id
LEFT JOIN secondary_sales ss ON o.secondary_sales_id = ss.id
LEFT JOIN customers c ON o.customer_id = c.id;

-- åˆ›å»ºç´¢å¼•
CREATE UNIQUE INDEX ON orders_with_details (id);
CREATE INDEX ON orders_with_details (status);
CREATE INDEX ON orders_with_details (sales_code);
CREATE INDEX ON orders_with_details (created_at DESC);

-- è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯5åˆ†é’Ÿï¼‰
CREATE OR REPLACE FUNCTION refresh_orders_view()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY orders_with_details;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼ˆéœ€è¦pg_cronæ‰©å±•ï¼‰
-- SELECT cron.schedule('refresh-orders', '*/5 * * * *', 'SELECT refresh_orders_view()');
```

### 1.3 ç¼“å­˜å±‚å®ç°

```javascript
// ordersCache.js - å®Œæ•´å®ç°
class OrdersCacheManager {
  constructor() {
    this.cache = new Map();
    this.indexes = {
      byStatus: new Map(),
      bySales: new Map(),
      byCustomer: new Map(),
      byDate: new Map(),
      byOrderNumber: new Map()
    };
    this.cacheDuration = 3 * 60 * 1000; // 3åˆ†é’Ÿ
    this.stats = {
      hits: 0,
      misses: 0,
      updates: 0
    };
  }

  // æ‰¹é‡å¤„ç†ä¼˜åŒ–
  async batchProcessOrders(orders, salesData) {
    const startTime = Date.now();
    
    // å¹¶è¡Œå¤„ç†
    const processed = await Promise.all(
      orders.map(async order => this.enrichOrder(order, salesData))
    );
    
    // æ„å»ºç´¢å¼•
    this.buildIndexes(processed);
    
    const processTime = Date.now() - startTime;
    console.log(`âœ… å¤„ç†${orders.length}ä¸ªè®¢å•è€—æ—¶: ${processTime}ms`);
    
    return processed;
  }
  
  // æŸ¥è¯¢ä¼˜åŒ–
  query(filters = {}) {
    const { status, sales_code, customer, date_range, search } = filters;
    
    // ä½¿ç”¨ç´¢å¼•å¿«é€ŸæŸ¥è¯¢
    if (status && this.indexes.byStatus.has(status)) {
      this.stats.hits++;
      return this.indexes.byStatus.get(status);
    }
    
    if (sales_code && this.indexes.bySales.has(sales_code)) {
      this.stats.hits++;
      return this.indexes.bySales.get(sales_code);
    }
    
    // é™çº§åˆ°è¿‡æ»¤æŸ¥è¯¢
    this.stats.misses++;
    return this.filterOrders(filters);
  }
  
  // å•æ¡æ›´æ–°ï¼ˆä¸åˆ·æ–°æ•´ä¸ªåˆ—è¡¨ï¼‰
  updateSingle(orderId, updates) {
    const order = this.cache.get(`order_${orderId}`);
    if (order) {
      Object.assign(order, updates);
      this.rebuildIndexForOrder(order);
      this.stats.updates++;
    }
  }
  
  // è·å–ç¼“å­˜ç»Ÿè®¡
  getStats() {
    const hitRate = this.stats.hits / (this.stats.hits + this.stats.misses) * 100;
    return {
      ...this.stats,
      hitRate: `${hitRate.toFixed(2)}%`,
      cacheSize: this.cache.size
    };
  }
}

export default new OrdersCacheManager();
```

### 1.4 APIä¼˜åŒ–

```javascript
// api.js - getOrdersä¼˜åŒ–
async getOrders(params = {}) {
  const { 
    page = 1, 
    limit = 100, 
    status, 
    sales_code, 
    date_range,
    use_cache = true 
  } = params;
  
  // 1. ç¼“å­˜ç­–ç•¥
  if (use_cache) {
    const cached = ordersCacheManager.query(params);
    if (cached) {
      console.log('ğŸ“¦ è®¢å•ç¼“å­˜å‘½ä¸­');
      return cached;
    }
  }
  
  // 2. ä½¿ç”¨ç‰©åŒ–è§†å›¾
  let query = supabase
    .from('orders_with_details')
    .select('*', { count: 'exact' });
  
  // 3. æ™ºèƒ½ç­›é€‰
  if (status && status !== 'all') {
    query = query.eq('status', status);
  }
  
  if (sales_code) {
    query = query.eq('sales_code', sales_code);
  }
  
  if (date_range) {
    const { start, end } = date_range;
    query = query.gte('created_at', start).lte('created_at', end);
  }
  
  // 4. åˆ†é¡µä¼˜åŒ–
  query = query
    .order('created_at', { ascending: false })
    .range((page - 1) * limit, page * limit - 1);
  
  const { data, count, error } = await query;
  
  if (!error && data) {
    // 5. æ›´æ–°ç¼“å­˜
    const processed = await ordersCacheManager.batchProcessOrders(data, {
      primary: await this.getPrimarySales(),
      secondary: await this.getSecondarySales()
    });
    
    return { 
      data: processed, 
      count,
      page,
      total_pages: Math.ceil(count / limit)
    };
  }
  
  throw error;
}
```

### 1.5 å‰ç«¯ä¼˜åŒ–

```javascript
// AdminOrders.js - å®Œæ•´ä¼˜åŒ–
import { useState, useCallback, useMemo, useEffect } from 'react';
import { Table, Button, Select, DatePicker, message } from 'antd';
import { FixedSizeList } from 'react-window'; // è™šæ‹Ÿæ»šåŠ¨

const AdminOrders = () => {
  const [orders, setOrders] = useState([]);
  const [loading, setLoading] = useState(false);
  const [filters, setFilters] = useState({
    status: 'all',
    sales_code: null,
    date_range: null
  });
  const [pagination, setPagination] = useState({
    current: 1,
    pageSize: 100,
    total: 0
  });
  
  // ä¼˜åŒ–ï¼šä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨å¤„ç†å¤§æ•°æ®é‡
  const VirtualTable = useCallback(({ columns, dataSource }) => {
    const Row = ({ index, style }) => (
      <div style={style}>
        <Table.Row>
          {columns.map(col => (
            <Table.Cell key={col.key}>
              {dataSource[index][col.dataIndex]}
            </Table.Cell>
          ))}
        </Table.Row>
      </div>
    );
    
    return (
      <FixedSizeList
        height={600}
        itemCount={dataSource.length}
        itemSize={60}
        width="100%"
      >
        {Row}
      </FixedSizeList>
    );
  }, []);
  
  // ä¼˜åŒ–ï¼šæ‰¹é‡çŠ¶æ€æ›´æ–°
  const batchUpdateStatus = useCallback(async (orderIds, newStatus) => {
    // ä¹è§‚UIæ›´æ–°
    setOrders(prev => prev.map(order => 
      orderIds.includes(order.id) 
        ? { ...order, status: newStatus, updating: true }
        : order
    ));
    
    try {
      // æ‰¹é‡APIè°ƒç”¨
      const batchSize = 10;
      for (let i = 0; i < orderIds.length; i += batchSize) {
        const batch = orderIds.slice(i, i + batchSize);
        await Promise.all(
          batch.map(id => adminAPI.updateOrderStatus(id, newStatus))
        );
      }
      
      message.success(`æˆåŠŸæ›´æ–°${orderIds.length}ä¸ªè®¢å•`);
      
      // æ›´æ–°ç¼“å­˜
      orderIds.forEach(id => {
        ordersCacheManager.updateSingle(id, { status: newStatus });
      });
      
    } catch (error) {
      message.error('æ›´æ–°å¤±è´¥ï¼Œæ­£åœ¨å›æ»š...');
      // å›æ»šUI
      await loadData();
    }
  }, []);
  
  // ä¼˜åŒ–ï¼šæ™ºèƒ½åŠ è½½æ•°æ®
  const loadData = useCallback(async () => {
    setLoading(true);
    try {
      const result = await adminAPI.getOrders({
        ...filters,
        page: pagination.current,
        limit: pagination.pageSize
      });
      
      setOrders(result.data);
      setPagination(prev => ({
        ...prev,
        total: result.count
      }));
      
    } catch (error) {
      message.error('åŠ è½½å¤±è´¥');
    } finally {
      setLoading(false);
    }
  }, [filters, pagination.current, pagination.pageSize]);
  
  // ä¼˜åŒ–ï¼šé˜²æŠ–æœç´¢
  const debouncedSearch = useMemo(
    () => debounce((value) => {
      setFilters(prev => ({ ...prev, search: value }));
    }, 500),
    []
  );
  
  // æ€§èƒ½ç›‘æ§
  useEffect(() => {
    const stats = ordersCacheManager.getStats();
    console.log('ğŸ“Š ç¼“å­˜ç»Ÿè®¡:', stats);
  }, [orders]);
  
  return (
    <div>
      {/* ç­›é€‰å™¨ */}
      <div className="filters">
        <Select 
          value={filters.status}
          onChange={v => setFilters(prev => ({ ...prev, status: v }))}
          options={[
            { value: 'all', label: 'å…¨éƒ¨' },
            { value: 'pending_payment', label: 'å¾…ä»˜æ¬¾' },
            { value: 'pending_config', label: 'å¾…é…ç½®' },
            { value: 'confirmed_config', label: 'å·²å®Œæˆ' }
          ]}
        />
        <DatePicker.RangePicker 
          onChange={(dates) => setFilters(prev => ({ 
            ...prev, 
            date_range: dates ? {
              start: dates[0].format('YYYY-MM-DD'),
              end: dates[1].format('YYYY-MM-DD')
            } : null
          }))}
        />
      </div>
      
      {/* è™šæ‹Ÿæ»šåŠ¨è¡¨æ ¼ */}
      <VirtualTable 
        columns={columns}
        dataSource={orders}
        loading={loading}
      />
      
      {/* åˆ†é¡µ */}
      <Pagination 
        {...pagination}
        onChange={(page, pageSize) => {
          setPagination(prev => ({ ...prev, current: page, pageSize }));
        }}
      />
    </div>
  );
};
```

### 1.6 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| é¦–æ¬¡åŠ è½½ | 2-4ç§’ | <0.5ç§’ | 87.5% |
| ç¿»é¡µå“åº” | 1-2ç§’ | <100ms | 95% |
| çŠ¶æ€æ›´æ–° | åˆ·æ–°é¡µé¢ | å³æ—¶æ›´æ–° | 100% |
| å†…å­˜å ç”¨ | 50MB | 20MB | 60% |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | >85% | - |

---

## äºŒã€é”€å”®ç®¡ç†é¡µé¢ä¼˜åŒ–ï¼ˆAdminSalesï¼‰

### 2.1 ç°çŠ¶é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 2-3ç§’
- **æ•°æ®é‡**: 24ä¸ªé”€å”®ï¼Œæ¯ä¸ªéœ€è¦è®¡ç®—è®¢å•ç»Ÿè®¡
- **æ€§èƒ½ç“¶é¢ˆ**:
  - å¾ªç¯æŸ¥è¯¢æ¯ä¸ªé”€å”®çš„è®¢å•
  - å®æ—¶è®¡ç®—ä½£é‡‘å’Œä¸šç»©
  - é”€å”®å±‚çº§å…³ç³»å¤æ‚
  - æ— ç¼“å­˜æœºåˆ¶

### 2.2 æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

#### 2.2.1 é¢„ç•™å­—æ®µ
```sql
-- primary_salesè¡¨é¢„ç•™å­—æ®µ
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS user_id INTEGER;
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS allow_recruit BOOLEAN DEFAULT TRUE;
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS max_secondary_count INTEGER DEFAULT 100;
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS recruit_link VARCHAR(255);
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS purchase_link VARCHAR(255);
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS total_recruited INTEGER DEFAULT 0;
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS last_active_date DATE;
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS monthly_target DECIMAL(10,2);
ALTER TABLE primary_sales ADD COLUMN IF NOT EXISTS achievement_rate DECIMAL(5,2);

-- secondary_salesè¡¨é¢„ç•™å­—æ®µ
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS user_id INTEGER;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS source_type VARCHAR(50);
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS converted_from_order_id INTEGER;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS converted_from_customer_id INTEGER;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS conversion_date TIMESTAMP;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS parent_commission_rate DECIMAL(5,2);
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS allow_recruit BOOLEAN DEFAULT FALSE;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS payment_qr_code TEXT;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS payment_info TEXT;
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS bank_account VARCHAR(255);
ALTER TABLE secondary_sales ADD COLUMN IF NOT EXISTS bank_name VARCHAR(100);
```

#### 2.2.2 åˆ›å»ºé”€å”®ç»Ÿè®¡è¡¨
```sql
-- å·²å®Œæˆçš„sales_statisticsè¡¨
CREATE TABLE IF NOT EXISTS sales_statistics (
  id SERIAL PRIMARY KEY,
  sales_id INTEGER NOT NULL,
  sales_type VARCHAR(20) NOT NULL,
  sales_code VARCHAR(50) NOT NULL,
  
  -- è®¢å•ç»Ÿè®¡
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  pending_orders INTEGER DEFAULT 0,
  rejected_orders INTEGER DEFAULT 0,
  
  -- é‡‘é¢ç»Ÿè®¡
  total_amount DECIMAL(10,2) DEFAULT 0,
  confirmed_amount DECIMAL(10,2) DEFAULT 0,
  pending_amount DECIMAL(10,2) DEFAULT 0,
  
  -- ä½£é‡‘ç»Ÿè®¡
  commission_rate DECIMAL(5,2),
  commission_amount DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  
  -- å®¢æˆ·ç»Ÿè®¡
  total_customers INTEGER DEFAULT 0,
  new_customers_month INTEGER DEFAULT 0,
  
  -- è½¬åŒ–ç»Ÿè®¡
  conversion_rate DECIMAL(5,2) DEFAULT 0,
  recruited_count INTEGER DEFAULT 0,
  
  -- æ—¶é—´ç»Ÿè®¡
  first_order_date DATE,
  last_order_date DATE,
  last_updated TIMESTAMP DEFAULT NOW(),
  
  UNIQUE(sales_id, sales_type)
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_sales_stats_code ON sales_statistics(sales_code);
CREATE INDEX idx_sales_stats_type ON sales_statistics(sales_type);
CREATE INDEX idx_sales_stats_updated ON sales_statistics(last_updated);
```

#### 2.2.3 åˆ›å»ºæ›´æ–°è§¦å‘å™¨
```sql
-- è‡ªåŠ¨æ›´æ–°é”€å”®ç»Ÿè®¡
CREATE OR REPLACE FUNCTION update_sales_statistics()
RETURNS TRIGGER AS $$
DECLARE
  v_sales_id INTEGER;
  v_sales_type VARCHAR(20);
  v_sales_code VARCHAR(50);
BEGIN
  -- è·å–é”€å”®ä¿¡æ¯
  IF NEW.primary_sales_id IS NOT NULL THEN
    v_sales_id := NEW.primary_sales_id;
    v_sales_type := 'primary';
    SELECT sales_code INTO v_sales_code FROM primary_sales WHERE id = v_sales_id;
  ELSIF NEW.secondary_sales_id IS NOT NULL THEN
    v_sales_id := NEW.secondary_sales_id;
    v_sales_type := 'secondary';
    SELECT sales_code INTO v_sales_code FROM secondary_sales WHERE id = v_sales_id;
  ELSE
    RETURN NEW;
  END IF;
  
  -- æ›´æ–°ç»Ÿè®¡
  INSERT INTO sales_statistics (
    sales_id, sales_type, sales_code,
    total_orders, valid_orders, total_amount, confirmed_amount
  )
  SELECT 
    v_sales_id,
    v_sales_type,
    v_sales_code,
    COUNT(*),
    COUNT(*) FILTER (WHERE status != 'rejected'),
    SUM(amount),
    SUM(CASE WHEN status = 'confirmed_config' THEN amount ELSE 0 END)
  FROM orders
  WHERE (primary_sales_id = v_sales_id OR secondary_sales_id = v_sales_id)
  ON CONFLICT (sales_id, sales_type) 
  DO UPDATE SET
    total_orders = EXCLUDED.total_orders,
    valid_orders = EXCLUDED.valid_orders,
    total_amount = EXCLUDED.total_amount,
    confirmed_amount = EXCLUDED.confirmed_amount,
    last_updated = NOW();
    
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- åˆ›å»ºè§¦å‘å™¨
CREATE TRIGGER trg_update_sales_stats
AFTER INSERT OR UPDATE ON orders
FOR EACH ROW
EXECUTE FUNCTION update_sales_statistics();
```

### 2.3 ç¼“å­˜å±‚å®ç°

```javascript
// salesCache.js - å®Œæ•´å®ç°
class SalesCacheManager {
  constructor() {
    this.cache = new Map();
    this.cacheDuration = 5 * 60 * 1000; // 5åˆ†é’Ÿ
    this.hierarchyMap = new Map(); // é”€å”®å±‚çº§å…³ç³»
  }
  
  // æ‰¹é‡å¤„ç†é”€å”®æ•°æ®
  async batchProcessSales(primarySales, secondarySales, orders) {
    const startTime = Date.now();
    
    // 1. æ„å»ºè®¢å•ç´¢å¼• O(n)
    const ordersBySales = new Map();
    orders.forEach(order => {
      const key = order.sales_code;
      if (!ordersBySales.has(key)) {
        ordersBySales.set(key, []);
      }
      ordersBySales.get(key).push(order);
    });
    
    // 2. æ„å»ºå±‚çº§å…³ç³»
    this.buildHierarchy(primarySales, secondarySales);
    
    // 3. å¹¶è¡Œå¤„ç†
    const [processedPrimary, processedSecondary] = await Promise.all([
      this.processPrimarySales(primarySales, ordersBySales),
      this.processSecondarySales(secondarySales, ordersBySales)
    ]);
    
    // 4. åˆå¹¶ç»“æœ
    const allSales = [...processedPrimary, ...processedSecondary];
    
    console.log(`âœ… æ‰¹é‡å¤„ç†${allSales.length}ä¸ªé”€å”®è€—æ—¶: ${Date.now() - startTime}ms`);
    
    // 5. æ›´æ–°ç¼“å­˜
    this.cache.set('all_sales', allSales);
    this.cache.set('timestamp', Date.now());
    
    return allSales;
  }
  
  // å¤„ç†ä¸€çº§é”€å”®
  async processPrimarySales(sales, ordersBySales) {
    return sales.map(sale => {
      const orders = ordersBySales.get(sale.sales_code) || [];
      const stats = this.calculateStats(orders);
      const subordinates = this.getSubordinates(sale.id);
      
      return {
        ...sale,
        ...stats,
        sales_type: 'ä¸€çº§é”€å”®',
        subordinate_count: subordinates.length,
        subordinate_performance: this.calculateSubordinatePerformance(subordinates, ordersBySales),
        team_total: stats.total_amount + this.calculateSubordinatePerformance(subordinates, ordersBySales)
      };
    });
  }
  
  // è®¡ç®—ç»Ÿè®¡æ•°æ®
  calculateStats(orders) {
    const validOrders = orders.filter(o => o.status !== 'rejected');
    const confirmedOrders = orders.filter(o => o.status === 'confirmed_config');
    
    return {
      total_orders: orders.length,
      valid_orders: validOrders.length,
      confirmed_orders: confirmedOrders.length,
      total_amount: orders.reduce((sum, o) => sum + (o.amount || 0), 0),
      confirmed_amount: confirmedOrders.reduce((sum, o) => sum + (o.amount || 0), 0),
      conversion_rate: validOrders.length > 0 
        ? (confirmedOrders.length / validOrders.length * 100).toFixed(2)
        : 0
    };
  }
  
  // è·å–ç¼“å­˜ç»Ÿè®¡
  getCacheStats() {
    const now = Date.now();
    const timestamp = this.cache.get('timestamp');
    const age = timestamp ? now - timestamp : 0;
    
    return {
      size: this.cache.size,
      age: `${Math.floor(age / 1000)}ç§’`,
      expired: age > this.cacheDuration
    };
  }
}

export default new SalesCacheManager();
```

### 2.4 APIä¼˜åŒ–

```javascript
// ä¼˜åŒ–çš„getSalesæ–¹æ³•
async getSales(params = {}) {
  const { sales_type, search, sort_by = 'created_at', use_stats_table = true } = params;
  
  // 1. ä¼˜å…ˆä½¿ç”¨ç»Ÿè®¡è¡¨
  if (use_stats_table) {
    try {
      const { data: stats } = await supabase
        .from('sales_statistics')
        .select(`
          *,
          primary_sales!inner(wechat_name, phone, email),
          secondary_sales!inner(wechat_name, phone, email)
        `)
        .order(sort_by, { ascending: false });
        
      if (stats) {
        return this.formatSalesFromStats(stats);
      }
    } catch (error) {
      console.warn('ç»Ÿè®¡è¡¨æŸ¥è¯¢å¤±è´¥ï¼Œé™çº§åˆ°å®æ—¶æŸ¥è¯¢', error);
    }
  }
  
  // 2. é™çº§åˆ°ç¼“å­˜æŸ¥è¯¢
  const cached = salesCacheManager.get(params);
  if (cached && !salesCacheManager.isExpired()) {
    console.log('âœ… é”€å”®ç¼“å­˜å‘½ä¸­');
    return cached;
  }
  
  // 3. å®æ—¶æŸ¥è¯¢ï¼ˆæ‰¹é‡ä¼˜åŒ–ï¼‰
  const [primarySales, secondarySales, orders] = await Promise.all([
    supabase.from('primary_sales').select('*'),
    supabase.from('secondary_sales').select('*'),
    supabase.from('orders').select('*').neq('status', 'rejected')
  ]);
  
  // 4. æ‰¹é‡å¤„ç†
  const processed = await salesCacheManager.batchProcessSales(
    primarySales.data,
    secondarySales.data,
    orders.data
  );
  
  return processed;
}
```

### 2.5 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| åŠ è½½æ—¶é—´ | 2-3ç§’ | <0.5ç§’ | 83% |
| æ•°æ®åº“æŸ¥è¯¢ | 25+ | 3ä¸ª | 88% |
| ç¼“å­˜å‘½ä¸­ç‡ | 0% | >90% | - |
| å®æ—¶æ€§ | æ¯æ¬¡æŸ¥è¯¢ | 5åˆ†é’Ÿæ›´æ–° | - |

---

## ä¸‰ã€å®¢æˆ·ç®¡ç†é¡µé¢ä¼˜åŒ–ï¼ˆAdminCustomersï¼‰

### 3.1 ç°çŠ¶é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 1-2ç§’
- **æ•°æ®é‡**: 100+ å®¢æˆ·
- **æ€§èƒ½ç“¶é¢ˆ**:
  - å®¢æˆ·æ•°æ®åˆ†æ•£åœ¨å¤šè¡¨
  - éœ€è¦è®¡ç®—æ¯ä¸ªå®¢æˆ·çš„è®¢å•ç»Ÿè®¡
  - æœç´¢åŠŸèƒ½æ•ˆç‡ä½
  - æ— ç´¢å¼•æ”¯æŒ

### 3.2 æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

#### 3.2.1 é¢„ç•™å­—æ®µ
```sql
-- customersè¡¨é¢„ç•™å­—æ®µ
ALTER TABLE customers ADD COLUMN IF NOT EXISTS user_id INTEGER;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS is_sales BOOLEAN DEFAULT FALSE;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS sales_type VARCHAR(20);
ALTER TABLE customers ADD COLUMN IF NOT EXISTS became_sales_at TIMESTAMP;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS sales_code VARCHAR(50);
ALTER TABLE customers ADD COLUMN IF NOT EXISTS sales_link VARCHAR(255);
ALTER TABLE customers ADD COLUMN IF NOT EXISTS parent_sales_id INTEGER;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS parent_sales_type VARCHAR(20);
ALTER TABLE customers ADD COLUMN IF NOT EXISTS commission_rate DECIMAL(5,2);
ALTER TABLE customers ADD COLUMN IF NOT EXISTS payment_qr_code TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS payment_address TEXT;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS total_earned_commission DECIMAL(10,2) DEFAULT 0;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS pending_commission DECIMAL(10,2) DEFAULT 0;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS last_purchase_date DATE;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS lifetime_value DECIMAL(10,2) DEFAULT 0;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS referral_count INTEGER DEFAULT 0;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS vip_level INTEGER DEFAULT 0;
ALTER TABLE customers ADD COLUMN IF NOT EXISTS tags TEXT[];  -- æ ‡ç­¾æ•°ç»„
```

#### 3.2.2 åˆ›å»ºå®¢æˆ·ç»Ÿè®¡è§†å›¾
```sql
CREATE MATERIALIZED VIEW IF NOT EXISTS customer_stats AS
SELECT 
  c.id,
  c.wechat_name,
  c.email,
  c.phone,
  c.created_at,
  c.is_sales,  -- é¢„ç•™
  c.sales_code as customer_sales_code,  -- é¢„ç•™
  -- è®¢å•ç»Ÿè®¡
  COUNT(DISTINCT o.id) as total_orders,
  COUNT(DISTINCT o.id) FILTER (WHERE o.status != 'rejected') as valid_orders,
  COUNT(DISTINCT o.id) FILTER (WHERE o.status = 'confirmed_config') as confirmed_orders,
  -- é‡‘é¢ç»Ÿè®¡
  COALESCE(SUM(o.amount), 0) as total_spent,
  COALESCE(SUM(o.amount) FILTER (WHERE o.status = 'confirmed_config'), 0) as confirmed_spent,
  COALESCE(AVG(o.amount), 0) as avg_order_value,
  -- æ—¶é—´ç»Ÿè®¡
  MAX(o.created_at) as last_order_date,
  MIN(o.created_at) as first_order_date,
  EXTRACT(DAY FROM NOW() - MAX(o.created_at)) as days_since_last_order,
  -- é”€å”®å½’å±
  o.sales_code,
  COALESCE(ps.wechat_name, ss.wechat_name) as sales_name,
  CASE 
    WHEN ps.id IS NOT NULL THEN 'primary'
    WHEN ss.id IS NOT NULL THEN 'secondary'
    ELSE 'direct'
  END as sales_type,
  -- å®¢æˆ·ä»·å€¼åˆ†å±‚
  CASE
    WHEN SUM(o.amount) > 5000 THEN 'VIP'
    WHEN SUM(o.amount) > 2000 THEN 'é«˜ä»·å€¼'
    WHEN SUM(o.amount) > 500 THEN 'æ™®é€š'
    ELSE 'æ½œåœ¨'
  END as customer_level
FROM customers c
LEFT JOIN orders o ON c.id = o.customer_id
LEFT JOIN primary_sales ps ON o.primary_sales_id = ps.id
LEFT JOIN secondary_sales ss ON o.secondary_sales_id = ss.id
GROUP BY c.id, o.sales_code, ps.wechat_name, ss.wechat_name, ps.id, ss.id;

-- åˆ›å»ºç´¢å¼•
CREATE UNIQUE INDEX ON customer_stats (id);
CREATE INDEX ON customer_stats (sales_code);
CREATE INDEX ON customer_stats (customer_level);
CREATE INDEX ON customer_stats (last_order_date DESC);

-- å…¨æ–‡æœç´¢ç´¢å¼•
CREATE INDEX idx_customer_search ON customers 
USING gin(to_tsvector('simple', 
  COALESCE(wechat_name, '') || ' ' || 
  COALESCE(email, '') || ' ' || 
  COALESCE(phone, '')
));
```

### 3.3 ç¼“å­˜å±‚å®ç°

```javascript
// customerCache.js
class CustomerCacheManager {
  constructor() {
    this.cache = new Map();
    this.searchCache = new Map();
    this.cacheDuration = 10 * 60 * 1000; // 10åˆ†é’Ÿ
  }
  
  // æ‰¹é‡å¤„ç†å®¢æˆ·æ•°æ®
  batchProcessCustomers(customers, orders) {
    // æ„å»ºè®¢å•ç´¢å¼•
    const ordersByCustomer = new Map();
    orders.forEach(order => {
      const key = order.customer_id;
      if (!ordersByCustomer.has(key)) {
        ordersByCustomer.set(key, []);
      }
      ordersByCustomer.get(key).push(order);
    });
    
    // å¤„ç†æ¯ä¸ªå®¢æˆ·
    return customers.map(customer => {
      const customerOrders = ordersByCustomer.get(customer.id) || [];
      const stats = this.calculateCustomerStats(customerOrders);
      
      return {
        ...customer,
        ...stats,
        value_score: this.calculateValueScore(stats),
        risk_level: this.calculateRiskLevel(stats)
      };
    });
  }
  
  // æ™ºèƒ½æœç´¢
  search(keyword) {
    // æ£€æŸ¥ç¼“å­˜
    if (this.searchCache.has(keyword)) {
      return this.searchCache.get(keyword);
    }
    
    // æ¨¡ç³Šæœç´¢
    const results = this.fuzzySearch(keyword);
    
    // ç¼“å­˜ç»“æœ
    this.searchCache.set(keyword, results);
    return results;
  }
  
  // æ¨¡ç³Šæœç´¢å®ç°
  fuzzySearch(keyword) {
    const customers = this.cache.get('all_customers') || [];
    const lowerKeyword = keyword.toLowerCase();
    
    return customers.filter(c => {
      const searchText = `${c.wechat_name} ${c.email} ${c.phone}`.toLowerCase();
      return searchText.includes(lowerKeyword);
    }).sort((a, b) => {
      // ä¼˜å…ˆçº§æ’åºï¼šå®Œå…¨åŒ¹é… > å¼€å¤´åŒ¹é… > åŒ…å«åŒ¹é…
      const aScore = this.getMatchScore(a, lowerKeyword);
      const bScore = this.getMatchScore(b, lowerKeyword);
      return bScore - aScore;
    });
  }
}
```

### 3.4 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| åŠ è½½æ—¶é—´ | 1-2ç§’ | <0.3ç§’ | 85% |
| æœç´¢å“åº” | 500ms | <50ms | 90% |
| æ•°æ®å®Œæ•´æ€§ | åŸºç¡€ä¿¡æ¯ | å…¨é¢ç»Ÿè®¡ | 100% |

---

## å››ã€èµ„é‡‘ç»Ÿè®¡é¡µé¢ä¼˜åŒ–ï¼ˆAdminFinanceï¼‰

### 4.1 ç°çŠ¶é—®é¢˜åˆ†æ
- **åŠ è½½æ—¶é—´**: 3-5ç§’
- **è®¡ç®—å¤æ‚åº¦**: é«˜
- **æ€§èƒ½ç“¶é¢ˆ**:
  - å®æ—¶è®¡ç®—æ‰€æœ‰è´¢åŠ¡æŒ‡æ ‡
  - èšåˆå¤§é‡å†å²æ•°æ®
  - å¤šç»´åº¦ç»Ÿè®¡è€—æ—¶
  - æ— é¢„è®¡ç®—æœºåˆ¶

### 4.2 æ•°æ®åº“ä¼˜åŒ–æ–¹æ¡ˆ

#### 4.2.1 åˆ›å»ºè´¢åŠ¡ç»Ÿè®¡è¡¨
```sql
-- æ—¥ç»Ÿè®¡è¡¨
CREATE TABLE IF NOT EXISTS finance_daily_stats (
  stat_date DATE PRIMARY KEY,
  
  -- è®¢å•ç»Ÿè®¡
  total_orders INTEGER DEFAULT 0,
  valid_orders INTEGER DEFAULT 0,
  confirmed_orders INTEGER DEFAULT 0,
  rejected_orders INTEGER DEFAULT 0,
  
  -- æ”¶å…¥ç»Ÿè®¡
  total_revenue DECIMAL(10,2) DEFAULT 0,
  confirmed_revenue DECIMAL(10,2) DEFAULT 0,
  pending_revenue DECIMAL(10,2) DEFAULT 0,
  refunded_amount DECIMAL(10,2) DEFAULT 0,
  
  -- ä½£é‡‘ç»Ÿè®¡
  total_commission DECIMAL(10,2) DEFAULT 0,
  paid_commission DECIMAL(10,2) DEFAULT 0,
  pending_commission DECIMAL(10,2) DEFAULT 0,
  
  -- åˆ©æ¶¦ç»Ÿè®¡
  gross_profit DECIMAL(10,2) DEFAULT 0,
  net_profit DECIMAL(10,2) DEFAULT 0,
  profit_margin DECIMAL(5,2) DEFAULT 0,
  
  -- æ”¯ä»˜æ–¹å¼åˆ†å¸ƒ
  alipay_amount DECIMAL(10,2) DEFAULT 0,
  wechat_amount DECIMAL(10,2) DEFAULT 0,
  bank_amount DECIMAL(10,2) DEFAULT 0,
  
  -- é”€å”®ä¸šç»©
  primary_sales_amount DECIMAL(10,2) DEFAULT 0,
  secondary_sales_amount DECIMAL(10,2) DEFAULT 0,
  direct_sales_amount DECIMAL(10,2) DEFAULT 0,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- æœˆç»Ÿè®¡è¡¨
CREATE TABLE IF NOT EXISTS finance_monthly_stats (
  stat_month VARCHAR(7) PRIMARY KEY,  -- YYYY-MM
  
  -- æ±‡æ€»ç»Ÿè®¡
  total_days INTEGER,
  working_days INTEGER,
  total_orders INTEGER,
  total_revenue DECIMAL(10,2),
  total_commission DECIMAL(10,2),
  total_profit DECIMAL(10,2),
  
  -- å¹³å‡ç»Ÿè®¡
  avg_daily_revenue DECIMAL(10,2),
  avg_order_value DECIMAL(10,2),
  avg_commission_rate DECIMAL(5,2),
  
  -- å¢é•¿ç»Ÿè®¡
  revenue_growth_rate DECIMAL(5,2),  -- ç¯æ¯”
  order_growth_rate DECIMAL(5,2),
  yoy_growth_rate DECIMAL(5,2),  -- åŒæ¯”
  
  -- ç›®æ ‡è¾¾æˆ
  revenue_target DECIMAL(10,2),
  achievement_rate DECIMAL(5,2),
  
  created_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_finance_daily_date ON finance_daily_stats(stat_date DESC);
CREATE INDEX idx_finance_monthly ON finance_monthly_stats(stat_month DESC);
```

#### 4.2.2 åˆ›å»ºè¿”ä½£è®°å½•è¡¨
```sql
CREATE TABLE IF NOT EXISTS commission_records (
  id SERIAL PRIMARY KEY,
  
  -- è®¢å•ä¿¡æ¯
  order_id INTEGER NOT NULL REFERENCES orders(id),
  order_number VARCHAR(50),
  order_amount DECIMAL(10,2),
  
  -- é”€å”®ä¿¡æ¯
  sales_id INTEGER NOT NULL,
  sales_type VARCHAR(20) NOT NULL,
  sales_code VARCHAR(50) NOT NULL,
  sales_name VARCHAR(100),
  user_id INTEGER,  -- é¢„ç•™
  
  -- è¿”ä½£ä¿¡æ¯
  commission_rate DECIMAL(5,2) NOT NULL,
  commission_amount DECIMAL(10,2) NOT NULL,
  currency VARCHAR(10) DEFAULT 'USD',
  
  -- çŠ¶æ€ç®¡ç†
  status VARCHAR(20) DEFAULT 'pending',  -- pending/approved/paid/cancelled
  approved_at TIMESTAMP,
  approved_by INTEGER,
  paid_at TIMESTAMP,
  payment_method VARCHAR(50),
  payment_reference VARCHAR(255),
  payment_proof TEXT,
  
  -- å±‚çº§ä¿¡æ¯
  is_secondary BOOLEAN DEFAULT FALSE,
  parent_sales_id INTEGER,
  parent_commission_amount DECIMAL(10,2),
  
  -- ç‰¹æ®Šæ ‡è®°
  is_customer_upgrade BOOLEAN DEFAULT FALSE,  -- å®¢æˆ·è½¬åŒ–è®¢å•
  source_type VARCHAR(50),
  notes TEXT,
  
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_commission_order ON commission_records(order_id);
CREATE INDEX idx_commission_sales ON commission_records(sales_id, sales_type);
CREATE INDEX idx_commission_status ON commission_records(status);
CREATE INDEX idx_commission_date ON commission_records(created_at DESC);
CREATE INDEX idx_commission_paid ON commission_records(paid_at DESC) WHERE paid_at IS NOT NULL;
```

#### 4.2.3 åˆ›å»ºè‡ªåŠ¨ç»Ÿè®¡å‡½æ•°
```sql
-- æ¯æ—¥ç»Ÿè®¡æ›´æ–°å‡½æ•°
CREATE OR REPLACE FUNCTION update_daily_finance_stats(p_date DATE)
RETURNS void AS $$
BEGIN
  INSERT INTO finance_daily_stats (
    stat_date,
    total_orders,
    valid_orders,
    total_revenue,
    confirmed_revenue,
    total_commission,
    paid_commission,
    pending_commission
  )
  SELECT 
    p_date,
    COUNT(*),
    COUNT(*) FILTER (WHERE status != 'rejected'),
    SUM(amount),
    SUM(amount) FILTER (WHERE status = 'confirmed_config'),
    SUM(commission_amount),
    SUM(paid_commission),
    SUM(commission_amount - COALESCE(paid_commission, 0))
  FROM orders
  LEFT JOIN commission_records cr ON orders.id = cr.order_id
  WHERE DATE(orders.created_at) = p_date
  ON CONFLICT (stat_date) DO UPDATE SET
    total_orders = EXCLUDED.total_orders,
    valid_orders = EXCLUDED.valid_orders,
    total_revenue = EXCLUDED.total_revenue,
    confirmed_revenue = EXCLUDED.confirmed_revenue,
    total_commission = EXCLUDED.total_commission,
    paid_commission = EXCLUDED.paid_commission,
    pending_commission = EXCLUDED.pending_commission,
    updated_at = NOW();
END;
$$ LANGUAGE plpgsql;

-- å®šæ—¶ä»»åŠ¡ï¼ˆæ¯æ—¥å‡Œæ™¨1ç‚¹æ‰§è¡Œï¼‰
-- SELECT cron.schedule('daily-finance-stats', '0 1 * * *', 
--   'SELECT update_daily_finance_stats(CURRENT_DATE - INTERVAL ''1 day'')');
```

### 4.3 ç¼“å­˜å±‚å®ç°

```javascript
// financeCache.js
class FinanceCacheManager {
  constructor() {
    this.cache = new Map();
    this.cacheDuration = 15 * 60 * 1000; // 15åˆ†é’Ÿ
  }
  
  // è·å–è´¢åŠ¡ç»Ÿè®¡
  async getFinanceStats(dateRange) {
    const cacheKey = `finance_${dateRange.start}_${dateRange.end}`;
    
    // æ£€æŸ¥ç¼“å­˜
    if (this.cache.has(cacheKey)) {
      const cached = this.cache.get(cacheKey);
      if (Date.now() - cached.timestamp < this.cacheDuration) {
        return cached.data;
      }
    }
    
    // æŸ¥è¯¢ç»Ÿè®¡è¡¨
    const stats = await this.queryFinanceStats(dateRange);
    
    // æ›´æ–°ç¼“å­˜
    this.cache.set(cacheKey, {
      data: stats,
      timestamp: Date.now()
    });
    
    return stats;
  }
  
  // æŸ¥è¯¢è´¢åŠ¡ç»Ÿè®¡
  async queryFinanceStats(dateRange) {
    // æ ¹æ®æ—¥æœŸèŒƒå›´é€‰æ‹©æŸ¥è¯¢ç­–ç•¥
    const days = this.getDaysBetween(dateRange.start, dateRange.end);
    
    if (days <= 31) {
      // æŸ¥è¯¢æ—¥ç»Ÿè®¡è¡¨
      return this.queryDailyStats(dateRange);
    } else if (days <= 365) {
      // æŸ¥è¯¢æœˆç»Ÿè®¡è¡¨
      return this.queryMonthlyStats(dateRange);
    } else {
      // æŸ¥è¯¢å¹´åº¦ç»Ÿè®¡
      return this.queryYearlyStats(dateRange);
    }
  }
  
  // å®æ—¶è®¡ç®—ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
  async calculateRealtime(dateRange) {
    const { data: orders } = await supabase
      .from('orders')
      .select('*')
      .gte('created_at', dateRange.start)
      .lte('created_at', dateRange.end);
      
    return this.aggregateOrders(orders);
  }
}
```

### 4.4 é¢„æœŸæ•ˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ—¥æŠ¥ç”Ÿæˆ | 3-5ç§’ | <0.5ç§’ | 90% |
| æœˆæŠ¥ç”Ÿæˆ | 5-8ç§’ | <1ç§’ | 87.5% |
| å®æ—¶ç»Ÿè®¡ | æ¯æ¬¡è®¡ç®— | é¢„è®¡ç®—+ç¼“å­˜ | 95% |

---

## äº”ã€é”€å”®å¯¹è´¦é¡µé¢ï¼ˆæ–°å¢ï¼‰

### 5.1 ä¸€çº§é”€å”®å¯¹è´¦é¡µé¢

#### 5.1.1 åŠŸèƒ½è®¾è®¡
```javascript
// ä¸€çº§é”€å”®çœ‹åˆ°çš„æ•°æ®
{
  // ä¸ªäººä¸šç»©
  personal: {
    total_orders: 150,
    total_amount: 28800,
    commission_rate: 40,
    commission_amount: 11520,
    paid_commission: 8000,
    pending_commission: 3520
  },
  
  // å›¢é˜Ÿä¸šç»©ï¼ˆäºŒçº§é”€å”®ï¼‰
  team: {
    member_count: 5,
    total_orders: 80,
    total_amount: 15000,
    team_commission: 3750,  // ä»äºŒçº§é”€å”®è®¢å•è·å¾—çš„ä½£é‡‘
    paid_team_commission: 2000,
    pending_team_commission: 1750
  },
  
  // æ˜ç»†åˆ—è¡¨
  orders: [...],  // ä¸ªäººè®¢å•æ˜ç»†
  team_orders: [...],  // å›¢é˜Ÿè®¢å•æ˜ç»†
  
  // ç»“ç®—è®°å½•
  settlements: [...]  // å†å²ç»“ç®—è®°å½•
}
```

#### 5.1.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```sql
-- åˆ›å»ºä¸€çº§é”€å”®å¯¹è´¦è§†å›¾
CREATE MATERIALIZED VIEW primary_sales_reconciliation AS
SELECT 
  ps.id as sales_id,
  ps.sales_code,
  ps.wechat_name,
  
  -- ä¸ªäººä¸šç»©
  COUNT(DISTINCT o1.id) as personal_orders,
  SUM(o1.amount) as personal_amount,
  ps.commission_rate as personal_rate,
  SUM(o1.amount * ps.commission_rate / 100) as personal_commission,
  
  -- å›¢é˜Ÿä¸šç»©
  COUNT(DISTINCT ss.id) as team_members,
  COUNT(DISTINCT o2.id) as team_orders,
  SUM(o2.amount) as team_amount,
  SUM(o2.amount * ss.commission_rate / 100 * 0.15) as team_commission,  -- å‡è®¾15%å›¢é˜Ÿåˆ†æˆ
  
  -- å·²æ”¯ä»˜ä½£é‡‘
  SUM(cr1.commission_amount) FILTER (WHERE cr1.status = 'paid') as paid_personal,
  SUM(cr2.commission_amount) FILTER (WHERE cr2.status = 'paid') as paid_team,
  
  -- å¾…æ”¯ä»˜ä½£é‡‘
  SUM(cr1.commission_amount) FILTER (WHERE cr1.status = 'pending') as pending_personal,
  SUM(cr2.commission_amount) FILTER (WHERE cr2.status = 'pending') as pending_team
  
FROM primary_sales ps
LEFT JOIN orders o1 ON o1.primary_sales_id = ps.id
LEFT JOIN secondary_sales ss ON ss.primary_sales_id = ps.id
LEFT JOIN orders o2 ON o2.secondary_sales_id = ss.id
LEFT JOIN commission_records cr1 ON cr1.order_id = o1.id AND cr1.sales_id = ps.id
LEFT JOIN commission_records cr2 ON cr2.order_id = o2.id AND cr2.parent_sales_id = ps.id
GROUP BY ps.id, ps.sales_code, ps.wechat_name, ps.commission_rate;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON primary_sales_reconciliation(sales_id);
CREATE INDEX ON primary_sales_reconciliation(sales_code);
```

### 5.2 äºŒçº§/ç‹¬ç«‹é”€å”®å¯¹è´¦é¡µé¢

#### 5.2.1 åŠŸèƒ½è®¾è®¡
```javascript
// äºŒçº§/ç‹¬ç«‹é”€å”®çœ‹åˆ°çš„æ•°æ®
{
  // ä¸ªäººä¸šç»©
  personal: {
    total_orders: 50,
    total_amount: 9500,
    commission_rate: 25,  // äºŒçº§é”€å”®25%ï¼Œç‹¬ç«‹é”€å”®10%
    commission_amount: 2375,
    paid_commission: 1500,
    pending_commission: 875
  },
  
  // ä¸Šçº§ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
  parent: {
    sales_name: 'å¼ ä¸‰',
    sales_code: 'PRI001',
    your_contribution: 1425  // ç»™ä¸Šçº§è´¡çŒ®çš„ä½£é‡‘
  },
  
  // è®¢å•æ˜ç»†
  orders: [...],
  
  // ç»“ç®—è®°å½•
  settlements: [...]
}
```

#### 5.2.2 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```sql
-- åˆ›å»ºäºŒçº§é”€å”®å¯¹è´¦è§†å›¾
CREATE MATERIALIZED VIEW secondary_sales_reconciliation AS
SELECT 
  ss.id as sales_id,
  ss.sales_code,
  ss.wechat_name,
  ss.primary_sales_id,
  ps.wechat_name as parent_name,
  ps.sales_code as parent_code,
  
  -- ä¸ªäººä¸šç»©
  COUNT(DISTINCT o.id) as total_orders,
  SUM(o.amount) as total_amount,
  ss.commission_rate,
  SUM(o.amount * ss.commission_rate / 100) as commission_amount,
  
  -- ç»™ä¸Šçº§çš„è´¡çŒ®
  SUM(o.amount * ps.commission_rate / 100 * 0.15) as parent_contribution,
  
  -- æ”¯ä»˜çŠ¶æ€
  SUM(cr.commission_amount) FILTER (WHERE cr.status = 'paid') as paid_commission,
  SUM(cr.commission_amount) FILTER (WHERE cr.status = 'pending') as pending_commission
  
FROM secondary_sales ss
LEFT JOIN primary_sales ps ON ss.primary_sales_id = ps.id
LEFT JOIN orders o ON o.secondary_sales_id = ss.id
LEFT JOIN commission_records cr ON cr.order_id = o.id AND cr.sales_id = ss.id
GROUP BY ss.id, ss.sales_code, ss.wechat_name, ss.primary_sales_id, 
         ps.wechat_name, ps.sales_code, ss.commission_rate;

-- åˆ›å»ºç´¢å¼•
CREATE INDEX ON secondary_sales_reconciliation(sales_id);
CREATE INDEX ON secondary_sales_reconciliation(sales_code);
```

### 5.3 å¯¹è´¦é¡µé¢å‰ç«¯å®ç°

```javascript
// SalesReconciliation.js - é”€å”®å¯¹è´¦é¡µé¢
import React, { useState, useEffect } from 'react';
import { Card, Table, Statistic, Row, Col, DatePicker, Button } from 'antd';

const SalesReconciliation = ({ salesType, salesCode }) => {
  const [data, setData] = useState(null);
  const [dateRange, setDateRange] = useState([moment().startOf('month'), moment()]);
  const [loading, setLoading] = useState(false);
  
  // åŠ è½½å¯¹è´¦æ•°æ®
  const loadReconciliation = async () => {
    setLoading(true);
    try {
      const result = await api.getSalesReconciliation({
        sales_type: salesType,
        sales_code: salesCode,
        start_date: dateRange[0].format('YYYY-MM-DD'),
        end_date: dateRange[1].format('YYYY-MM-DD')
      });
      setData(result);
    } catch (error) {
      message.error('åŠ è½½å¯¹è´¦æ•°æ®å¤±è´¥');
    } finally {
      setLoading(false);
    }
  };
  
  useEffect(() => {
    loadReconciliation();
  }, [dateRange]);
  
  // å¯¼å‡ºå¯¹è´¦å•
  const exportReconciliation = () => {
    const csv = generateCSV(data);
    downloadCSV(csv, `å¯¹è´¦å•_${salesCode}_${moment().format('YYYYMMDD')}.csv`);
  };
  
  return (
    <div className="sales-reconciliation">
      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <Row gutter={16}>
        <Col span={6}>
          <Card>
            <Statistic 
              title="æ€»è®¢å•æ•°" 
              value={data?.personal.total_orders} 
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic 
              title="æ€»é‡‘é¢" 
              value={data?.personal.total_amount} 
              prefix="$"
              precision={2}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic 
              title="åº”å¾—ä½£é‡‘" 
              value={data?.personal.commission_amount} 
              prefix="$"
              precision={2}
              valueStyle={{ color: '#3f8600' }}
            />
          </Card>
        </Col>
        <Col span={6}>
          <Card>
            <Statistic 
              title="å¾…ç»“ç®—" 
              value={data?.personal.pending_commission} 
              prefix="$"
              precision={2}
              valueStyle={{ color: '#cf1322' }}
            />
          </Card>
        </Col>
      </Row>
      
      {/* å›¢é˜Ÿä¸šç»©ï¼ˆä»…ä¸€çº§é”€å”®ï¼‰ */}
      {salesType === 'primary' && data?.team && (
        <Card title="å›¢é˜Ÿä¸šç»©" style={{ marginTop: 16 }}>
          <Row gutter={16}>
            <Col span={6}>
              <Statistic title="å›¢é˜Ÿæˆå‘˜" value={data.team.member_count} />
            </Col>
            <Col span={6}>
              <Statistic title="å›¢é˜Ÿè®¢å•" value={data.team.total_orders} />
            </Col>
            <Col span={6}>
              <Statistic 
                title="å›¢é˜Ÿä½£é‡‘" 
                value={data.team.team_commission} 
                prefix="$"
              />
            </Col>
          </Row>
        </Card>
      )}
      
      {/* è®¢å•æ˜ç»† */}
      <Card title="è®¢å•æ˜ç»†" style={{ marginTop: 16 }}>
        <Table 
          columns={[
            { title: 'è®¢å•å·', dataIndex: 'order_number', key: 'order_number' },
            { title: 'å®¢æˆ·', dataIndex: 'customer_name', key: 'customer_name' },
            { title: 'é‡‘é¢', dataIndex: 'amount', key: 'amount', render: v => `$${v}` },
            { title: 'ä½£é‡‘ç‡', dataIndex: 'commission_rate', key: 'commission_rate', render: v => `${v}%` },
            { title: 'ä½£é‡‘', dataIndex: 'commission', key: 'commission', render: v => `$${v}` },
            { title: 'çŠ¶æ€', dataIndex: 'status', key: 'status' },
            { title: 'æ—¥æœŸ', dataIndex: 'created_at', key: 'created_at' }
          ]}
          dataSource={data?.orders}
          loading={loading}
        />
      </Card>
      
      {/* æ“ä½œæŒ‰é’® */}
      <div style={{ marginTop: 16, textAlign: 'right' }}>
        <Button onClick={exportReconciliation} type="primary">
          å¯¼å‡ºå¯¹è´¦å•
        </Button>
      </div>
    </div>
  );
};

export default SalesReconciliation;
```

---

## å…­ã€æµ‹è¯•è®¡åˆ’

### 6.1 æµ‹è¯•ç¯å¢ƒå‡†å¤‡
```bash
# 1. åˆ›å»ºæµ‹è¯•æ•°æ®åº“åˆ†æ”¯
git checkout -b feature/performance-optimization

# 2. å¤‡ä»½å½“å‰æ•°æ®
pg_dump -h your-host -U your-user -d your-db > backup_$(date +%Y%m%d).sql

# 3. åˆ›å»ºæµ‹è¯•ç¯å¢ƒå˜é‡
cat > .env.test << EOF
REACT_APP_SUPABASE_URL=your-test-url
REACT_APP_SUPABASE_KEY=your-test-key
REACT_APP_ENABLE_NEW_STATS=true
REACT_APP_ENABLE_CACHE=true
REACT_APP_ENABLE_VIRTUAL_SCROLL=true
EOF
```

### 6.2 æµ‹è¯•æ­¥éª¤

#### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“ä¼˜åŒ–æµ‹è¯•
1. æ‰§è¡Œé¢„ç•™å­—æ®µSQLï¼ˆå®‰å…¨ï¼Œä½¿ç”¨IF NOT EXISTSï¼‰
2. åˆ›å»ºç´¢å¼•ï¼ˆä½¿ç”¨CONCURRENTLYï¼Œä¸é”è¡¨ï¼‰
3. åˆ›å»ºç‰©åŒ–è§†å›¾
4. å¡«å……ç»Ÿè®¡è¡¨æ•°æ®
5. éªŒè¯æŸ¥è¯¢æ€§èƒ½

#### ç¬¬äºŒé˜¶æ®µï¼šç¼“å­˜å±‚æµ‹è¯•
1. éƒ¨ç½²ç¼“å­˜ç®¡ç†å™¨
2. æµ‹è¯•ç¼“å­˜å‘½ä¸­ç‡
3. éªŒè¯æ•°æ®ä¸€è‡´æ€§
4. å‹åŠ›æµ‹è¯•

#### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯ä¼˜åŒ–æµ‹è¯•
1. è™šæ‹Ÿæ»šåŠ¨æµ‹è¯•
2. æ‰¹é‡æ“ä½œæµ‹è¯•
3. å®æ—¶æ›´æ–°æµ‹è¯•
4. å†…å­˜æ³„æ¼æ£€æµ‹

### 6.3 æ€§èƒ½åŸºå‡†æµ‹è¯•
```javascript
// performanceTest.js
const runPerformanceTest = async () => {
  const tests = [
    { name: 'è®¢å•åˆ—è¡¨åŠ è½½', fn: testOrdersLoad },
    { name: 'é”€å”®ç»Ÿè®¡è®¡ç®—', fn: testSalesStats },
    { name: 'å®¢æˆ·æœç´¢', fn: testCustomerSearch },
    { name: 'è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ', fn: testFinanceReport }
  ];
  
  for (const test of tests) {
    console.time(test.name);
    await test.fn();
    console.timeEnd(test.name);
  }
};
```

### 6.4 å›æ»šæ–¹æ¡ˆ
```sql
-- å¦‚æœéœ€è¦å›æ»š
-- 1. åˆ é™¤ç‰©åŒ–è§†å›¾
DROP MATERIALIZED VIEW IF EXISTS orders_with_details CASCADE;
DROP MATERIALIZED VIEW IF EXISTS customer_stats CASCADE;

-- 2. åˆ é™¤ç»Ÿè®¡è¡¨
DROP TABLE IF EXISTS sales_statistics CASCADE;
DROP TABLE IF EXISTS finance_daily_stats CASCADE;
DROP TABLE IF EXISTS commission_records CASCADE;

-- 3. åˆ é™¤ç´¢å¼•
DROP INDEX IF EXISTS idx_orders_status;
-- ... å…¶ä»–ç´¢å¼•

-- 4. æ¢å¤å¤‡ä»½
psql -h your-host -U your-user -d your-db < backup_20241219.sql
```

---

## ä¸ƒã€ä¸Šçº¿è®¡åˆ’

### 7.1 å‰ç½®æ¡ä»¶
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æå‡è¾¾æ ‡
- [ ] æ•°æ®ä¸€è‡´æ€§éªŒè¯
- [ ] è·å¾—æ‚¨çš„æ˜ç¡®åŒæ„

### 7.2 åˆ†é˜¶æ®µä¸Šçº¿
1. **Phase 1**: æ•°æ®åº“ä¼˜åŒ–ï¼ˆä½é£é™©ï¼‰
2. **Phase 2**: ç¼“å­˜å±‚éƒ¨ç½²ï¼ˆä¸­é£é™©ï¼‰
3. **Phase 3**: å‰ç«¯ä¼˜åŒ–ï¼ˆä½é£é™©ï¼‰
4. **Phase 4**: æ–°åŠŸèƒ½ä¸Šçº¿ï¼ˆé”€å”®å¯¹è´¦ï¼‰

### 7.3 ç›‘æ§æŒ‡æ ‡
- é¡µé¢åŠ è½½æ—¶é—´
- APIå“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- ç¼“å­˜å‘½ä¸­ç‡
- é”™è¯¯ç‡

---

## å…«ã€é£é™©è¯„ä¼°

| é£é™©é¡¹ | å½±å“ | æ¦‚ç‡ | ç¼“è§£æªæ–½ |
|--------|------|------|----------|
| ç´¢å¼•åˆ›å»ºé”è¡¨ | é«˜ | ä½ | ä½¿ç”¨CONCURRENTLY |
| ç¼“å­˜æ•°æ®ä¸ä¸€è‡´ | ä¸­ | ä¸­ | è®¾ç½®åˆç†è¿‡æœŸæ—¶é—´ |
| ç‰©åŒ–è§†å›¾å»¶è¿Ÿ | ä½ | ä¸­ | å®šæ—¶åˆ·æ–°+æ‰‹åŠ¨åˆ·æ–° |
| å†…å­˜æº¢å‡º | é«˜ | ä½ | è™šæ‹Ÿæ»šåŠ¨+åˆ†é¡µ |

---

**é‡è¦æé†’**ï¼š
1. æ‰€æœ‰æ“ä½œä»…åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œ
2. éœ€è¦æ‚¨æ˜ç¡®åŒæ„æ‰èƒ½ä¸Šçº¿
3. æä¾›å®Œæ•´å›æ»šæ–¹æ¡ˆ
4. åˆ†é˜¶æ®µé€æ­¥å®æ–½

æ˜¯å¦åŒæ„å¼€å§‹åœ¨æµ‹è¯•ç¯å¢ƒæ‰§è¡Œä¼˜åŒ–æ–¹æ¡ˆï¼Ÿ