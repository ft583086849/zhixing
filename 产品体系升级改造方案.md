# çŸ¥è¡Œè´¢åº“ç³»ç»Ÿäº§å“ä½“ç³»å‡çº§æ”¹é€ æ–¹æ¡ˆ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**å‡çº§ç›®æ ‡**ï¼šä»å•ä¸€äº§å“ï¼ˆæ¨å¸ç­–ç•¥188uï¼‰å‡çº§ä¸ºä¸‰äº§å“ä½“ç³»
**ç”Ÿæ•ˆæ—¶é—´**ï¼š2024å¹´9æœˆ6æ—¥ 00:00ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
**æ ¸å¿ƒåŸåˆ™**ï¼šä¿æŠ¤å†å²æ•°æ®ï¼Œå¹³æ»‘å‡çº§ï¼ŒåŠŸèƒ½å®Œæ•´

## ğŸš€ **å¼€å‘æµç¨‹å’Œè´¨é‡ä¿è¯**

### **ä¸‰é˜¶æ®µå¼€å‘æµç¨‹**
1. **æ¶æ„é‡æ„é˜¶æ®µ**ï¼šå®æ–½æ­£ç¡®çš„äº§å“é…ç½®æ¶æ„
2. **MCPè‡ªåŠ¨å›æµ‹é˜¶æ®µ**ï¼šä½¿ç”¨MCPå·¥å…·è¿›è¡Œå…¨æµç¨‹éªŒè¯
3. **Bugä¿®å¤é˜¶æ®µ**ï¼šä¿®å¤æµ‹è¯•å‘ç°çš„é—®é¢˜

### **MCPå›æµ‹éªŒè¯æ–¹æ¡ˆ**
- ä½¿ç”¨ `mcp__ide__executeCode` è‡ªåŠ¨åŒ–æµ‹è¯•
- è¦†ç›–äº§å“é€‰æ‹©ã€è®¢å•åˆ›å»ºã€æ”¯ä»˜æµç¨‹å…¨é“¾è·¯
- éªŒè¯æ•°æ®åº“é…ç½®æ­£ç¡®æ€§å’ŒAPIå…¼å®¹æ€§
- ç¡®ä¿å‰ç«¯é¡µé¢åŠŸèƒ½å®Œæ•´æ€§

### **è´¨é‡ä¿è¯æ ‡å‡†**
- âœ… æ‰€æœ‰MCPæµ‹è¯•ç”¨ä¾‹é€šè¿‡
- âœ… ç°æœ‰åŠŸèƒ½é›¶å½±å“
- âœ… æ–°äº§å“ä½“ç³»åŠŸèƒ½å®Œæ•´
- âœ… æ•°æ®åº“æ¶æ„å‘åå…¼å®¹

---

## ğŸ¯ æ–°äº§å“ä½“ç³»

### 1. æ¨å¸ç­–ç•¥ï¼ˆåŸ188uäº§å“å‡çº§ï¼‰
- **æœˆè´¹**ï¼š288uï¼ˆâ†‘100uï¼‰
- **å­£åº¦**ï¼š588uï¼ˆâ†‘100uï¼‰
- **åŠå¹´**ï¼š1088uï¼ˆâ†‘200uï¼‰
- **ä¸€å¹´**ï¼š1888uï¼ˆâ†‘300uï¼‰

### 2. æ¨å¸ç³»ç»Ÿï¼ˆDiscordæ–°äº§å“ï¼‰
- **æœˆè´¹**ï¼š588u
- **å­£åº¦**ï¼š1588u
- **åŠå¹´**ï¼š2588u
- **ä¸€å¹´**ï¼š3999u
- **ç‰¹è‰²**ï¼šDiscordé›†æˆï¼Œ3å¤©å…è´¹è¯•ç”¨

### 3. å¥—é¤ç»„åˆï¼ˆç­–ç•¥+ç³»ç»Ÿï¼‰
- **æœˆè´¹**ï¼š688uï¼ˆçœ188uï¼‰
- **å­£åº¦**ï¼š1888uï¼ˆçœ288uï¼‰
- **åŠå¹´**ï¼š3188uï¼ˆçœ688uï¼‰
- **ä¸€å¹´**ï¼š4688uï¼ˆçœ1199uï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“æ”¹é€ æ–¹æ¡ˆ

### æ•°æ®åº“å¤‡ä»½ï¼ˆå¿…é¡»å…ˆæ‰§è¡Œï¼ï¼‰
```bash
# å®Œæ•´å¤‡ä»½å½“å‰æ•°æ®åº“
pg_dump zhixing_db > backup_before_upgrade_20240906.sql
```

### è¡¨ç»“æ„æ‰©å±•

#### orders_optimized è¡¨æ–°å¢å­—æ®µ
```sql
-- æ·»åŠ äº§å“ç›¸å…³å­—æ®µ
ALTER TABLE orders_optimized 
ADD COLUMN product_type VARCHAR(20) DEFAULT 'æ¨å¸ç­–ç•¥' NOT NULL,
ADD COLUMN package_type VARCHAR(10) DEFAULT 'å•å“' NOT NULL,
ADD COLUMN discord_id VARCHAR(50),
ADD COLUMN trial_end_time TIMESTAMPTZ,
ADD COLUMN created_date DATE GENERATED ALWAYS AS (DATE(created_at AT TIME ZONE 'Asia/Shanghai')) STORED;

-- å†å²æ•°æ®å¤„ç†
UPDATE orders_optimized 
SET product_type = 'æ¨å¸ç­–ç•¥', 
    package_type = 'å•å“' 
WHERE product_type = 'æ¨å¸ç­–ç•¥';

-- æ·»åŠ ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_orders_product_type ON orders_optimized(product_type);
CREATE INDEX idx_orders_package_type ON orders_optimized(package_type);
CREATE INDEX idx_orders_product_status ON orders_optimized(product_type, status);
CREATE INDEX idx_orders_created_date ON orders_optimized(created_date);
```

#### äº§å“é…ç½®è¡¨
```sql
-- åˆ›å»ºäº§å“é…ç½®è¡¨
CREATE TABLE product_config (
    id SERIAL PRIMARY KEY,
    product_type VARCHAR(20) NOT NULL,
    duration_months INTEGER NOT NULL,
    price_usd DECIMAL(10,2) NOT NULL,
    effective_date DATE NOT NULL,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(product_type, duration_months, effective_date)
);

-- æ’å…¥æ–°ä»·æ ¼é…ç½®ï¼ˆ9æœˆ6æ—¥ç”Ÿæ•ˆï¼‰
INSERT INTO product_config (product_type, duration_months, price_usd, effective_date) VALUES
-- æ¨å¸ç­–ç•¥
('æ¨å¸ç­–ç•¥', 1, 288.00, '2024-09-06'),
('æ¨å¸ç­–ç•¥', 3, 588.00, '2024-09-06'),
('æ¨å¸ç­–ç•¥', 6, 1088.00, '2024-09-06'),
('æ¨å¸ç­–ç•¥', 12, 1888.00, '2024-09-06'),
-- æ¨å¸ç³»ç»Ÿ
('æ¨å¸ç³»ç»Ÿ', 1, 588.00, '2024-09-06'),
('æ¨å¸ç³»ç»Ÿ', 3, 1588.00, '2024-09-06'),
('æ¨å¸ç³»ç»Ÿ', 6, 2588.00, '2024-09-06'),
('æ¨å¸ç³»ç»Ÿ', 12, 3999.00, '2024-09-06'),
-- å¥—é¤ç»„åˆ
('å¥—é¤ç»„åˆ', 1, 688.00, '2024-09-06'),
('å¥—é¤ç»„åˆ', 3, 1888.00, '2024-09-06'),
('å¥—é¤ç»„åˆ', 6, 2988.00, '2024-09-06'),
('å¥—é¤ç»„åˆ', 12, 4688.00, '2024-09-06');
```

---

## ğŸ¨ å‰ç«¯é¡µé¢æ”¹é€ 

### 1. ç”¨æˆ·è´­ä¹°é¡µé¢ (PurchasePage.js)

#### æ–°UIè®¾è®¡
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é€‰æ‹©äº§å“ç±»å‹              â”‚
â”‚  [æ¨å¸ç­–ç•¥] [æ¨å¸ç³»ç»Ÿ] [å¥—é¤ç»„åˆ]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           é€‰æ‹©è´­ä¹°æ—¶é•¿              â”‚
â”‚  â—‹ 1ä¸ªæœˆ - 288u                   â”‚
â”‚  â—‹ 3ä¸ªæœˆ - 588u (å¹³å‡196u/æœˆ)     â”‚
â”‚  â—‹ 6ä¸ªæœˆ - 1088u (å¹³å‡181u/æœˆ)    â”‚
â”‚  â—‹ 12ä¸ªæœˆ - 1888u (å¹³å‡157u/æœˆ)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           äº§å“åŠŸèƒ½è¯´æ˜              â”‚
â”‚  æ ¹æ®é€‰æ‹©çš„äº§å“æ˜¾ç¤ºä¸åŒåŠŸèƒ½ç‰¹è‰²     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ ¸å¿ƒç»„ä»¶è®¾è®¡
```javascript
// ProductSelector.js - äº§å“é€‰æ‹©å™¨
const ProductSelector = () => {
  const products = [
    {
      key: 'æ¨å¸ç­–ç•¥',
      name: 'æ¨å¸ç­–ç•¥',
      description: 'ç»å…¸ç­–ç•¥äº§å“ï¼Œé€‚åˆä¸ªäººç”¨æˆ·',
      features: ['ç­–ç•¥æ¨é€', 'æ•°æ®åˆ†æ', '7Ã—24å°æ—¶æœåŠ¡']
    },
    {
      key: 'æ¨å¸ç³»ç»Ÿ',
      name: 'æ¨å¸ç³»ç»Ÿ',
      description: 'Discordé›†æˆç‰ˆæœ¬ï¼Œ3å¤©å…è´¹è¯•ç”¨',
      features: ['Discordé¢‘é“', 'VIPç¾¤ç»„', 'å®æ—¶æ¨é€', 'ç­–ç•¥æ¨é€']
    },
    {
      key: 'å¥—é¤ç»„åˆ',
      name: 'ç­–ç•¥+ç³»ç»Ÿç»„åˆ',
      description: 'æœ€ä¼˜æƒ å¥—é¤ï¼ŒåŒ…å«å…¨éƒ¨åŠŸèƒ½',
      features: ['å…¨åŠŸèƒ½åŒ…å«', 'æœ€å¤§ä¼˜æƒ ', 'VIPä¸“å±æœåŠ¡']
    }
  ];
  
  return (
    <Tabs>
      {products.map(product => (
        <TabPane key={product.key} tab={product.name}>
          <PricingTable productType={product.key} />
        </TabPane>
      ))}
    </Tabs>
  );
};
```

### 2. é”€å”®ç®¡ç†é¡µé¢ (SalesPage.js)

#### æ–°å¢åŠŸèƒ½
- **äº§å“é“¾æ¥ç”Ÿæˆ**ï¼šä¸ºæ¯ä¸ªäº§å“ç”Ÿæˆä¸“å±æ¨å¹¿é“¾æ¥
- **äº§å“ä¸šç»©ç»Ÿè®¡**ï¼šæ˜¾ç¤ºå„äº§å“é”€å”®æ•°æ®
- **ä½£é‡‘é¢„è§ˆ**ï¼šä¸åŒäº§å“ä½£é‡‘é¢„ä¼°

#### æ¨å¹¿é“¾æ¥æ ¼å¼
```
æ¨å¸ç­–ç•¥ï¼šhttps://zhixing-seven.vercel.app/purchase?sales_code=XXX&product=strategy
æ¨å¸ç³»ç»Ÿï¼šhttps://zhixing-seven.vercel.app/purchase?sales_code=XXX&product=system
å¥—é¤ç»„åˆï¼šhttps://zhixing-seven.vercel.app/purchase?sales_code=XXX&product=combo
```

---

## ğŸ¢ ç®¡ç†åå°æ”¹é€ 

### 1. è®¢å•ç®¡ç†é¡µé¢ (AdminOrders.js)

#### åˆ—è¡¨æ”¹é€ 
```javascript
const columns = [
  { title: 'è®¢å•å·', dataIndex: 'order_id' },
  { title: 'å®¢æˆ·å¾®ä¿¡', dataIndex: 'customer_wechat' },
  { title: 'é”€å”®å‘˜', dataIndex: 'sales_wechat' },
  { 
    title: 'äº§å“ç±»å‹', 
    dataIndex: 'product_type',
    filters: [
      { text: 'æ¨å¸ç­–ç•¥', value: 'æ¨å¸ç­–ç•¥' },
      { text: 'æ¨å¸ç³»ç»Ÿ', value: 'æ¨å¸ç³»ç»Ÿ' },
      { text: 'å¥—é¤ç»„åˆ', value: 'å¥—é¤ç»„åˆ' }
    ]
  },
  { 
    title: 'å¥—é¤ç±»å‹', 
    dataIndex: 'package_type',
    render: (text) => text === 'å•å“' ? 
      <Tag color="blue">å•å“</Tag> : 
      <Tag color="gold">ç»„åˆ</Tag>
  },
  { title: 'é‡‘é¢', dataIndex: 'amount' },
  { title: 'æ—¶é•¿', dataIndex: 'duration_display' },
  { title: 'çŠ¶æ€', dataIndex: 'status' },
  { title: 'Discord', dataIndex: 'discord_id' },
  { title: 'æ“ä½œ', render: (record) => <ActionButtons record={record} /> }
];
```

#### ç­›é€‰åŠŸèƒ½å¢å¼º
```javascript
const filters = {
  productType: ['å…¨éƒ¨', 'æ¨å¸ç­–ç•¥', 'æ¨å¸ç³»ç»Ÿ', 'å¥—é¤ç»„åˆ'],
  packageType: ['å…¨éƒ¨', 'å•å“', 'ç»„åˆ'],
  status: ['å…¨éƒ¨', 'pending', 'confirmed_payment', 'confirmed_config', 'active', 'expired'],
  dateRange: 'æ—¶é—´èŒƒå›´é€‰æ‹©å™¨'
};
```

### 2. å®¢æˆ·ç®¡ç†é¡µé¢ (AdminCustomers.js)

#### æ–°å¢å®¢æˆ·äº§å“åå¥½åˆ†æ
```javascript
const customerColumns = [
  { title: 'å®¢æˆ·å¾®ä¿¡', dataIndex: 'customer_wechat' },
  { title: 'è®¢å•æ€»æ•°', dataIndex: 'total_orders' },
  { title: 'æ¶ˆè´¹æ€»é¢', dataIndex: 'total_amount' },
  { 
    title: 'ä¸»è¦äº§å“', 
    dataIndex: 'primary_product',
    render: (product) => <Tag color={getProductColor(product)}>{product}</Tag>
  },
  { 
    title: 'äº§å“åˆ†å¸ƒ', 
    render: (record) => (
      <div>
        {record.product_distribution.map(item => 
          <Tag key={item.product}>{item.product}: {item.count}</Tag>
        )}
      </div>
    )
  },
  { title: 'æœ€åè´­ä¹°', dataIndex: 'last_order_date' },
  { title: 'å‚¬å•çŠ¶æ€', dataIndex: 'reminder_status' }
];
```

### 3. é”€å”®ç®¡ç†é¡µé¢ (AdminSales.js)

#### é”€å”®å‘˜äº§å“ä¸šç»©ç»Ÿè®¡
```javascript
const SalesProductStats = ({ salesCode }) => {
  return (
    <Card title="äº§å“é”€å”®ç»Ÿè®¡">
      <Row gutter={16}>
        <Col span={8}>
          <Statistic 
            title="æ¨å¸ç­–ç•¥" 
            value={stats.strategy.count}
            suffix={`/ ${stats.strategy.amount}u`}
          />
        </Col>
        <Col span={8}>
          <Statistic 
            title="æ¨å¸ç³»ç»Ÿ" 
            value={stats.system.count}
            suffix={`/ ${stats.system.amount}u`}
          />
        </Col>
        <Col span={8}>
          <Statistic 
            title="å¥—é¤ç»„åˆ" 
            value={stats.combo.count}
            suffix={`/ ${stats.combo.amount}u`}
          />
        </Col>
      </Row>
    </Card>
  );
};
```

### 4. æ•°æ®æ¦‚è§ˆé¡µé¢ (AdminOverview.js)

#### æ–°å¢äº§å“ç»Ÿè®¡å›¾è¡¨
```javascript
// äº§å“é”€å”®å æ¯”é¥¼å›¾
const ProductPieChart = () => {
  const data = [
    { name: 'æ¨å¸ç­–ç•¥', value: 45, amount: '28,800u' },
    { name: 'æ¨å¸ç³»ç»Ÿ', value: 25, amount: '39,920u' },
    { name: 'å¥—é¤ç»„åˆ', value: 30, amount: '56,160u' }
  ];
  
  return <PieChart data={data} />;
};

// äº§å“é”€å”®è¶‹åŠ¿çº¿å›¾
const ProductTrendChart = () => {
  const data = {
    labels: ['9æœˆ1æ—¥', '9æœˆ2æ—¥', '9æœˆ3æ—¥', '9æœˆ4æ—¥', '9æœˆ5æ—¥', '9æœˆ6æ—¥'],
    datasets: [
      {
        label: 'æ¨å¸ç­–ç•¥',
        data: [12, 15, 10, 18, 20, 25],
        borderColor: 'rgb(75, 192, 192)'
      },
      {
        label: 'æ¨å¸ç³»ç»Ÿ',
        data: [0, 0, 0, 0, 0, 8],
        borderColor: 'rgb(255, 99, 132)'
      },
      {
        label: 'å¥—é¤ç»„åˆ',
        data: [0, 0, 0, 0, 0, 12],
        borderColor: 'rgb(53, 162, 235)'
      }
    ]
  };
  
  return <LineChart data={data} />;
};
```

### 5. è´¢åŠ¡ç®¡ç†é¡µé¢ (AdminFinance.js)

#### æŒ‰äº§å“åˆ†ç±»çš„è´¢åŠ¡ç»Ÿè®¡
```javascript
const FinanceByProduct = () => {
  return (
    <Card title="äº§å“è´¢åŠ¡æ¦‚è§ˆ">
      <Table 
        dataSource={financeData}
        columns={[
          { title: 'äº§å“ç±»å‹', dataIndex: 'product_type' },
          { title: 'è®¢å•æ•°é‡', dataIndex: 'order_count' },
          { title: 'æ€»é”€å”®é¢', dataIndex: 'total_sales' },
          { title: 'åº”ä»˜ä½£é‡‘', dataIndex: 'pending_commission' },
          { title: 'å·²ä»˜ä½£é‡‘', dataIndex: 'paid_commission' },
          { title: 'åˆ©æ¶¦', dataIndex: 'profit' },
          { title: 'åˆ©æ¶¦ç‡', dataIndex: 'profit_rate' }
        ]}
      />
    </Card>
  );
};
```

### 6. é”€å”®å¯¹è´¦é¡µé¢æ”¹é€ 

#### ä¸€çº§é”€å”®å¯¹è´¦ (SalesCommissionPage.js)
```javascript
const ProductCommissionStats = ({ salesCode }) => {
  return (
    <Row gutter={16}>
      <Col span={24}>
        <Card title="äº§å“ä½£é‡‘ç»Ÿè®¡">
          <Table 
            dataSource={commissionStats}
            columns={[
              { title: 'äº§å“ç±»å‹', dataIndex: 'product_type' },
              { title: 'è®¢å•æ•°', dataIndex: 'order_count' },
              { title: 'é”€å”®é¢', dataIndex: 'sales_amount' },
              { title: 'ä½£é‡‘ç‡', dataIndex: 'commission_rate' },
              { title: 'åº”å¾—ä½£é‡‘', dataIndex: 'commission_amount' },
              { title: 'å·²ä»˜ä½£é‡‘', dataIndex: 'paid_commission' },
              { title: 'å¾…ä»˜ä½£é‡‘', dataIndex: 'pending_commission' }
            ]}
          />
        </Card>
      </Col>
    </Row>
  );
};
```

#### äºŒçº§é”€å”®å¯¹è´¦ (SecondarySalesPage.js)
```javascript
const TeamProductStats = ({ primarySalesCode }) => {
  return (
    <Card title="å›¢é˜Ÿäº§å“ä¸šç»©">
      <Table 
        dataSource={teamStats}
        columns={[
          { title: 'ä¸‹çº§é”€å”®', dataIndex: 'sales_wechat' },
          { title: 'æ¨å¸ç­–ç•¥', dataIndex: 'strategy_count' },
          { title: 'æ¨å¸ç³»ç»Ÿ', dataIndex: 'system_count' },
          { title: 'å¥—é¤ç»„åˆ', dataIndex: 'combo_count' },
          { title: 'æ€»ä¸šç»©', dataIndex: 'total_sales' },
          { title: 'å›¢é˜Ÿä½£é‡‘', dataIndex: 'team_commission' }
        ]}
      />
    </Card>
  );
};
```

---

## ğŸ”Œ APIæ¥å£æ”¹é€ 

### æ–°å¢APIæ¥å£

#### äº§å“ç›¸å…³API
```javascript
// è·å–äº§å“é…ç½®
export const getProductConfig = async (date = new Date()) => {
  const response = await supabase
    .from('product_config')
    .select('*')
    .lte('effective_date', date.toISOString().split('T')[0])
    .eq('is_active', true)
    .order('effective_date', { ascending: false });
  
  return response.data;
};

// è·å–åŠ¨æ€ä»·æ ¼
export const getDynamicPricing = async (productType, duration, date = new Date()) => {
  const response = await supabase
    .from('product_config')
    .select('price_usd')
    .eq('product_type', productType)
    .eq('duration_months', duration)
    .lte('effective_date', date.toISOString().split('T')[0])
    .eq('is_active', true)
    .order('effective_date', { ascending: false })
    .limit(1);
  
  return response.data[0]?.price_usd;
};
```

#### è®¢å•APIå¢å¼º
```javascript
// åˆ›å»ºè®¢å•ï¼ˆæ”¯æŒäº§å“ç±»å‹ï¼‰
export const createOrder = async (orderData) => {
  const { product_type, duration, sales_code, customer_wechat, discord_id } = orderData;
  
  // è·å–åŠ¨æ€ä»·æ ¼
  const price = await getDynamicPricing(product_type, duration);
  
  const response = await supabase
    .from('orders_optimized')
    .insert({
      ...orderData,
      amount: price,
      product_type,
      package_type: product_type === 'å¥—é¤ç»„åˆ' ? 'ç»„åˆ' : 'å•å“',
      discord_id
    });
  
  return response;
};

// è·å–è®¢å•ï¼ˆæ”¯æŒäº§å“ç­›é€‰ï¼‰
export const getOrdersWithFilters = async (filters = {}) => {
  let query = supabase
    .from('orders_optimized')
    .select(`
      *,
      sales_optimized(wechat_name, sales_type)
    `);
  
  if (filters.product_type && filters.product_type !== 'å…¨éƒ¨') {
    query = query.eq('product_type', filters.product_type);
  }
  
  if (filters.package_type && filters.package_type !== 'å…¨éƒ¨') {
    query = query.eq('package_type', filters.package_type);
  }
  
  if (filters.status && filters.status !== 'å…¨éƒ¨') {
    query = query.eq('status', filters.status);
  }
  
  if (filters.date_start) {
    query = query.gte('created_at', filters.date_start);
  }
  
  if (filters.date_end) {
    query = query.lte('created_at', filters.date_end);
  }
  
  return query.order('created_at', { ascending: false });
};
```

#### ç»Ÿè®¡APIå¢å¼º
```javascript
// äº§å“ç»Ÿè®¡
export const getProductStats = async (dateRange = {}) => {
  let query = supabase
    .from('orders_optimized')
    .select('product_type, amount, status')
    .in('status', ['confirmed_payment', 'confirmed_config', 'active']);
  
  if (dateRange.start) {
    query = query.gte('created_at', dateRange.start);
  }
  
  if (dateRange.end) {
    query = query.lte('created_at', dateRange.end);
  }
  
  const response = await query;
  
  // æŒ‰äº§å“ç±»å‹èšåˆç»Ÿè®¡
  const stats = response.data.reduce((acc, order) => {
    if (!acc[order.product_type]) {
      acc[order.product_type] = { count: 0, amount: 0 };
    }
    acc[order.product_type].count++;
    acc[order.product_type].amount += order.amount;
    return acc;
  }, {});
  
  return stats;
};

// é”€å”®å‘˜äº§å“ä¸šç»©ç»Ÿè®¡
export const getSalesProductStats = async (salesCode) => {
  const response = await supabase
    .from('orders_optimized')
    .select('product_type, amount, commission_amount')
    .eq('sales_code', salesCode)
    .in('status', ['confirmed_payment', 'confirmed_config', 'active']);
  
  return response.data.reduce((acc, order) => {
    if (!acc[order.product_type]) {
      acc[order.product_type] = { 
        count: 0, 
        sales_amount: 0, 
        commission_amount: 0 
      };
    }
    acc[order.product_type].count++;
    acc[order.product_type].sales_amount += order.amount;
    acc[order.product_type].commission_amount += order.commission_amount;
    return acc;
  }, {});
};
```

---

## âš™ï¸ ç³»ç»ŸåŠŸèƒ½å¢å¼º

### 1. Discordé›†æˆå‡†å¤‡
```javascript
// Discordç›¸å…³å­—æ®µå’ŒåŠŸèƒ½
const DiscordIntegration = {
  // è®¢å•è¡¨å­—æ®µ
  fields: ['discord_id', 'trial_end_time'],
  
  // è¯•ç”¨æœŸç®¡ç†
  trialManagement: {
    duration: 3, // 3å¤©è¯•ç”¨
    autoRemove: true, // åˆ°æœŸè‡ªåŠ¨ç§»é™¤æƒé™
    notifications: true // åˆ°æœŸæé†’
  },
  
  // æƒé™ç®¡ç†
  permissions: {
    'æ¨å¸ç³»ç»Ÿ': ['system_channel_access'],
    'å¥—é¤ç»„åˆ': ['system_channel_access', 'strategy_channel_access']
  }
};
```

### 2. ä»·æ ¼åˆ‡æ¢é€»è¾‘
```javascript
// ä»·æ ¼ç”Ÿæ•ˆæ—¶é—´åˆ¤æ–­
const getPriceByDate = (productType, duration, orderDate) => {
  const switchDate = new Date('2024-09-06T00:00:00+08:00');
  const isNewPrice = new Date(orderDate) >= switchDate;
  
  if (isNewPrice) {
    return getNewPrice(productType, duration);
  } else {
    return getOldPrice(duration); // å†å²ä»·æ ¼
  }
};
```

### 3. æ•°æ®è¿ç§»è„šæœ¬
```javascript
// å†å²è®¢å•äº§å“ç±»å‹æ ‡è®°
const migrateHistoricalOrders = async () => {
  const response = await supabase
    .from('orders_optimized')
    .update({ 
      product_type: 'æ¨å¸ç­–ç•¥',
      package_type: 'å•å“' 
    })
    .is('product_type', null);
  
  console.log(`è¿ç§»äº† ${response.data.length} ä¸ªå†å²è®¢å•`);
};
```

---

## ğŸ“ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ•°æ®åº“å‡†å¤‡ï¼ˆ1å¤©ï¼‰
1. âœ… å®Œæ•´æ•°æ®åº“å¤‡ä»½
2. âœ… æ·»åŠ æ–°å­—æ®µå’Œç´¢å¼•
3. âœ… åˆ›å»ºäº§å“é…ç½®è¡¨
4. âœ… è¿ç§»å†å²æ•°æ®
5. âœ… æ•°æ®ä¸€è‡´æ€§éªŒè¯

### ç¬¬äºŒé˜¶æ®µï¼šåç«¯APIå¼€å‘ï¼ˆ2å¤©ï¼‰
1. âœ… äº§å“é…ç½®ç®¡ç†API
2. âœ… åŠ¨æ€ä»·æ ¼è·å–API
3. âœ… è®¢å•APIå¢å¼º
4. âœ… ç»Ÿè®¡APIé‡æ„
5. âœ… APIæµ‹è¯•å’ŒéªŒè¯

### ç¬¬ä¸‰é˜¶æ®µï¼šå‰ç«¯é¡µé¢æ”¹é€ ï¼ˆ3å¤©ï¼‰
1. âœ… è´­ä¹°é¡µé¢é‡æ„
2. âœ… é”€å”®ç®¡ç†é¡µé¢æ›´æ–°
3. âœ… ç®¡ç†åå°é¡µé¢æ”¹é€ 
4. âœ… å¯¹è´¦é¡µé¢å‡çº§
5. âœ… æ•°æ®æ¦‚è§ˆå¢å¼º

### ç¬¬å››é˜¶æ®µï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å¤©ï¼‰
1. âœ… åŠŸèƒ½å®Œæ•´æ€§æµ‹è¯•
2. âœ… æ•°æ®å‡†ç¡®æ€§éªŒè¯
3. âœ… ä»·æ ¼åˆ‡æ¢æµ‹è¯•
4. âœ… æ€§èƒ½æµ‹è¯•
5. âœ… ç”¨æˆ·ä½“éªŒæµ‹è¯•

### ç¬¬äº”é˜¶æ®µï¼šä¸Šçº¿éƒ¨ç½²ï¼ˆ0.5å¤©ï¼‰
1. âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²
2. âœ… æ•°æ®åº“è¿ç§»æ‰§è¡Œ
3. âœ… åŠŸèƒ½éªŒè¯
4. âœ… ç›‘æ§å’Œæ—¥å¿—
5. âœ… ç”¨æˆ·é€šçŸ¥

---

## ğŸ¯ æ ¸å¿ƒæ–‡ä»¶æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼ˆ20ä¸ªï¼‰

#### å‰ç«¯é¡µé¢æ–‡ä»¶
1. `client/src/pages/PurchasePage.js` - è´­ä¹°é¡µé¢é‡æ„ â­â­â­
2. `client/src/pages/SalesPage.js` - é”€å”®ç®¡ç†é¡µé¢
3. `client/src/components/admin/AdminOrders.js` - è®¢å•ç®¡ç† â­â­â­
4. `client/src/components/admin/AdminCustomers.js` - å®¢æˆ·ç®¡ç†
5. `client/src/components/admin/AdminSales.js` - é”€å”®ç®¡ç†
6. `client/src/components/admin/AdminFinance.js` - è´¢åŠ¡ç®¡ç†
7. `client/src/components/admin/AdminOverview.js` - æ•°æ®æ¦‚è§ˆ â­â­
8. `client/src/pages/SalesCommissionPage.js` - ä¸€çº§é”€å”®å¯¹è´¦
9. `client/src/pages/SecondarySalesPage.js` - äºŒçº§é”€å”®å¯¹è´¦

#### æ–°å»ºç»„ä»¶æ–‡ä»¶
10. `client/src/components/common/ProductSelector.js` - äº§å“é€‰æ‹©å™¨
11. `client/src/components/common/PricingTable.js` - ä»·æ ¼è¡¨ç»„ä»¶
12. `client/src/components/charts/ProductPieChart.js` - äº§å“å æ¯”å›¾
13. `client/src/components/charts/ProductTrendChart.js` - äº§å“è¶‹åŠ¿å›¾

#### APIå’ŒæœåŠ¡æ–‡ä»¶
14. `client/src/services/api.js` - APIæ¥å£å¢å¼º â­â­â­
15. `client/src/services/productApi.js` - æ–°å»ºäº§å“API
16. `client/src/services/adminApi.js` - ç®¡ç†APIå¢å¼º

#### çŠ¶æ€ç®¡ç†æ–‡ä»¶
17. `client/src/store/slices/productSlice.js` - æ–°å»ºäº§å“çŠ¶æ€
18. `client/src/store/slices/orderSlice.js` - è®¢å•çŠ¶æ€æ›´æ–°
19. `client/src/store/slices/adminSlice.js` - ç®¡ç†çŠ¶æ€æ›´æ–°

#### æ•°æ®åº“æ–‡ä»¶
20. `database/upgrade_v2.sql` - æ•°æ®åº“å‡çº§è„šæœ¬

### ä¼˜å…ˆçº§æ ‡è®°
- â­â­â­ æœ€é«˜ä¼˜å…ˆçº§ï¼šæ ¸å¿ƒè´­ä¹°æµç¨‹å’Œè®¢å•ç®¡ç†
- â­â­ é«˜ä¼˜å…ˆçº§ï¼šç»Ÿè®¡å’Œå±•ç¤ºåŠŸèƒ½
- â­ ä¸­ä¼˜å…ˆçº§ï¼šè¾…åŠ©åŠŸèƒ½

---

## ğŸ” è´¨é‡ä¿è¯

### æ•°æ®å®Œæ•´æ€§æ£€æŸ¥
```sql
-- æ£€æŸ¥å†å²è®¢å•è¿ç§»
SELECT 
  product_type, 
  COUNT(*) as count,
  MIN(created_at) as earliest,
  MAX(created_at) as latest
FROM orders_optimized 
GROUP BY product_type;

-- æ£€æŸ¥ä»·æ ¼ä¸€è‡´æ€§
SELECT 
  o.product_type,
  o.duration,
  o.amount,
  pc.price_usd,
  CASE WHEN o.amount = pc.price_usd THEN 'ä¸€è‡´' ELSE 'ä¸ä¸€è‡´' END as status
FROM orders_optimized o
LEFT JOIN product_config pc ON pc.product_type = o.product_type 
  AND pc.duration_months = CASE o.duration 
    WHEN '1month' THEN 1
    WHEN '3months' THEN 3
    WHEN '6months' THEN 6
    WHEN '1year' THEN 12
  END
WHERE o.created_at >= '2024-09-06'
  AND pc.effective_date = '2024-09-06';
```

### åŠŸèƒ½æµ‹è¯•ç”¨ä¾‹
1. **äº§å“é€‰æ‹©æµ‹è¯•**ï¼šéªŒè¯ä¸‰ç§äº§å“å¯æ­£å¸¸é€‰æ‹©
2. **ä»·æ ¼æ˜¾ç¤ºæµ‹è¯•**ï¼šéªŒè¯ä¸åŒæ—¶æœŸä»·æ ¼æ˜¾ç¤ºæ­£ç¡®
3. **è®¢å•åˆ›å»ºæµ‹è¯•**ï¼šéªŒè¯æ–°è®¢å•åŒ…å«æ­£ç¡®äº§å“ä¿¡æ¯
4. **ç­›é€‰åŠŸèƒ½æµ‹è¯•**ï¼šéªŒè¯ç®¡ç†åå°ç­›é€‰åŠŸèƒ½
5. **ç»Ÿè®¡å‡†ç¡®æ€§æµ‹è¯•**ï¼šéªŒè¯å„ç±»ç»Ÿè®¡æ•°æ®å‡†ç¡®

### æ€§èƒ½ç›‘æ§æŒ‡æ ‡
- é¡µé¢åŠ è½½æ—¶é—´ < 2ç§’
- APIå“åº”æ—¶é—´ < 500ms
- æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ï¼ˆä½¿ç”¨ç´¢å¼•ï¼‰
- å‰ç«¯ç»„ä»¶æ¸²æŸ“ä¼˜åŒ–

---

## ğŸ“ åº”æ€¥é¢„æ¡ˆ

### å›æ»šæ–¹æ¡ˆ
1. **æ•°æ®åº“å›æ»š**ï¼šä½¿ç”¨å¤‡ä»½æ–‡ä»¶å¿«é€Ÿæ¢å¤
2. **ä»£ç å›æ»š**ï¼šGitç‰ˆæœ¬å›é€€
3. **é…ç½®å›æ»š**ï¼šæ¢å¤åŸæœ‰é…ç½®æ–‡ä»¶

### ç›‘æ§å‘Šè­¦
1. **é”™è¯¯ç›‘æ§**ï¼šAPIé”™è¯¯ç‡è¶…è¿‡1%å‘Šè­¦
2. **æ€§èƒ½ç›‘æ§**ï¼šå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼å‘Šè­¦
3. **ä¸šåŠ¡ç›‘æ§**ï¼šè®¢å•åˆ›å»ºå¤±è´¥ç‡ç›‘æ§

### åº”æ€¥è”ç³»
- **æŠ€æœ¯è´Ÿè´£äºº**ï¼šç«‹å³å“åº”æŠ€æœ¯é—®é¢˜
- **ä¸šåŠ¡è´Ÿè´£äºº**ï¼šå¤„ç†ç”¨æˆ·æŠ•è¯‰å’Œä¸šåŠ¡é—®é¢˜
- **è¿ç»´è´Ÿè´£äºº**ï¼šå¤„ç†æœåŠ¡å™¨å’Œéƒ¨ç½²é—®é¢˜

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶
- [ ] ä¸‰ç§äº§å“å¯æ­£å¸¸è´­ä¹°
- [ ] ä»·æ ¼æ˜¾ç¤ºå‡†ç¡®æ— è¯¯
- [ ] ç®¡ç†åå°åŠŸèƒ½å®Œæ•´
- [ ] ç»Ÿè®¡æ•°æ®å‡†ç¡®
- [ ] å†å²æ•°æ®å®Œæ•´ä¿ç•™

### æ€§èƒ½éªŒæ”¶
- [ ] é¡µé¢å“åº”é€Ÿåº¦æ­£å¸¸
- [ ] æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
- [ ] å‰ç«¯äº¤äº’æµç•…

### æ•°æ®éªŒæ”¶
- [ ] å†å²è®¢å•å®Œæ•´è¿ç§»
- [ ] æ–°è®¢å•æ•°æ®ç»“æ„æ­£ç¡®
- [ ] ç»Ÿè®¡æ•°æ®è®¡ç®—å‡†ç¡®

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**åˆ›å»ºæ—¶é—´**ï¼š2024å¹´9æœˆ6æ—¥
**æœ€åæ›´æ–°**ï¼š2024å¹´9æœˆ6æ—¥
**è´Ÿè´£äºº**ï¼šæŠ€æœ¯å›¢é˜Ÿ

---

> ğŸ’¡ **é‡è¦æé†’**ï¼šæœ¬æ–¹æ¡ˆæ¶‰åŠç”Ÿäº§æ•°æ®åº“ä¿®æ”¹ï¼Œæ‰§è¡Œå‰åŠ¡å¿…å®Œæˆæ•°æ®å¤‡ä»½ï¼Œå¹¶åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚