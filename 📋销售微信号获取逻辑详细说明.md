# 📋 销售微信号获取逻辑详细说明

## 🎯 问题：客户管理和销售管理里的销售微信号获取不到

### 一、客户管理中的销售微信号获取逻辑

**文件位置：** `client/src/services/api.js` 第156-241行 `AdminAPI.getCustomers()`

**核心逻辑：**
```javascript
// 1. 获取数据源
const [ordersResult, primarySalesResult, secondarySalesResult] = await Promise.all([
  supabaseClient.from('orders').select('*'),
  supabaseClient.from('primary_sales').select('sales_code, name, wechat_name'),
  supabaseClient.from('secondary_sales').select('sales_code, name, wechat_name')
]);

// 2. 合并销售数据
const allSales = [...(primarySalesResult.data || []), ...(secondarySalesResult.data || [])];

// 3. 对每个订单，通过sales_code查找销售微信号
orders.forEach(order => {
  if (order.sales_code) {
    const matchingSale = allSales.find(sale => sale.sales_code === order.sales_code);
    if (matchingSale) {
      // 🔧 关键：优先使用name字段，其次wechat_name
      salesWechat = matchingSale.name || matchingSale.wechat_name || '-';
    }
  }
});
```

**查询的字段：**
- `primary_sales` 表：`sales_code, name, wechat_name`
- `secondary_sales` 表：`sales_code, name, wechat_name`

**获取优先级：**
1. `matchingSale.name` （第一优先级）
2. `matchingSale.wechat_name` （第二优先级）
3. `'-'` （默认值）

---

### 二、销售管理中的销售微信号获取逻辑

**文件位置：** `client/src/services/api.js` 第304-496行 `AdminAPI.getSales()`

#### 2.1 一级销售微信号获取（第370行）
```javascript
// 🔧 修复：通过sales_code反向获取销售微信号
// 确保wechat_name有值，如果销售表中为空，使用name或phone作为备选
const wechatName = sale.wechat_name || sale.name || sale.phone || `一级销售-${sale.sales_code}`;

return {
  ...sale,
  wechat_name: wechatName, // 🔧 确保微信号字段有值
  // ... 其他字段
};
```

**一级销售获取优先级：**
1. `sale.wechat_name` （第一优先级）
2. `sale.name` （第二优先级）
3. `sale.phone` （第三优先级）
4. `一级销售-${sale.sales_code}` （默认值）

#### 2.2 二级销售微信号获取（第455行）
```javascript
// 🔧 修复：通过sales_code反向获取销售微信号
// 确保wechat_name有值，如果销售表中为空，使用name或phone作为备选
const wechatName = sale.wechat_name || sale.name || sale.phone || `二级销售-${sale.sales_code}`;

return {
  ...sale,
  wechat_name: wechatName, // 🔧 确保微信号字段有值
  // ... 其他字段
};
```

**二级销售获取优先级：**
1. `sale.wechat_name` （第一优先级）
2. `sale.name` （第二优先级）
3. `sale.phone` （第三优先级）
4. `二级销售-${sale.sales_code}` （默认值）

---

## 🔍 需要检查的数据库字段

### 1. primary_sales 表需要检查的字段：
```sql
SELECT sales_code, name, wechat_name, phone FROM primary_sales LIMIT 5;
```

### 2. secondary_sales 表需要检查的字段：
```sql
SELECT sales_code, name, wechat_name, phone FROM secondary_sales LIMIT 5;
```

### 3. orders 表需要检查的关联字段：
```sql
SELECT id, sales_code, customer_wechat, tradingview_username FROM orders LIMIT 5;
```

---

## 🚨 可能的问题原因

1. **数据库字段为空：** `name`, `wechat_name`, `phone` 字段都是空值
2. **关联失败：** `orders.sales_code` 与 `primary_sales.sales_code` / `secondary_sales.sales_code` 不匹配
3. **数据类型问题：** 字段值为 `null`, `undefined`, 或空字符串 `''`

---

## 📝 请帮我查询这些数据

请在Supabase控制台或数据库工具中执行以下查询，告诉我结果：

```sql
-- 1. 检查一级销售数据
SELECT sales_code, name, wechat_name, phone, created_at 
FROM primary_sales 
ORDER BY created_at DESC 
LIMIT 5;

-- 2. 检查二级销售数据  
SELECT sales_code, name, wechat_name, phone, created_at
FROM secondary_sales 
ORDER BY created_at DESC 
LIMIT 5;

-- 3. 检查订单关联
SELECT id, sales_code, customer_wechat, tradingview_username, created_at
FROM orders 
WHERE sales_code IS NOT NULL
ORDER BY created_at DESC 
LIMIT 5;

-- 4. 检查关联情况
SELECT 
  o.sales_code,
  p.name as primary_name,
  p.wechat_name as primary_wechat,
  s.name as secondary_name,
  s.wechat_name as secondary_wechat
FROM orders o
LEFT JOIN primary_sales p ON o.sales_code = p.sales_code
LEFT JOIN secondary_sales s ON o.sales_code = s.sales_code
WHERE o.sales_code IS NOT NULL
LIMIT 5;
```

把这些查询结果发给我，我就能确定具体问题在哪里了！
