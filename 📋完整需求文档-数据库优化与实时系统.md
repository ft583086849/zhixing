# 📋 完整需求文档 - 数据库优化与实时系统

> 创建时间：2025-08-15
> 最后更新：2025-08-15
> 状态：待确认

---

## 一、📌 核心需求概述

### 1.1 总体目标
- **每个表都有完整数据**，避免关联查询和实时计算
- **整个系统完全实时**，所有数据变化立即反映
- **支持未来用户系统**，预留用户登录和角色转换功能

### 1.2 核心原则
- ✅ 数据冗余存储，牺牲空间换取查询性能
- ✅ 事件驱动，每个操作立即更新所有相关数据
- ✅ 预留扩展字段，支持未来功能升级

---

## 二、🔴 今日新增需求（2025-08-15）

### 2.1 转化率统计需求 🆕
**需求描述**：
- 查看所有销售的7天免费订单转化率
- 可按销售类型筛选（一级/二级/独立）
- 按转化率从高到低排序
- 显示位置：AdminOverview.js的Top5销售排行榜下方

**具体指标**：
- 免费订单数量
- 转化订单数量
- 转化率百分比
- 平均转化天数
- 转化产品分布（1个月/3个月/6个月/年费）

### 2.2 实时对账系统 🆕
**需求描述**：
- **每笔订单立即产生对账记录**（不是每天汇总）
- 销售实时看到每笔订单的佣金
- 显示余额变化轨迹（交易前→交易后）
- 支持争议处理和调整

**实时展示**：
```
新订单 → 立即显示：
├─ 佣金金额：+$25.00
├─ 当前余额：$1,275.00
├─ 状态：待确认
└─ 推送通知：新订单佣金已入账
```

### 2.3 资金统计实时化 🆕
**需求描述**：
- 资金统计页面数据实时更新
- 收益分配实时计算
- 不需要手动刷新

### 2.4 佣金规则透明化 🆕
**需求描述**：
- 所有佣金规则记录在表中
- 支持阶梯佣金（业绩越高佣金越高）
- 支持特殊规则（续费奖励等）
- 佣金计算过程可追溯

---

## 三、📊 数据库设计需求

### 3.1 新建表清单

#### 用户系统相关（支持未来功能）
1. **users表** - 用户账号表
2. **customers表** - 客户信息表
3. **sales表** - 销售信息表（替代secondary_sales）

#### 统计与分析
4. **overview_stats表** - 数据概览统计表
5. **sales_ranking表** - 销售排行榜表
6. **daily_stats表** - 每日统计快照表
7. **conversion_stats表** - 转化率统计表 🆕

#### 资金与对账
8. **fund_statistics表** - 资金统计表 🆕
9. **sales_reconciliation表** - 销售对账明细表（实时）🆕
10. **sales_balance表** - 销售余额表 🆕
11. **fund_flow表** - 资金流水表 🆕
12. **daily_reconciliation_summary表** - 每日对账汇总表 🆕

#### 佣金管理
13. **commission_rules表** - 佣金规则表 🆕
14. **commission_records表** - 佣金记录表 🆕

#### 业务追踪
15. **reminder_records表** - 催单记录表 🆕
16. **user_conversion_journey表** - 用户转化旅程表 🆕

### 3.2 现有表优化

#### orders表添加字段
```sql
-- 客户完整信息
customer_id, customer_name, customer_phone, customer_email

-- 销售完整信息
sales_id, sales_wechat_name, sales_type, sales_commission_rate

-- 一级销售信息
primary_sales_id, primary_sales_code, primary_sales_wechat
primary_commission_amount

-- 二级销售信息
secondary_sales_id, secondary_sales_code, secondary_sales_wechat
secondary_commission_amount

-- 预留字段
extra_field1, extra_field2, extra_field3, extra_json
```

---

## 四、🎯 分佣逻辑需求

### 4.1 核心规则
```
订单金额 $100 的分佣流程：

1. 一级销售直销：
   └─ 一级销售获得：$100 × 40% = $40

2. 二级销售订单（假设二级佣金率25%）：
   ├─ 二级销售获得：$100 × 25% = $25
   └─ 一级销售获得：$100 × (40% - 25%) = $15（分销收益）

3. 独立销售订单：
   └─ 独立销售获得：$100 × 25% = $25（默认佣金率）
```

### 4.2 关键点
- **总佣金率固定40%**
- **二级销售佣金率可调**（0-40%）
- **差额自动归一级销售**

---

## 五、🔄 实时数据流需求

### 5.1 订单创建时的实时流程
```
用户下单 → 立即触发：
├─ 创建订单记录（orders）
├─ 创建对账记录（sales_reconciliation）🆕
├─ 创建佣金记录（commission_records）🆕
├─ 创建资金流水（fund_flow）🆕
├─ 更新销售余额（sales_balance）🆕
├─ 更新转化统计（conversion_stats）🆕
├─ 更新资金统计（fund_statistics）🆕
├─ 更新销售排行（sales_ranking）
└─ 实时推送到前端（Supabase Realtime）
```

### 5.2 实时性要求
- **延迟要求**：< 100ms
- **推送方式**：WebSocket实时推送
- **失败重试**：3次，间隔1秒

---

## 六、👤 未来用户系统支持

### 6.1 用户角色流转
```
普通用户(注册) → 购买产品(成为客户) → 申请成为销售 → 获得销售资格
                                      ↓
                            继续作为客户购买(给原销售返佣)
```

### 6.2 预留设计
- 所有新表都包含`user_id`字段
- 支持用户多角色（既是客户又是销售）
- 保持原有销售关系（客户变销售后仍给原销售返佣）

---

## 七、📱 前端展示需求

### 7.1 管理员看到的
- **数据概览**：实时统计，预存储数据
- **资金统计**：实时收益分配
- **销售排行榜**：Top5 + 转化率排行榜 🆕
- **订单管理**：完整信息，无需关联查询

### 7.2 一级销售看到的
- **实时对账**：每笔订单立即显示 🆕
- **分销管理**：二级销售业绩和佣金设置
- **余额变化**：实时余额和可提现金额 🆕

### 7.3 二级销售看到的
- **实时对账**：自己的订单和佣金 🆕
- **催单管理**：即将到期客户提醒
- **余额查询**：当前余额和历史记录 🆕

---

## 八、⚡ 性能指标要求

### 8.1 查询性能
- 列表查询：< 100ms
- 统计查询：< 200ms（预存储）
- 实时更新：< 100ms

### 8.2 并发要求
- 支持1000+销售同时在线
- 支持100+订单/秒处理能力

---

## 九、🔐 数据安全需求

### 9.1 权限控制
- 销售只能看自己的数据
- 二级销售不能看一级销售的完整数据
- 管理员可以看所有数据

### 9.2 数据审计
- 所有佣金变更记录
- 所有余额变化记录
- 所有争议处理记录

---

## 十、📋 实施优先级

### 第一阶段（高优先级）🔴
1. 修复primary_sales表引用问题
2. 创建实时对账系统表
3. 创建转化率统计表
4. 实现订单创建时的实时数据流

### 第二阶段（中优先级）🟡
5. 创建资金统计表
6. 创建佣金规则表
7. 优化orders表结构
8. 实现前端实时推送

### 第三阶段（低优先级）🟢
9. 创建用户系统表
10. 实现用户角色转换
11. 完善数据分析功能

---

## 十一、✅ 验收标准

### 11.1 功能验收
- [ ] 每笔订单立即产生对账记录
- [ ] 销售实时看到佣金变化
- [ ] 转化率统计实时更新
- [ ] 资金统计无需手动刷新

### 11.2 性能验收
- [ ] 查询响应时间 < 200ms
- [ ] 实时推送延迟 < 100ms
- [ ] 支持1000+并发用户

### 11.3 数据验收
- [ ] 所有表数据完整，无需关联
- [ ] 历史数据可追溯
- [ ] 数据一致性保证

---

## 十二、📝 备注

1. **标记说明**：
   - 🆕 = 今日新增需求（2025-08-15）
   - 🔴 = 高优先级
   - 🟡 = 中优先级
   - 🟢 = 低优先级

2. **关键决策**：
   - 采用数据冗余策略，空间换时间
   - 使用PostgreSQL触发器保证实时性
   - 使用Supabase Realtime实现推送

3. **风险提醒**：
   - 数据冗余需要保证一致性
   - 实时系统需要考虑性能开销
   - 需要完善的错误处理机制

---

**文档状态**：待用户确认补充