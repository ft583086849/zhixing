# 📋 配置确认（config_confirmed）过滤需求明细

## 一、需求文档明确要求

根据《支付管理系统需求文档.md》，以下指标和功能**必须**过滤配置确认的订单：

### 1. 一级销售页面（5.1节）

#### 5.1.1 二级销售管理
- **业绩统计**：二级销售的订单数、总金额、佣金收入仅计入配置确认的订单
- **时间搜索**：搜索二级销售名下配置确认订单的付款时间
- **注意**：二级销售总数量不受配置确认状态影响

#### 5.1.2 我的佣金统计
- **统计规则**：所有统计仅计入配置确认的订单（config_confirmed: true）
- **过滤逻辑**：未配置确认的订单不计入订单量、金额、佣金等任何统计
- 包括：
  - 二级销售订单量计数求和
  - 二级销售订单金额求和
  - 总佣金求和

#### 5.1.3 我名下销售的订单
- **展示逻辑**：仅展示配置确认的订单（config_confirmed: true）
- **过滤规则**：未配置确认的订单不在列表中显示

### 2. 二级销售对账页面（5.2节）

- **展示逻辑**：仅展示配置确认的订单（config_confirmed: true）
- **统计计算**：以下指标仅计入配置确认的订单
  - 总订单数
  - 总金额
  - 总佣金
  - 本月佣金
- **过滤规则**：未配置确认的订单不在列表中显示，不计入任何统计
- **特殊说明**：返佣比例不受配置确认状态影响，保持固定比率

### 3. 佣金计算相关（3.7节和4.5节）

#### 一级销售佣金比率计算
- **数据过滤**：仅计入配置确认的订单（config_confirmed: true）
- **适用范围**：
  - 一级销售对账页面显示
  - 管理员页面一级销售佣金比率显示
  - 所有涉及一级销售佣金比率计算的地方

### 4. 管理员数据概览（特殊说明）

**重要**：根据需求文档第509行：
> **统计规则**：数据概览页面的所有数据统计应按订单管理页面的数据进行计算，**不使用config_confirmed过滤逻辑**

这意味着管理员数据概览页面显示所有订单，不过滤。

## 二、总结

### ✅ 需要过滤 config_confirmed = true 的地方：

1. **销售端（一级/二级）所有统计和显示**
   - 总订单数
   - 总订单金额
   - 总佣金/累计佣金
   - 本月订单数
   - 本月订单金额
   - 本月佣金
   - 订单列表显示

2. **佣金计算**
   - 一级销售佣金比率计算
   - 二级销售佣金统计
   - 分佣计算

### ❌ 不需要过滤的地方：

1. **管理员数据概览页面**
   - 显示所有订单的统计
   - 包括未确认的订单

2. **销售数量统计**
   - 二级销售总数量（人数）

3. **佣金比率设置**
   - 返佣比例保持固定，不受订单状态影响

## 三、实施要点

### 数据库层面（推荐）
```sql
-- 创建只包含确认订单的视图
CREATE VIEW confirmed_orders AS
SELECT * FROM orders 
WHERE config_confirmed = true;

-- 销售统计视图
CREATE VIEW sales_stats AS
SELECT 
  sales_code,
  COUNT(*) as total_orders,
  SUM(amount) as total_amount,
  SUM(commission_amount) as total_commission
FROM confirmed_orders
GROUP BY sales_code;
```

### 前端实现
```javascript
// 错误示例（不推荐）
const allOrders = await getOrders();
const confirmedOrders = allOrders.filter(o => o.config_confirmed);

// 正确示例（推荐）
const confirmedOrders = await getConfirmedOrders(); // 直接从视图获取
```

## 四、注意事项

1. **数据一致性**：所有销售端的统计必须基于相同的过滤规则
2. **性能优化**：在数据库层面过滤，避免传输未确认订单
3. **权限控制**：销售端不应该能看到未确认的订单数据
4. **文档说明**：需求文档明确标注了"🆕"的地方都是新增的配置确认过滤要求
