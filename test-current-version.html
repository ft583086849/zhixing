<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å½“å‰ç‰ˆæœ¬</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #1890ff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .error {
            background: #fff2e8;
            border: 1px solid #ffbb96;
            color: #fa8c16;
        }
        .info {
            background: #e6f7ff;
            border: 1px solid #91d5ff;
            color: #1890ff;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #40a9ff;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” ç‰ˆæœ¬æ£€æµ‹å·¥å…·</h1>
        
        <div class="test-section">
            <h2>æµ‹è¯•ç›®æ ‡</h2>
            <p>æ£€æµ‹å½“å‰è¿è¡Œçš„ä»£ç æ˜¯å¦ä½¿ç”¨ orders_optimized è¡¨</p>
        </div>

        <div class="test-section">
            <h2>æµ‹è¯•æ­¥éª¤</h2>
            <button onclick="testLocalhost()">1. æµ‹è¯• localhost:3000</button>
            <button onclick="testProduction()">2. æµ‹è¯•ç”Ÿäº§ç¯å¢ƒ</button>
            <button onclick="checkLatestOrder()">3. æ£€æŸ¥æœ€æ–°è®¢å•</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const supabaseUrl = 'https://itvmeamoqthfqtkpubdv.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml0dm1lYW1vcXRoZnF0a3B1YmR2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ0ODEyMzUsImV4cCI6MjA3MDA1NzIzNX0.ypBF3lJJTJtSPLEu1zWXqPorS-FDSZzRUy_0ge_Y-r0';

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const result = document.createElement('div');
            result.className = `result ${type}`;
            result.innerHTML = message;
            results.appendChild(result);
        }

        async function testLocalhost() {
            addResult('æ­£åœ¨æµ‹è¯• localhost:3000...', 'info');
            
            try {
                // å°è¯•è®¿é—®æœ¬åœ°æœåŠ¡å™¨
                const response = await fetch('http://localhost:3000/manifest.json');
                if (response.ok) {
                    const data = await response.json();
                    addResult(`âœ… localhost:3000 æ­£åœ¨è¿è¡Œ<br>åº”ç”¨åç§°: ${data.name}`, 'success');
                    
                    // æ£€æŸ¥æ„å»ºæ—¶é—´
                    addResult('æç¤º: è®¿é—® <a href="http://localhost:3000" target="_blank">http://localhost:3000</a> æŸ¥çœ‹å®é™…é¡µé¢', 'info');
                } else {
                    addResult('âŒ localhost:3000 æ— æ³•è®¿é—®', 'error');
                }
            } catch (error) {
                addResult(`âŒ localhost:3000 è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testProduction() {
            addResult('æ£€æŸ¥å¯èƒ½çš„ç”Ÿäº§ç¯å¢ƒ...', 'info');
            
            // åˆ—å‡ºå¯èƒ½çš„ç”Ÿäº§åŸŸå
            const domains = [
                'w.vercel.app',
                'w.netlify.app',
                // æ·»åŠ å…¶ä»–å¯èƒ½çš„åŸŸå
            ];
            
            addResult('è¯·æä¾›ç”Ÿäº§ç¯å¢ƒåŸŸåè¿›è¡Œæµ‹è¯•', 'info');
        }

        async function checkLatestOrder() {
            addResult('æ­£åœ¨æ£€æŸ¥æœ€æ–°è®¢å•...', 'info');
            
            try {
                // ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
                const ordersResponse = await fetch(`${supabaseUrl}/rest/v1/orders?select=*&order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': supabaseAnonKey,
                        'Authorization': `Bearer ${supabaseAnonKey}`
                    }
                });
                
                const optimizedResponse = await fetch(`${supabaseUrl}/rest/v1/orders_optimized?select=*&order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': supabaseAnonKey,
                        'Authorization': `Bearer ${supabaseAnonKey}`
                    }
                });
                
                if (ordersResponse.ok && optimizedResponse.ok) {
                    const ordersData = await ordersResponse.json();
                    const optimizedData = await optimizedResponse.json();
                    
                    if (ordersData.length > 0) {
                        const latestOrder = ordersData[0];
                        addResult(`<strong>ordersè¡¨æœ€æ–°è®¢å•:</strong><br>
                            ID: ${latestOrder.id}<br>
                            ç”¨æˆ·: ${latestOrder.tradingview_username}<br>
                            æ—¶é—´: ${new Date(latestOrder.created_at).toLocaleString('zh-CN')}`, 'info');
                    }
                    
                    if (optimizedData.length > 0) {
                        const latestOptimized = optimizedData[0];
                        addResult(`<strong>orders_optimizedè¡¨æœ€æ–°è®¢å•:</strong><br>
                            ID: ${latestOptimized.id}<br>
                            ç”¨æˆ·: ${latestOptimized.tradingview_username}<br>
                            æ—¶é—´: ${new Date(latestOptimized.created_at).toLocaleString('zh-CN')}`, 'info');
                    }
                    
                    // æ¯”è¾ƒä¸¤è¡¨
                    if (ordersData.length > 0 && optimizedData.length > 0) {
                        const ordersTime = new Date(ordersData[0].created_at);
                        const optimizedTime = new Date(optimizedData[0].created_at);
                        
                        if (ordersTime > optimizedTime) {
                            addResult('âš ï¸ ordersè¡¨æœ‰æ›´æ–°çš„æ•°æ®ï¼Œè¯´æ˜è¿˜åœ¨ä½¿ç”¨æ—§ä»£ç ï¼', 'error');
                        } else if (ordersData[0].id === optimizedData[0].id) {
                            addResult('âœ… ä¸¤è¡¨æ•°æ®ä¸€è‡´ï¼Œè§¦å‘å™¨æ­£åœ¨å·¥ä½œ', 'success');
                        }
                    }
                }
            } catch (error) {
                addResult(`æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            addResult('ç‰ˆæœ¬æ£€æµ‹å·¥å…·å·²åŠ è½½', 'success');
            addResult(`å½“å‰æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`, 'info');
        };
    </script>
</body>
</html>