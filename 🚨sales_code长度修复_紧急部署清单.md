# Sales Code 长度修复 - 紧急部署清单

## 问题分析

### 根本原因
- **数据库字段限制**：`VARCHAR(16)` 或 `VARCHAR(32)`
- **代码生成问题**：最近某次修改导致生成23字符长度的sales_code
- **错误信息**：`Data too long for column 'sales_code'`

### 时间线
- **早上7点前**：正常工作
- **7点后**：开始失败，用户注册报错

## 修复内容

### 1. `api/primary-sales.js`
**修改前格式**：
```javascript
const salesCode = `PS${String(tempId).padStart(6, '0')}${Date.now().toString(36).slice(-8).toUpperCase()}`;
// 生成示例：PS1754448598574MDZDEALQ (23字符) ❌超限
```

**修改后格式**：
```javascript
const salesCode = `PS${tempId.toString(36).slice(-8).toUpperCase()}`;
// 生成示例：PSMDZDEALQ (10字符) ✅安全
```

**安全措施**：
- 添加严格的注释警告
- 明确标注字段长度限制
- 禁止未经确认的格式修改

### 2. `api/secondary-sales.js`
**同样的修复**：
- 修复二级销售代码生成格式
- 添加相同的安全注释和警告

### 3. `api/admin.js`
**数据库注释增强**：
- 在表结构定义中添加长度警告
- 明确标注代码生成不能超过字段长度

## 预期效果

### 修复前
- ❌ 一级销售创建：`Data too long for column 'sales_code'`
- ❌ 二级销售注册：`注册失败，请稍后重试`

### 修复后
- ✅ 一级销售创建：正常工作
- ✅ 二级销售注册：正常工作
- ✅ 代码格式：永久限制在安全范围内

## 代码格式规范

### 一级销售代码格式
- **格式**：`PS + 8位36进制` = 10字符
- **示例**：`PSMDZDEALQ`
- **范围**：完全在VARCHAR(32)安全范围内

### 二级销售代码格式
- **格式**：`SS + 8位36进制` = 10字符
- **示例**：`SSMDZDEALQ`
- **范围**：完全在VARCHAR(32)安全范围内

### 二级注册代码格式
- **格式**：`SR + 8位36进制` = 10字符
- **示例**：`SRMDZDEALQ`
- **范围**：完全在VARCHAR(32)安全范围内

## 安全保障

### 代码级保障
```javascript
// ⚠️ 重要：数据库字段为 VARCHAR(16)，生成的代码不能超过16字符
// ⚠️ 当前格式：PS + 8位36进制 = 10字符，安全范围内
// ⚠️ 禁止修改此格式！任何修改前必须先确认数据库字段长度
```

### 数据库级保障
```sql
sales_code VARCHAR(32) UNIQUE COMMENT '用户购买链接代码 - ⚠️重要：代码生成不能超过此长度！'
```

## 验证计划

部署后立即验证：
1. 一级销售创建（alipay和crypto）
2. 二级销售独立注册（alipay和crypto）
3. 生成的代码长度确认
4. 数据库存储正常

## 风险评估

- **风险等级**：极低
- **影响范围**：仅修复代码生成格式
- **回滚方案**：如有问题可立即回滚
- **数据安全**：不影响现有数据

---

**紧急修复**：解决用户无法注册的问题  
**永久保障**：防止未来再次出现此类问题  
**部署时间**：立即部署