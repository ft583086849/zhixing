# ğŸ”§ ä½£é‡‘ç‡æ›´æ–°å¤±è´¥é—®é¢˜ä¿®å¤å†å²

## ğŸ“ é—®é¢˜æè¿°
**é”™è¯¯ä¿¡æ¯**: "ä½£é‡‘ç‡æ›´æ–°å¤±è´¥: æœªçŸ¥é”™è¯¯"
**å‘ç”Ÿä½ç½®**: https://zhixing-seven.vercel.app/admin/sales

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### 1ï¸âƒ£ **ç¬¬ä¸€æ¬¡å‡ºç°** - å‚æ•°ä¼ é€’é—®é¢˜
**é—®é¢˜åŸå› **:
- Redux action ç¼ºå°‘ `salesType` å‚æ•°
- é”€å”®IDä»é”™è¯¯çš„ä½ç½®æå–ï¼ˆä½¿ç”¨äº†å¾ªç¯å˜é‡è€Œä¸æ˜¯record.sales?.idï¼‰

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// AdminSales.js - ä¿®å¤å‰
handleConfirmCommissionRate(salesId, record) {
  // salesId æ˜¯å¾ªç¯å˜é‡ï¼Œä¸æ˜¯å®é™…çš„é”€å”®ID
  dispatch(updateCommissionRate({ salesId, commissionRate }))
}

// AdminSales.js - ä¿®å¤å
handleConfirmCommissionRate(salesId, record) {
  const actualSalesId = record.sales?.id;
  const actualSalesType = record.sales?.sales_type || 'secondary';
  dispatch(updateCommissionRate({ 
    salesId: actualSalesId, 
    commissionRate: rateToStore,
    salesType: actualSalesType
  }))
}
```

### 2ï¸âƒ£ **ç¬¬äºŒæ¬¡å‡ºç°** - ä½£é‡‘ç‡0è®¾ç½®é—®é¢˜
**é—®é¢˜åŸå› **:
- ç³»ç»Ÿå°†ä½£é‡‘ç‡0è§†ä¸º"æœªè®¾ç½®"
- é»˜è®¤å€¼é€»è¾‘è¦†ç›–äº†0å€¼

**ä¿®å¤æ–¹æ¡ˆ**:
```javascript
// api.js - ä¿®å¤å‰
if (!commissionRate) {
  throw new Error('ä½£é‡‘ç‡æ— æ•ˆ');
}

// api.js - ä¿®å¤å
if (commissionRate === null || commissionRate === undefined || commissionRate < 0) {
  throw new Error('ä½£é‡‘ç‡æ— æ•ˆ');
}
```

### 3ï¸âƒ£ **å½“å‰é—®é¢˜** - APIå‡½æ•°ç­¾åä¸åŒ¹é…
**é—®é¢˜åŸå› **:
- adminSlice.js è°ƒç”¨: `adminAPI.updateCommissionRate(salesId, commissionRate, salesType)`
- api.js å‡½æ•°å®šä¹‰å¯èƒ½ä¸åŒ¹é…

## âœ… å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

### 1. **å‰ç«¯ç»„ä»¶å±‚** (AdminSales.js)
```javascript
const handleConfirmCommissionRate = async (salesId, record) => {
  try {
    // è·å–æ­£ç¡®çš„é”€å”®IDå’Œç±»å‹
    const actualSalesId = record.sales?.id;
    const actualSalesType = record.sales?.sales_type || record.sales_type || 'secondary';
    
    if (!actualSalesId) {
      throw new Error('æ— æ³•è·å–é”€å”®ID');
    }
    
    // å¤„ç†ä½£é‡‘ç‡æ ¼å¼
    let rateToStore = newRate;
    if (newRate === 0) {
      rateToStore = 0;
    } else if (record.sales?.commission_rate < 1 && record.sales?.commission_rate > 0) {
      rateToStore = newRate / 100;
    }
    
    // è°ƒç”¨Redux action
    await dispatch(updateCommissionRate({ 
      salesId: actualSalesId, 
      commissionRate: rateToStore,
      salesType: actualSalesType
    })).unwrap();
    
    message.success('ä½£é‡‘ç‡æ›´æ–°æˆåŠŸ');
  } catch (error) {
    message.error('ä½£é‡‘ç‡æ›´æ–°å¤±è´¥: ' + error.message);
  }
};
```

### 2. **Reduxå±‚** (adminSlice.js)
```javascript
export const updateCommissionRate = createAsyncThunk(
  'admin/updateCommissionRate',
  async ({ salesId, commissionRate, salesType }, { rejectWithValue }) => {
    try {
      const response = await adminAPI.updateCommissionRate(
        salesId, 
        commissionRate, 
        salesType
      );
      return response;
    } catch (error) {
      return rejectWithValue(error.message || 'æ›´æ–°ä½£é‡‘æ¯”ç‡å¤±è´¥');
    }
  }
);
```

### 3. **APIå±‚** (api.js)
```javascript
async updateCommissionRate(salesId, commissionRate, salesType) {
  try {
    // å‚æ•°éªŒè¯
    if (!salesId) {
      throw new Error('é”€å”®IDä¸èƒ½ä¸ºç©º');
    }
    if (commissionRate === null || commissionRate === undefined || commissionRate < 0) {
      throw new Error('ä½£é‡‘ç‡æ— æ•ˆ');
    }
    
    // æ ¹æ®é”€å”®ç±»å‹æ›´æ–°
    let updatedSale;
    if (salesType === 'primary') {
      updatedSale = await SupabaseService.updatePrimarySales(salesId, {
        commission_rate: commissionRate,
        updated_at: new Date().toISOString()
      });
    } else {
      updatedSale = await SupabaseService.updateSecondarySales(salesId, {
        commission_rate: commissionRate,
        updated_at: new Date().toISOString()
      });
    }
    
    // æ¸…é™¤ç¼“å­˜
    CacheManager.clear('sales');
    CacheManager.clear('admin-sales');
    
    return {
      success: true,
      data: updatedSale,
      message: 'ä½£é‡‘æ¯”ç‡æ›´æ–°æˆåŠŸ'
    };
  } catch (error) {
    // è¯¦ç»†é”™è¯¯æ—¥å¿—
    console.error('æ›´æ–°ä½£é‡‘æ¯”ç‡å¤±è´¥è¯¦æƒ…:', {
      error,
      salesId,
      commissionRate,
      salesType,
      errorMessage: error.message,
      errorCode: error.code
    });
    
    // æŠ›å‡ºå…·ä½“é”™è¯¯
    if (error.message?.includes('é”€å”®ID')) {
      throw new Error('é”€å”®IDæ— æ•ˆæˆ–ä¸å­˜åœ¨');
    }
    if (error.message?.includes('ä½£é‡‘ç‡')) {
      throw new Error('ä½£é‡‘ç‡æ ¼å¼æ— æ•ˆ');
    }
    
    throw new Error(error.message || 'æ›´æ–°ä½£é‡‘æ¯”ç‡å¤±è´¥');
  }
}
```

## ğŸ” è°ƒè¯•æ­¥éª¤

### 1. æ£€æŸ¥å‚æ•°ä¼ é€’
æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼ŒæŸ¥çœ‹æ›´æ–°æ—¶çš„å‚æ•°ï¼š
```javascript
console.log('æ›´æ–°ä½£é‡‘ç‡:', { 
  salesId: actualSalesId, 
  è¾“å…¥å€¼: newRate, 
  å­˜å‚¨å€¼: rateToStore,
  salesType: actualSalesType 
});
```

### 2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚
åœ¨å¼€å‘è€…å·¥å…·çš„Networkæ ‡ç­¾ä¸­æŸ¥çœ‹è¯·æ±‚æ˜¯å¦å‘é€æˆåŠŸ

### 3. æ£€æŸ¥æ•°æ®åº“æ›´æ–°
ç¡®è®¤Supabaseæ•°æ®åº“ä¸­çš„è®°å½•æ˜¯å¦æ›´æ–°

## ğŸ“Š æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•1: è®¾ç½®æ­£å¸¸ä½£é‡‘ç‡
- è¾“å…¥: 30%
- æœŸæœ›: æˆåŠŸæ›´æ–°ï¼Œæ˜¾ç¤º30%

### æµ‹è¯•2: è®¾ç½®ä½£é‡‘ç‡ä¸º0
- è¾“å…¥: 0%
- æœŸæœ›: æˆåŠŸæ›´æ–°ï¼Œæ˜¾ç¤º0%

### æµ‹è¯•3: è®¾ç½®æ— æ•ˆå€¼
- è¾“å…¥: -10%
- æœŸæœ›: æ˜¾ç¤ºé”™è¯¯"ä½£é‡‘ç‡æ— æ•ˆ"

### æµ‹è¯•4: æ›´æ–°ä¸å­˜åœ¨çš„é”€å”®ID
- æœŸæœ›: æ˜¾ç¤ºé”™è¯¯"é”€å”®IDæ— æ•ˆæˆ–ä¸å­˜åœ¨"

## ğŸš€ éƒ¨ç½²æ³¨æ„äº‹é¡¹

1. **æ¸…é™¤Vercelç¼“å­˜**
```bash
git commit --allow-empty -m "ğŸ”„ å¼ºåˆ¶æ¸…é™¤ç¼“å­˜"
git push origin main
```

2. **éªŒè¯éƒ¨ç½²**
- ç­‰å¾…2-3åˆ†é’Ÿ
- åˆ·æ–°é¡µé¢
- æµ‹è¯•åŠŸèƒ½

## ğŸ“ ç›¸å…³æ–‡ä»¶
- `/client/src/components/admin/AdminSales.js`
- `/client/src/store/slices/adminSlice.js`
- `/client/src/services/api.js`
- `/client/src/services/supabase.js`
