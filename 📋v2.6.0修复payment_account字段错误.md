# 📋 v2.6.0 修复 payment_account 字段错误

## 🔧 问题描述

用户访问二级销售注册页面时报错：
```
Could not find the 'payment_account' column of 'secondary_sales' in the schema cache
```

**问题链接**：https://zhixing-seven.vercel.app/secondary-sales?registration_code=SEC17547229471452369

## 🎯 根本原因

1. **数据库实际情况**：
   - `secondary_sales` 表只有 `payment_address` 字段
   - 没有 `payment_account` 字段

2. **代码问题**：
   - API层错误地添加了 `payment_account` 字段映射
   - 导致向 Supabase 发送不存在的字段

3. **读写不对称**：
   - 读取时：API层做了兼容处理（payment_address → payment_account）正常显示
   - 写入时：发送了数据库不存在的 payment_account 字段，导致报错

## ✅ 修复内容

### 1. 修改 `client/src/services/api.js`

#### 修复 registerPrimary 方法（第1640-1641行）
```javascript
// 删除了错误的映射：
// salesData.payment_account = salesData.payment_address;
// 改为仅保留注释说明
```

#### 修复 registerSecondary 方法（第1707-1708行）
```javascript
// 删除了错误的映射：
// salesData.payment_account = salesData.payment_address;
// 改为仅保留注释说明
```

#### 修复 getSales 方法（第918行和1061行）
```javascript
// 从：
payment_account: sale.payment_account || sale.payment_address

// 改为：
payment_account: sale.payment_address  // 🔧 统一使用 payment_address 字段
```

## 📊 数据流程（修复后）

### 写入流程
1. 前端表单收集 `payment_address`
2. API层直接传递 `payment_address`（不再添加 payment_account）
3. Supabase正确保存到 `payment_address` 字段 ✅

### 读取流程
1. 数据库读取 `payment_address`
2. API层映射为 `payment_account`（为了前端兼容）
3. 前端通过 `payment_account` 显示 ✅

## 🚀 部署步骤

1. **提交代码**
   ```bash
   git add client/src/services/api.js
   git commit -m "fix: 修复二级销售注册 payment_account 字段错误"
   git push
   ```

2. **Vercel 自动部署**
   - 等待自动部署完成
   - 预计时间：3-5分钟

3. **验证修复**
   - 访问：https://zhixing-seven.vercel.app/secondary-sales?registration_code=SEC17547229471452369
   - 填写表单并提交
   - 确认能够成功保存

## 📝 测试要点

1. **二级销售注册**（关联模式）
   - URL: /secondary-sales?registration_code=XXX
   - 填写微信号、收款地址
   - 提交成功 ✅

2. **二级销售注册**（独立模式）
   - URL: /secondary-sales
   - 填写微信号、收款地址
   - 提交成功 ✅

3. **一级销售注册**
   - URL: /sales
   - 填写微信号、收款地址
   - 提交成功 ✅

4. **销售管理页面**
   - URL: /admin/sales
   - 收款地址正常显示 ✅

## 🔍 相关文件

- `client/src/services/api.js` - API层字段映射逻辑
- `client/src/pages/UnifiedSecondarySalesPage.js` - 二级销售注册页面
- `client/src/components/admin/AdminSales.js` - 销售管理页面

## 📌 注意事项

- 数据库表结构保持不变，只修改前端代码
- 确保所有环境（开发、测试、生产）使用相同的数据库结构
- 未来如需添加 payment_account 字段，需要同时修改数据库和前端

## ✅ 修复状态

- [x] 分析问题原因
- [x] 修改 API 代码
- [x] 创建部署文档
- [ ] 部署到生产环境
- [ ] 验证修复效果

---

**修复时间**：2025-01-07
**修复版本**：v2.6.0
**修复人员**：系统管理员
