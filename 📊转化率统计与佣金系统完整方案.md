# 📊 转化率统计与佣金系统完整方案

> 创建时间：2025-08-15
> 目的：设计转化率分析、佣金规则管理、销售排行榜的完整方案

---

## 一、🎯 分佣逻辑梳理

### 当前系统的分佣规则：

```
订单金额 $100 的分佣流程：

1. 一级销售直销：
   └─ 一级销售获得：$100 × 40% = $40

2. 二级销售订单（假设二级佣金率25%）：
   ├─ 二级销售获得：$100 × 25% = $25
   └─ 一级销售获得：$100 × (40% - 25%) = $15（分销收益）

3. 独立销售订单：
   └─ 独立销售获得：$100 × 25% = $25（默认佣金率）
```

### 核心规则：
- **总佣金率固定40%**：这是给销售体系的总佣金
- **二级销售可调整**：一级销售可以设置二级销售的佣金率（0-40%）
- **差额归一级**：40% - 二级销售佣金率 = 一级销售分销收益

---

## 二、📊 新表结构设计（支持用户系统）

### 1️⃣ conversion_stats表 - 转化率统计表（新建）
```sql
CREATE TABLE conversion_stats (
  id SERIAL PRIMARY KEY,
  
  -- 统计维度
  stat_date DATE NOT NULL,                          -- 统计日期
  stat_period VARCHAR(20) DEFAULT 'daily',          -- daily/weekly/monthly/all
  
  -- 销售信息（支持未来用户系统）
  sales_id INTEGER,                                 -- 销售ID
  sales_user_id INTEGER,                           -- 未来的用户ID
  sales_code VARCHAR(50),                          -- 销售代码
  sales_wechat VARCHAR(100),                       -- 销售微信
  sales_type VARCHAR(20),                          -- primary/secondary/independent
  primary_sales_id INTEGER,                        -- 所属一级销售ID
  
  -- 免费订单统计
  free_orders_count INTEGER DEFAULT 0,             -- 7天免费订单数
  free_orders_users INTEGER DEFAULT 0,             -- 免费订单用户数（去重）
  free_orders_amount DECIMAL(10,2) DEFAULT 0,      -- 免费订单价值（按后续转化价格）
  
  -- 转化统计
  converted_orders_count INTEGER DEFAULT 0,        -- 转化的订单数
  converted_users_count INTEGER DEFAULT 0,         -- 转化的用户数
  conversion_amount DECIMAL(10,2) DEFAULT 0,       -- 转化金额
  
  -- 转化率指标
  order_conversion_rate DECIMAL(5,2) DEFAULT 0,    -- 订单转化率%
  user_conversion_rate DECIMAL(5,2) DEFAULT 0,     -- 用户转化率%
  avg_conversion_days DECIMAL(5,1) DEFAULT 0,      -- 平均转化天数
  
  -- 转化明细（按时长）
  converted_to_1month INTEGER DEFAULT 0,           -- 转化为1个月
  converted_to_3months INTEGER DEFAULT 0,          -- 转化为3个月
  converted_to_6months INTEGER DEFAULT 0,          -- 转化为6个月
  converted_to_yearly INTEGER DEFAULT 0,           -- 转化为年费
  
  -- 用户留存
  day7_retention_rate DECIMAL(5,2) DEFAULT 0,      -- 7天留存率
  day30_retention_rate DECIMAL(5,2) DEFAULT 0,     -- 30天留存率
  
  -- 排名信息
  conversion_rank INTEGER,                         -- 转化率排名
  conversion_rank_in_type INTEGER,                 -- 同类型中的排名
  
  -- 元数据
  last_calculated_at TIMESTAMP,                    -- 最后计算时间
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_conversion_sales ON conversion_stats(sales_id, stat_date);
CREATE INDEX idx_conversion_rate ON conversion_stats(user_conversion_rate DESC);
CREATE INDEX idx_conversion_type ON conversion_stats(sales_type, user_conversion_rate DESC);
```

### 2️⃣ commission_rules表 - 佣金规则表（新建）
```sql
CREATE TABLE commission_rules (
  id SERIAL PRIMARY KEY,
  
  -- 规则基本信息
  rule_code VARCHAR(50) UNIQUE NOT NULL,           -- 规则代码
  rule_name VARCHAR(100) NOT NULL,                 -- 规则名称
  rule_type VARCHAR(20) NOT NULL,                  -- base/special/promotion
  
  -- 适用范围
  sales_type VARCHAR(20),                          -- primary/secondary/independent/all
  sales_id INTEGER,                                -- 特定销售ID（个性化规则）
  sales_user_id INTEGER,                           -- 未来的用户ID
  product_type VARCHAR(50),                        -- 产品类型
  
  -- 佣金率设置
  base_rate DECIMAL(5,4) NOT NULL,                 -- 基础佣金率
  
  -- 阶梯佣金（按业绩）
  tier1_threshold DECIMAL(10,2),                   -- 第一阶梯门槛
  tier1_rate DECIMAL(5,4),                         -- 第一阶梯佣金率
  tier2_threshold DECIMAL(10,2),                   -- 第二阶梯门槛
  tier2_rate DECIMAL(5,4),                         -- 第二阶梯佣金率
  tier3_threshold DECIMAL(10,2),                   -- 第三阶梯门槛
  tier3_rate DECIMAL(5,4),                         -- 第三阶梯佣金率
  
  -- 分销规则（仅一级销售）
  distribution_enabled BOOLEAN DEFAULT false,       -- 是否启用分销
  distribution_rate DECIMAL(5,4),                  -- 分销收益率
  max_secondary_rate DECIMAL(5,4) DEFAULT 0.35,    -- 二级销售最高佣金率
  min_secondary_rate DECIMAL(5,4) DEFAULT 0.10,    -- 二级销售最低佣金率
  default_secondary_rate DECIMAL(5,4) DEFAULT 0.25, -- 二级销售默认佣金率
  
  -- 特殊规则
  free_trial_commission BOOLEAN DEFAULT false,      -- 免费试用是否有佣金
  renewal_bonus_rate DECIMAL(5,4),                 -- 续费奖励率
  
  -- 生效时间
  effective_from DATE NOT NULL,                    -- 生效开始日期
  effective_to DATE,                               -- 生效结束日期
  
  -- 状态
  status VARCHAR(20) DEFAULT 'active',             -- active/inactive/archived
  priority INTEGER DEFAULT 100,                    -- 优先级（数字越小优先级越高）
  
  -- 审计字段
  created_by INTEGER,                              -- 创建人ID
  approved_by INTEGER,                             -- 审批人ID
  approved_at TIMESTAMP,                           -- 审批时间
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_commission_rules_type ON commission_rules(sales_type, status);
CREATE INDEX idx_commission_rules_sales ON commission_rules(sales_id);
CREATE INDEX idx_commission_rules_priority ON commission_rules(priority, status);
```

### 3️⃣ sales_ranking表 - 销售排行榜表（优化版）
```sql
CREATE TABLE sales_ranking (
  id SERIAL PRIMARY KEY,
  
  -- 排行榜信息
  ranking_date DATE NOT NULL,                      -- 排行日期
  ranking_type VARCHAR(20) NOT NULL,               -- revenue/conversion/growth
  ranking_period VARCHAR(20) NOT NULL,             -- daily/weekly/monthly/all
  
  -- 销售信息（支持用户系统）
  rank_position INTEGER NOT NULL,                  -- 排名
  sales_id INTEGER,                                -- 销售ID
  sales_user_id INTEGER,                           -- 未来的用户ID
  sales_code VARCHAR(50),                          -- 销售代码
  sales_wechat VARCHAR(100),                       -- 销售微信
  sales_name VARCHAR(100),                         -- 销售名称
  sales_type VARCHAR(20),                          -- primary/secondary/independent
  
  -- 上级信息
  primary_sales_id INTEGER,                        -- 一级销售ID
  primary_sales_user_id INTEGER,                   -- 一级销售用户ID
  primary_sales_wechat VARCHAR(100),               -- 一级销售微信
  primary_sales_name VARCHAR(100),                 -- 一级销售名称
  
  -- 业绩数据
  total_orders INTEGER DEFAULT 0,                  -- 总订单数
  total_revenue DECIMAL(10,2) DEFAULT 0,           -- 总销售额
  total_commission DECIMAL(10,2) DEFAULT 0,        -- 总佣金
  revenue_percentage DECIMAL(5,2) DEFAULT 0,       -- 占总销售额比例
  
  -- 转化数据（新增）
  free_orders INTEGER DEFAULT 0,                   -- 免费订单数
  converted_orders INTEGER DEFAULT 0,              -- 转化订单数
  conversion_rate DECIMAL(5,2) DEFAULT 0,          -- 转化率
  avg_order_value DECIMAL(10,2) DEFAULT 0,         -- 平均订单价值
  
  -- 增长数据
  growth_rate DECIMAL(5,2) DEFAULT 0,              -- 增长率
  new_customers INTEGER DEFAULT 0,                 -- 新客户数
  retention_rate DECIMAL(5,2) DEFAULT 0,           -- 客户留存率
  
  -- 评分（综合排名用）
  performance_score DECIMAL(10,2) DEFAULT 0,       -- 综合绩效分
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_ranking_date ON sales_ranking(ranking_date, ranking_type);
CREATE INDEX idx_ranking_position ON sales_ranking(rank_position, ranking_type);
CREATE INDEX idx_ranking_sales ON sales_ranking(sales_id);
```

### 4️⃣ commission_records表 - 佣金记录表（新建）
```sql
CREATE TABLE commission_records (
  id SERIAL PRIMARY KEY,
  
  -- 佣金基本信息
  record_number VARCHAR(50) UNIQUE NOT NULL,       -- 佣金记录号
  order_id INTEGER NOT NULL,                       -- 订单ID
  order_number VARCHAR(50),                        -- 订单号
  
  -- 销售信息（支持用户系统）
  sales_id INTEGER NOT NULL,                       -- 销售ID
  sales_user_id INTEGER,                           -- 销售用户ID
  sales_code VARCHAR(50),                          -- 销售代码
  sales_type VARCHAR(20),                          -- primary/secondary/independent
  
  -- 客户信息（支持用户系统）
  customer_id INTEGER,                             -- 客户ID
  customer_user_id INTEGER,                        -- 客户用户ID
  customer_wechat VARCHAR(100),                    -- 客户微信
  
  -- 金额信息
  order_amount DECIMAL(10,2) NOT NULL,             -- 订单金额
  commission_rate DECIMAL(5,4) NOT NULL,           -- 佣金率
  commission_amount DECIMAL(10,2) NOT NULL,        -- 佣金金额
  
  -- 佣金类型
  commission_type VARCHAR(20),                     -- direct/distribution/bonus
  
  -- 分销信息（如果是分销佣金）
  parent_sales_id INTEGER,                         -- 上级销售ID
  parent_commission_amount DECIMAL(10,2),          -- 上级获得的佣金
  child_sales_id INTEGER,                          -- 下级销售ID
  child_commission_amount DECIMAL(10,2),           -- 下级获得的佣金
  
  -- 规则信息
  rule_id INTEGER,                                 -- 应用的佣金规则ID
  rule_code VARCHAR(50),                           -- 规则代码
  
  -- 结算信息
  settlement_status VARCHAR(20) DEFAULT 'pending',  -- pending/settled/paid
  settlement_date DATE,                            -- 结算日期
  payment_date DATE,                               -- 支付日期
  payment_method VARCHAR(20),                      -- 支付方式
  payment_reference VARCHAR(100),                  -- 支付参考号
  
  -- 审计信息
  calculated_at TIMESTAMP,                         -- 计算时间
  settled_by INTEGER,                              -- 结算人
  paid_by INTEGER,                                 -- 支付人
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_commission_order ON commission_records(order_id);
CREATE INDEX idx_commission_sales ON commission_records(sales_id);
CREATE INDEX idx_commission_status ON commission_records(settlement_status);
CREATE INDEX idx_commission_date ON commission_records(created_at);
```

### 5️⃣ user_conversion_journey表 - 用户转化旅程表（新建）
```sql
CREATE TABLE user_conversion_journey (
  id SERIAL PRIMARY KEY,
  
  -- 用户信息（支持未来用户系统）
  customer_wechat VARCHAR(100) NOT NULL,           -- 客户微信
  customer_user_id INTEGER,                        -- 未来的用户ID
  customer_name VARCHAR(100),                      -- 客户名称
  
  -- 来源信息
  source_sales_id INTEGER,                         -- 来源销售ID
  source_sales_code VARCHAR(50),                   -- 来源销售代码
  source_sales_type VARCHAR(20),                   -- 销售类型
  source_channel VARCHAR(50),                      -- 来源渠道
  
  -- 免费试用阶段
  trial_start_date TIMESTAMP,                      -- 试用开始时间
  trial_end_date TIMESTAMP,                        -- 试用结束时间
  trial_order_id INTEGER,                          -- 试用订单ID
  trial_engagement_score INTEGER,                  -- 试用期活跃度（0-100）
  
  -- 转化阶段
  converted BOOLEAN DEFAULT false,                 -- 是否转化
  conversion_date TIMESTAMP,                       -- 转化时间
  conversion_order_id INTEGER,                     -- 转化订单ID
  conversion_product VARCHAR(50),                  -- 转化产品类型
  conversion_amount DECIMAL(10,2),                 -- 转化金额
  days_to_convert INTEGER,                         -- 转化用时（天）
  
  -- 转化路径
  touch_points INTEGER DEFAULT 0,                  -- 接触次数
  reminder_count INTEGER DEFAULT 0,                -- 催单次数
  last_reminder_date TIMESTAMP,                    -- 最后催单时间
  
  -- 续费情况
  renewal_count INTEGER DEFAULT 0,                 -- 续费次数
  total_lifetime_value DECIMAL(10,2) DEFAULT 0,    -- 总生命周期价值
  churn_date DATE,                                 -- 流失日期
  churn_reason VARCHAR(100),                       -- 流失原因
  
  -- 分析标签
  customer_segment VARCHAR(50),                    -- 客户分类
  conversion_probability DECIMAL(5,2),             -- 转化概率预测
  
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_journey_customer ON user_conversion_journey(customer_wechat);
CREATE INDEX idx_journey_sales ON user_conversion_journey(source_sales_id);
CREATE INDEX idx_journey_conversion ON user_conversion_journey(converted, conversion_date);
```

---

## 三、🔄 转化率统计实现

### 1. 实时更新转化率
```sql
-- 创建函数：计算销售的转化率
CREATE OR REPLACE FUNCTION calculate_conversion_rate(p_sales_id INTEGER)
RETURNS TABLE (
  free_orders INTEGER,
  converted_orders INTEGER,
  conversion_rate DECIMAL
) AS $$
BEGIN
  RETURN QUERY
  WITH free_trials AS (
    SELECT COUNT(DISTINCT o1.id) as free_count
    FROM orders o1
    WHERE o1.sales_id = p_sales_id
      AND o1.duration = '7days'
      AND o1.amount = 0
  ),
  conversions AS (
    SELECT COUNT(DISTINCT o2.id) as converted_count
    FROM orders o1
    JOIN orders o2 ON o1.customer_wechat = o2.customer_wechat
    WHERE o1.sales_id = p_sales_id
      AND o1.duration = '7days'
      AND o1.amount = 0
      AND o2.amount > 0
      AND o2.created_at > o1.created_at
  )
  SELECT 
    ft.free_count,
    c.converted_count,
    CASE 
      WHEN ft.free_count > 0 
      THEN ROUND((c.converted_count::DECIMAL / ft.free_count) * 100, 2)
      ELSE 0
    END as rate
  FROM free_trials ft, conversions c;
END;
$$ LANGUAGE plpgsql;
```

### 2. 定时更新转化率统计
```sql
-- 每日更新转化率统计
CREATE OR REPLACE FUNCTION update_daily_conversion_stats()
RETURNS void AS $$
BEGIN
  -- 清除今日数据
  DELETE FROM conversion_stats WHERE stat_date = CURRENT_DATE;
  
  -- 插入新的统计数据
  INSERT INTO conversion_stats (
    stat_date, sales_id, sales_code, sales_type,
    free_orders_count, converted_orders_count,
    user_conversion_rate
  )
  SELECT 
    CURRENT_DATE,
    s.id,
    s.sales_code,
    s.sales_type,
    COUNT(DISTINCT CASE WHEN o.duration = '7days' THEN o.id END),
    COUNT(DISTINCT CASE WHEN o2.amount > 0 THEN o2.id END),
    CASE 
      WHEN COUNT(DISTINCT CASE WHEN o.duration = '7days' THEN o.customer_wechat END) > 0
      THEN ROUND(
        COUNT(DISTINCT CASE WHEN o2.amount > 0 THEN o2.customer_wechat END)::DECIMAL / 
        COUNT(DISTINCT CASE WHEN o.duration = '7days' THEN o.customer_wechat END) * 100, 
        2
      )
      ELSE 0
    END
  FROM secondary_sales s
  LEFT JOIN orders o ON s.sales_code = o.sales_code
  LEFT JOIN orders o2 ON o.customer_wechat = o2.customer_wechat 
    AND o2.amount > 0 
    AND o2.created_at > o.created_at
  GROUP BY s.id, s.sales_code, s.sales_type;
  
  -- 更新排名
  UPDATE conversion_stats cs
  SET conversion_rank = subq.rank
  FROM (
    SELECT 
      sales_id,
      RANK() OVER (ORDER BY user_conversion_rate DESC) as rank
    FROM conversion_stats
    WHERE stat_date = CURRENT_DATE
  ) subq
  WHERE cs.sales_id = subq.sales_id
    AND cs.stat_date = CURRENT_DATE;
END;
$$ LANGUAGE plpgsql;
```

---

## 四、📱 前端展示实现

### 1. 转化率排行榜组件
```javascript
// ConversionRankingTable.js
const ConversionRankingTable = () => {
  const [data, setData] = useState([]);
  const [salesType, setSalesType] = useState('all'); // all/primary/secondary/independent
  
  // 获取转化率数据
  const loadConversionStats = async () => {
    const query = supabase
      .from('conversion_stats')
      .select('*')
      .eq('stat_date', today)
      .order('user_conversion_rate', { ascending: false })
      .limit(20);
    
    if (salesType !== 'all') {
      query.eq('sales_type', salesType);
    }
    
    const { data } = await query;
    setData(data);
  };
  
  const columns = [
    {
      title: '排名',
      dataIndex: 'conversion_rank',
      render: (rank) => {
        if (rank === 1) return '🥇';
        if (rank === 2) return '🥈';
        if (rank === 3) return '🥉';
        return rank;
      }
    },
    {
      title: '销售类型',
      dataIndex: 'sales_type',
      render: (type) => {
        const typeMap = {
          'primary': { text: '一级销售', color: 'blue' },
          'secondary': { text: '二级销售', color: 'green' },
          'independent': { text: '独立销售', color: 'orange' }
        };
        const info = typeMap[type];
        return <Tag color={info.color}>{info.text}</Tag>;
      }
    },
    {
      title: '销售名称',
      dataIndex: 'sales_wechat'
    },
    {
      title: '免费订单数',
      dataIndex: 'free_orders_count',
      sorter: true
    },
    {
      title: '转化订单数',
      dataIndex: 'converted_orders_count',
      sorter: true
    },
    {
      title: '转化率',
      dataIndex: 'user_conversion_rate',
      render: (rate) => (
        <Progress 
          percent={rate} 
          size="small"
          strokeColor={rate > 50 ? '#52c41a' : rate > 30 ? '#faad14' : '#f5222d'}
        />
      ),
      sorter: true,
      defaultSortOrder: 'descend'
    },
    {
      title: '转化金额',
      dataIndex: 'conversion_amount',
      render: (amount) => `$${amount.toFixed(2)}`
    },
    {
      title: '平均转化天数',
      dataIndex: 'avg_conversion_days',
      render: (days) => `${days}天`
    }
  ];
  
  return (
    <Card title="销售转化率排行榜">
      <Space style={{ marginBottom: 16 }}>
        <Radio.Group value={salesType} onChange={e => setSalesType(e.target.value)}>
          <Radio.Button value="all">全部</Radio.Button>
          <Radio.Button value="primary">一级销售</Radio.Button>
          <Radio.Button value="secondary">二级销售</Radio.Button>
          <Radio.Button value="independent">独立销售</Radio.Button>
        </Radio.Group>
      </Space>
      
      <Table 
        columns={columns}
        dataSource={data}
        rowKey="id"
      />
    </Card>
  );
};
```

### 2. 在AdminOverview.js中集成
```javascript
// 在Top5销售排行榜下方添加
<ConversionRankingTable />
```

---

## 五、✅ 实施计划

### 第1阶段：基础表创建
1. 创建所有新表
2. 设置默认佣金规则
3. 初始化历史数据

### 第2阶段：数据迁移
```sql
-- 迁移历史转化数据
INSERT INTO user_conversion_journey (
  customer_wechat,
  source_sales_id,
  trial_start_date,
  converted,
  conversion_date
)
SELECT DISTINCT
  o1.customer_wechat,
  s.id,
  o1.created_at,
  CASE WHEN o2.id IS NOT NULL THEN true ELSE false END,
  o2.created_at
FROM orders o1
JOIN secondary_sales s ON o1.sales_code = s.sales_code
LEFT JOIN orders o2 ON o1.customer_wechat = o2.customer_wechat 
  AND o2.amount > 0 
  AND o2.created_at > o1.created_at
WHERE o1.duration = '7days';
```

### 第3阶段：实时更新部署
1. 部署触发器
2. 设置定时任务
3. 启用实时推送

### 第4阶段：前端集成
1. 添加转化率排行榜
2. 更新佣金显示逻辑
3. 添加用户转化旅程图

---

## 六、🎯 效果预期

### 功能增强：
1. **转化率分析**：清晰展示每个销售的免费转付费效果
2. **佣金透明**：所有佣金规则记录在案，可追溯
3. **排行激励**：多维度排行榜，激励销售团队

### 数据价值：
1. **预测模型**：基于历史数据预测转化概率
2. **优化决策**：识别高转化销售的成功模式
3. **精准营销**：针对不同转化阶段的客户精准施策

### 未来扩展：
1. **用户系统无缝对接**：所有表都预留了user_id字段
2. **智能佣金**：支持复杂的阶梯佣金和促销规则
3. **全链路追踪**：完整记录用户从试用到续费的全过程

这个方案完整地解决了你的需求，包括转化率统计、佣金规则管理，并为未来的用户系统预留了扩展空间。