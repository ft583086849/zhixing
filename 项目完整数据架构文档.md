# 📊 知行财库系统 - 完整数据架构文档

> 生成时间: 2025-08-21  
> 项目类型: 全栈销售管理系统  
> 部署地址: https://zhixing-seven.vercel.app

## 一、数据库表结构明细

### 1. orders_optimized（订单表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| order_id | VARCHAR | 订单ID(主键) | 自动生成 | 创建时 |
| customer_wechat | VARCHAR | 客户微信号 | 用户输入 | 创建时 |
| sales_wechat | VARCHAR | 销售微信号 | 从sales表关联 | 创建时 |
| sales_code | VARCHAR | 销售代码 | URL参数传入 | 创建时 |
| amount | DECIMAL | 订单金额($) | 用户选择 | 创建时 |
| duration | VARCHAR | 购买时长 | 7天/1个月/3个月等 | 创建时 |
| status | VARCHAR | 订单状态 | pending→confirmed→active | 实时更新 |
| payment_proof | TEXT | 支付凭证 | 图片URL | 创建时 |
| expiry_time | TIMESTAMP | 到期时间 | created_at + duration | 创建时计算 |
| payment_time | TIMESTAMP | 支付时间 | 确认支付时记录 | 状态更新时 |
| config_time | TIMESTAMP | 配置时间 | 配置生效时记录 | 状态更新时 |
| commission_rate | DECIMAL | 佣金率 | 从sales表获取 | 创建时 |
| commission_amount | DECIMAL | 佣金金额 | amount * rate | 配置时计算 |
| commission_paid | BOOLEAN | 佣金已支付 | 默认false | 支付时更新 |
| reminder_sent | BOOLEAN | 催单已发送 | 默认false | 催单时更新 |
| is_reminded | BOOLEAN | 是否已催单 | 默认false | 催单时更新 |
| reminder_time | TIMESTAMP | 催单时间 | 催单时记录 | 催单时更新 |
| chain_name | VARCHAR | 区块链名称 | 加密支付时填写 | 创建时 |
| wallet_address | VARCHAR | 钱包地址 | 加密支付时填写 | 创建时 |
| created_at | TIMESTAMP | 创建时间 | 自动记录 | 创建时 |
| updated_at | TIMESTAMP | 更新时间 | 自动更新 | 每次更新 |

### 2. sales_optimized（销售员表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| id | BIGINT | 主键ID | 自增 | 创建时 |
| sales_code | VARCHAR | 销售代码(唯一) | PRI/SEC+时间戳 | 创建时 |
| wechat_name | VARCHAR | 微信名称 | 用户输入 | 可更新 |
| sales_type | VARCHAR | 销售类型 | primary/secondary/independent | 创建时 |
| parent_sales_code | VARCHAR | 上级销售代码 | 注册时指定 | 创建时 |
| primary_sales_code | VARCHAR | 一级销售代码 | 递归查找 | 创建时 |
| commission_rate | DECIMAL | 佣金率(%) | 管理员设置 | 可更新 |
| pending_commission | DECIMAL | 待返佣金($) | SUM(未支付佣金) | 触发器更新 |
| total_commission | DECIMAL | 总佣金($) | SUM(所有佣金) | 触发器更新 |
| payment_method | VARCHAR | 收款方式 | alipay/crypto | 可更新 |
| payment_account | VARCHAR | 收款账号 | 支付宝/钱包 | 可更新 |
| chain_name | VARCHAR | 区块链名称 | 加密货币链 | 可更新 |
| wallet_address | VARCHAR | 钱包地址 | 加密钱包地址 | 可更新 |
| created_at | TIMESTAMP | 创建时间 | 自动记录 | 创建时 |
| updated_at | TIMESTAMP | 更新时间 | 自动更新 | 每次更新 |

### 3. customers_optimized（客户表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| id | BIGINT | 主键ID | 自增 | 创建时 |
| customer_wechat | VARCHAR | 客户微信(唯一) | 订单创建时 | 创建时 |
| sales_wechat | VARCHAR | 销售微信 | 从订单关联 | 触发器更新 |
| sales_code | VARCHAR | 销售代码 | 从订单关联 | 触发器更新 |
| total_orders | INT | 总订单数 | COUNT(orders) | 触发器更新 |
| total_amount | DECIMAL | 总金额($) | SUM(orders.amount) | 触发器更新 |
| is_reminded | BOOLEAN | 是否已催单 | 默认false | 催单时更新 |
| reminder_time | TIMESTAMP | 催单时间 | 催单时记录 | 催单时更新 |
| created_at | TIMESTAMP | 创建时间 | 自动记录 | 创建时 |
| updated_at | TIMESTAMP | 更新时间 | 自动更新 | 每次更新 |

### 4. admins（管理员表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| id | BIGINT | 主键ID | 自增 | 创建时 |
| username | VARCHAR | 用户名(唯一) | 管理员设置 | 创建时 |
| password | VARCHAR | 密码(加密) | bcrypt加密 | 可更新 |
| role | VARCHAR | 角色 | admin/super_admin | 创建时 |
| created_at | TIMESTAMP | 创建时间 | 自动记录 | 创建时 |

### 5. commission_history（佣金历史表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| id | BIGINT | 主键ID | 自增 | 创建时 |
| sales_code | VARCHAR | 销售代码 | 修改时记录 | 创建时 |
| wechat_name | VARCHAR | 微信名称 | 修改时记录 | 创建时 |
| commission_rate | DECIMAL | 当前佣金率 | 修改后的值 | 创建时 |
| changed_from | DECIMAL | 原佣金率 | 修改前的值 | 创建时 |
| changed_to | DECIMAL | 新佣金率 | 修改后的值 | 创建时 |
| changed_by | VARCHAR | 修改人 | 操作管理员 | 创建时 |
| changed_at | TIMESTAMP | 修改时间 | 自动记录 | 创建时 |
| reason | TEXT | 修改原因 | 管理员输入 | 创建时 |

### 6. excluded_sales_config（排除销售配置表）
| 字段名 | 类型 | 含义 | 计算逻辑 | 更新周期 |
|--------|------|------|----------|----------|
| id | BIGINT | 主键ID | 自增 | 创建时 |
| wechat_name | VARCHAR | 销售微信 | 要排除的销售 | 创建时 |
| sales_code | VARCHAR | 销售代码 | 关联销售代码 | 创建时 |
| sales_type | VARCHAR | 销售类型 | 销售类型 | 创建时 |
| reason | TEXT | 排除原因 | 管理员输入 | 创建时 |
| excluded_by | VARCHAR | 操作人 | 管理员 | 创建时 |
| excluded_at | TIMESTAMP | 排除时间 | 自动记录 | 创建时 |
| is_active | BOOLEAN | 是否激活 | 默认true | 可更新 |

## 二、页面路由与功能映射

### 前台页面

| 页面路径 | 页面名称 | 涉及的表 | API调用 | 主要功能 |
|---------|---------|---------|---------|---------|
| / | 首页 | - | - | 系统入口导航 |
| /sales | 销售管理 | sales_optimized | salesAPI.register<br>salesAPI.getSalesByWechat | 销售注册<br>配置收款方式<br>生成推广链接 |
| /purchase?sales_code=XXX | 购买页面 | orders_optimized<br>sales_optimized | ordersAPI.createOrder | 创建订单<br>上传支付凭证 |

### 管理后台页面

| 页面路径 | 页面名称 | 涉及的表 | API调用 | 主要功能 |
|---------|---------|---------|---------|---------|
| /admin | 管理员登录 | admins | authAPI.login | 管理员身份验证 |
| /admin/dashboard | 管理后台首页 | - | - | 功能导航 |
| /admin/orders | 订单管理 | orders_optimized | AdminAPI.getOrders<br>AdminAPI.updateOrderStatus | 订单审核<br>状态更新<br>配置生效 |
| /admin/sales | 销售管理 | sales_optimized<br>commission_history | AdminAPI.getSales<br>AdminAPI.updateCommissionRate | 查看销售<br>调整佣金率<br>查看佣金 |
| /admin/finance | 财务管理 | orders_optimized<br>sales_optimized | AdminAPI.getFinanceStats<br>AdminAPI.markCommissionPaid | 财务统计<br>佣金支付<br>收入分析 |
| /admin/customers | 客户管理 | customers_optimized<br>orders_optimized | AdminAPI.getCustomers<br>AdminAPI.markReminder | 客户列表<br>催单管理<br>数据导出 |
| /admin/overview | 数据概览 | overview_stats<br>orders_optimized<br>sales_optimized | AdminAPI.getStats<br>AdminAPI.getConversionStats | 统计图表<br>转化率分析<br>趋势分析 |

### 对账页面

| 页面路径 | 页面名称 | 涉及的表 | API调用 | 主要功能 |
|---------|---------|---------|---------|---------|
| /sales/commission | 一级销售对账 | sales_optimized<br>orders_optimized | AdminAPI.getPrimarySalesStats | 查看总佣金<br>团队佣金<br>订单明细 |
| /sales/secondary | 二级销售对账 | sales_optimized<br>orders_optimized | salesAPI.getSecondaryStats | 查看个人佣金<br>催单功能 |

## 三、API接口详细说明

### 核心API接口

| API名称 | 方法 | 参数 | 返回值 | 计算逻辑 | 使用页面 |
|---------|------|------|--------|----------|----------|
| AdminAPI.getStats | POST | timeRange<br>startDate<br>endDate | total_orders<br>total_revenue<br>total_commission<br>pending_commission | 聚合统计订单数据 | 数据概览<br>财务管理 |
| AdminAPI.getOrders | GET | status<br>amount<br>date_range | 订单列表 | 筛选查询 | 订单管理 |
| AdminAPI.updateOrderStatus | PUT | order_id<br>status<br>config_time | 更新结果 | 触发佣金计算 | 订单管理 |
| AdminAPI.getSales | GET | sales_type<br>wechat_name | 销售员列表 | 关联查询 | 销售管理 |
| AdminAPI.getCustomers | GET | customer_wechat<br>is_reminded | 客户列表 | 关联订单统计 | 客户管理 |
| AdminAPI.markReminder | PUT | customer_wechat | 更新结果 | 标记催单状态 | 客户管理 |
| AdminAPI.getPrimarySalesStats | POST | sales_code | 销售统计<br>佣金明细<br>订单列表 | 递归计算团队佣金 | 一级销售对账 |
| AdminAPI.getConversionStats | GET | timeRange<br>salesTypeFilter | 转化率数据 | 付费订单/总订单 | 数据概览 |
| salesAPI.register | POST | wechat_name<br>sales_type<br>parent_code | 销售信息 | 生成销售代码 | 销售管理 |
| ordersAPI.createOrder | POST | customer_wechat<br>amount<br>duration<br>sales_code | 订单信息 | 创建订单记录 | 购买页面 |

## 四、数据流转关系

### 1. 订单生命周期
```
客户访问 → 创建订单(pending) → 管理员审核 → 确认支付(confirmed_payment) 
→ 配置生效(confirmed_config) → 激活使用(active) → 到期(expired)
```

### 2. 佣金计算流程
```
订单配置生效 → 触发器执行 → 计算直销佣金(amount * rate) 
→ 查找上级销售 → 计算团队佣金(amount * (parent_rate - self_rate))
→ 更新pending_commission → 支付后更新commission_paid
```

### 3. 催单流程
```
系统判断(到期前7天) → 显示催单建议 → 管理员点击催单 
→ 更新is_reminded=true → 记录reminder_time → 不再显示该客户
```

### 4. 统计更新机制
```
实时统计: 订单/销售/客户表通过聚合查询实时计算
定时统计: overview_stats表每日凌晨更新前一天数据
触发更新: customers_optimized通过触发器在订单变化时更新
```

## 五、关键计算逻辑

### 佣金计算
- **直销佣金**: `订单金额 * 销售员佣金率`
- **团队佣金**: `订单金额 * (上级佣金率 - 下级佣金率)`
- **待返佣金**: `SUM(commission_amount WHERE commission_paid = false)`
- **已付佣金**: `SUM(commission_amount WHERE commission_paid = true)`

### 转化率计算
- **公式**: `(付费订单数 / 总订单数) * 100%`
- **排除机制**: 可排除excluded_sales_config中的销售
- **时间范围**: 今天/本周/本月/全部

### 到期时间计算
- **7天免费**: `created_at + 7天`
- **1个月**: `created_at + 30天`
- **3个月**: `created_at + 90天`
- **6个月**: `created_at + 180天`
- **1年**: `created_at + 365天`

### 催单规则
- **付费订单**: 到期前7天内可催单
- **免费订单**: 到期前3天内可催单
- **已过期**: 过期30天内仍显示

## 六、时间周期说明

### 时区设置
- **统一时区**: 中国标准时间 (UTC+8)
- **今日定义**: 北京时间 00:00:00 到 23:59:59

### 更新周期
| 数据类型 | 更新方式 | 更新时机 |
|---------|---------|---------|
| 订单状态 | 实时更新 | 状态变化时 |
| 佣金计算 | 触发器更新 | 订单配置时 |
| 客户统计 | 触发器更新 | 订单创建/更新时 |
| 销售统计 | 实时查询 | 每次查询时计算 |
| 概览统计 | 定时任务 | 每日凌晨0点 |

## 七、表关联关系图

```
orders_optimized 
    ├── sales_code → sales_optimized (多对一)
    ├── customer_wechat → customers_optimized (多对一)
    └── 触发器 → 自动更新 customers_optimized

sales_optimized
    ├── parent_sales_code → sales_optimized (自关联)
    ├── primary_sales_code → sales_optimized (多对一)
    └── sales_code → commission_history (一对多)

customers_optimized
    └── customer_wechat → orders_optimized (一对多)

excluded_sales_config
    └── sales_code → sales_optimized (多对一)
```

## 八、权限与安全

### 角色权限
- **管理员**: 全部功能访问权限
- **一级销售**: 查看自己和团队数据
- **二级销售**: 仅查看个人数据
- **独立销售**: 仅查看个人数据
- **客户**: 仅能创建订单

### 数据安全
- 密码使用bcrypt加密
- API使用JWT认证
- 敏感信息不在前端暴露
- 支付凭证使用安全存储

## 九、业务规则总结

1. **销售层级**: 最多支持二级分销体系
2. **佣金规则**: 上级佣金率必须高于下级
3. **订单审核**: 必须人工确认支付
4. **催单限制**: 已催单客户不重复显示
5. **统计排除**: 可排除测试销售不计入统计
6. **时间计算**: 全部使用中国标准时间

---

*本文档生成时间: 2025-08-21*  
*项目版本: v1.0.0*