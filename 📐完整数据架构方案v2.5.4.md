# 📐 完整数据架构方案 v2.5.4

## 🎯 核心原则
**所有页面使用统一的后端计算逻辑，前端只负责显示**

---

## 一、🏆 一级销售处理方案

### 1.1 数据存储
- **表**: `primary_sales`
- **关键字段**:
  - `wechat_name`: 微信号
  - `sales_code`: 销售代码（唯一）
  - `commission_rate`: 基础佣金率（默认40%）
  - `secondary_registration_code`: 二级销售注册码

### 1.2 佣金计算逻辑
```javascript
// 动态佣金率计算公式
if (有管理的二级销售) {
  净佣金 = (一级直接订单金额 × 40%) + 
           (二级订单总金额 × 40% - 二级实际支付佣金)
  
  动态佣金率 = 净佣金 ÷ 团队总金额
} else {
  佣金率 = 40% (固定)
}
```

### 1.3 数据获取
- **API**: `SupabaseService.getPrimarySalesSettlement()`
- **返回数据**:
  ```javascript
  {
    sales: {一级销售信息},
    orders: [所有订单],
    secondarySales: [管理的二级销售],
    stats: {
      totalOrders: 总订单数（含二级）,
      totalAmount: 总金额（含二级）,
      totalCommission: 净佣金,
      currentCommissionRate: 动态佣金率,
      monthCommission: 本月佣金,
      todayCommission: 当日佣金
    }
  }
  ```

### 1.4 页面显示
- **一级销售对账页面**: 直接使用 `getPrimarySalesSettlement`
- **管理员后台**: 调用同样的API，保证数据一致

---

## 二、👥 二级销售处理方案（有上级）

### 2.1 数据存储
- **表**: `secondary_sales`
- **关键字段**:
  - `wechat_name`: 微信号
  - `sales_code`: 销售代码（唯一）
  - `commission_rate`: 佣金率（默认25%）
  - `primary_sales_id`: 所属一级销售ID（**必须有值**）

### 2.2 佣金计算逻辑
```javascript
// 二级销售佣金
佣金率 = commission_rate || 25%  // 默认25%
佣金额 = 已确认订单金额 × 佣金率
```

### 2.3 特点
- ✅ 由一级销售通过注册码邀请加入
- ✅ 一级销售可以调整其佣金率（15%-35%）
- ✅ 订单计入一级销售的团队业绩
- ✅ 影响一级销售的动态佣金率

### 2.4 注册流程
```
1. 一级销售分享注册链接（含registration_code）
2. 二级销售填写信息注册
3. 系统自动关联primary_sales_id
4. 默认佣金率设为25%
```

---

## 三、🔷 独立销售处理方案（无上级）

### 3.1 数据存储
- **表**: `secondary_sales`（与二级共用表）
- **关键字段**:
  - `wechat_name`: 微信号
  - `sales_code`: 销售代码（唯一）
  - `commission_rate`: 佣金率（默认25%）
  - `primary_sales_id`: **NULL**（区分标志）

### 3.2 佣金计算逻辑
```javascript
// 独立销售佣金
佣金率 = commission_rate || 25%  // 默认25%
佣金额 = 已确认订单金额 × 佣金率
```

### 3.3 特点
- ✅ 直接注册，无需邀请码
- ✅ 固定佣金率25%（可由管理员调整）
- ✅ 订单不影响任何一级销售
- ✅ 在管理页面显示为"独立销售"标签

### 3.4 注册流程
```
1. 直接访问二级销售注册页（无registration_code）
2. 填写信息注册
3. primary_sales_id保持为NULL
4. 默认佣金率设为25%
```

---

## 四、🔄 管理员后台统一方案

### 4.1 数据获取逻辑
```javascript
AdminAPI.getSales = async (params) => {
  const results = [];
  
  // 1. 获取所有一级销售（使用对账API）
  for (const primary of primarySales) {
    const data = await getPrimarySalesSettlement({
      sales_code: primary.sales_code
    });
    results.push(formatForAdmin(data));
  }
  
  // 2. 获取所有二级销售（区分类型）
  for (const secondary of secondarySales) {
    if (secondary.primary_sales_id) {
      // 有上级的二级销售
      results.push({
        type: 'secondary',
        label: '二级销售',
        ...secondary
      });
    } else {
      // 独立销售
      results.push({
        type: 'independent',
        label: '独立销售',
        ...secondary
      });
    }
  }
  
  return results;
}
```

### 4.2 显示规则
| 类型 | 显示标签 | 佣金率 | 特殊说明 |
|------|---------|--------|----------|
| 一级销售 | "一级销售" | 动态计算 | 显示管理的二级数量 |
| 二级销售 | "二级销售" | 25%或自定义 | 显示所属一级销售 |
| 独立销售 | "独立销售" | 25% | 无上级信息 |

---

## 五、🛠️ 实施步骤

### 第1步：数据清理
```sql
-- 1. 检查重复记录
SELECT wechat_name, COUNT(*) as cnt 
FROM secondary_sales 
GROUP BY wechat_name 
HAVING cnt > 1;

-- 2. 设置默认佣金率
UPDATE secondary_sales 
SET commission_rate = 0.25 
WHERE commission_rate IS NULL;
```

### 第2步：代码修改
- [x] `client/src/services/api.js` - 统一默认佣金率为25%
- [ ] `AdminSales.js` - 使用统一数据源
- [ ] 添加数据刷新延迟（500ms）

### 第3步：验证
1. 运行 `检查非25佣金率的存量销售.js`
2. 确认各页面数据一致
3. 测试佣金率更新功能

---

## 六、📊 数据流示例

### 场景1：一级销售查看对账
```
用户访问 → 一级销售对账页面
    ↓
调用 getPrimarySalesSettlement(wechat_name)
    ↓
返回：销售信息 + 订单列表 + 二级销售 + 动态佣金率
```

### 场景2：管理员查看所有销售
```
管理员访问 → 销售管理页面
    ↓
调用 AdminAPI.getSales()
    ↓
并行调用：
- getPrimarySalesSettlement (每个一级)
- getSecondarySalesSettlement (独立+二级)
    ↓
合并返回：统一格式的销售列表
```

### 场景3：更新佣金率
```
管理员/一级 → 修改佣金率
    ↓
调用 updateCommissionRate(salesId, rate, type)
    ↓
更新数据库
    ↓
延迟500ms刷新数据
    ↓
重新获取最新数据
```

---

## 七、✅ 预期效果

1. **数据一致性**
   - 所有页面显示相同的数据
   - 佣金计算逻辑统一

2. **清晰的销售分类**
   - 一级销售：动态佣金，管理团队
   - 二级销售：25%默认，可调整
   - 独立销售：25%固定，独立运营

3. **无重复记录**
   - 每个销售只显示一次
   - 明确标识销售类型

4. **实时更新**
   - 修改立即生效
   - 延迟刷新保证数据同步

---

## 八、⚠️ 注意事项

1. **保留自定义佣金率**
   - 不要覆盖一级销售设置的特殊佣金率
   - 这是正常的业务需求

2. **区分销售类型**
   - primary_sales_id = NULL → 独立销售
   - primary_sales_id != NULL → 二级销售

3. **佣金率格式**
   - 数据库存储：小数（0.25）
   - 前端显示：百分比（25%）

4. **缓存策略**
   - 更新操作后清除相关缓存
   - 关键数据不使用缓存
